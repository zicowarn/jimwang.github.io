
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Jim Wang">
    <title>标签: Inno Setup - Jim Wang</title>
    <meta name="author" content="Jim Wang">
    
    
        <link rel="icon" href="http://yoursite.com/assets/images/favicon.png">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{}</script>
    <meta name="description" content="ssss">
<meta property="og:type" content="blog">
<meta property="og:title" content="Jim Wang">
<meta property="og:url" content="http://yoursite.com/tags/Inno-Setup/index.html">
<meta property="og:site_name" content="Jim Wang">
<meta property="og:description" content="ssss">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Jim Wang">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="http://yoursite.com/assets/images/avater.png"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-lbwyo1qxpg1hpfggd0e8dvssxoutmxxszfevq18hnlk7wrvazw0lfy2esysn.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-172143513-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-172143513-1');
    </script>


    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?1d51896cc9cd82561c7c8e353bb78c0d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/%20"
            aria-label=""
        >
            Jim Wang
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/avater.png" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="阅读有关作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/avater.png" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">Jim Wang</h4>
                <h5 class="sidebar-profile-subtitle"><p>个人技术博客</p>
</h5>
                
                    <h5 class="sidebar-profile-bio"> <hr style='margin: 5px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 20%;'> <span>全栈探索之路<span> <hr style='margin: 8px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 60%;'> 记录个人对技术的理解和开发过程中遇到的问题，欢迎了解更多。 </h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/zicowarn"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#wechat"
                            
                            rel="noopener"
                            title="微信公众号"
                        >
                        <i class="sidebar-button-icon fab fa-weixin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">微信公众号</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/zuiwuxin?s=09"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/zhichao-wang-a16662109"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="领英"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">领英</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:zicowarn@hotmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="邮箱"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/08/10/inno-05-beautify-wizard-laben/"
                            aria-label=": Inno Setup 如何更换向导页面标题部分的背景"
                        >
                            Inno Setup 如何更换向导页面标题部分的背景
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-08-10T08:11:08+08:00">
	
		    8月 10, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Inno-Setup-%E7%9B%B8%E5%85%B3/">Inno Setup 相关</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="InnoSetup-如何更换向导页面标题部分的背景"><a href="#InnoSetup-如何更换向导页面标题部分的背景" class="headerlink" title="InnoSetup 如何更换向导页面标题部分的背景"></a>InnoSetup 如何更换向导页面标题部分的背景</h2><p>开发部领导新的要求，希望在产品安装包的向导页面做些美化。比如，显示公司的logo在向导页面的标题部分。</p>
<p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-label-part.png" alt></p>
<p>所谓标题即Label部分就是上图中红色方格标注的部分。 标注部分右侧是logo图标。</p>
<h3 id="1-初探，如何更换logo部分"><a href="#1-初探，如何更换logo部分" class="headerlink" title="1. 初探，如何更换logo部分"></a>1. 初探，如何更换logo部分</h3><p>Inno Setup开发文档里里有介绍如何更换Label中右侧的logo的方法。可以通过在<strong>[Setup]</strong>可以定义<code>WizardSmallImageFile</code>=”logo文件路径”来实现。但其要求的logo图片都是长宽相等的。长款不等的图片在显示会被拉伸，其效果惨不忍睹。该选项支持多重文件，即:你可以一次定义多个分辨率的logo文件，Inno Setup在安装的时候会根据系统当前的DPI设置，来自动选择合适分辨率的图片。多重定义的方法如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Example:</span><br><span class="line">WizardSmallImageFile=mysmallimage.bmp,mysmallimage2.bmp</span><br></pre></td></tr></table></figure>

<p>Logo文件分辨率要求如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">100%	55x55</span><br><span class="line">125%	64x68</span><br><span class="line">150%	83x80</span><br><span class="line">175%	92x97</span><br><span class="line">200%	110x106</span><br><span class="line">225%	119x123</span><br><span class="line">250%	138x140</span><br></pre></td></tr></table></figure>

<p>图片被拉伸通常发生在以下两种情况，一、显示器的设置发生了变化。二、Inno Setup向导页面被设定未可缩放。向导页面的缩放可以通过<code>WizardSizePercen</code>和<code>WizardResizable</code>。<code>WizardSizePercent</code>的合法值为从100值150。该参数的目的是允许你在不改变文字大小的前提下等比例缩放所以的安装和卸载向导页面。150意思是缩放为默认大小的150%，即增到50%。这里<code>WizardResizable</code>的合法值为yes和no，而当<code>WizardStyle</code>（其合法值为classic和modern）被设置为modern的时候，就默认为<code>WizardResizable</code>的值为yes，也同时默认为<code>WizardSizePercen</code>为120%。具体解释可以查看Inno Setup的官方文档。</p>
<h3 id="2-深入，如何得到当前的显示器的DPI"><a href="#2-深入，如何得到当前的显示器的DPI" class="headerlink" title="2. 深入，如何得到当前的显示器的DPI"></a>2. 深入，如何得到当前的显示器的DPI</h3><p>上文说到，图片的拉伸除了与向导页面有关，与系统的显示设置也相关，那如何得到当前显示的DPI呢？在Win7之前的系统中，要得到当前显示器的DPI，在Inno Setup的<strong>[Code]</strong>部分可以使用<code>TGraphicsObject.PixelsPerInch</code> 这个属性得到当前系统显示器设定的DPI。TGraphicsObject 这里有个小例子，代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">CheckDPI</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  CurrentDPI, StandardDPI, MediumDPI, LargeDPI: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">&#123; Get the current DPI, 从向导页面的字体中得到当前的DPI &#125;</span> </span><br><span class="line">  CurrentDPI  := WizardForm.Font.PixelsPerInch;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">&#123; Store defaults determined from Windows DPI settings &#125;</span></span><br><span class="line">  StandardDPI := <span class="number">96</span>;  <span class="comment">&#123; 100% &#125;</span></span><br><span class="line">  MediumDPI   := <span class="number">120</span>; <span class="comment">&#123; 125% &#125;</span></span><br><span class="line">  LargeDPI    := <span class="number">144</span>; <span class="comment">&#123; 150% &#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (CurrentDPI &gt;= StandardDPI) <span class="keyword">and</span> (CurrentDPI &lt; MediumDPI) <span class="keyword">then</span> </span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; Execute some custom code for small to medium DPI &#125;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (CurrentDPI &gt;= MediumDPI) <span class="keyword">and</span> (CurrentDPI &lt; LargeDPI) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; Execute some custom code for medium to large DPI &#125;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (CurrentDPI &gt;= LargeDPI) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; Execute some custom code for large DPI or above &#125;</span></span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>从Inno Setup 的5.6的版本开始，在多重定义的时候，Inno Setup就会根据当前DPI自动选择图片大小。这个自动选择是如何实现的呢。 下面的代码就使用了<code>PixelsPerInch</code>这个属性，并尝试模拟了自动选择这部分功能。</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[Setup]</span><br><span class="line">; Use <span class="number">100</span>% images by <span class="keyword">default</span></span><br><span class="line">WizardImageFile=WizardImage <span class="number">100</span>.bmp</span><br><span class="line">WizardSmallImageFile=WizardSmallImage <span class="number">100</span>.bmp</span><br><span class="line"></span><br><span class="line">[Files]</span><br><span class="line">; Embed all other sizes <span class="keyword">to</span> the installer</span><br><span class="line">Source: "WizardImage *.bmp"; Excludes: "* 100.bmp"; Flags: dontcopy</span><br><span class="line">Source: "WizardSmallImage *.bmp"; Excludes: "* 100.bmp"; Flags: dontcopy</span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetScalingFactor</span>:</span> Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> WizardForm.Font.PixelsPerInch &gt;= <span class="number">192</span> <span class="keyword">then</span> Result := <span class="number">200</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> WizardForm.Font.PixelsPerInch &gt;= <span class="number">144</span> <span class="keyword">then</span> Result := <span class="number">150</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> WizardForm.Font.PixelsPerInch &gt;= <span class="number">120</span> <span class="keyword">then</span> Result := <span class="number">125</span></span><br><span class="line">    <span class="keyword">else</span> Result := <span class="number">100</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">LoadEmbededScaledBitmap</span><span class="params">(Image: TBitmapImage; NameBase: <span class="keyword">string</span>)</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  <span class="keyword">Name</span>: <span class="keyword">String</span>;</span><br><span class="line">  FileName: <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">Name</span> := Format(<span class="string">'%s %d.bmp'</span>, [NameBase, GetScalingFactor]);</span><br><span class="line">  ExtractTemporaryFile(<span class="keyword">Name</span>);</span><br><span class="line">  FileName := ExpandConstant(<span class="string">'&#123;tmp&#125;\'</span> + <span class="keyword">Name</span>);</span><br><span class="line">  Image.Bitmap.LoadFromFile(FileName);</span><br><span class="line">  DeleteFile(FileName);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">&#123; If using larger scaling, load the correct size of images &#125;</span></span><br><span class="line">  <span class="keyword">if</span> GetScalingFactor &gt; <span class="number">100</span> <span class="keyword">then</span> </span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    LoadEmbededScaledBitmap(WizardForm.WizardBitmapImage, <span class="string">'WizardImage'</span>);</span><br><span class="line">    LoadEmbededScaledBitmap(WizardForm.WizardBitmapImage2, <span class="string">'WizardImage'</span>);</span><br><span class="line">    LoadEmbededScaledBitmap(WizardForm.WizardSmallBitmapImage, <span class="string">'WizardSmallImage'</span>);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>那么有没有在不用重复定义，仅用一张图片然后根据当前的DPI来进行人为的缩放，也能达到良好的显示效果呢，当然有，方法如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">  CustomPage: TWizardPage;</span><br><span class="line">  BtnImage: TBitmapImage;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  CustomPage := CreateCustomPage(wpLicense, <span class="string">'Heading'</span>, <span class="string">'Sub heading.'</span>);</span><br><span class="line">  ExtractTemporaryFile(<span class="string">'image.bmp'</span>);</span><br><span class="line">  BtnImage := TBitmapImage.Create(WizardForm); <span class="comment">//在当前页面即wpLicense页面创建一个Image按钮。</span></span><br><span class="line">  <span class="keyword">with</span> BtnImage <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      Parent := CustomPage.Surface;</span><br><span class="line">      Bitmap.LoadFromFile(ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>)+<span class="string">'\image.bmp'</span>);</span><br><span class="line">      AutoSize := True;</span><br><span class="line">      AutoSize := False;  <span class="comment">// 缩放之前 关系BtnImage的自由大小属性</span></span><br><span class="line">      Height := ScaleX(Height); <span class="comment">// 然后根据当前BtnImage的大小进行缩放</span></span><br><span class="line">      Width := ScaleY(Width);</span><br><span class="line">      Stretch := True;</span><br><span class="line">      Left := ScaleX(<span class="number">90</span>);</span><br><span class="line">      Top := WizardForm.SelectTasksPage.Top + WizardForm.SelectTasksPage.Height -</span><br><span class="line">             Height - ScaleY(<span class="number">8</span>);</span><br><span class="line">      Cursor := crHand;</span><br><span class="line">      OnClick := @ImageOnClick;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-进阶，Win8之后新系统得到当前的显示器的DPI"><a href="#3-进阶，Win8之后新系统得到当前的显示器的DPI" class="headerlink" title="3. 进阶，Win8之后新系统得到当前的显示器的DPI"></a>3. 进阶，Win8之后新系统得到当前的显示器的DPI</h3><p>由于Windows 8.1之后的系统中，用户可以调整每个监视器的DPI缩放比例，并且Font.PixelsPerInch始终为主监视器返回DPI值，因此<strong>第2节</strong>中的方法就不在适用新的系统了。如果在多显示多DPI的复杂环境中，<strong>第2节</strong>中的方法表现的也不尽如人意。某些时候，可以监听WM_DPICHANGED事件，然后手动并使窗口适应变化的DPI（但此更改可以只是将窗口移动到具有不同DPI设置的监视器）。而 要获取某个窗口的DPI，就需要考虑别的解决方案了。我在网上找到了相关的介绍，但是我当前的项目中不需要这些，也就没对代码进行测试。感兴趣的朋友可以自己尝试一下，代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="keyword">const</span></span><br><span class="line">  S_OK = $<span class="number">00000000</span>;</span><br><span class="line">  LOGPIXELSY = <span class="number">90</span>;</span><br><span class="line">  MONITOR_DEFAULTTONULL = $<span class="number">00000000</span>;</span><br><span class="line">  MONITOR_DEFAULTTOPRIMARY = $<span class="number">00000001</span>;</span><br><span class="line">  MONITOR_DEFAULTTONEAREST = $<span class="number">00000002</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span></span><br><span class="line">  HDC = THandle;</span><br><span class="line">  HMONITOR = THandle;</span><br><span class="line">  MONITOR_DPI_TYPE = (</span><br><span class="line">    MDT_EFFECTIVE_DPI,</span><br><span class="line">    MDT_ANGULAR_DPI,</span><br><span class="line">    MDT_RAW_DPI</span><br><span class="line">  );</span><br><span class="line"><span class="keyword">const</span></span><br><span class="line">  MDT_DEFAULT = MDT_EFFECTIVE_DPI;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetDC</span><span class="params">(hWnd: HWND)</span>:</span> HDC;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">'GetDC@user32.dll stdcall'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReleaseDC</span><span class="params">(hWnd: HWND; hDC: HDC)</span>:</span> Integer;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">'ReleaseDC@user32.dll stdcall'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetDeviceCaps</span><span class="params">(hdc: HDC; <span class="keyword">index</span>: Integer)</span>:</span> Integer;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">'GetDeviceCaps@gdi32.dll stdcall'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MonitorFromWindow</span><span class="params">(hwnd: HWND; dwFlags: DWORD)</span>:</span> HMONITOR;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">'MonitorFromWindow@user32.dll stdcall'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetDpiForMonitor</span><span class="params">(hmonitor: HMONITOR; dpiType: MONITOR_DPI_TYPE;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">out</span> dpiX: UINT; <span class="keyword">out</span> dpiY: UINT)</span>:</span> HRESULT;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">'GetDpiForMonitor@shcore.dll stdcall delayload'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsWindows81OrLater</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := GetWindowsVersion &gt;= $<span class="number">06030000</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetPrimaryMonitorDPI</span>:</span> Integer;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  DC: HDC;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// no need for try..finally block here; just get the desktop DC handle,</span></span><br><span class="line">  <span class="comment">// get the DPI and release the obtained handle</span></span><br><span class="line">  DC := GetDC(<span class="number">0</span>);</span><br><span class="line">  Result := GetDeviceCaps(DC, LOGPIXELSY);</span><br><span class="line">  ReleaseDC(<span class="number">0</span>, DC);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetWindowMonitorDPI</span><span class="params">(Handle: HWND)</span>:</span> Integer;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  HorzDPI: UINT;</span><br><span class="line">  VertDPI: UINT;</span><br><span class="line">  Monitor: HMONITOR;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// if we're not on at least Windows 8.1, then return the primary monitor</span></span><br><span class="line">  <span class="comment">// DPI since earlier systems did not allow per monitor DPI settings</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> IsWindows81OrLater <span class="keyword">then</span></span><br><span class="line">    Result := GetPrimaryMonitorDPI</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  <span class="comment">// otherwise determine which monitor the given window intersects and try</span></span><br><span class="line">  <span class="comment">// to get DPI settings of the found monitor (if any; check MSDN docs for</span></span><br><span class="line">  <span class="comment">// the explanation and other options how to find the nearest monitor)</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// try to get the monitor which the window intersects</span></span><br><span class="line">    Monitor := MonitorFromWindow(Handle, MONITOR_DEFAULTTONULL);</span><br><span class="line">    <span class="comment">// if there's any, then...</span></span><br><span class="line">    <span class="keyword">if</span> Monitor &lt;&gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      <span class="comment">// try to get DPI for that monitor; if it succeeds, return the value,</span></span><br><span class="line">      <span class="comment">// raise an exception otherwise (for details check the MSDN docs)</span></span><br><span class="line">      <span class="keyword">if</span> GetDpiForMonitor(Monitor, MDT_DEFAULT, HorzDPI, VertDPI) = S_OK <span class="keyword">then</span></span><br><span class="line">        Result := VertDPI</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        RaiseException(<span class="string">'GetDpiForMonitor function call failed!'</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      RaiseException(<span class="string">'The given window does not intersect any monitor!'</span>);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>这是Windows SDK中介绍的方法，整个设计相对来说比较复杂。简单来说，将上述代码加入你的项目中，当你需要显示器的DPI的时候就调用<code>GetWindowMonitorDPI</code>函数，然后根据DPI结合<strong>第2节</strong>中的方法来缩放或者选择你要显示的图片。</p>
<h3 id="4-回到项目，更换向导页面标题部分的背景"><a href="#4-回到项目，更换向导页面标题部分的背景" class="headerlink" title="4. 回到项目，更换向导页面标题部分的背景"></a>4. 回到项目，更换向导页面标题部分的背景</h3><p>上述的内容，也是我再寻找解决新需求的过程中，搜集和整理的部分内容，记录下来也是为了以后需要的时候知道应该向那个方向努力。我告诉开发主管的是，我个人不建议将我们安装应用程序的向导页面设置为可缩放，因为这样需要做出的改变特别多，而且当前的大小也能满足使用需求。但美化工作不能少，第一步的任务核心就是页面简介背景部分，代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[Files]</span><br><span class="line">Source: "Logo-header.bmp"; Flags: dontcopy</span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span><span class="params">()</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  BitmapImage: TBitmapImage;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  ExtractTemporaryFile(<span class="string">'Logo-header.bmp'</span>);</span><br><span class="line">  BitmapImage := TBitmapImage.Create(WizardForm);</span><br><span class="line">  BitmapImage.Parent := WizardForm.MainPanel;</span><br><span class="line">  BitmapImage.Width := WizardForm.MainPanel.Width;</span><br><span class="line">  BitmapImage.Height := WizardForm.MainPanel.Height;</span><br><span class="line">  BitmapImage.Stretch := True;</span><br><span class="line">  BitmapImage.AutoSize := False;</span><br><span class="line">  BitmapImage.Bitmap.LoadFromFile(ExpandConstant(<span class="string">'&#123;tmp&#125;\Logo-header.bmp'</span>));</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 禁用 原始页面的小图标</span></span><br><span class="line">  WizardForm.WizardSmallBitmapImage.Visible := False;</span><br><span class="line">  <span class="comment">// 启用 页面简介标题</span></span><br><span class="line">  WizardForm.PageDescriptionLabel.Visible := True;</span><br><span class="line">  <span class="comment">// 启用 页面名称标题</span></span><br><span class="line">  WizardForm.PageNameLabel.Visible := True;</span><br><span class="line">  <span class="comment">// 限定页面简介标题宽度</span></span><br><span class="line">  WizardForm.PageDescriptionLabel.Width :=</span><br><span class="line">    WizardForm.PageDescriptionLabel.Width - ScaleX(<span class="number">120</span>);</span><br><span class="line">  <span class="comment">// 限定页面名称标题宽度</span></span><br><span class="line">  WizardForm.PageNameLabel.Width :=</span><br><span class="line">    WizardForm.PageNameLabel.Width - ScaleX(<span class="number">120</span>)</span><br><span class="line"> <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>上述代码的核心思想就是，准备一张图片，该图片并不会被拷贝在目标文件夹中，在页面初始的时候，设定页面标题简述部分的背景，由于原始页面小logo被禁用，就需要缩进标题名称和简介文本的宽度，防止其覆盖图片的部分内容。</p>
<p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-welcome-part.png" alt="image-20200220170839898"></p>
<p>任务第二部分内容，就是更改欢迎页面的背景图片，即上图中红色部分框选的地方。首先在<strong>[Setup]</strong>中定义属性为<a href="http://www.jrsoftware.org/ishelp/index.php?topic=setup_disablewelcomepage" target="_blank" rel="noopener"><code>DisableWelcomePage=no</code></a>，意指启用欢迎页面。 然后在<strong>[Setup]</strong>部分定义<code>WizardBitmapImage</code>属性即可。结束页面（下图）与开始页面相似，只需在<strong>[Setup]</strong>部分定义<code>WizardBitmapImage2</code> 属性即可。</p>
<p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-finish-part.png" alt="image-20200220170935862"></p>
<p>需要说明的是，如果属性<code>WizardBitmapImage2</code>为被定义，而属性<code>WizardBitmapImage</code>被定义，则结束页面会选择<code>WizardBitmapImage</code>中定义的图片作为上图中红色部分圈选的背景图片。</p>
<h3 id="5-扩展，欢迎页面和结束页面整页照片"><a href="#5-扩展，欢迎页面和结束页面整页照片" class="headerlink" title="5. 扩展，欢迎页面和结束页面整页照片"></a>5. 扩展，欢迎页面和结束页面整页照片</h3><p>我们在<strong>第4节</strong>部分，了解了如何在使用Inno Setup的属性设定，更改欢迎和结束页面的左侧背景图片，那么有没有一种可能，即省去这两个页面的文字（通常需要考虑翻译的问题），直接使用一张图片作为整个页面的背景呢？有，本节我们就探索一下。中心思想为四部：</p>
<ul>
<li>在各自的父页面上拉伸“ WizardBitmapImage”（欢迎）和“ WizardBitmapImage2”（完成），因为这两个页面都有图片部分，就不需要再初始化TBitmapImage了。</li>
<li>隐藏其它内容，例如 标题和段落.</li>
<li>确保安装程序永远不需要重新启动计算机，否则会在结束图片上会显示上重新启动提示。</li>
<li>请确保在<strong>[Run]</strong>部分中没有任何<code>postinstall</code>条目。否则结束页面上也会显示提示信息。</li>
</ul>
<p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-finish-part-full.png" alt="image-20200220171021313"></p>
<p>实现这部分的代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[Setup]</span><br><span class="line">DisableWelcomePage=no</span><br><span class="line">WizardImageFile=Demo.bmp  <span class="comment">// 如果WizardImageFile2 没定义则结束页面也使用该图片</span></span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span><span class="params">()</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// 欢迎页面</span></span><br><span class="line">  <span class="comment">// 隐藏 部分内容</span></span><br><span class="line">  WizardForm.WelcomeLabel1.Visible := False;</span><br><span class="line">  WizardForm.WelcomeLabel2.Visible := False;</span><br><span class="line">  <span class="comment">// 拉伸页面宽度</span></span><br><span class="line">  WizardForm.WizardBitmapImage.Width := WizardForm.WizardBitmapImage.Parent.Width;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 结束页面</span></span><br><span class="line">  <span class="comment">// 隐藏 部分内容</span></span><br><span class="line">  WizardForm.FinishedLabel.Visible := False;</span><br><span class="line">  WizardForm.FinishedHeadingLabel.Visible := False;</span><br><span class="line">  <span class="comment">// 拉伸页面宽度</span></span><br><span class="line">  WizardForm.WizardBitmapImage2.Width := WizardForm.WizardBitmapImage2.Parent.Width;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>



<h3 id="6-扩展2，在向导页脚左侧显示版本号"><a href="#6-扩展2，在向导页脚左侧显示版本号" class="headerlink" title="6. 扩展2，在向导页脚左侧显示版本号"></a>6. 扩展2，在向导页脚左侧显示版本号</h3><p>需要的显示结果如下图所示：</p>
<p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-bottom-left-part.png" alt="image-20200221093833941"></p>
<p>代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span><span class="params">()</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  VersionLabel: TNewStaticText;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// 定义一个静态文本实例</span></span><br><span class="line">  VersionLabel := TNewStaticText.Create(WizardForm);</span><br><span class="line">  <span class="comment">// 从Setup部分的设定中获取版本号</span></span><br><span class="line">  VersionLabel.Caption := Format(<span class="string">'Version: %s'</span>, [<span class="string">'&#123;#SetupSetting("AppVersion")&#125;'</span>]);</span><br><span class="line">  <span class="comment">// 所有页面有效</span></span><br><span class="line">  VersionLabel.Parent := WizardForm;</span><br><span class="line">  <span class="comment">// 左侧位置</span></span><br><span class="line">  VersionLabel.Left := ScaleX(<span class="number">16</span>);</span><br><span class="line">  <span class="comment">// 保证 文本与按钮的 在水平方向 中心对齐</span></span><br><span class="line">  VersionLabel.Top :=</span><br><span class="line">    WizardForm.BackButton.Top +</span><br><span class="line">    (WizardForm.BackButton.Height <span class="keyword">div</span> <span class="number">2</span>) -</span><br><span class="line">    (VersionLabel.Height <span class="keyword">div</span> <span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>对齐的方式，以按钮的左上位置为基点，加上按钮高度与文本高度之差即可。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/08/10/inno-05-beautify-wizard-laben/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/07/10/inno-04-registry-hcr/"
                            aria-label=": Inno Setup Windows 注册表关键字HKEY\_CLASSES\_ROOT相关内容"
                        >
                            Inno Setup Windows 注册表关键字HKEY\_CLASSES\_ROOT相关内容
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-07-10T08:11:08+08:00">
	
		    7月 10, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Inno-Setup-%E7%9B%B8%E5%85%B3/">Inno Setup 相关</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="Windows-注册表"><a href="#Windows-注册表" class="headerlink" title="Windows 注册表"></a>Windows 注册表</h2><p>HKEY_CLASSES_ROOT在此关键字之下，可以看见有一个CLSID关键字。在CLSID关键字之下列有系统中安装的所有组件的CLSID。注册表CLSID是一个具有如下格式的串：00000010-0000-0010-8000-00AA00D2EA4</p>
<p>HKEY_CLASSES_ROOT的开头，列出了将是各种应用程序所注册的文件扩展名。在扩展名之后，可以看到许多其它的名字。此类名字大多数被称作是ProgID，表示是程序员定义的标识符。某些名称表示的不是ProgID而实一些特殊的关键字。</p>
<p>如：</p>
<ul>
<li>CLSID</li>
<li>AppID，此关键字下的子关键字的作用是将某个APPID（应用程序的ID）映射成某个远程服务器名称。分式COM（DCOM）将用到此关键字。</li>
<li>组件类别，注册表的这一分支可以将CATID（组件类别ID）映射成某个特定的组件类别。</li>
<li>Interface，此关键字将用于将IID映射成某个接口相关的信息。这些信息主要用于在跨进程边界使用接口的情况。</li>
<li>Licenses，保存的是授权使用COM组件的一些认可信息。</li>
<li>TypeLib，类型库关键字保存的是关于接口成员函数所用的参数的信息。另外还有一些信息。此关键字可以将一个LIBID映射成存储类型库的文件名称。</li>
</ul>
<h3 id="ProgID"><a href="#ProgID" class="headerlink" title="ProgID"></a>ProgID</h3><p>所谓ProgID指的是程序员给某个CLSID指定的一个程序员易记的名称。ProgID命名规则为：..，如下图：</p>
<p>如WPDSp.WPDServiceProvider是版本无关ProgID，根据其值可在CLSID下找到相应键，进而找到相应信息，如组件最新版本信息。</p>
<p>WPDSp.WPDServiceProvider.1是版本相关ProgID，根据其CLSID值可以找到该版本组件的信息。</p>
<h3 id="ProgID注册表格式"><a href="#ProgID注册表格式" class="headerlink" title="ProgID注册表格式"></a>ProgID注册表格式</h3><p>ProgID及与版本无关的ProgID被列在组件CLSID下面。</p>
<p>ProgID的主要作用是获取相应的CLSID。在每一个CLSID项中查找查个ProgID将非常低效的。因此在其下面也将直接列出ProgID。由于ProgID不是针对最终用户而定义的，因此ProgID关键字的缺省值为用户易记的名称。在之下有一个名为CLSID的关键字，其缺省值为组件的CLSID。如下图所示：</p>
<p>与版本好无关的ProgID也直接被列在HKEY_CLASSES_ROOT下面。它们还有另外一个关键字CurVer，其缺省值为组件当前版本的ProgID，如下图：</p>
<h3 id="ProgID和CLSID的转换"><a href="#ProgID和CLSID的转换" class="headerlink" title="ProgID和CLSID的转换"></a>ProgID和CLSID的转换</h3><ul>
<li>CLSIDFromProgID</li>
<li>ProgIDFromCLSID</li>
</ul>
<h3 id="组件的自注册"><a href="#组件的自注册" class="headerlink" title="组件的自注册"></a>组件的自注册</h3><p>为把组件注册到注册表，在DLL中一定要输出如下两个函数：</p>
<p>STDAPI DllRegisterServer(); //注册</p>
<p>STDAPI DllUnregisterServer(); //反注册</p>
<p>我们使用Regsvr32.exe注册某个组件或者反注册某个组件时，其实就是调用这两个函数的过程。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/07/10/inno-04-registry-hcr/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/07/05/inno-03-check-network-state/"
                            aria-label=": Inno Setup 检查网络连接的Pascal代码"
                        >
                            Inno Setup 检查网络连接的Pascal代码
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-07-05T08:11:08+08:00">
	
		    7月 05, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Inno-Setup-%E7%9B%B8%E5%85%B3/">Inno Setup 相关</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="InnoSetup-检查网络连接"><a href="#InnoSetup-检查网络连接" class="headerlink" title="InnoSetup 检查网络连接"></a>InnoSetup 检查网络连接</h2><h3 id="1-循环检查网络连接直至连接成共，代码如下："><a href="#1-循环检查网络连接直至连接成共，代码如下：" class="headerlink" title="1. 循环检查网络连接直至连接成共，代码如下："></a>1. 循环检查网络连接直至连接成共，代码如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">function IsNetWorkActivatedRepeated: boolean;</span><br><span class="line">var</span><br><span class="line">  WinHttpReq: Variant;</span><br><span class="line">  Connected: Boolean;</span><br><span class="line">begin</span><br><span class="line">  Connected :&#x3D; False;</span><br><span class="line">  repeat</span><br><span class="line">    Log(&#39;Checking connection to the server&#39;);</span><br><span class="line">    try</span><br><span class="line">      WinHttpReq :&#x3D; CreateOleObject(&#39;WinHttp.WinHttpRequest.5.1&#39;);</span><br><span class="line">      &#123; Use your real server host name &#125;</span><br><span class="line">      WinHttpReq.Open(&#39;GET&#39;, &#39;https:&#x2F;&#x2F;www.camtek.de&#x2F;&#39;, False);</span><br><span class="line">      WinHttpReq.Send(&#39;&#39;);</span><br><span class="line">      Log(&#39;Connected to the server; status: &#39; + IntToStr(WinHttpReq.Status) + &#39; &#39; +</span><br><span class="line">          WinHttpReq.StatusText);</span><br><span class="line">      Connected :&#x3D; True;</span><br><span class="line">    except</span><br><span class="line">      Log(&#39;Error connecting to the server: &#39; + GetExceptionMessage);</span><br><span class="line">      if WizardSilent then</span><br><span class="line">      begin</span><br><span class="line">        Log(&#39;Connection to the server is not available, aborting silent installation&#39;);</span><br><span class="line">        Result :&#x3D; False;</span><br><span class="line">        Exit;</span><br><span class="line">      end</span><br><span class="line">        else</span><br><span class="line">      if MsgBox(&#39;Cannot reach server. Please check your Internet connection.&#39;,</span><br><span class="line">                mbError, MB_RETRYCANCEL) &#x3D; IDRETRY then</span><br><span class="line">      begin</span><br><span class="line">        Log(&#39;Retrying&#39;);</span><br><span class="line">      end</span><br><span class="line">        else</span><br><span class="line">      begin</span><br><span class="line">        Log(&#39;Aborting&#39;);</span><br><span class="line">        Result :&#x3D; False;</span><br><span class="line">        Exit;</span><br><span class="line">      end;</span><br><span class="line">    end;</span><br><span class="line">  until Connected;</span><br><span class="line"></span><br><span class="line">  Result :&#x3D; True;</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<h3 id="2-有限次数检测网络，代码如下："><a href="#2-有限次数检测网络，代码如下：" class="headerlink" title="2. 有限次数检测网络，代码如下："></a>2. 有限次数检测网络，代码如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">function IsNetWorkActivatedTried: boolean;</span><br><span class="line">var</span><br><span class="line">  WinHttpReq: Variant;</span><br><span class="line">  Connected: Boolean;</span><br><span class="line">  iTriedTime: Integer;</span><br><span class="line">begin</span><br><span class="line">  Connected :&#x3D; False;</span><br><span class="line">  iTriedTime :&#x3D; 0;</span><br><span class="line">  repeat</span><br><span class="line">    iTriedTime :&#x3D; iTriedTime + 1;</span><br><span class="line">    Log(&#39;Checking connection to the server, try &#39; +  + IntToStr(iTriedTime) + &#39; time.&#39;);</span><br><span class="line">    try</span><br><span class="line"></span><br><span class="line">      WinHttpReq :&#x3D; CreateOleObject(&#39;WinHttp.WinHttpRequest.5.1&#39;);</span><br><span class="line">      WinHttpReq.SetTimeouts(&#39;3000&#39;, &#39;3000&#39;, &#39;3000&#39;, &#39;3000&#39;);</span><br><span class="line">      &#x2F;&#x2F; Use your real server host name </span><br><span class="line">      WinHttpReq.Open(&#39;GET&#39;, &#39;https:&#x2F;&#x2F;www.goolge.de&#x2F;&#39;, False);</span><br><span class="line">      WinHttpReq.Send(&#39;&#39;);</span><br><span class="line">      Log(&#39;Connected to the server; status: &#39; + IntToStr(WinHttpReq.Status) + &#39; &#39; +</span><br><span class="line">          WinHttpReq.StatusText);</span><br><span class="line">      Connected :&#x3D; True;</span><br><span class="line">    except</span><br><span class="line">      Log(&#39;Error connecting to the server, msg: &#39; + GetExceptionMessage + &#39;try again! &#39;);</span><br><span class="line">    end;</span><br><span class="line">  until (iTriedTime &#x3D; 3) or (Connected &#x3D; True) ;</span><br><span class="line">  Result :&#x3D; Connected;</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>


                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/07/05/inno-03-check-network-state/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/06/30/inno-02-installdotnet/"
                            aria-label=": Inno Setup 在x86和x64环境下安装-NET安装包"
                        >
                            Inno Setup 在x86和x64环境下安装-NET安装包
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-06-30T08:11:08+08:00">
	
		    6月 30, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Inno-Setup-%E7%9B%B8%E5%85%B3/">Inno Setup 相关</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="任务难点"><a href="#任务难点" class="headerlink" title="任务难点"></a>任务难点</h3><p>准备一个安装程序，以验证系统的体系结构并安装.NET。</p>
<h3 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h3><p>此安装脚本示例的目的是启动一个安装程序，该安装程序检查系统上当前安装的.NET版本，并仅在需要时安装一个。安装程序将在软件包中包括Microsoft提供的Web安装程序。 安装程序还将根据运行所在的体系结构安装一些库。</p>
<h3 id="2-背景"><a href="#2-背景" class="headerlink" title="2. 背景"></a>2. 背景</h3><p>出于我们的目的，我们需要可从Microsoft下载站点下载的InnoSetup编译器和.NET Framework Web安装程序文件。Microsoft维护一组注册表项，这些注册表项指示已安装的.NET Framework版本和Service Pack。C＃MVP Scott Dorman在此<a href="http://stackoverflow.com/questions/199080/how-to-detect-what-net-framework-versions-and-service-packs-are-installed" target="_blank" rel="noopener">Stack Overflow线程中</a>发布了一个列表，其中包含版本1.0到4.0（在撰写本文时）。除1.0以外，大多数.NET Framework版本所需的注册表项都非常相似。无论如何，我们将忽略该版本已被1.1淘汰的版本。</p>
<p>4.5版和更高版本有些棘手，因为它们可以作为4.0版的就地更新安装并重用完全相同的注册表项。MSDN官方页面“ <a href="https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed" target="_blank" rel="noopener">如何：确定安装的.NET Framework版本”</a>建议检查<code>DWORD</code>value 的存在<code>Release</code>，所以我在下面做这件事。替代方法是检查.NET 4.0 的<code>REG_SZ</code>值<code>Version</code>4.0.30319，.NET 4.5的4.5.50709和.NET 4.6的4.6.00079。（可悲的是，在安装它们时，我不认为要记录4.5.1和4.5.2的版本字符串。）</p>
<p>4.5.1版引入了另一个复杂性：根据Windows版本，可能有_两个_<code>Release</code>值！该脚本通过将所有4.5版或更高版本的查询视为_最低_要求来处理此问题，即，如果该<code>Release</code>值等于或大于任何系统上指定版本的最小值，则这些查询将成功。.NET 4.5或更高版本也可以满足.NET 4.0的查询，因为后者是作为就地更新安装的。对较早版本的查询需要完全匹配，即，即使应用程序兼容，.NET 4.0或更高版本也_无法_满足它们。</p>
<h3 id="3-代码部分"><a href="#3-代码部分" class="headerlink" title="3. 代码部分"></a>3. 代码部分</h3><p>在[Code]部分，我们定义如下函数来检测以安装的.NET版本。该部分代码取自Jordan Russell的网站。 在下面的Inno Setup脚本代码块中，函数<code>IsDotNetDetected</code>检查是否安装了指定的.NET Framework版本和至少指定的Service Pack级别。所有列出的版本字符串均适用于最终发行版本；测试版和发行候选版通常具有不同的版本号。函数<code>InitializeSetup</code>演示了如何使用<code>IsDotNetDetected</code>不带Service Pack的.NET Framework 4.6进行检查。 原始代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsDotNetDetected</span><span class="params">(version: <span class="keyword">string</span>; service: cardinal)</span>:</span> boolean;</span><br><span class="line"><span class="comment">// Indicates whether the specified version and service pack of the .NET Framework is installed.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// version -- Specify one of these strings for the required .NET Framework version:</span></span><br><span class="line"><span class="comment">//    'v1.1'          .NET Framework 1.1</span></span><br><span class="line"><span class="comment">//    'v2.0'          .NET Framework 2.0</span></span><br><span class="line"><span class="comment">//    'v3.0'          .NET Framework 3.0</span></span><br><span class="line"><span class="comment">//    'v3.5'          .NET Framework 3.5</span></span><br><span class="line"><span class="comment">//    'v4\Client'     .NET Framework 4.0 Client Profile</span></span><br><span class="line"><span class="comment">//    'v4\Full'       .NET Framework 4.0 Full Installation</span></span><br><span class="line"><span class="comment">//    'v4.5'          .NET Framework 4.5</span></span><br><span class="line"><span class="comment">//    'v4.5.1'        .NET Framework 4.5.1</span></span><br><span class="line"><span class="comment">//    'v4.5.2'        .NET Framework 4.5.2</span></span><br><span class="line"><span class="comment">//    'v4.6'          .NET Framework 4.6</span></span><br><span class="line"><span class="comment">//    'v4.6.1'        .NET Framework 4.6.1</span></span><br><span class="line"><span class="comment">//    'v4.6.2'        .NET Framework 4.6.2</span></span><br><span class="line"><span class="comment">//    'v4.7'          .NET Framework 4.7</span></span><br><span class="line"><span class="comment">//    'v4.7.1'        .NET Framework 4.7.1</span></span><br><span class="line"><span class="comment">//    'v4.7.2'        .NET Framework 4.7.2</span></span><br><span class="line"><span class="comment">//    'v4.8'          .NET Framework 4.8</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// service -- Specify any non-negative integer for the required service pack level:</span></span><br><span class="line"><span class="comment">//    0               No service packs required</span></span><br><span class="line"><span class="comment">//    1, 2, etc.      Service pack 1, 2, etc. required</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    key, versionKey: <span class="keyword">string</span>;</span><br><span class="line">    install, release, serviceCount, versionRelease: cardinal;</span><br><span class="line">    success: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    versionKey := version;</span><br><span class="line">    versionRelease := <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 1.1 and 2.0 embed release number in version key</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">'v1.1'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        versionKey := <span class="string">'v1.1.4322'</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> version = <span class="string">'v2.0'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        versionKey := <span class="string">'v2.0.50727'</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 and newer install as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> Pos(<span class="string">'v4.'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        versionKey := <span class="string">'v4\Full'</span>;</span><br><span class="line">        <span class="keyword">case</span> version <span class="keyword">of</span></span><br><span class="line">          <span class="string">'v4.5'</span>:   versionRelease := <span class="number">378389</span>;</span><br><span class="line">          <span class="string">'v4.5.1'</span>: versionRelease := <span class="number">378675</span>; <span class="comment">// 378758 on Windows 8 and older</span></span><br><span class="line">          <span class="string">'v4.5.2'</span>: versionRelease := <span class="number">379893</span>;</span><br><span class="line">          <span class="string">'v4.6'</span>:   versionRelease := <span class="number">393295</span>; <span class="comment">// 393297 on Windows 8.1 and older</span></span><br><span class="line">          <span class="string">'v4.6.1'</span>: versionRelease := <span class="number">394254</span>; <span class="comment">// 394271 before Win10 November Update</span></span><br><span class="line">          <span class="string">'v4.6.2'</span>: versionRelease := <span class="number">394802</span>; <span class="comment">// 394806 before Win10 Anniversary Update</span></span><br><span class="line">          <span class="string">'v4.7'</span>:   versionRelease := <span class="number">460798</span>; <span class="comment">// 460805 before Win10 Creators Update</span></span><br><span class="line">          <span class="string">'v4.7.1'</span>: versionRelease := <span class="number">461308</span>; <span class="comment">// 461310 before Win10 Fall Creators Update</span></span><br><span class="line">          <span class="string">'v4.7.2'</span>: versionRelease := <span class="number">461808</span>; <span class="comment">// 461814 before Win10 April 2018 Update</span></span><br><span class="line">          <span class="string">'v4.8'</span>:   versionRelease := <span class="number">528040</span>; <span class="comment">// 528049 before Win10 May 2019 Update</span></span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">'SOFTWARE\Microsoft\NET Framework Setup\NDP\'</span> + versionKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 3.0 uses value InstallSuccess in subkey Setup</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v3.0'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key + <span class="string">'\Setup'</span>, <span class="string">'InstallSuccess'</span>, install);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key, <span class="string">'Install'</span>, install);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.0 and newer use value Servicing instead of SP</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v4'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Servicing'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'SP'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 and newer use additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> versionRelease &gt; <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Release'</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= versionRelease);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    result := success <span class="keyword">and</span> (install = <span class="number">1</span>) <span class="keyword">and</span> (serviceCount &gt;= service);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InitializeSetup</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> IsDotNetDetected(<span class="string">'v4.6'</span>, <span class="number">0</span>) <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        MsgBox(<span class="string">'MyApp requires Microsoft .NET Framework 4.6.'</span><span class="string">#13#13</span></span><br><span class="line">            <span class="string">'Please use Windows Update to install this version,'</span><span class="string">#13</span></span><br><span class="line">            <span class="string">'and then re-run the MyApp setup program.'</span>, mbInformation, MB_OK);</span><br><span class="line">        result := false;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        result := true;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>针对此代码，我们修改为如下形式：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsDotNetDetected</span><span class="params">(version: <span class="keyword">string</span>; service: cardinal)</span>:</span> boolean;</span><br><span class="line"><span class="comment">// Indicates whether the specified version and service pack of the .NET Framework is installed.</span></span><br><span class="line"><span class="comment">// see the link: https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed?redirectedfrom=MSDN#net_b</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// version -- Specify one of these strings for the required .NET Framework version:</span></span><br><span class="line"><span class="comment">//    'v1.1.4322'     .NET Framework 1.1</span></span><br><span class="line"><span class="comment">//    'v2.0.50727'    .NET Framework 2.0</span></span><br><span class="line"><span class="comment">//    'v3.0'          .NET Framework 3.0</span></span><br><span class="line"><span class="comment">//    'v3.5'          .NET Framework 3.5</span></span><br><span class="line"><span class="comment">//    'v4\Client'     .NET Framework 4.0 Client Profile</span></span><br><span class="line"><span class="comment">//    'v4\Full'       .NET Framework 4.0 Full Installation</span></span><br><span class="line"><span class="comment">//    'v4.5'          .NET Framework 4.5 378389</span></span><br><span class="line"><span class="comment">//    'v4.6'          .NET Framework 4.6 393295</span></span><br><span class="line"><span class="comment">//    'v4.6.1'        .NET Framework 4.6.1 394254</span></span><br><span class="line"><span class="comment">//    'v4.6.2'        .NET Framework 4.6.2 394802</span></span><br><span class="line"><span class="comment">//    'v4.7'          .NET Framework 4.7 393295</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// service -- Specify any non-negative integer for the required service pack level:</span></span><br><span class="line"><span class="comment">//    0               No service packs required</span></span><br><span class="line"><span class="comment">//    1, 2, etc.      Service pack 1, 2, etc. required</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    key: <span class="keyword">string</span>;</span><br><span class="line">    install, release, serviceCount: cardinal;</span><br><span class="line">    check45, success: boolean;</span><br><span class="line"><span class="keyword">var</span> reqNetVer : <span class="keyword">string</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// .NET 4.5 installs as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">'v4.5'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">'v4\Full'</span>;</span><br><span class="line">        check45 := true;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        check45 := false;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">'SOFTWARE\Microsoft\NET Framework Setup\NDP\'</span> + version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 3.0 uses value InstallSuccess in subkey Setup</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v3.0'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key + <span class="string">'\Setup'</span>, <span class="string">'InstallSuccess'</span>, install);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key, <span class="string">'Install'</span>, install);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.0/4.5 uses value Servicing instead of SP</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v4'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Servicing'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'SP'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 uses additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> check45 <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Release'</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= <span class="number">378389</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    result := success <span class="keyword">and</span> (install = <span class="number">1</span>) <span class="keyword">and</span> (serviceCount &gt;= service);</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>这是一个全局函数，用于验证是否正确安装了作为参数传递的.NET Framework版本。 现在，我们应该编写一个由安装程序在运行时调用的简单函数，以验证是否已安装所需的.NET版本。我们将以4.0为例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function IsRequiredDotNetDetected(): Boolean;  </span><br><span class="line">begin</span><br><span class="line">    result :&#x3D; IsDotNetDetected(&#39;v4\Full&#39;, 0);</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<p>如果需要，我们还可以在设置过程中发布一条消息：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InitializeSetup</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> IsDotNetDetected(<span class="string">'v4\Full'</span>, <span class="number">0</span>) <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        MsgBox(<span class="string">'&#123;#MyAppName&#125; requires Microsoft .NET Framework 4.0 Client Profile.'</span><span class="string">#13#13</span></span><br><span class="line">          <span class="string">'The installer will attempt to install it'</span>, mbInformation, MB_OK);        </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    result := true;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>代码部分已经完成，现在我们可以关注<strong>[Files]</strong>部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Files]</span><br><span class="line">Source: &quot;&#123;#MyDistFolder&#125;\dotNetFx40_Full_setup.exe&quot;; DestDir: &#123;tmp&#125;; Flags: deleteafterinstall; Check: not IsRequiredDotNetDetected</span><br></pre></td></tr></table></figure>

<p>安装程序将复制.NET安装程序文件（这大约是850 KB的智能文件），<strong>只有</strong>在没有已经存在于系统中，到<strong>系统临时</strong>目录。安装完成后，该文件将被删除。现在已经复制了网络安装程序，如果需要，我们需要运行它。 在<strong>[run]</strong>部分中，输入以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Run]</span><br><span class="line">Filename: &#123;tmp&#125;\dotNetFx40_Full_setup.exe; Parameters: &quot;&#x2F;q:a &#x2F;c:&quot;&quot;install &#x2F;l </span><br><span class="line">  &#x2F;q&quot;&quot;&quot;; Check: not IsRequiredDotNetDetected; StatusMsg: Microsoft Framework 4.0 is beïng installed. Please wait...</span><br></pre></td></tr></table></figure>

<h3 id="4-x86-x64选项"><a href="#4-x86-x64选项" class="headerlink" title="4. x86 / x64选项"></a>4. x86 / x64选项</h3><p>此示例显示安装程序如何根据系统体系结构运行。它将安装系统所需的本机库，以进行更智能的安装。在 <strong>[setuo]</strong>部分中，定义以下指令：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArchitecturesInstallIn64BitMode=x64</span><br></pre></td></tr></table></figure>

<p>这两行将根据系统安装一个lib文件夹：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Source: &quot;&#123;#MyDistFolder&#125;\lib\x64\*&quot;; DestDir: &quot;&#123;app&#125;\lib\x64&quot;; Check: Is64BitInstallMode; Flags: ignoreversion recursesubdirs createallsubdirs</span><br><span class="line">Source: &quot;&#123;#MyDistFolder&#125;\lib\x86\*&quot;; DestDir: &quot;&#123;app&#125;\lib\x86&quot;; Check: not Is64BitInstallMode; Flags: ignoreversion recursesubdirs createallsubdirs</span><br></pre></td></tr></table></figure>

<h3 id="5-有关安装-NET过程代码的其它解决方案"><a href="#5-有关安装-NET过程代码的其它解决方案" class="headerlink" title="5. 有关安装.NET过程代码的其它解决方案"></a>5. 有关安装.NET过程代码的其它解决方案</h3><p>如果不行实现InnoSetup中的AfterInstall的标识，希望.NET的安装在文件<strong>[Files]</strong>执行的某一步骤时被执行，就需要主意.NET的执行顺序。请参看如下两部分代码。</p>
<p>使用安装的返回值</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InstallFramework</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\dotNetFx40_Full_x86_x64.exe'</span>), <span class="string">'/q /norestart'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; you can interact with the user that the installation failed &#125;</span></span><br><span class="line">    MsgBox(<span class="string">'.NET installation failed with code: '</span> + IntToStr(ResultCode) + <span class="string">'.'</span>,</span><br><span class="line">      mbError, MB_OK);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>使用进度条显示安装进度，但是由于要获得.NET安装程序的安装进度并不容易，因此我将在安装执行过程中向用户简单显示无休止的选取框进度栏。 即，该进度条仅在此具用于显示，不能准确表示安装的进度。</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InstallFramework</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  StatusText: <span class="keyword">string</span>;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  StatusText := WizardForm.StatusLabel.Caption;</span><br><span class="line">  WizardForm.StatusLabel.Caption := <span class="string">'Installing .NET framework...'</span>;</span><br><span class="line">  WizardForm.ProgressGauge.Style := npbstMarquee;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\dotNetFx45_Full_asetup.exe'</span>), <span class="string">'/q /norestart'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// you can interact with the user that the installation failed</span></span><br><span class="line">    MsgBox(<span class="string">'.NET installation failed with code: '</span> + IntToStr(ResultCode) + <span class="string">'.'</span>,</span><br><span class="line">      mbError, MB_OK);</span><br><span class="line">    CancelWithoutPrompt := true;</span><br><span class="line">    WizardForm.Close;       </span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.StatusLabel.Caption := StatusText;</span><br><span class="line">    WizardForm.ProgressGauge.Style := npbstNormal;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-提示"><a href="#6-提示" class="headerlink" title="6. 提示"></a>6. 提示</h3><p>Inno 是具有一个内置变量{dotnet40}的，ExpandConstant(‘{dotnet40}’)。其它有关的变量为：</p>
<p><strong>{dotnet11}</strong></p>
<p>32-bit .NET Framework version 1.1 root directory.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 1.1 present.</p>
<p>32位.NET Framework 1.1版根目录。</p>
<p>会将系统扩展到当前的.NET Framework版本1.1会发生例外。</p>
<p><strong>{dotnet20}</strong></p>
<p>.NET Framework version 2.0-3.5 root directory. <code>{dotnet20}</code> is equivalent to <code>{dotnet2032}</code> unless the install is running in [64-bit install mode], in which case it is equivalent to <code>{dotnet2064}</code>.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 2.0-3.5 present.</p>
<p>.NET Framework 2.0-3.5版根目录。除非安装以64位安装模式运行，否则{dotnet20}等效于{dotnet2032}，在这种情况下，等效于{dotnet2064}。</p>
<p>会将系统扩展到当前的.NET Framework版本2.0-3.5将会发生例外。</p>
<p><strong>{dotnet2032}</strong></p>
<p>32-bit .NET Framework version 2.0-3.5 root directory.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 2.0-3.5 present.</p>
<p>32位.NET Framework 2.0-3.5版根目录。</p>
<p>会将系统扩展到当前的.NET Framework版本2.0-3.5将会发生例外。</p>
<p><strong>{dotnet2064}</strong></p>
<p>64-bit Windows only: 64-bit .NET Framework version 2.0-3.5 root directory.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 2.0-3.5 present.</p>
<p>仅适用于64位Windows：64位.NET Framework 2.0-3.5版根目录。</p>
<p>会将系统扩展到当前的.NET Framework版本2.0-3.5将会发生例外。</p>
<p><strong>{dotnet40}</strong></p>
<p>.NET Framework version 4.0 and later root directory. <code>{dotnet40}</code> is equivalent to <code>{dotnet4032}</code> unless the install is running in [64-bit install mode], in which case it is equivalent to <code>{dotnet4064}</code>.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 4.0 or later present.</p>
<p>.NET Framework 4.0版和更高版本的根目录。除非安装以64位安装模式运行，否则{dotnet40}等效于{dotnet4032}，在这种情况下，等效于{dotnet4064}。</p>
<p>将系统扩展到.NET Framework 4.0或更高版本时，将发生例外。</p>
<p><strong>{dotnet4032}</strong></p>
<p>32-bit .NET Framework version 4.0 and later root directory.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 4.0 or later present.</p>
<p>32位.NET Framework 4.0版和更高版本的根目录。</p>
<p>将系统扩展到.NET Framework 4.0或更高版本时，将发生例外。</p>
<p><strong>{dotnet4064}</strong></p>
<p>64-bit Windows only: 64-bit .NET Framework version 4.0 and later root directory.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 4.0 or later present.</p>
<p>仅适用于64位Windows：64位.NET Framework 4.0版和更高版本的根目录。</p>
<p>将系统扩展到.NET Framework 4.0或更高版本时，将发生例外。</p>
<h3 id="7-使用RegAsm-exe-注册-NET-DLL-文件"><a href="#7-使用RegAsm-exe-注册-NET-DLL-文件" class="headerlink" title="7. 使用RegAsm.exe 注册 .NET DLL 文件"></a>7. 使用RegAsm.exe 注册 .NET DLL 文件</h3><p>其中<strong>[run]</strong>的代码如下， 主意其WorkingDir参数，其表示运行注册程序的时候，运行的目录：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Filename: "&#123;dotnet20&#125;\RegAsm.exe"; Parameters: /codebase YourDLL.dll; WorkingDir: &#123;app&#125;; StatusMsg: "Registering Controls..."; Flags: runminimized</span><br></pre></td></tr></table></figure>

<h3 id="8-其它完整解决方案"><a href="#8-其它完整解决方案" class="headerlink" title="8. 其它完整解决方案"></a>8. 其它完整解决方案</h3><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Other parts of installer file go here</span></span><br><span class="line">[CustomMessages]</span><br><span class="line">IDP_DownloadFailed=Download <span class="keyword">of</span> .NET Framework <span class="number">4.7</span>.<span class="number">2</span> failed. .NET Framework <span class="number">4.7</span> <span class="keyword">is</span> required <span class="keyword">to</span> run VidCoder.</span><br><span class="line">IDP_RetryCancel=Click <span class="string">'Retry'</span> <span class="keyword">to</span> <span class="keyword">try</span> downloading the files again, <span class="keyword">or</span> click <span class="string">'Cancel'</span> <span class="keyword">to</span> terminate setup.</span><br><span class="line">InstallingDotNetFramework=Installing .NET Framework <span class="number">4.7</span>.<span class="number">2</span>. This might take a few minutes...</span><br><span class="line">DotNetFrameworkFailedToLaunch=Failed to launch .NET Framework Installer with error "%1". Please fix the error then run this installer again.</span><br><span class="line">DotNetFrameworkFailed1602=.NET Framework installation was cancelled. This installation can <span class="keyword">continue</span>, but be aware that this application may <span class="keyword">not</span> run unless the .NET Framework installation <span class="keyword">is</span> completed successfully.</span><br><span class="line">DotNetFrameworkFailed1603=A fatal error occurred <span class="keyword">while</span> installing the .NET Framework. Please fix the error, <span class="keyword">then</span> run the installer again.</span><br><span class="line">DotNetFrameworkFailed5100=Your computer does <span class="keyword">not</span> meet the requirements <span class="keyword">of</span> the .NET Framework. Please consult the documentation.</span><br><span class="line">DotNetFrameworkFailedOther=The .NET Framework installer exited with an unexpected status code "%1". Please review any other messages shown by the installer to determine whether the installation completed successfully, and abort this installation and fix the problem if it did not.</span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  requiresRestart: boolean;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NetFrameworkIsMissing</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  bSuccess: Boolean;</span><br><span class="line">  regVersion: Cardinal;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := True;</span><br><span class="line"></span><br><span class="line">  bSuccess := RegQueryDWordValue(HKLM, <span class="string">'Software\Microsoft\NET Framework Setup\NDP\v4\Full'</span>, <span class="string">'Release'</span>, regVersion);</span><br><span class="line">  <span class="keyword">if</span> (True = bSuccess) <span class="keyword">and</span> (regVersion &gt;= <span class="number">461308</span>) <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">    Result := False;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> NetFrameworkIsMissing() <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    idpAddFile(<span class="string">'http://go.microsoft.com/fwlink/?LinkId=863262'</span>, ExpandConstant(<span class="string">'&#123;tmp&#125;\NetFrameworkInstaller.exe'</span>));</span><br><span class="line">    idpDownloadAfter(wpReady);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFramework</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  StatusText: <span class="keyword">string</span>;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  StatusText := WizardForm.StatusLabel.Caption;</span><br><span class="line">  WizardForm.StatusLabel.Caption := CustomMessage(<span class="string">'InstallingDotNetFramework'</span>);</span><br><span class="line">  WizardForm.ProgressGauge.Style := npbstMarquee;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\NetFrameworkInstaller.exe'</span>), <span class="string">'/passive /norestart /showrmui /showfinalerror'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedToLaunch'</span>), [SysErrorMessage(resultCode)]);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      <span class="comment">// See https://msdn.microsoft.com/en-us/library/ee942965(v=vs.110).aspx#return_codes</span></span><br><span class="line">      <span class="keyword">case</span> resultCode <span class="keyword">of</span></span><br><span class="line">        <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// Successful</span></span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">          MsgBox(CustomMessage(<span class="string">'DotNetFrameworkFailed1602'</span>), mbInformation, MB_OK);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">          Result := CustomMessage(<span class="string">'DotNetFrameworkFailed1603'</span>);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">          requiresRestart := True;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">          requiresRestart := True;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">          Result := CustomMessage(<span class="string">'DotNetFrameworkFailed5100'</span>);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">          MsgBox(FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedOther'</span>), [IntToStr(resultCode)]), mbError, MB_OK);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">      <span class="keyword">end</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.StatusLabel.Caption := StatusText;</span><br><span class="line">    WizardForm.ProgressGauge.Style := npbstNormal;</span><br><span class="line"></span><br><span class="line">    DeleteFile(ExpandConstant(<span class="string">'&#123;tmp&#125;\NetFrameworkInstaller.exe'</span>));</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PrepareToInstall</span><span class="params">(<span class="keyword">var</span> NeedsRestart: Boolean)</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// 'NeedsRestart' only has an effect if we return a non-empty string, thus aborting the installation.</span></span><br><span class="line">  <span class="comment">// If the installers indicate that they want a restart, this should be done at the end of installation.</span></span><br><span class="line">  <span class="comment">// Therefore we set the global 'restartRequired' if a restart is needed, and return this from NeedRestart()</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> NetFrameworkIsMissing() <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    Result := InstallFramework();</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NeedRestart</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := requiresRestart;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>根据此版本修改后适用于自己项目的.NET框架安装代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFrameworkWebRuntime</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WasVisible: Boolean;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkWebInstaller&#125;'</span>);</span><br><span class="line">  WasVisible := WizardForm.PreparingLabel.Visible;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      WizardForm.PreparingLabel.Visible := True;</span><br><span class="line">      WizardForm.PreparingLabel.Caption := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkWebInstallerCaption'</span>), [TO_COMPARE_DOT_NET]);</span><br><span class="line">      ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkWebInstaller&#125;'</span>);</span><br><span class="line">      <span class="comment">//if not Exec(ExpandConstant('&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;'), '/q /norestart', '', SW_SHOW, ewWaitUntilTerminated, ResultCode) then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;'</span>), <span class="string">'/passive /norestart /showrmui /showfinalerror'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-</span></span><br><span class="line">          <span class="comment">// you can interact with the user that the installation failed, for example: error code 2: the system cannot find the file specified.</span></span><br><span class="line">          Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedToLaunch'</span>), [SysErrorMessage(ResultCode)])     </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">case</span> ResultCode <span class="keyword">of</span></span><br><span class="line">            <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">// Successful</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">              MsgBox(CustomMessage(<span class="string">'DotNetFrameworkFailed1602'</span>), mbInformation, MB_OK);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed1603'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed5100'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">//MsgBox(FmtMessage(CustomMessage('DotNetFrameworkFailedOther'), [IntToStr(resultCode)]), mbError, MB_OK);</span></span><br><span class="line">              Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedOther'</span>), IntToStr(ResultCode));     </span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">          <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.PreparingLabel.Visible := WasVisible;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  DeleteFile(ExpandConstant(<span class="string">'&#123;tmp&#125;&#123;#DotNetFrameWorkWebInstaller&#125;'</span>));</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>上述代码中</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkWebInstaller&#125;'</span>);</span><br></pre></td></tr></table></figure>

<p>强制解压安装文件。该动作早于[Files]的运行。在安装结束之后删除该文件，使用代码如：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DeleteFile(ExpandConstant(<span class="string">'&#123;tmp&#125;&#123;#DotNetFrameWorkWebInstaller&#125;'</span>));</span><br></pre></td></tr></table></figure>

<p>有关.NET安装包运行时的错误代码可以参考连接：</p>
<p>// See <a href="https://msdn.microsoft.com/en-us/library/ee942965%28v=vs.110%29.aspx#return_codes" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/ee942965(v=vs.110).aspx#return_codes</a></p>
<p>有关Exec函数，其错误代码为Windows系统错误代码，运行时的错误文本，可以参考连接：</p>
<p>// See [<a href="https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-]" target="_blank" rel="noopener">https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-]</a>(</p>
<h3 id="9-Inno-Setup-对注册表的操作"><a href="#9-Inno-Setup-对注册表的操作" class="headerlink" title="9. Inno Setup 对注册表的操作"></a>9. Inno Setup 对注册表的操作</h3><p>由于安装.NET的框架的目的就是要使用一下依赖.NET框架的动态库文件。而这部分DLL文件能够顺利使用就需要对该DLL文件进行注册。</p>
<h4 id="9-1-Regasm-程序集注册工具"><a href="#9-1-Regasm-程序集注册工具" class="headerlink" title="9.1 Regasm  程序集注册工具"></a>9.1 Regasm  程序集注册工具</h4><p><strong>Regasm 简介 ：</strong></p>
<p>EXE files such as RegAsm.exe are categorized as Executable Application (Windows Executable) files. As a Windows Executable file, it was created for use in Windows 10 by [Microsoft].</p>
<p>像RegAsm.exe这样的EXE文件都被分类为可执行应用程序（Windows Executable）文件。 作为Windows可执行文件，它由Microsoft创建供Windows 10使用。</p>
<p>The first version of RegAsm.exe for Windows Vista was introduced on 11/08/2006 in Windows Vista. The most recent version [file version 10] was introduced on 07/29/2015 for Windows 10. RegAsm.exe is bundled with the software package in Windows 10, Windows 8.1, and Windows 8.</p>
<p>Windows Vista的RegAsm.exe的第一版于2006年11月8日在Windows Vista中引入。 Windows 10的最新版本（文件版本10）已于07/29/2015引入。RegAsm.exe与Windows 10，Windows 8.1和Windows 8中的软件包捆绑在一起。</p>
<p>Please see below for more detailed information, <a href="https://www.exefiles.com/en/extensions/exe/all-files/" target="_blank" rel="noopener">EXE</a> file troubleshooting instructions, and free downloads of different versions of RegAsm.exe.</p>
<p>请参阅下面的详细信息，EXE文件故障排除说明以及RegAsm.exe不同版本的免费下载。</p>
<p><strong>作用：</strong> 读取程序集中的元数据，并将所需的项添加到注册表中。注册表允许 COM 客户程序以透明方式创建 .NET Framework 类。类一经注册，任何 COM 客户程序都可以使用它，就好像该类是一个 COM 类。类仅在安装程序集时注册一次。程序集中的类实例直到被实际注册时，才能从 COM 中创建。</p>
<p><strong>使用方法：</strong></p>
<p>regasm assemblyFile [options]</p>
<p><strong>重要参数：</strong></p>
<p>/codebase 在注册表中创建一个 Codebase 项。Codebase 项指定未安装到全局程序集缓存中的程序集的文件路径。如果随后要安装正在注册到全局程序集缓存中的程序集，则不应指定此选项。用 /codebase 选项指定的 assemblyFile 参数必须是具有强名称的程序集。</p>
<h4 id="9-2-Regsvr32-程序集注册工具"><a href="#9-2-Regsvr32-程序集注册工具" class="headerlink" title="9.2 Regsvr32  程序集注册工具"></a>9.2 Regsvr32  程序集注册工具</h4><p><strong>作用：</strong> Regsvr32命令用于注册COM组件，是 Windows 系统提供的用来向系统注册控件或者卸载控件的命令，以命令行方式运行。WinXP及以上系统的regsvr32.exe在windows\system32文件夹下；2000系统的regsvr32.exe在winnt\system32文件夹下。</p>
<h4 id="9-3-两个DLL注册工具的差异"><a href="#9-3-两个DLL注册工具的差异" class="headerlink" title="9.3 两个DLL注册工具的差异"></a>9.3 两个DLL注册工具的差异</h4><p>使用regasm.exe来注册.NET 组件，regsvr32并不适用于.NET组件。 （或者您也可以将regasm.exe理解为.NET的regsvr32）。regsvr32不适用于.NET的组件的注册，感觉意思是对于非托管的代码使用regsvr32来注册，对于托管的代码使用regasm来注册。</p>
<p><code>regsvr32</code> will load the library and try to call the <code>DllRegisterServer()</code> from that library. It doesn’t care what <code>DllRegisterServer()</code> actually does - it just calls that function and checks the returned value. You use it to register COM servers in unmanaged DLLs. It can’t generate a .tlb file.</p>
<p>regsvr32将加载该库并尝试从该库中调用DllRegisterServer（）。 不管DllRegisterServer（）实际做什么，它只是调用该函数并检查返回的值。 您可以使用它在非托管DLL中注册COM服务器。 无法生成.tlb文件。</p>
<p><code>regasm</code> will register a COM-exposed .NET assembly as a COM server. You use it for .NET assemblies. It can generate a .tlb file given the assembly only - it inspects the type infromation stored in the assembly and includes the COM-exposed entities into the type library.</p>
<p>regasm将把暴露于COM的.NET程序集注册为COM服务器。 您将其用于.NET程序集。 仅在给定程序集的情况下，它可以生成.tlb文件-它检查存储在程序集中的类型信息，并将COM公开的实体包括到类型库中。</p>
<h4 id="9-4-NET中“托管代码”和“非托管代码”的区别"><a href="#9-4-NET中“托管代码”和“非托管代码”的区别" class="headerlink" title="9.4  .NET中“托管代码”和“非托管代码”的区别"></a>9.4  .NET中“托管代码”和“非托管代码”的区别</h4><p><strong>托管代码</strong> <strong>(managed code)</strong></p>
<p>托管代码是Visual Basic .NET和C#编译器创建的代码。它运行在CLR(公共语言运行时)，除其他外，它提供像垃圾收集，运行时类型检查和引用检查的服务。所以，认为它是，“我的代码是由CLR管理。</p>
<p>Visual Basic和C#只能生成托管代码，所以，如果你正在用这些语言编写一个应用程序，你正在写一个由CLR管理的应用程序。如果您在Visual C .NET中编写应用程序，您可以根据需要生成托管代码，但它是可选的。</p>
<p><strong>非托管代码</strong> <strong>(unmanaged code)</strong></p>
<p>非托管代码直接编译为机器代码。因此，通过该定义，所有由传统C/C++编译器编译的代码是“非托管代码”。此外，由于它编译为机器代码而不是中间语言，所以它是不可移植的。</p>
<p>没有可用的内存管理或任何其他CLR提供。</p>
<p>由于您不能使用Visual Basic或C#创建非托管代码，在Visual Studio中，所有非托管代码都用C/C++编写。</p>
<p><strong>混合两者</strong></p>
<p>由于Visual C可以编译为托管代码或非托管代码，因此可以在同一个应用程序中混合这两个代码。这模糊了两者之间的界限，并使定义复杂化，但值得一提的是，你知道，如果你使用的第三方库有一些严重的非托管代码，你仍然可能有内存泄漏。</p>
<p><strong>区别：</strong></p>
<p>1、托管代码是一种中间语言，运行在CLR上；</p>
<p> 非托管代码被编译为机器码，运行在机器上。</p>
<p>2、托管代码独立于平台和语言，能更好的实现不同语言平台之间的兼容；</p>
<p> 非托管代码依赖于平台和语言。</p>
<p>3、托管代码可享受CLR提供的服务（如安全检测、垃圾回收等），不需要自己完成这些操作；</p>
<p> 非托管代码需要自己提供安全检测、垃圾回收等操作。</p>
<p>托管代码就意味着托管数据？答案是否定的。</p>
<p>对于Visual Basic和C#来说，生活是简单的，因为你没有其它选择。当你在那些语言里面声明一个类，那么这个类的实例会在托管堆中被创建，垃圾收集器(GC)会帮我们管理这些对象的回收。但是在Visual C++中，你有另一个选择。即使你正创建一个托管程序，你可以决定哪些类是托管类型，哪些类是非托管类型的。</p>
<p>这就是非托管类型：</p>
<p>class Foo { private: int x; public: Foo(): x(0){} Foo(int xx): x(xx) {} };</p>
<p>这就是托管类型</p>
<p>__gc class Bar { private: int x; public: Bar(): x(0){} Bar(int xx): x(xx) {} };</p>
<p>他们唯一的区别就是类Bar的定义中有__gc关键字。这个关键字会给代码带来巨大的区别。</p>
<h4 id="9-5-使用Inno-Setup的-Registry-段注册-NET相关DLL文件"><a href="#9-5-使用Inno-Setup的-Registry-段注册-NET相关DLL文件" class="headerlink" title="9.5 使用Inno Setup的 [Registry] 段注册.NET相关DLL文件"></a>9.5 使用Inno Setup的 [Registry] 段注册.NET相关DLL文件</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[Registry]</span><br><span class="line">; ProgID part, TechTemp</span><br><span class="line">Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletekeyifempty</span><br><span class="line">Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID"; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID"; ValueType: string; ValueName: ""; ValueData: "&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part, TechTemp </span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; Flags: uninsdeletekeyifempty</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; ValueType: string; ValueName: ""; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part\InprocServer32, TechTemp</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: ""; ValueData: "mscoree.dll"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "ThreadingModel"; ValueData: "Both"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "Class"; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "Assembly"; ValueData: "xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "RuntimeVersion"; ValueData: "v4.0.30319"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "CodeBase"; ValueData: "file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll"; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part\InprocServer32\<span class="number">1.0</span>.<span class="number">0.0</span>, TechTemp</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "Class"; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "Assembly"; ValueData: "xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "RuntimeVersion"; ValueData: "v4.0.30319"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "CodeBase"; ValueData: "file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll"; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part\Implemented Categories, TechTemp</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories"; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories\&#123;&#123;&#123;#DotNetDllCLSIDImplementedCategories&#125;&#125;"; Flags: uninsdeletekey</span><br><span class="line">; CLSID Part\ProgId, TechTemp</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId"; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId"; ValueType: string; ValueName: ""; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br></pre></td></tr></table></figure>

<h3 id="10-项目完整代码，最小测试版"><a href="#10-项目完整代码，最小测试版" class="headerlink" title="10. 项目完整代码，最小测试版"></a>10. 项目完整代码，最小测试版</h3><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br></pre></td><td class="code"><pre><span class="line">; -- Example1.iss --</span><br><span class="line">; Demonstrates copying <span class="number">3</span> files <span class="keyword">and</span> creating an icon.</span><br><span class="line"></span><br><span class="line">; SEE THE DOCUMENTATION <span class="keyword">FOR</span> DETAILS <span class="keyword">ON</span> CREATING .ISS SCRIPT FILES!</span><br><span class="line"></span><br><span class="line">#define ********AppPath</span><br><span class="line">#expr ********AppPath = "\********\trunk\hcnt\wire\"</span><br><span class="line"></span><br><span class="line">#define DotNetRegistToolPath</span><br><span class="line">#expr DotNetRegistToolPath = ""</span><br><span class="line"></span><br><span class="line">#define DotNetFrameWorkInstallerPath</span><br><span class="line">#expr DotNetFrameWorkInstallerPath = "..\NET\NET_Framework_Runtime\462\"</span><br><span class="line"></span><br><span class="line">#define DotNet4OCTechTemplDllPath</span><br><span class="line">#expr DotNet4OCTechTemplDllPath = "..\helper\xxxxxxxxxxxxxxxxxxx"</span><br><span class="line"></span><br><span class="line">#define DotNetFrameWorkOfflineInstaller</span><br><span class="line">#expr DotNetFrameWorkOfflineInstaller = "ndp48-x86-x64-allos-enu.exe"</span><br><span class="line"></span><br><span class="line">#define DotNetFrameWorkWebInstaller</span><br><span class="line">#expr DotNetFrameWorkWebInstaller = "ndp48-web.exe"</span><br><span class="line"></span><br><span class="line">;#define DotNetDllCLSID</span><br><span class="line">;#expr DotNetDllCLSID = "62519924-26A8-3770-9F82-0A0BC26EE7D4"</span><br><span class="line"></span><br><span class="line">;#define DotNetDllCLSIDImplementedCategories</span><br><span class="line">;#expr DotNetDllCLSIDImplementedCategories = "62C8FE65-4EBB-45E7-B440-6E39B2CDBF29"</span><br><span class="line"></span><br><span class="line">;#define AppPathBackSlash</span><br><span class="line">;#expr AppPathBackSlash = "********/trunk/hcnt/wire"</span><br><span class="line"></span><br><span class="line">;#define CommonappdataPathBackSlash</span><br><span class="line">;#expr CommonappdataPathBackSlash = "C:/ProgramData"</span><br><span class="line"></span><br><span class="line">[Setup]</span><br><span class="line">;SignTool=MyCustom sign /a /tr http:<span class="comment">//sha256timestamp.ws.symantec.com/sha256/timestamp /d $q******** for SolidWorks 2020 Beta3$q $f</span></span><br><span class="line">PrivilegesRequired=admin </span><br><span class="line">AppName=My <span class="keyword">Program</span></span><br><span class="line">AppVersion=<span class="number">1.5</span></span><br><span class="line">WizardStyle=modern</span><br><span class="line">DefaultDirName=<span class="comment">&#123;autopf&#125;</span>\My <span class="keyword">Program</span></span><br><span class="line">DefaultGroupName=My <span class="keyword">Program</span></span><br><span class="line">UninstallDisplayIcon=<span class="comment">&#123;app&#125;</span>\MyProg.exe</span><br><span class="line">Compression=lzma2</span><br><span class="line">SolidCompression=yes</span><br><span class="line">OutputDir=userdocs:Inno Setup Examples Output</span><br><span class="line">ArchitecturesInstallIn64BitMode = x64</span><br><span class="line">ArchitecturesAllowed = x64</span><br><span class="line">SetupLogging=yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Languages]</span><br><span class="line"><span class="keyword">Name</span>: ENGLISH; MessagesFile: compiler:<span class="keyword">Default</span>.isl</span><br><span class="line"><span class="keyword">Name</span>: DEUTSCH; MessagesFile: compiler:Languages\German.isl; </span><br><span class="line"></span><br><span class="line">[Files]</span><br><span class="line">; .NET Part</span><br><span class="line">; .NET Framework Runtime, offline installer english all os runtime </span><br><span class="line">Source: "&#123;#DotNetFrameWorkInstallerPath&#125;&#123;#DotNetFrameWorkOfflineInstaller&#125;"; DestDir: "&#123;tmp&#125;"; Flags: dontcopy noencryption;</span><br><span class="line">; .NET Framework Runtime, web installer <span class="keyword">for</span> other languages</span><br><span class="line">Source: "&#123;#DotNetFrameWorkInstallerPath&#125;&#123;#DotNetFrameWorkWebInstaller&#125;"; DestDir: "&#123;tmp&#125;"; Flags: dontcopy noencryption;</span><br><span class="line">; xxxxxxxxxxxxxxxxxxx.dll + Hilfsdlls</span><br><span class="line">Source: "&#123;#DotNet4OCTechTemplDllPath&#125;\*.*"; DestDir: "&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\"; Flags: ignoreversion recursesubdirs; Permissions: everyone-full;</span><br><span class="line"></span><br><span class="line">Source: "MyProg.exe"; DestDir: "&#123;app&#125;"</span><br><span class="line">Source: "MyProg.chm"; DestDir: "&#123;app&#125;"</span><br><span class="line">Source: "Readme.txt"; DestDir: "&#123;app&#125;"; Flags: isreadme</span><br><span class="line"></span><br><span class="line">[Run]</span><br><span class="line">; Regist the .NET DLL <span class="keyword">file</span> by using the tool regasm.exe, return <span class="number">0</span>: ERROR_SUCCESS; <span class="number">1</span>:ERROR_INVALID_FUNCTION; <span class="number">2</span>:ERROR_FILE_NOT_FOUND; <span class="number">3</span>: ERROR_PATH_NOT_FOUND  </span><br><span class="line">Filename:  &#123;code:GetCurrentRegAsmPath|&#123;#DotNetRegistToolPath&#125;&#125;\regasm.exe; Parameters: " ""&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\xxxxxxxxxxxxxxxxxxx.dll"" /codebase /verbose"; WorkingDir: "&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\"; StatusMsg: Registering DLLs; Flags: 64bit runhidden waituntilterminated;</span><br><span class="line"></span><br><span class="line">[UninstallRun]</span><br><span class="line">; Regist the .NET DLL <span class="keyword">file</span> by using the tool regasm.exe, return <span class="number">0</span>: ERROR_SUCCESS; <span class="number">1</span>:ERROR_INVALID_FUNCTION; <span class="number">2</span>:ERROR_FILE_NOT_FOUND; <span class="number">3</span>: ERROR_PATH_NOT_FOUND  </span><br><span class="line">Filename:  &#123;code:GetCurrentRegAsmPath|&#123;#DotNetRegistToolPath&#125;&#125;\regasm.exe; Parameters: "/unregister ""&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\xxxxxxxxxxxxxxxxxxx.dll"" /codebase /verbose"; WorkingDir: "&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\"; StatusMsg: Unregistering DLLs; Flags: 64bit runhidden waituntilterminated;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[CustomMessages]</span><br><span class="line">; .NET Framwork installation processing </span><br><span class="line">ENGLISH.DotNetFrameworkOfflineInstallerCaption = Installing Microsoft .NET framework %<span class="number">1</span> offline installer <span class="keyword">for</span> Windows...</span><br><span class="line">ENGLISH.DotNetFrameworkWebInstallerCaption = Installing Microsoft .NET framework %<span class="number">1</span> Web installer <span class="keyword">for</span> Windows...</span><br><span class="line">ENGLISH.DotNetFrameworkFailedToLaunch = .NET installation failed <span class="keyword">with</span> code: %<span class="number">1</span>. Please fix the error <span class="keyword">then</span> run this installer again.</span><br><span class="line">ENGLISH.DotNetFrameworkFailed1602 = .NET Framework installation was cancelled. This installation can <span class="keyword">continue</span>, but be aware that this application may <span class="keyword">not</span> run unless the .NET Framework installation <span class="keyword">is</span> completed successfully.</span><br><span class="line">ENGLISH.DotNetFrameworkFailed1603 = A fatal error occurred <span class="keyword">while</span> installing the .NET Framework. Please fix the error, <span class="keyword">then</span> run the installer again.</span><br><span class="line">ENGLISH.DotNetFrameworkFailed5100 = Your computer does <span class="keyword">not</span> meet the requirements <span class="keyword">of</span> the .NET Framework. Please consult the documentation.</span><br><span class="line">ENGLISH.DotNetFrameworkFailedOther = The .NET Framework installer exited with an unexpected status code "%1". Please review any other messages shown by the installer to determine whether the installation completed successfully, and abort this installation and fix the problem if it did not.</span><br><span class="line"></span><br><span class="line">; .NET Framwork installation processing </span><br><span class="line">DEUTSCH.DotNetFrameworkOfflineInstallerCaption = Installation von Microsoft .NET Framework %<span class="number">1</span> offline Installationsprogramm für Windows ...</span><br><span class="line">DEUTSCH.DotNetFrameworkWebInstallerCaption = Installation von Microsoft .NET Framework %<span class="number">1</span> Web Installationsprogramm für Windows ...</span><br><span class="line">DEUTSCH.DotNetFrameworkFailedToLaunch = .NET Installation fehlgeschlagen mit Code: %<span class="number">1</span>. Bitte beheben Sie den Fehler und führen Sie das Installationsprogramm erneut aus.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailed1602 = .NET Framework-Installation wurde abgebrochen. Diese Installation kann fortgesetzt werden. Beachten Sie jedoch, dass diese Anwendung möglicherweise erst ausgeführt wird, wenn die .NET Framework-Installation erfolgreich abgeschlossen wurde.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailed1603 = Bei der Installation von .NET Framework ist ein schwerwiegender Fehler aufgetreten. Bitte beheben Sie den Fehler und führen Sie das Installationsprogramm erneut aus.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailed5100 = Ihr Computer entspricht nicht den Anforderungen von .NET Framework. Bitte konsultieren Sie die Dokumentation.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailedOther = Das .NET Framework-Installationsprogramm wurde mit dem unerwarteten Statuscode "%1" beendet. Überprüfen Sie alle anderen vom Installationsprogramm angezeigten Meldungen, um festzustellen, ob die Installation erfolgreich abgeschlossen wurde, und brechen Sie diese Installation ab, und beheben Sie das Problem, wenn dies nicht der Fall ist.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;; Please <span class="keyword">do</span> <span class="keyword">not</span> delete the following, you can use it <span class="keyword">to</span> check the resgition <span class="keyword">of</span> the .NET DLL xxxxxxxxxxxxxxxxxxx.dll </span><br><span class="line">;; ProgID part, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletekeyifempty</span><br><span class="line">;Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID"; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID"; ValueType: string; ValueName: ""; ValueData: "&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part, TechTemp </span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; Flags: uninsdeletekeyifempty</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; ValueType: string; ValueName: ""; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part\InprocServer32, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: ""; ValueData: "mscoree.dll"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "ThreadingModel"; ValueData: "Both"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "Class"; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "Assembly"; ValueData: "xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "RuntimeVersion"; ValueData: "v4.0.30319"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "CodeBase"; ValueData: "file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll"; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part\InprocServer32\<span class="number">1.0</span>.<span class="number">0.0</span>, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "Class"; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "Assembly"; ValueData: "xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "RuntimeVersion"; ValueData: "v4.0.30319"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "CodeBase"; ValueData: "file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll"; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part\Implemented Categories, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories"; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories\&#123;&#123;&#123;#DotNetDllCLSIDImplementedCategories&#125;&#125;"; Flags: uninsdeletekey</span><br><span class="line">;; CLSID Part\ProgId, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId"; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId"; ValueType: string; ValueName: ""; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line"></span><br><span class="line">[Icons]</span><br><span class="line">Name: "&#123;group&#125;\My Program"; Filename: "&#123;app&#125;\MyProg.exe"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"><span class="keyword">const</span> TO_COMPARE_DOT_NET = <span class="string">'v4.6.2'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bCancelWithoutPrompt: boolean;</span><br><span class="line">    bConnectWithNetwork: boolean;</span><br><span class="line">    bRequiresRestart: boolean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetCurrentRegAsmPath</span><span class="params">(S: <span class="keyword">String</span>)</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span> version: <span class="keyword">String</span>;</span><br><span class="line">    key: <span class="keyword">String</span>;</span><br><span class="line">    installPath: <span class="keyword">String</span>;</span><br><span class="line">    success: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    Result := S;</span><br><span class="line">    <span class="comment">// .NET 4.6.2 installs also as update to .NET 4.0 Full, you can also be on the safe side, check the windows 10 anniversary update</span></span><br><span class="line">    <span class="comment">// if the build was newer than (build 10.0.14393) with the code GetWindowsVersion &gt;= $A003839</span></span><br><span class="line">    <span class="keyword">if</span> TO_COMPARE_DOT_NET = <span class="string">'v4.6.2'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">'v4\Full'</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">    <span class="comment">// .NET 4.5 installs as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">if</span> TO_COMPARE_DOT_NET = <span class="string">'v4.5'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">'v4\Full'</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">'SOFTWARE\Microsoft\NET Framework Setup\NDP\'</span> + version;</span><br><span class="line">    success := RegQueryStringValue(HKLM, key, <span class="string">'InstallPath'</span>, installPath);</span><br><span class="line">    <span class="keyword">if</span> (success = True) <span class="keyword">and</span> (S = <span class="string">''</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      Result := installPath;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFrameworkWebRuntime</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WasVisible: Boolean;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkWebInstaller&#125;'</span>);</span><br><span class="line">  WasVisible := WizardForm.PreparingLabel.Visible;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      WizardForm.PreparingLabel.Visible := True;</span><br><span class="line">      WizardForm.PreparingLabel.Caption := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkWebInstallerCaption'</span>), [TO_COMPARE_DOT_NET]);</span><br><span class="line">      ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkWebInstaller&#125;'</span>);</span><br><span class="line">      <span class="comment">//if not Exec(ExpandConstant('&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;'), '/q /norestart', '', SW_SHOW, ewWaitUntilTerminated, ResultCode) then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;'</span>), <span class="string">'/passive /norestart /showrmui /showfinalerror'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-</span></span><br><span class="line">          <span class="comment">// you can interact with the user that the installation failed, for example: error code 2: the system cannot find the file specified.</span></span><br><span class="line">          Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedToLaunch'</span>), [SysErrorMessage(ResultCode)])     </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">case</span> ResultCode <span class="keyword">of</span></span><br><span class="line">            <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">// Successful</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">              MsgBox(CustomMessage(<span class="string">'DotNetFrameworkFailed1602'</span>), mbInformation, MB_OK);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed1603'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed5100'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">//MsgBox(FmtMessage(CustomMessage('DotNetFrameworkFailedOther'), [IntToStr(resultCode)]), mbError, MB_OK);</span></span><br><span class="line">              Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedOther'</span>), IntToStr(ResultCode));     </span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">          <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.PreparingLabel.Visible := WasVisible;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  DeleteFile(ExpandConstant(<span class="string">'&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;'</span>));</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFrameworkOfflineRuntime</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WasVisible: Boolean;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  WasVisible := WizardForm.PreparingLabel.Visible;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      WizardForm.PreparingLabel.Visible := True;</span><br><span class="line">      WizardForm.PreparingLabel.Caption := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkOfflineInstallerCaption'</span>), [TO_COMPARE_DOT_NET]);</span><br><span class="line">      ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkOfflineInstaller&#125;'</span>);</span><br><span class="line">      <span class="comment">//if not Exec(ExpandConstant('&#123;tmp&#125;\&#123;#DotNetFrameWorkOfflineInstaller&#125;'), '/q /norestart', '', SW_SHOW, ewWaitUntilTerminated, ResultCode) then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\&#123;#DotNetFrameWorkOfflineInstaller&#125;'</span>), <span class="string">'/passive /norestart /showrmui /showfinalerror'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-</span></span><br><span class="line">          <span class="comment">// you can interact with the user that the installation failed, for example: error code 2: the system cannot find the file specified.</span></span><br><span class="line">          Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedToLaunch'</span>), [SysErrorMessage(ResultCode)])     </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">case</span> ResultCode <span class="keyword">of</span></span><br><span class="line">            <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">// Successful</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">              MsgBox(CustomMessage(<span class="string">'DotNetFrameworkFailed1602'</span>), mbInformation, MB_OK);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed1603'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed5100'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">//MsgBox(FmtMessage(CustomMessage('DotNetFrameworkFailedOther'), [IntToStr(resultCode)]), mbError, MB_OK);</span></span><br><span class="line">              Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedOther'</span>), IntToStr(ResultCode));</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">          <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.PreparingLabel.Visible := WasVisible;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  DeleteFile(ExpandConstant(<span class="string">'&#123;tmp&#125;\&#123;#DotNetFrameWorkOfflineInstaller&#125;'</span>));</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsNetWorkActivatedTried</span>:</span> boolean;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WinHttpReq: Variant;</span><br><span class="line">  Connected: Boolean;</span><br><span class="line">  iTriedTime: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Connected := False;</span><br><span class="line">  iTriedTime := <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">repeat</span></span><br><span class="line">    iTriedTime := iTriedTime + <span class="number">1</span>;</span><br><span class="line">    Log(<span class="string">'Checking connection to the server, try '</span> +  + IntToStr(iTriedTime) + <span class="string">' time.'</span>);</span><br><span class="line">    <span class="keyword">try</span> </span><br><span class="line">      WinHttpReq := CreateOleObject(<span class="string">'WinHttp.WinHttpRequest.5.1'</span>);</span><br><span class="line">      WinHttpReq.SetTimeouts(<span class="string">'3000'</span>, <span class="string">'3000'</span>, <span class="string">'3000'</span>, <span class="string">'3000'</span>);</span><br><span class="line">      <span class="comment">// Use your real server host name </span></span><br><span class="line">      WinHttpReq.Open(<span class="string">'GET'</span>, <span class="string">'https://www.camtek.de/'</span>, False);</span><br><span class="line">      WinHttpReq.Send(<span class="string">''</span>);</span><br><span class="line">      Log(<span class="string">'Connected to the server; status: '</span> + IntToStr(WinHttpReq.Status) + <span class="string">' '</span> +</span><br><span class="line">          WinHttpReq.StatusText);</span><br><span class="line">      Connected := True;</span><br><span class="line">    <span class="keyword">except</span></span><br><span class="line">      Log(<span class="string">'Error connecting to the server, msg: '</span> + GetExceptionMessage + <span class="string">'try again! '</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">until</span> (iTriedTime = <span class="number">3</span>) <span class="keyword">or</span> (Connected = True) ;</span><br><span class="line">  Result := Connected;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsDotNetDetected</span><span class="params">(version: <span class="keyword">string</span>; service: cardinal)</span>:</span> boolean;</span><br><span class="line"><span class="comment">// Indicates whether the specified version and service pack of the .NET Framework is installed.</span></span><br><span class="line"><span class="comment">// see the link: https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed?redirectedfrom=MSDN#net_b</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// version -- Specify one of these strings for the required .NET Framework version:</span></span><br><span class="line"><span class="comment">//    'v1.1.4322'     .NET Framework 1.1</span></span><br><span class="line"><span class="comment">//    'v2.0.50727'    .NET Framework 2.0</span></span><br><span class="line"><span class="comment">//    'v3.0'          .NET Framework 3.0</span></span><br><span class="line"><span class="comment">//    'v3.5'          .NET Framework 3.5</span></span><br><span class="line"><span class="comment">//    'v4\Client'     .NET Framework 4.0 Client Profile</span></span><br><span class="line"><span class="comment">//    'v4\Full'       .NET Framework 4.0 Full Installation</span></span><br><span class="line"><span class="comment">//    'v4.5'          .NET Framework 4.5 378389</span></span><br><span class="line"><span class="comment">//    'v4.6'          .NET Framework 4.6 393295</span></span><br><span class="line"><span class="comment">//    'v4.6.1'        .NET Framework 4.6.1 394254</span></span><br><span class="line"><span class="comment">//    'v4.6.2'        .NET Framework 4.6.2 394802</span></span><br><span class="line"><span class="comment">//    'v4.7'          .NET Framework 4.7 393295</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// service -- Specify any non-negative integer for the required service pack level:</span></span><br><span class="line"><span class="comment">//    0               No service packs required</span></span><br><span class="line"><span class="comment">//    1, 2, etc.      Service pack 1, 2, etc. required</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    key: <span class="keyword">string</span>;</span><br><span class="line">    install, release, serviceCount: cardinal;</span><br><span class="line">    check45, check462, success: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.6.2 installs also as update to .NET 4.0 Full, you can also be on the safe side, check the windows 10 anniversary update</span></span><br><span class="line">    <span class="comment">// if the build was newer than (build 10.0.14393) with the code GetWindowsVersion &gt;= $A003839</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">'v4.6.2'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">'v4\Full'</span>;</span><br><span class="line">        check462 := true;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        check462 := false;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 installs as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">'v4.5'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">'v4\Full'</span>;</span><br><span class="line">        check45 := true;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        check45 := false;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">'SOFTWARE\Microsoft\NET Framework Setup\NDP\'</span> + version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 3.0 uses value InstallSuccess in subkey Setup</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v3.0'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key + <span class="string">'\Setup'</span>, <span class="string">'InstallSuccess'</span>, install);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key, <span class="string">'Install'</span>, install);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.0/4.5 uses value Servicing instead of SP</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v4'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Servicing'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'SP'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 uses additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> check45 <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Release'</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= <span class="number">378389</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.6.2 uses additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> check462 <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Release'</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= <span class="number">394802</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    Result := success <span class="keyword">and</span> (install = <span class="number">1</span>) <span class="keyword">and</span> (serviceCount &gt;= service);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsRequiredDotNetDetected</span>:</span> Boolean;  </span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    Result := IsDotNetDetected(TO_COMPARE_DOT_NET, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallDotNetOfflineRuntime</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bConnectWithNetwork <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        Result := True;</span><br><span class="line">      <span class="keyword">end</span> </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> ActiveLanguage = <span class="string">'ENGLISH'</span> <span class="keyword">then</span></span><br><span class="line">          <span class="keyword">begin</span></span><br><span class="line">             Result := True;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">          <span class="keyword">begin</span></span><br><span class="line">            Result := False;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallDotNetWebRuntime</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> bConnectWithNetwork) <span class="keyword">and</span> ( <span class="keyword">not</span> ActiveLanguage = <span class="string">'ENGLISH'</span>) <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        Result := True;</span><br><span class="line">      <span class="keyword">end</span> </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        Result := False;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InitializeSetup</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    bConnectWithNetwork := IsNetWorkActivatedTried;</span><br><span class="line">    Result := True;</span><br><span class="line"><span class="keyword">end</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PrepareToInstall</span><span class="params">(<span class="keyword">var</span> NeedsRestart: Boolean)</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span> bInstallWeb: boolean;</span><br><span class="line">    bInstallStd: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// 'NeedsRestart' only has an effect if we return a non-empty string, thus aborting the installation.</span></span><br><span class="line">  <span class="comment">// If the installers indicate that they want a restart, this should be done at the end of installation.</span></span><br><span class="line">  <span class="comment">// Therefore we set the global 'restartRequired' if a restart is needed, and return this from NeedRestart()</span></span><br><span class="line">  bCancelWithoutPrompt := false;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> IsRequiredDotNetDetected <span class="keyword">then</span> </span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      bInstallWeb := InstallDotNetWebRuntime;</span><br><span class="line">      bInstallStd := InstallDotNetOfflineRuntime;</span><br><span class="line">      <span class="keyword">if</span> ( bInstallWeb = True) <span class="keyword">then</span> </span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          Result := InstallFrameworkWebRuntime</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( bInstallStd = True) <span class="keyword">then</span> </span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          Result := InstallFrameworkOfflineRuntime</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          Result := InstallFrameworkWebRuntime</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;          </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NeedRestart</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := bRequiresRestart;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>欢迎订阅我的个人微信公众号，一起讨论学习。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/06/30/inno-02-installdotnet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/06/25/inno-01-run-as-admin/"
                            aria-label=": Inno Setup 如何以管理员的身份运行"
                        >
                            Inno Setup 如何以管理员的身份运行
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-06-25T08:11:08+08:00">
	
		    6月 25, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Inno-Setup-%E7%9B%B8%E5%85%B3/">Inno Setup 相关</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="Inno-Setup-如何以管理员的身份相关"><a href="#Inno-Setup-如何以管理员的身份相关" class="headerlink" title="Inno Setup 如何以管理员的身份相关"></a>Inno Setup 如何以管理员的身份相关</h2><h3 id="1-如何以管理员身份运行一个Batch脚本文件"><a href="#1-如何以管理员身份运行一个Batch脚本文件" class="headerlink" title="1. 如何以管理员身份运行一个Batch脚本文件"></a>1. 如何以管理员身份运行一个Batch脚本文件</h3><p>If you are using <code>[Run]</code> section then make sure you use <code>runascurrentuser</code> flag (If this flag is specified, the spawned process will inherit Setup/Uninstall’s user credentials (typically, full administrative privileges))</p>
<p>Else there are three ways how to run applications programatically (recommended way):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function Exec(const Filename, Params, WorkingDir: String; const ShowCmd: Integer; const Wait: TExecWait; var ResultCode: Integer): Boolean;</span><br><span class="line"></span><br><span class="line">function ShellExec(const Verb, Filename, Params, WorkingDir: String; const ShowCmd: Integer; const Wait: TExecWait; var ErrorCode: Integer): Boolean;</span><br><span class="line"></span><br><span class="line">function ShellExecAsOriginalUser(const Verb, Filename, Params, WorkingDir: String; const ShowCmd: Integer; const Wait: TExecWait; var ErrorCode: Integer): Boolean;</span><br></pre></td></tr></table></figure>

<p>You should use <code>Exec()</code> or <code>ShellExec()</code> because they open the specified file or performs another action specified by Verb, using the same credentials as Setup/Uninstall.</p>
<p>But none of mentioned ways will work if your installer is not running in elevated mode. So make sure the UAC window will appear before installer starts:</p>
<p>In section <code>[Setup]</code> use directive <code>PrivilegesRequired</code></p>
<p>Valid values:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">none&#96;, &#96;poweruser&#96;, &#96;admin&#96;, or &#96;lowest</span><br></pre></td></tr></table></figure>

<p>Use admin to ensure appropriate credentials.</p>
<h3 id="2-各个合法值在不同版本中的表现"><a href="#2-各个合法值在不同版本中的表现" class="headerlink" title="2. 各个合法值在不同版本中的表现"></a>2. 各个合法值在不同版本中的表现</h3><h4 id="合法值为："><a href="#合法值为：" class="headerlink" title="合法值为："></a>合法值为：</h4><ul>
<li>none, poweruser, admin, or lowest</li>
</ul>
<h4 id="默认值为：Default-value"><a href="#默认值为：Default-value" class="headerlink" title="默认值为：Default value:"></a>默认值为：Default value:</h4><ul>
<li>admin</li>
</ul>
<h4 id="描述Description"><a href="#描述Description" class="headerlink" title="描述Description:"></a>描述Description:</h4><p>The effect of this directive depends on which version of Windows the user is running:</p>
<p>此参数的效果取决于用户运行的Windows版本：</p>
<p><strong>On Windows Vista and later:</strong></p>
<p>This directive affects whether elevated rights are requested (via a User Account Control dialog) when the installation is started.</p>
<p>该指令影响安装开始时是否要求提升权限（通过“用户帐户控制”对话框）。</p>
<p>When set to admin (the default) or poweruser, Setup will always run with administrative privileges. If Setup was started by an unprivileged user, Windows will ask for the password to an account that has administrative privileges, and Setup will then run under that account.</p>
<p>当设置为admin（默认）或超级用户时，安装程序将始终以管理特权运行。 如果安装程序是由非特权用户启动的，则Windows将要求输入具有管理特权的帐户的密码，然后安装程序将在该帐户下运行。</p>
<p>When set to none, Setup will only run with administrative privileges if it was started by a member of the Administrators group. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p>
<p>如果设置为none，则安装程序仅由Administrators组的成员启动时才具有管理特权。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p>
<p>When set to lowest, Setup will not request to be run administrative privileges even if it was started by a member of the Administrators group. Additionally, the uninstall info root key will always be HKEY_CURRENT_USER, and the “common” forms of the Shell Folder constants are mapped to the “user” forms, even if administrative privileges are available. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p>
<p>设置为最低时，即使安装程序是由Administrators组的成员启动的，它也不会请求运行管理权限。 此外，卸载信息的根密钥将始终为HKEY_CURRENT_USER，并且即使具有管理特权，Shell文件夹常量的“公共”形式也将映射到“用户”形式。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p>
<p><strong>On Windows NT/2000/XP/2003</strong></p>
<p>This directive specifies the minimum user privileges required to run the installation.</p>
<p>该指令指定运行安装所需的最低用户特权。</p>
<p>When set to admin (the default), Setup will only run if the user is a member of the Administrators group. Otherwise, it will display the following message and exit: “You must be logged in as an administrator when installing this program.”</p>
<p>当设置为admin（默认值）时，仅当用户是Administrators组的成员时，安装程序才会运行。 否则，它将显示以下消息并退出：“安装此程序时，您必须以管理员身份登录。”</p>
<p>When set to poweruser, Setup will only run if the user is a member of the Administrators or Power Users groups. Otherwise, it will display the following message and exit: “You must be logged in as an administrator or as a member of the Power Users group when installing this program.”</p>
<p>设置为poweruser时，仅当用户是Administrators或Power Users组的成员时，安装程序才会运行。 否则，它将显示以下消息并退出：“安装此程序时，您必须以管理员或Power Users组成员的身份登录。”</p>
<p>When set to none Setup will not check the user’s group membership. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p>
<p>设置为none时，安装程序将不检查用户的组成员身份。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p>
<p>When set to lowest Setup will not check the user’s group membership. Additionally, the uninstall info root key will always be HKEY_CURRENT_USER, and the “common” forms of the Shell Folder constants are mapped to the “user” forms, even if administrative privileges are available. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p>
<p>设置为最低时，安装程序将不检查用户的组成员身份。 此外，卸载信息的根密钥将始终为HKEY_CURRENT_USER，并且即使具有管理特权，Shell文件夹常量的“公共”形式也将映射到“用户”形式。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p>
<p><strong>On Windows 95/98/Me</strong></p>
<p>This directive has no effect on these versions of Windows.</p>
<p>该指令对这些版本的Windows无效。</p>
<h3 id="以管理员身份安装和非管理员身份安装的区别"><a href="#以管理员身份安装和非管理员身份安装的区别" class="headerlink" title="以管理员身份安装和非管理员身份安装的区别"></a>以管理员身份安装和非管理员身份安装的区别</h3><p>An installation can run in one of two modes: administrative or non administrative. Which mode is selected is specified by the <a href="http://www.jrsoftware.org/ishelp/topic_setup_privilegesrequired.htm" target="_blank" rel="noopener">PrivilegesRequired</a> and <a href="http://www.jrsoftware.org/ishelp/topic_setup_privilegesrequiredoverridesallowed.htm" target="_blank" rel="noopener">PrivilegesRequiredOverridesAllowed</a> [Setup] section directives.</p>
<p>In administrative install mode:</p>
<ul>
<li>The <code>{group}</code> folder is created in the <em>All Users</em> profile.</li>
<li>The “auto” form of the directory and Shell Folder constants is mapped to the “common” form.</li>
<li>The <a href="http://www.jrsoftware.org/ishelp/topic_registrysection.htm" target="_blank" rel="noopener">HKA</a> and uninstall info root keys will be HKEY_LOCAL_MACHINE.</li>
</ul>
<p>In non administrative install mode:</p>
<ul>
<li>The <code>{group}</code> folder is created in the current user’s profile.</li>
<li>The “auto” form of the directory and Shell Folder constants is mapped to the “user” form.</li>
<li>The <a href="http://www.jrsoftware.org/ishelp/topic_registrysection.htm" target="_blank" rel="noopener">HKA</a> and uninstall info root keys will be HKEY_CURRENT_USER.</li>
</ul>
<p><strong>Notes:</strong></p>
<p>Regardless of the version of Windows, if the installation is running in administrative install mode then you should be careful about making any per-user area changes: such changes may not achieve what you are intending. The compiler will warn you about this, which can be disabled using <a href="http://www.jrsoftware.org/ishelp/topic_setup_useduserareaswarning.htm" target="_blank" rel="noopener">UsedUserAreasWarning</a>.</p>
<p>无论Windows的版本如何，如果安装均以管理安装模式运行，则应谨慎进行每个用户区域的更改：此类更改可能无法实现您的预期。 编译器将对此警告，可以使用<a href="http://www.jrsoftware.org/ishelp/topic_setup_useduserareaswarning.htm" target="_blank" rel="noopener">UsedUserAreasWarning</a>禁用。</p>
<p>If the installation is running in non administrative install mode, but administrative privileges are available anyway then Setup or the [Code] section might still make use of these privileges. For this reason the uninstaller will always be marked as requiring administrative privileges in this case, just as if the installation was running in administrative install mode.</p>
<p>如果安装程序在非管理安装模式下运行，但是仍然具有管理特权，则安装程序或[Code]部分可能仍会使用这些特权。 因此，在这种情况下，卸载程序将始终被标记为需要管理特权，就像安装在管理安装模式下运行一样。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/06/25/inno-01-run-as-admin/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">第 1 页 共 1 页</li>
    </ul>
</div>

</section>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Jim Wang. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avater.png" alt="作者的图片"/>
        
            <h4 id="about-card-name">Jim Wang</h4>
        
            <div id="about-card-bio"> <hr style='margin: 5px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 20%;'> <span>全栈探索之路<span> <hr style='margin: 8px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 60%;'> 记录个人对技术的理解和开发过程中遇到的问题，欢迎了解更多。 </div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>软件工程师</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                河南，中国
            </div>
        
    </div>
</div>

        




    
        
    



    
        
    

<div id="wechat">
    <div id="wechat-card">
        <div id="wechat-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="wechat-qrcode-picture" src="/assets/images/wechat-qrcode.jpg" alt="global.wechat_public_qr_code_image"/>
        
        
            <div id="wechat-qrcode-desc"><p>请扫描上方的二维码订阅我的个人微信公众号</p> <hr style='margin: 8px auto; border-top: 2px solid rgba(1, 1, 1, 0.14); width: 60%;'> <p>原创不易，多多点赞分享支持。</p></div>
        
        
            <img id="wechat-searchbar-picture" src="/assets/images/wechat-search-white.png" alt="global.wechat_public_search_bar_image"/>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/background-cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-gm6c7itfvqwsezy1fdbvshhzjvi8xskdhlwee7qrhwsbsbmeopxkn4jz7zz9.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
