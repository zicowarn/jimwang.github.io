
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Jim Wang">
    <title>归档 - Jim Wang</title>
    <meta name="author" content="Jim Wang">
    
    
        <link rel="icon" href="http://yoursite.com/assets/images/favicon.png">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{}</script>
    <meta name="description" content="ssss">
<meta property="og:type" content="blog">
<meta property="og:title" content="Jim Wang">
<meta property="og:url" content="http://yoursite.com/archives/index.html">
<meta property="og:site_name" content="Jim Wang">
<meta property="og:description" content="ssss">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Jim Wang">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="http://yoursite.com/assets/images/avater.png"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-lh9m5qsk5uqjin3owpni8a1qtblql6jlqel1idwi2kxv8d5giolf430qyce2.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-172143513-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-172143513-1');
    </script>


    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?1d51896cc9cd82561c7c8e353bb78c0d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/%20"
            aria-label=""
        >
            Jim Wang
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/avater.png" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="阅读有关作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/avater.png" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">Jim Wang</h4>
                <h5 class="sidebar-profile-subtitle"><p>个人技术博客</p>
</h5>
                
                    <h5 class="sidebar-profile-bio"> <hr style='margin: 5px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 20%;'> <span>全栈探索之路<span> <hr style='margin: 8px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 60%;'> 记录个人对技术的理解和开发过程中遇到的问题，欢迎了解更多。 </h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/zicowarn"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#wechat"
                            
                            rel="noopener"
                            title="微信公众号"
                        >
                        <i class="sidebar-button-icon fab fa-weixin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">微信公众号</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/zuiwuxin?s=09"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/zhichao-wang-a16662109"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="领英"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">领英</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:zicowarn@hotmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="邮箱"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/08/10/inno-05-beautify-wizard-laben/"
                            aria-label=": Inno Setup 如何更换向导页面标题部分的背景"
                        >
                            Inno Setup 如何更换向导页面标题部分的背景
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-08-10T08:11:08+08:00">
	
		    8月 10, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Inno-Setup-%E7%9B%B8%E5%85%B3/">Inno Setup 相关</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="InnoSetup-如何更换向导页面标题部分的背景"><a href="#InnoSetup-如何更换向导页面标题部分的背景" class="headerlink" title="InnoSetup 如何更换向导页面标题部分的背景"></a>InnoSetup 如何更换向导页面标题部分的背景</h2><p>开发部领导新的要求，希望在产品安装包的向导页面做些美化。比如，显示公司的logo在向导页面的标题部分。</p>
<p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-label-part.png" alt></p>
<p>所谓标题即Label部分就是上图中红色方格标注的部分。 标注部分右侧是logo图标。</p>
<h3 id="1-初探，如何更换logo部分"><a href="#1-初探，如何更换logo部分" class="headerlink" title="1. 初探，如何更换logo部分"></a>1. 初探，如何更换logo部分</h3><p>Inno Setup开发文档里里有介绍如何更换Label中右侧的logo的方法。可以通过在<strong>[Setup]</strong>可以定义<code>WizardSmallImageFile</code>=”logo文件路径”来实现。但其要求的logo图片都是长宽相等的。长款不等的图片在显示会被拉伸，其效果惨不忍睹。该选项支持多重文件，即:你可以一次定义多个分辨率的logo文件，Inno Setup在安装的时候会根据系统当前的DPI设置，来自动选择合适分辨率的图片。多重定义的方法如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Example:</span><br><span class="line">WizardSmallImageFile=mysmallimage.bmp,mysmallimage2.bmp</span><br></pre></td></tr></table></figure>

<p>Logo文件分辨率要求如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">100%	55x55</span><br><span class="line">125%	64x68</span><br><span class="line">150%	83x80</span><br><span class="line">175%	92x97</span><br><span class="line">200%	110x106</span><br><span class="line">225%	119x123</span><br><span class="line">250%	138x140</span><br></pre></td></tr></table></figure>

<p>图片被拉伸通常发生在以下两种情况，一、显示器的设置发生了变化。二、Inno Setup向导页面被设定未可缩放。向导页面的缩放可以通过<code>WizardSizePercen</code>和<code>WizardResizable</code>。<code>WizardSizePercent</code>的合法值为从100值150。该参数的目的是允许你在不改变文字大小的前提下等比例缩放所以的安装和卸载向导页面。150意思是缩放为默认大小的150%，即增到50%。这里<code>WizardResizable</code>的合法值为yes和no，而当<code>WizardStyle</code>（其合法值为classic和modern）被设置为modern的时候，就默认为<code>WizardResizable</code>的值为yes，也同时默认为<code>WizardSizePercen</code>为120%。具体解释可以查看Inno Setup的官方文档。</p>
<h3 id="2-深入，如何得到当前的显示器的DPI"><a href="#2-深入，如何得到当前的显示器的DPI" class="headerlink" title="2. 深入，如何得到当前的显示器的DPI"></a>2. 深入，如何得到当前的显示器的DPI</h3><p>上文说到，图片的拉伸除了与向导页面有关，与系统的显示设置也相关，那如何得到当前显示的DPI呢？在Win7之前的系统中，要得到当前显示器的DPI，在Inno Setup的<strong>[Code]</strong>部分可以使用<code>TGraphicsObject.PixelsPerInch</code> 这个属性得到当前系统显示器设定的DPI。TGraphicsObject 这里有个小例子，代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">CheckDPI</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  CurrentDPI, StandardDPI, MediumDPI, LargeDPI: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">&#123; Get the current DPI, 从向导页面的字体中得到当前的DPI &#125;</span> </span><br><span class="line">  CurrentDPI  := WizardForm.Font.PixelsPerInch;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">&#123; Store defaults determined from Windows DPI settings &#125;</span></span><br><span class="line">  StandardDPI := <span class="number">96</span>;  <span class="comment">&#123; 100% &#125;</span></span><br><span class="line">  MediumDPI   := <span class="number">120</span>; <span class="comment">&#123; 125% &#125;</span></span><br><span class="line">  LargeDPI    := <span class="number">144</span>; <span class="comment">&#123; 150% &#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (CurrentDPI &gt;= StandardDPI) <span class="keyword">and</span> (CurrentDPI &lt; MediumDPI) <span class="keyword">then</span> </span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; Execute some custom code for small to medium DPI &#125;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (CurrentDPI &gt;= MediumDPI) <span class="keyword">and</span> (CurrentDPI &lt; LargeDPI) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; Execute some custom code for medium to large DPI &#125;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (CurrentDPI &gt;= LargeDPI) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; Execute some custom code for large DPI or above &#125;</span></span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>从Inno Setup 的5.6的版本开始，在多重定义的时候，Inno Setup就会根据当前DPI自动选择图片大小。这个自动选择是如何实现的呢。 下面的代码就使用了<code>PixelsPerInch</code>这个属性，并尝试模拟了自动选择这部分功能。</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[Setup]</span><br><span class="line">; Use <span class="number">100</span>% images by <span class="keyword">default</span></span><br><span class="line">WizardImageFile=WizardImage <span class="number">100</span>.bmp</span><br><span class="line">WizardSmallImageFile=WizardSmallImage <span class="number">100</span>.bmp</span><br><span class="line"></span><br><span class="line">[Files]</span><br><span class="line">; Embed all other sizes <span class="keyword">to</span> the installer</span><br><span class="line">Source: "WizardImage *.bmp"; Excludes: "* 100.bmp"; Flags: dontcopy</span><br><span class="line">Source: "WizardSmallImage *.bmp"; Excludes: "* 100.bmp"; Flags: dontcopy</span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetScalingFactor</span>:</span> Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> WizardForm.Font.PixelsPerInch &gt;= <span class="number">192</span> <span class="keyword">then</span> Result := <span class="number">200</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> WizardForm.Font.PixelsPerInch &gt;= <span class="number">144</span> <span class="keyword">then</span> Result := <span class="number">150</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> WizardForm.Font.PixelsPerInch &gt;= <span class="number">120</span> <span class="keyword">then</span> Result := <span class="number">125</span></span><br><span class="line">    <span class="keyword">else</span> Result := <span class="number">100</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">LoadEmbededScaledBitmap</span><span class="params">(Image: TBitmapImage; NameBase: <span class="keyword">string</span>)</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  <span class="keyword">Name</span>: <span class="keyword">String</span>;</span><br><span class="line">  FileName: <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">Name</span> := Format(<span class="string">'%s %d.bmp'</span>, [NameBase, GetScalingFactor]);</span><br><span class="line">  ExtractTemporaryFile(<span class="keyword">Name</span>);</span><br><span class="line">  FileName := ExpandConstant(<span class="string">'&#123;tmp&#125;\'</span> + <span class="keyword">Name</span>);</span><br><span class="line">  Image.Bitmap.LoadFromFile(FileName);</span><br><span class="line">  DeleteFile(FileName);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">&#123; If using larger scaling, load the correct size of images &#125;</span></span><br><span class="line">  <span class="keyword">if</span> GetScalingFactor &gt; <span class="number">100</span> <span class="keyword">then</span> </span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    LoadEmbededScaledBitmap(WizardForm.WizardBitmapImage, <span class="string">'WizardImage'</span>);</span><br><span class="line">    LoadEmbededScaledBitmap(WizardForm.WizardBitmapImage2, <span class="string">'WizardImage'</span>);</span><br><span class="line">    LoadEmbededScaledBitmap(WizardForm.WizardSmallBitmapImage, <span class="string">'WizardSmallImage'</span>);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>那么有没有在不用重复定义，仅用一张图片然后根据当前的DPI来进行人为的缩放，也能达到良好的显示效果呢，当然有，方法如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">  CustomPage: TWizardPage;</span><br><span class="line">  BtnImage: TBitmapImage;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  CustomPage := CreateCustomPage(wpLicense, <span class="string">'Heading'</span>, <span class="string">'Sub heading.'</span>);</span><br><span class="line">  ExtractTemporaryFile(<span class="string">'image.bmp'</span>);</span><br><span class="line">  BtnImage := TBitmapImage.Create(WizardForm); <span class="comment">//在当前页面即wpLicense页面创建一个Image按钮。</span></span><br><span class="line">  <span class="keyword">with</span> BtnImage <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      Parent := CustomPage.Surface;</span><br><span class="line">      Bitmap.LoadFromFile(ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>)+<span class="string">'\image.bmp'</span>);</span><br><span class="line">      AutoSize := True;</span><br><span class="line">      AutoSize := False;  <span class="comment">// 缩放之前 关系BtnImage的自由大小属性</span></span><br><span class="line">      Height := ScaleX(Height); <span class="comment">// 然后根据当前BtnImage的大小进行缩放</span></span><br><span class="line">      Width := ScaleY(Width);</span><br><span class="line">      Stretch := True;</span><br><span class="line">      Left := ScaleX(<span class="number">90</span>);</span><br><span class="line">      Top := WizardForm.SelectTasksPage.Top + WizardForm.SelectTasksPage.Height -</span><br><span class="line">             Height - ScaleY(<span class="number">8</span>);</span><br><span class="line">      Cursor := crHand;</span><br><span class="line">      OnClick := @ImageOnClick;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3-进阶，Win8之后新系统得到当前的显示器的DPI"><a href="#3-进阶，Win8之后新系统得到当前的显示器的DPI" class="headerlink" title="3. 进阶，Win8之后新系统得到当前的显示器的DPI"></a>3. 进阶，Win8之后新系统得到当前的显示器的DPI</h3><p>由于Windows 8.1之后的系统中，用户可以调整每个监视器的DPI缩放比例，并且Font.PixelsPerInch始终为主监视器返回DPI值，因此<strong>第2节</strong>中的方法就不在适用新的系统了。如果在多显示多DPI的复杂环境中，<strong>第2节</strong>中的方法表现的也不尽如人意。某些时候，可以监听WM_DPICHANGED事件，然后手动并使窗口适应变化的DPI（但此更改可以只是将窗口移动到具有不同DPI设置的监视器）。而 要获取某个窗口的DPI，就需要考虑别的解决方案了。我在网上找到了相关的介绍，但是我当前的项目中不需要这些，也就没对代码进行测试。感兴趣的朋友可以自己尝试一下，代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="keyword">const</span></span><br><span class="line">  S_OK = $<span class="number">00000000</span>;</span><br><span class="line">  LOGPIXELSY = <span class="number">90</span>;</span><br><span class="line">  MONITOR_DEFAULTTONULL = $<span class="number">00000000</span>;</span><br><span class="line">  MONITOR_DEFAULTTOPRIMARY = $<span class="number">00000001</span>;</span><br><span class="line">  MONITOR_DEFAULTTONEAREST = $<span class="number">00000002</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span></span><br><span class="line">  HDC = THandle;</span><br><span class="line">  HMONITOR = THandle;</span><br><span class="line">  MONITOR_DPI_TYPE = (</span><br><span class="line">    MDT_EFFECTIVE_DPI,</span><br><span class="line">    MDT_ANGULAR_DPI,</span><br><span class="line">    MDT_RAW_DPI</span><br><span class="line">  );</span><br><span class="line"><span class="keyword">const</span></span><br><span class="line">  MDT_DEFAULT = MDT_EFFECTIVE_DPI;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetDC</span><span class="params">(hWnd: HWND)</span>:</span> HDC;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">'GetDC@user32.dll stdcall'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReleaseDC</span><span class="params">(hWnd: HWND; hDC: HDC)</span>:</span> Integer;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">'ReleaseDC@user32.dll stdcall'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetDeviceCaps</span><span class="params">(hdc: HDC; <span class="keyword">index</span>: Integer)</span>:</span> Integer;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">'GetDeviceCaps@gdi32.dll stdcall'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MonitorFromWindow</span><span class="params">(hwnd: HWND; dwFlags: DWORD)</span>:</span> HMONITOR;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">'MonitorFromWindow@user32.dll stdcall'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetDpiForMonitor</span><span class="params">(hmonitor: HMONITOR; dpiType: MONITOR_DPI_TYPE;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">out</span> dpiX: UINT; <span class="keyword">out</span> dpiY: UINT)</span>:</span> HRESULT;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">'GetDpiForMonitor@shcore.dll stdcall delayload'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsWindows81OrLater</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := GetWindowsVersion &gt;= $<span class="number">06030000</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetPrimaryMonitorDPI</span>:</span> Integer;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  DC: HDC;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// no need for try..finally block here; just get the desktop DC handle,</span></span><br><span class="line">  <span class="comment">// get the DPI and release the obtained handle</span></span><br><span class="line">  DC := GetDC(<span class="number">0</span>);</span><br><span class="line">  Result := GetDeviceCaps(DC, LOGPIXELSY);</span><br><span class="line">  ReleaseDC(<span class="number">0</span>, DC);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetWindowMonitorDPI</span><span class="params">(Handle: HWND)</span>:</span> Integer;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  HorzDPI: UINT;</span><br><span class="line">  VertDPI: UINT;</span><br><span class="line">  Monitor: HMONITOR;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// if we're not on at least Windows 8.1, then return the primary monitor</span></span><br><span class="line">  <span class="comment">// DPI since earlier systems did not allow per monitor DPI settings</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> IsWindows81OrLater <span class="keyword">then</span></span><br><span class="line">    Result := GetPrimaryMonitorDPI</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  <span class="comment">// otherwise determine which monitor the given window intersects and try</span></span><br><span class="line">  <span class="comment">// to get DPI settings of the found monitor (if any; check MSDN docs for</span></span><br><span class="line">  <span class="comment">// the explanation and other options how to find the nearest monitor)</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// try to get the monitor which the window intersects</span></span><br><span class="line">    Monitor := MonitorFromWindow(Handle, MONITOR_DEFAULTTONULL);</span><br><span class="line">    <span class="comment">// if there's any, then...</span></span><br><span class="line">    <span class="keyword">if</span> Monitor &lt;&gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      <span class="comment">// try to get DPI for that monitor; if it succeeds, return the value,</span></span><br><span class="line">      <span class="comment">// raise an exception otherwise (for details check the MSDN docs)</span></span><br><span class="line">      <span class="keyword">if</span> GetDpiForMonitor(Monitor, MDT_DEFAULT, HorzDPI, VertDPI) = S_OK <span class="keyword">then</span></span><br><span class="line">        Result := VertDPI</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        RaiseException(<span class="string">'GetDpiForMonitor function call failed!'</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      RaiseException(<span class="string">'The given window does not intersect any monitor!'</span>);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>这是Windows SDK中介绍的方法，整个设计相对来说比较复杂。简单来说，将上述代码加入你的项目中，当你需要显示器的DPI的时候就调用<code>GetWindowMonitorDPI</code>函数，然后根据DPI结合<strong>第2节</strong>中的方法来缩放或者选择你要显示的图片。</p>
<h3 id="4-回到项目，更换向导页面标题部分的背景"><a href="#4-回到项目，更换向导页面标题部分的背景" class="headerlink" title="4. 回到项目，更换向导页面标题部分的背景"></a>4. 回到项目，更换向导页面标题部分的背景</h3><p>上述的内容，也是我再寻找解决新需求的过程中，搜集和整理的部分内容，记录下来也是为了以后需要的时候知道应该向那个方向努力。我告诉开发主管的是，我个人不建议将我们安装应用程序的向导页面设置为可缩放，因为这样需要做出的改变特别多，而且当前的大小也能满足使用需求。但美化工作不能少，第一步的任务核心就是页面简介背景部分，代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[Files]</span><br><span class="line">Source: "Logo-header.bmp"; Flags: dontcopy</span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span><span class="params">()</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  BitmapImage: TBitmapImage;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  ExtractTemporaryFile(<span class="string">'Logo-header.bmp'</span>);</span><br><span class="line">  BitmapImage := TBitmapImage.Create(WizardForm);</span><br><span class="line">  BitmapImage.Parent := WizardForm.MainPanel;</span><br><span class="line">  BitmapImage.Width := WizardForm.MainPanel.Width;</span><br><span class="line">  BitmapImage.Height := WizardForm.MainPanel.Height;</span><br><span class="line">  BitmapImage.Stretch := True;</span><br><span class="line">  BitmapImage.AutoSize := False;</span><br><span class="line">  BitmapImage.Bitmap.LoadFromFile(ExpandConstant(<span class="string">'&#123;tmp&#125;\Logo-header.bmp'</span>));</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 禁用 原始页面的小图标</span></span><br><span class="line">  WizardForm.WizardSmallBitmapImage.Visible := False;</span><br><span class="line">  <span class="comment">// 启用 页面简介标题</span></span><br><span class="line">  WizardForm.PageDescriptionLabel.Visible := True;</span><br><span class="line">  <span class="comment">// 启用 页面名称标题</span></span><br><span class="line">  WizardForm.PageNameLabel.Visible := True;</span><br><span class="line">  <span class="comment">// 限定页面简介标题宽度</span></span><br><span class="line">  WizardForm.PageDescriptionLabel.Width :=</span><br><span class="line">    WizardForm.PageDescriptionLabel.Width - ScaleX(<span class="number">120</span>);</span><br><span class="line">  <span class="comment">// 限定页面名称标题宽度</span></span><br><span class="line">  WizardForm.PageNameLabel.Width :=</span><br><span class="line">    WizardForm.PageNameLabel.Width - ScaleX(<span class="number">120</span>)</span><br><span class="line"> <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>上述代码的核心思想就是，准备一张图片，该图片并不会被拷贝在目标文件夹中，在页面初始的时候，设定页面标题简述部分的背景，由于原始页面小logo被禁用，就需要缩进标题名称和简介文本的宽度，防止其覆盖图片的部分内容。</p>
<p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-welcome-part.png" alt="image-20200220170839898"></p>
<p>任务第二部分内容，就是更改欢迎页面的背景图片，即上图中红色部分框选的地方。首先在<strong>[Setup]</strong>中定义属性为<a href="http://www.jrsoftware.org/ishelp/index.php?topic=setup_disablewelcomepage" target="_blank" rel="noopener"><code>DisableWelcomePage=no</code></a>，意指启用欢迎页面。 然后在<strong>[Setup]</strong>部分定义<code>WizardBitmapImage</code>属性即可。结束页面（下图）与开始页面相似，只需在<strong>[Setup]</strong>部分定义<code>WizardBitmapImage2</code> 属性即可。</p>
<p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-finish-part.png" alt="image-20200220170935862"></p>
<p>需要说明的是，如果属性<code>WizardBitmapImage2</code>为被定义，而属性<code>WizardBitmapImage</code>被定义，则结束页面会选择<code>WizardBitmapImage</code>中定义的图片作为上图中红色部分圈选的背景图片。</p>
<h3 id="5-扩展，欢迎页面和结束页面整页照片"><a href="#5-扩展，欢迎页面和结束页面整页照片" class="headerlink" title="5. 扩展，欢迎页面和结束页面整页照片"></a>5. 扩展，欢迎页面和结束页面整页照片</h3><p>我们在<strong>第4节</strong>部分，了解了如何在使用Inno Setup的属性设定，更改欢迎和结束页面的左侧背景图片，那么有没有一种可能，即省去这两个页面的文字（通常需要考虑翻译的问题），直接使用一张图片作为整个页面的背景呢？有，本节我们就探索一下。中心思想为四部：</p>
<ul>
<li>在各自的父页面上拉伸“ WizardBitmapImage”（欢迎）和“ WizardBitmapImage2”（完成），因为这两个页面都有图片部分，就不需要再初始化TBitmapImage了。</li>
<li>隐藏其它内容，例如 标题和段落.</li>
<li>确保安装程序永远不需要重新启动计算机，否则会在结束图片上会显示上重新启动提示。</li>
<li>请确保在<strong>[Run]</strong>部分中没有任何<code>postinstall</code>条目。否则结束页面上也会显示提示信息。</li>
</ul>
<p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-finish-part-full.png" alt="image-20200220171021313"></p>
<p>实现这部分的代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[Setup]</span><br><span class="line">DisableWelcomePage=no</span><br><span class="line">WizardImageFile=Demo.bmp  <span class="comment">// 如果WizardImageFile2 没定义则结束页面也使用该图片</span></span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span><span class="params">()</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// 欢迎页面</span></span><br><span class="line">  <span class="comment">// 隐藏 部分内容</span></span><br><span class="line">  WizardForm.WelcomeLabel1.Visible := False;</span><br><span class="line">  WizardForm.WelcomeLabel2.Visible := False;</span><br><span class="line">  <span class="comment">// 拉伸页面宽度</span></span><br><span class="line">  WizardForm.WizardBitmapImage.Width := WizardForm.WizardBitmapImage.Parent.Width;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 结束页面</span></span><br><span class="line">  <span class="comment">// 隐藏 部分内容</span></span><br><span class="line">  WizardForm.FinishedLabel.Visible := False;</span><br><span class="line">  WizardForm.FinishedHeadingLabel.Visible := False;</span><br><span class="line">  <span class="comment">// 拉伸页面宽度</span></span><br><span class="line">  WizardForm.WizardBitmapImage2.Width := WizardForm.WizardBitmapImage2.Parent.Width;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>



<h3 id="6-扩展2，在向导页脚左侧显示版本号"><a href="#6-扩展2，在向导页脚左侧显示版本号" class="headerlink" title="6. 扩展2，在向导页脚左侧显示版本号"></a>6. 扩展2，在向导页脚左侧显示版本号</h3><p>需要的显示结果如下图所示：</p>
<p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-bottom-left-part.png" alt="image-20200221093833941"></p>
<p>代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span><span class="params">()</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  VersionLabel: TNewStaticText;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// 定义一个静态文本实例</span></span><br><span class="line">  VersionLabel := TNewStaticText.Create(WizardForm);</span><br><span class="line">  <span class="comment">// 从Setup部分的设定中获取版本号</span></span><br><span class="line">  VersionLabel.Caption := Format(<span class="string">'Version: %s'</span>, [<span class="string">'&#123;#SetupSetting("AppVersion")&#125;'</span>]);</span><br><span class="line">  <span class="comment">// 所有页面有效</span></span><br><span class="line">  VersionLabel.Parent := WizardForm;</span><br><span class="line">  <span class="comment">// 左侧位置</span></span><br><span class="line">  VersionLabel.Left := ScaleX(<span class="number">16</span>);</span><br><span class="line">  <span class="comment">// 保证 文本与按钮的 在水平方向 中心对齐</span></span><br><span class="line">  VersionLabel.Top :=</span><br><span class="line">    WizardForm.BackButton.Top +</span><br><span class="line">    (WizardForm.BackButton.Height <span class="keyword">div</span> <span class="number">2</span>) -</span><br><span class="line">    (VersionLabel.Height <span class="keyword">div</span> <span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>对齐的方式，以按钮的左上位置为基点，加上按钮高度与文本高度之差即可。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/08/10/inno-05-beautify-wizard-laben/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/07/10/inno-04-registry-hcr/"
                            aria-label=": Inno Setup Windows 注册表关键字HKEY\_CLASSES\_ROOT相关内容"
                        >
                            Inno Setup Windows 注册表关键字HKEY\_CLASSES\_ROOT相关内容
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-07-10T08:11:08+08:00">
	
		    7月 10, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Inno-Setup-%E7%9B%B8%E5%85%B3/">Inno Setup 相关</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="Windows-注册表"><a href="#Windows-注册表" class="headerlink" title="Windows 注册表"></a>Windows 注册表</h2><p>HKEY_CLASSES_ROOT在此关键字之下，可以看见有一个CLSID关键字。在CLSID关键字之下列有系统中安装的所有组件的CLSID。注册表CLSID是一个具有如下格式的串：00000010-0000-0010-8000-00AA00D2EA4</p>
<p>HKEY_CLASSES_ROOT的开头，列出了将是各种应用程序所注册的文件扩展名。在扩展名之后，可以看到许多其它的名字。此类名字大多数被称作是ProgID，表示是程序员定义的标识符。某些名称表示的不是ProgID而实一些特殊的关键字。</p>
<p>如：</p>
<ul>
<li>CLSID</li>
<li>AppID，此关键字下的子关键字的作用是将某个APPID（应用程序的ID）映射成某个远程服务器名称。分式COM（DCOM）将用到此关键字。</li>
<li>组件类别，注册表的这一分支可以将CATID（组件类别ID）映射成某个特定的组件类别。</li>
<li>Interface，此关键字将用于将IID映射成某个接口相关的信息。这些信息主要用于在跨进程边界使用接口的情况。</li>
<li>Licenses，保存的是授权使用COM组件的一些认可信息。</li>
<li>TypeLib，类型库关键字保存的是关于接口成员函数所用的参数的信息。另外还有一些信息。此关键字可以将一个LIBID映射成存储类型库的文件名称。</li>
</ul>
<h3 id="ProgID"><a href="#ProgID" class="headerlink" title="ProgID"></a>ProgID</h3><p>所谓ProgID指的是程序员给某个CLSID指定的一个程序员易记的名称。ProgID命名规则为：..，如下图：</p>
<p>如WPDSp.WPDServiceProvider是版本无关ProgID，根据其值可在CLSID下找到相应键，进而找到相应信息，如组件最新版本信息。</p>
<p>WPDSp.WPDServiceProvider.1是版本相关ProgID，根据其CLSID值可以找到该版本组件的信息。</p>
<h3 id="ProgID注册表格式"><a href="#ProgID注册表格式" class="headerlink" title="ProgID注册表格式"></a>ProgID注册表格式</h3><p>ProgID及与版本无关的ProgID被列在组件CLSID下面。</p>
<p>ProgID的主要作用是获取相应的CLSID。在每一个CLSID项中查找查个ProgID将非常低效的。因此在其下面也将直接列出ProgID。由于ProgID不是针对最终用户而定义的，因此ProgID关键字的缺省值为用户易记的名称。在之下有一个名为CLSID的关键字，其缺省值为组件的CLSID。如下图所示：</p>
<p>与版本好无关的ProgID也直接被列在HKEY_CLASSES_ROOT下面。它们还有另外一个关键字CurVer，其缺省值为组件当前版本的ProgID，如下图：</p>
<h3 id="ProgID和CLSID的转换"><a href="#ProgID和CLSID的转换" class="headerlink" title="ProgID和CLSID的转换"></a>ProgID和CLSID的转换</h3><ul>
<li>CLSIDFromProgID</li>
<li>ProgIDFromCLSID</li>
</ul>
<h3 id="组件的自注册"><a href="#组件的自注册" class="headerlink" title="组件的自注册"></a>组件的自注册</h3><p>为把组件注册到注册表，在DLL中一定要输出如下两个函数：</p>
<p>STDAPI DllRegisterServer(); //注册</p>
<p>STDAPI DllUnregisterServer(); //反注册</p>
<p>我们使用Regsvr32.exe注册某个组件或者反注册某个组件时，其实就是调用这两个函数的过程。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/07/10/inno-04-registry-hcr/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/07/05/inno-03-check-network-state/"
                            aria-label=": Inno Setup 检查网络连接的Pascal代码"
                        >
                            Inno Setup 检查网络连接的Pascal代码
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-07-05T08:11:08+08:00">
	
		    7月 05, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Inno-Setup-%E7%9B%B8%E5%85%B3/">Inno Setup 相关</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="InnoSetup-检查网络连接"><a href="#InnoSetup-检查网络连接" class="headerlink" title="InnoSetup 检查网络连接"></a>InnoSetup 检查网络连接</h2><h3 id="1-循环检查网络连接直至连接成共，代码如下："><a href="#1-循环检查网络连接直至连接成共，代码如下：" class="headerlink" title="1. 循环检查网络连接直至连接成共，代码如下："></a>1. 循环检查网络连接直至连接成共，代码如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">function IsNetWorkActivatedRepeated: boolean;</span><br><span class="line">var</span><br><span class="line">  WinHttpReq: Variant;</span><br><span class="line">  Connected: Boolean;</span><br><span class="line">begin</span><br><span class="line">  Connected :&#x3D; False;</span><br><span class="line">  repeat</span><br><span class="line">    Log(&#39;Checking connection to the server&#39;);</span><br><span class="line">    try</span><br><span class="line">      WinHttpReq :&#x3D; CreateOleObject(&#39;WinHttp.WinHttpRequest.5.1&#39;);</span><br><span class="line">      &#123; Use your real server host name &#125;</span><br><span class="line">      WinHttpReq.Open(&#39;GET&#39;, &#39;https:&#x2F;&#x2F;www.camtek.de&#x2F;&#39;, False);</span><br><span class="line">      WinHttpReq.Send(&#39;&#39;);</span><br><span class="line">      Log(&#39;Connected to the server; status: &#39; + IntToStr(WinHttpReq.Status) + &#39; &#39; +</span><br><span class="line">          WinHttpReq.StatusText);</span><br><span class="line">      Connected :&#x3D; True;</span><br><span class="line">    except</span><br><span class="line">      Log(&#39;Error connecting to the server: &#39; + GetExceptionMessage);</span><br><span class="line">      if WizardSilent then</span><br><span class="line">      begin</span><br><span class="line">        Log(&#39;Connection to the server is not available, aborting silent installation&#39;);</span><br><span class="line">        Result :&#x3D; False;</span><br><span class="line">        Exit;</span><br><span class="line">      end</span><br><span class="line">        else</span><br><span class="line">      if MsgBox(&#39;Cannot reach server. Please check your Internet connection.&#39;,</span><br><span class="line">                mbError, MB_RETRYCANCEL) &#x3D; IDRETRY then</span><br><span class="line">      begin</span><br><span class="line">        Log(&#39;Retrying&#39;);</span><br><span class="line">      end</span><br><span class="line">        else</span><br><span class="line">      begin</span><br><span class="line">        Log(&#39;Aborting&#39;);</span><br><span class="line">        Result :&#x3D; False;</span><br><span class="line">        Exit;</span><br><span class="line">      end;</span><br><span class="line">    end;</span><br><span class="line">  until Connected;</span><br><span class="line"></span><br><span class="line">  Result :&#x3D; True;</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<h3 id="2-有限次数检测网络，代码如下："><a href="#2-有限次数检测网络，代码如下：" class="headerlink" title="2. 有限次数检测网络，代码如下："></a>2. 有限次数检测网络，代码如下：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">function IsNetWorkActivatedTried: boolean;</span><br><span class="line">var</span><br><span class="line">  WinHttpReq: Variant;</span><br><span class="line">  Connected: Boolean;</span><br><span class="line">  iTriedTime: Integer;</span><br><span class="line">begin</span><br><span class="line">  Connected :&#x3D; False;</span><br><span class="line">  iTriedTime :&#x3D; 0;</span><br><span class="line">  repeat</span><br><span class="line">    iTriedTime :&#x3D; iTriedTime + 1;</span><br><span class="line">    Log(&#39;Checking connection to the server, try &#39; +  + IntToStr(iTriedTime) + &#39; time.&#39;);</span><br><span class="line">    try</span><br><span class="line"></span><br><span class="line">      WinHttpReq :&#x3D; CreateOleObject(&#39;WinHttp.WinHttpRequest.5.1&#39;);</span><br><span class="line">      WinHttpReq.SetTimeouts(&#39;3000&#39;, &#39;3000&#39;, &#39;3000&#39;, &#39;3000&#39;);</span><br><span class="line">      &#x2F;&#x2F; Use your real server host name </span><br><span class="line">      WinHttpReq.Open(&#39;GET&#39;, &#39;https:&#x2F;&#x2F;www.goolge.de&#x2F;&#39;, False);</span><br><span class="line">      WinHttpReq.Send(&#39;&#39;);</span><br><span class="line">      Log(&#39;Connected to the server; status: &#39; + IntToStr(WinHttpReq.Status) + &#39; &#39; +</span><br><span class="line">          WinHttpReq.StatusText);</span><br><span class="line">      Connected :&#x3D; True;</span><br><span class="line">    except</span><br><span class="line">      Log(&#39;Error connecting to the server, msg: &#39; + GetExceptionMessage + &#39;try again! &#39;);</span><br><span class="line">    end;</span><br><span class="line">  until (iTriedTime &#x3D; 3) or (Connected &#x3D; True) ;</span><br><span class="line">  Result :&#x3D; Connected;</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>


                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/07/05/inno-03-check-network-state/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/06/30/inno-02-installdotnet/"
                            aria-label=": Inno Setup 在x86和x64环境下安装-NET安装包"
                        >
                            Inno Setup 在x86和x64环境下安装-NET安装包
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-06-30T08:11:08+08:00">
	
		    6月 30, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Inno-Setup-%E7%9B%B8%E5%85%B3/">Inno Setup 相关</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="任务难点"><a href="#任务难点" class="headerlink" title="任务难点"></a>任务难点</h3><p>准备一个安装程序，以验证系统的体系结构并安装.NET。</p>
<h3 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h3><p>此安装脚本示例的目的是启动一个安装程序，该安装程序检查系统上当前安装的.NET版本，并仅在需要时安装一个。安装程序将在软件包中包括Microsoft提供的Web安装程序。 安装程序还将根据运行所在的体系结构安装一些库。</p>
<h3 id="2-背景"><a href="#2-背景" class="headerlink" title="2. 背景"></a>2. 背景</h3><p>出于我们的目的，我们需要可从Microsoft下载站点下载的InnoSetup编译器和.NET Framework Web安装程序文件。Microsoft维护一组注册表项，这些注册表项指示已安装的.NET Framework版本和Service Pack。C＃MVP Scott Dorman在此<a href="http://stackoverflow.com/questions/199080/how-to-detect-what-net-framework-versions-and-service-packs-are-installed" target="_blank" rel="noopener">Stack Overflow线程中</a>发布了一个列表，其中包含版本1.0到4.0（在撰写本文时）。除1.0以外，大多数.NET Framework版本所需的注册表项都非常相似。无论如何，我们将忽略该版本已被1.1淘汰的版本。</p>
<p>4.5版和更高版本有些棘手，因为它们可以作为4.0版的就地更新安装并重用完全相同的注册表项。MSDN官方页面“ <a href="https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed" target="_blank" rel="noopener">如何：确定安装的.NET Framework版本”</a>建议检查<code>DWORD</code>value 的存在<code>Release</code>，所以我在下面做这件事。替代方法是检查.NET 4.0 的<code>REG_SZ</code>值<code>Version</code>4.0.30319，.NET 4.5的4.5.50709和.NET 4.6的4.6.00079。（可悲的是，在安装它们时，我不认为要记录4.5.1和4.5.2的版本字符串。）</p>
<p>4.5.1版引入了另一个复杂性：根据Windows版本，可能有_两个_<code>Release</code>值！该脚本通过将所有4.5版或更高版本的查询视为_最低_要求来处理此问题，即，如果该<code>Release</code>值等于或大于任何系统上指定版本的最小值，则这些查询将成功。.NET 4.5或更高版本也可以满足.NET 4.0的查询，因为后者是作为就地更新安装的。对较早版本的查询需要完全匹配，即，即使应用程序兼容，.NET 4.0或更高版本也_无法_满足它们。</p>
<h3 id="3-代码部分"><a href="#3-代码部分" class="headerlink" title="3. 代码部分"></a>3. 代码部分</h3><p>在[Code]部分，我们定义如下函数来检测以安装的.NET版本。该部分代码取自Jordan Russell的网站。 在下面的Inno Setup脚本代码块中，函数<code>IsDotNetDetected</code>检查是否安装了指定的.NET Framework版本和至少指定的Service Pack级别。所有列出的版本字符串均适用于最终发行版本；测试版和发行候选版通常具有不同的版本号。函数<code>InitializeSetup</code>演示了如何使用<code>IsDotNetDetected</code>不带Service Pack的.NET Framework 4.6进行检查。 原始代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsDotNetDetected</span><span class="params">(version: <span class="keyword">string</span>; service: cardinal)</span>:</span> boolean;</span><br><span class="line"><span class="comment">// Indicates whether the specified version and service pack of the .NET Framework is installed.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// version -- Specify one of these strings for the required .NET Framework version:</span></span><br><span class="line"><span class="comment">//    'v1.1'          .NET Framework 1.1</span></span><br><span class="line"><span class="comment">//    'v2.0'          .NET Framework 2.0</span></span><br><span class="line"><span class="comment">//    'v3.0'          .NET Framework 3.0</span></span><br><span class="line"><span class="comment">//    'v3.5'          .NET Framework 3.5</span></span><br><span class="line"><span class="comment">//    'v4\Client'     .NET Framework 4.0 Client Profile</span></span><br><span class="line"><span class="comment">//    'v4\Full'       .NET Framework 4.0 Full Installation</span></span><br><span class="line"><span class="comment">//    'v4.5'          .NET Framework 4.5</span></span><br><span class="line"><span class="comment">//    'v4.5.1'        .NET Framework 4.5.1</span></span><br><span class="line"><span class="comment">//    'v4.5.2'        .NET Framework 4.5.2</span></span><br><span class="line"><span class="comment">//    'v4.6'          .NET Framework 4.6</span></span><br><span class="line"><span class="comment">//    'v4.6.1'        .NET Framework 4.6.1</span></span><br><span class="line"><span class="comment">//    'v4.6.2'        .NET Framework 4.6.2</span></span><br><span class="line"><span class="comment">//    'v4.7'          .NET Framework 4.7</span></span><br><span class="line"><span class="comment">//    'v4.7.1'        .NET Framework 4.7.1</span></span><br><span class="line"><span class="comment">//    'v4.7.2'        .NET Framework 4.7.2</span></span><br><span class="line"><span class="comment">//    'v4.8'          .NET Framework 4.8</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// service -- Specify any non-negative integer for the required service pack level:</span></span><br><span class="line"><span class="comment">//    0               No service packs required</span></span><br><span class="line"><span class="comment">//    1, 2, etc.      Service pack 1, 2, etc. required</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    key, versionKey: <span class="keyword">string</span>;</span><br><span class="line">    install, release, serviceCount, versionRelease: cardinal;</span><br><span class="line">    success: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    versionKey := version;</span><br><span class="line">    versionRelease := <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 1.1 and 2.0 embed release number in version key</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">'v1.1'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        versionKey := <span class="string">'v1.1.4322'</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> version = <span class="string">'v2.0'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        versionKey := <span class="string">'v2.0.50727'</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 and newer install as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> Pos(<span class="string">'v4.'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        versionKey := <span class="string">'v4\Full'</span>;</span><br><span class="line">        <span class="keyword">case</span> version <span class="keyword">of</span></span><br><span class="line">          <span class="string">'v4.5'</span>:   versionRelease := <span class="number">378389</span>;</span><br><span class="line">          <span class="string">'v4.5.1'</span>: versionRelease := <span class="number">378675</span>; <span class="comment">// 378758 on Windows 8 and older</span></span><br><span class="line">          <span class="string">'v4.5.2'</span>: versionRelease := <span class="number">379893</span>;</span><br><span class="line">          <span class="string">'v4.6'</span>:   versionRelease := <span class="number">393295</span>; <span class="comment">// 393297 on Windows 8.1 and older</span></span><br><span class="line">          <span class="string">'v4.6.1'</span>: versionRelease := <span class="number">394254</span>; <span class="comment">// 394271 before Win10 November Update</span></span><br><span class="line">          <span class="string">'v4.6.2'</span>: versionRelease := <span class="number">394802</span>; <span class="comment">// 394806 before Win10 Anniversary Update</span></span><br><span class="line">          <span class="string">'v4.7'</span>:   versionRelease := <span class="number">460798</span>; <span class="comment">// 460805 before Win10 Creators Update</span></span><br><span class="line">          <span class="string">'v4.7.1'</span>: versionRelease := <span class="number">461308</span>; <span class="comment">// 461310 before Win10 Fall Creators Update</span></span><br><span class="line">          <span class="string">'v4.7.2'</span>: versionRelease := <span class="number">461808</span>; <span class="comment">// 461814 before Win10 April 2018 Update</span></span><br><span class="line">          <span class="string">'v4.8'</span>:   versionRelease := <span class="number">528040</span>; <span class="comment">// 528049 before Win10 May 2019 Update</span></span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">'SOFTWARE\Microsoft\NET Framework Setup\NDP\'</span> + versionKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 3.0 uses value InstallSuccess in subkey Setup</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v3.0'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key + <span class="string">'\Setup'</span>, <span class="string">'InstallSuccess'</span>, install);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key, <span class="string">'Install'</span>, install);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.0 and newer use value Servicing instead of SP</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v4'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Servicing'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'SP'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 and newer use additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> versionRelease &gt; <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Release'</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= versionRelease);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    result := success <span class="keyword">and</span> (install = <span class="number">1</span>) <span class="keyword">and</span> (serviceCount &gt;= service);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InitializeSetup</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> IsDotNetDetected(<span class="string">'v4.6'</span>, <span class="number">0</span>) <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        MsgBox(<span class="string">'MyApp requires Microsoft .NET Framework 4.6.'</span><span class="string">#13#13</span></span><br><span class="line">            <span class="string">'Please use Windows Update to install this version,'</span><span class="string">#13</span></span><br><span class="line">            <span class="string">'and then re-run the MyApp setup program.'</span>, mbInformation, MB_OK);</span><br><span class="line">        result := false;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        result := true;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>针对此代码，我们修改为如下形式：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsDotNetDetected</span><span class="params">(version: <span class="keyword">string</span>; service: cardinal)</span>:</span> boolean;</span><br><span class="line"><span class="comment">// Indicates whether the specified version and service pack of the .NET Framework is installed.</span></span><br><span class="line"><span class="comment">// see the link: https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed?redirectedfrom=MSDN#net_b</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// version -- Specify one of these strings for the required .NET Framework version:</span></span><br><span class="line"><span class="comment">//    'v1.1.4322'     .NET Framework 1.1</span></span><br><span class="line"><span class="comment">//    'v2.0.50727'    .NET Framework 2.0</span></span><br><span class="line"><span class="comment">//    'v3.0'          .NET Framework 3.0</span></span><br><span class="line"><span class="comment">//    'v3.5'          .NET Framework 3.5</span></span><br><span class="line"><span class="comment">//    'v4\Client'     .NET Framework 4.0 Client Profile</span></span><br><span class="line"><span class="comment">//    'v4\Full'       .NET Framework 4.0 Full Installation</span></span><br><span class="line"><span class="comment">//    'v4.5'          .NET Framework 4.5 378389</span></span><br><span class="line"><span class="comment">//    'v4.6'          .NET Framework 4.6 393295</span></span><br><span class="line"><span class="comment">//    'v4.6.1'        .NET Framework 4.6.1 394254</span></span><br><span class="line"><span class="comment">//    'v4.6.2'        .NET Framework 4.6.2 394802</span></span><br><span class="line"><span class="comment">//    'v4.7'          .NET Framework 4.7 393295</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// service -- Specify any non-negative integer for the required service pack level:</span></span><br><span class="line"><span class="comment">//    0               No service packs required</span></span><br><span class="line"><span class="comment">//    1, 2, etc.      Service pack 1, 2, etc. required</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    key: <span class="keyword">string</span>;</span><br><span class="line">    install, release, serviceCount: cardinal;</span><br><span class="line">    check45, success: boolean;</span><br><span class="line"><span class="keyword">var</span> reqNetVer : <span class="keyword">string</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// .NET 4.5 installs as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">'v4.5'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">'v4\Full'</span>;</span><br><span class="line">        check45 := true;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        check45 := false;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">'SOFTWARE\Microsoft\NET Framework Setup\NDP\'</span> + version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 3.0 uses value InstallSuccess in subkey Setup</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v3.0'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key + <span class="string">'\Setup'</span>, <span class="string">'InstallSuccess'</span>, install);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key, <span class="string">'Install'</span>, install);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.0/4.5 uses value Servicing instead of SP</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v4'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Servicing'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'SP'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 uses additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> check45 <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Release'</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= <span class="number">378389</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    result := success <span class="keyword">and</span> (install = <span class="number">1</span>) <span class="keyword">and</span> (serviceCount &gt;= service);</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>这是一个全局函数，用于验证是否正确安装了作为参数传递的.NET Framework版本。 现在，我们应该编写一个由安装程序在运行时调用的简单函数，以验证是否已安装所需的.NET版本。我们将以4.0为例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function IsRequiredDotNetDetected(): Boolean;  </span><br><span class="line">begin</span><br><span class="line">    result :&#x3D; IsDotNetDetected(&#39;v4\Full&#39;, 0);</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<p>如果需要，我们还可以在设置过程中发布一条消息：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InitializeSetup</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> IsDotNetDetected(<span class="string">'v4\Full'</span>, <span class="number">0</span>) <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        MsgBox(<span class="string">'&#123;#MyAppName&#125; requires Microsoft .NET Framework 4.0 Client Profile.'</span><span class="string">#13#13</span></span><br><span class="line">          <span class="string">'The installer will attempt to install it'</span>, mbInformation, MB_OK);        </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    result := true;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>代码部分已经完成，现在我们可以关注<strong>[Files]</strong>部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Files]</span><br><span class="line">Source: &quot;&#123;#MyDistFolder&#125;\dotNetFx40_Full_setup.exe&quot;; DestDir: &#123;tmp&#125;; Flags: deleteafterinstall; Check: not IsRequiredDotNetDetected</span><br></pre></td></tr></table></figure>

<p>安装程序将复制.NET安装程序文件（这大约是850 KB的智能文件），<strong>只有</strong>在没有已经存在于系统中，到<strong>系统临时</strong>目录。安装完成后，该文件将被删除。现在已经复制了网络安装程序，如果需要，我们需要运行它。 在<strong>[run]</strong>部分中，输入以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Run]</span><br><span class="line">Filename: &#123;tmp&#125;\dotNetFx40_Full_setup.exe; Parameters: &quot;&#x2F;q:a &#x2F;c:&quot;&quot;install &#x2F;l </span><br><span class="line">  &#x2F;q&quot;&quot;&quot;; Check: not IsRequiredDotNetDetected; StatusMsg: Microsoft Framework 4.0 is beïng installed. Please wait...</span><br></pre></td></tr></table></figure>

<h3 id="4-x86-x64选项"><a href="#4-x86-x64选项" class="headerlink" title="4. x86 / x64选项"></a>4. x86 / x64选项</h3><p>此示例显示安装程序如何根据系统体系结构运行。它将安装系统所需的本机库，以进行更智能的安装。在 <strong>[setuo]</strong>部分中，定义以下指令：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArchitecturesInstallIn64BitMode=x64</span><br></pre></td></tr></table></figure>

<p>这两行将根据系统安装一个lib文件夹：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Source: &quot;&#123;#MyDistFolder&#125;\lib\x64\*&quot;; DestDir: &quot;&#123;app&#125;\lib\x64&quot;; Check: Is64BitInstallMode; Flags: ignoreversion recursesubdirs createallsubdirs</span><br><span class="line">Source: &quot;&#123;#MyDistFolder&#125;\lib\x86\*&quot;; DestDir: &quot;&#123;app&#125;\lib\x86&quot;; Check: not Is64BitInstallMode; Flags: ignoreversion recursesubdirs createallsubdirs</span><br></pre></td></tr></table></figure>

<h3 id="5-有关安装-NET过程代码的其它解决方案"><a href="#5-有关安装-NET过程代码的其它解决方案" class="headerlink" title="5. 有关安装.NET过程代码的其它解决方案"></a>5. 有关安装.NET过程代码的其它解决方案</h3><p>如果不行实现InnoSetup中的AfterInstall的标识，希望.NET的安装在文件<strong>[Files]</strong>执行的某一步骤时被执行，就需要主意.NET的执行顺序。请参看如下两部分代码。</p>
<p>使用安装的返回值</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InstallFramework</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\dotNetFx40_Full_x86_x64.exe'</span>), <span class="string">'/q /norestart'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; you can interact with the user that the installation failed &#125;</span></span><br><span class="line">    MsgBox(<span class="string">'.NET installation failed with code: '</span> + IntToStr(ResultCode) + <span class="string">'.'</span>,</span><br><span class="line">      mbError, MB_OK);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>使用进度条显示安装进度，但是由于要获得.NET安装程序的安装进度并不容易，因此我将在安装执行过程中向用户简单显示无休止的选取框进度栏。 即，该进度条仅在此具用于显示，不能准确表示安装的进度。</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InstallFramework</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  StatusText: <span class="keyword">string</span>;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  StatusText := WizardForm.StatusLabel.Caption;</span><br><span class="line">  WizardForm.StatusLabel.Caption := <span class="string">'Installing .NET framework...'</span>;</span><br><span class="line">  WizardForm.ProgressGauge.Style := npbstMarquee;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\dotNetFx45_Full_asetup.exe'</span>), <span class="string">'/q /norestart'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// you can interact with the user that the installation failed</span></span><br><span class="line">    MsgBox(<span class="string">'.NET installation failed with code: '</span> + IntToStr(ResultCode) + <span class="string">'.'</span>,</span><br><span class="line">      mbError, MB_OK);</span><br><span class="line">    CancelWithoutPrompt := true;</span><br><span class="line">    WizardForm.Close;       </span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.StatusLabel.Caption := StatusText;</span><br><span class="line">    WizardForm.ProgressGauge.Style := npbstNormal;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<h3 id="6-提示"><a href="#6-提示" class="headerlink" title="6. 提示"></a>6. 提示</h3><p>Inno 是具有一个内置变量{dotnet40}的，ExpandConstant(‘{dotnet40}’)。其它有关的变量为：</p>
<p><strong>{dotnet11}</strong></p>
<p>32-bit .NET Framework version 1.1 root directory.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 1.1 present.</p>
<p>32位.NET Framework 1.1版根目录。</p>
<p>会将系统扩展到当前的.NET Framework版本1.1会发生例外。</p>
<p><strong>{dotnet20}</strong></p>
<p>.NET Framework version 2.0-3.5 root directory. <code>{dotnet20}</code> is equivalent to <code>{dotnet2032}</code> unless the install is running in [64-bit install mode], in which case it is equivalent to <code>{dotnet2064}</code>.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 2.0-3.5 present.</p>
<p>.NET Framework 2.0-3.5版根目录。除非安装以64位安装模式运行，否则{dotnet20}等效于{dotnet2032}，在这种情况下，等效于{dotnet2064}。</p>
<p>会将系统扩展到当前的.NET Framework版本2.0-3.5将会发生例外。</p>
<p><strong>{dotnet2032}</strong></p>
<p>32-bit .NET Framework version 2.0-3.5 root directory.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 2.0-3.5 present.</p>
<p>32位.NET Framework 2.0-3.5版根目录。</p>
<p>会将系统扩展到当前的.NET Framework版本2.0-3.5将会发生例外。</p>
<p><strong>{dotnet2064}</strong></p>
<p>64-bit Windows only: 64-bit .NET Framework version 2.0-3.5 root directory.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 2.0-3.5 present.</p>
<p>仅适用于64位Windows：64位.NET Framework 2.0-3.5版根目录。</p>
<p>会将系统扩展到当前的.NET Framework版本2.0-3.5将会发生例外。</p>
<p><strong>{dotnet40}</strong></p>
<p>.NET Framework version 4.0 and later root directory. <code>{dotnet40}</code> is equivalent to <code>{dotnet4032}</code> unless the install is running in [64-bit install mode], in which case it is equivalent to <code>{dotnet4064}</code>.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 4.0 or later present.</p>
<p>.NET Framework 4.0版和更高版本的根目录。除非安装以64位安装模式运行，否则{dotnet40}等效于{dotnet4032}，在这种情况下，等效于{dotnet4064}。</p>
<p>将系统扩展到.NET Framework 4.0或更高版本时，将发生例外。</p>
<p><strong>{dotnet4032}</strong></p>
<p>32-bit .NET Framework version 4.0 and later root directory.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 4.0 or later present.</p>
<p>32位.NET Framework 4.0版和更高版本的根目录。</p>
<p>将系统扩展到.NET Framework 4.0或更高版本时，将发生例外。</p>
<p><strong>{dotnet4064}</strong></p>
<p>64-bit Windows only: 64-bit .NET Framework version 4.0 and later root directory.</p>
<p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 4.0 or later present.</p>
<p>仅适用于64位Windows：64位.NET Framework 4.0版和更高版本的根目录。</p>
<p>将系统扩展到.NET Framework 4.0或更高版本时，将发生例外。</p>
<h3 id="7-使用RegAsm-exe-注册-NET-DLL-文件"><a href="#7-使用RegAsm-exe-注册-NET-DLL-文件" class="headerlink" title="7. 使用RegAsm.exe 注册 .NET DLL 文件"></a>7. 使用RegAsm.exe 注册 .NET DLL 文件</h3><p>其中<strong>[run]</strong>的代码如下， 主意其WorkingDir参数，其表示运行注册程序的时候，运行的目录：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Filename: "&#123;dotnet20&#125;\RegAsm.exe"; Parameters: /codebase YourDLL.dll; WorkingDir: &#123;app&#125;; StatusMsg: "Registering Controls..."; Flags: runminimized</span><br></pre></td></tr></table></figure>

<h3 id="8-其它完整解决方案"><a href="#8-其它完整解决方案" class="headerlink" title="8. 其它完整解决方案"></a>8. 其它完整解决方案</h3><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Other parts of installer file go here</span></span><br><span class="line">[CustomMessages]</span><br><span class="line">IDP_DownloadFailed=Download <span class="keyword">of</span> .NET Framework <span class="number">4.7</span>.<span class="number">2</span> failed. .NET Framework <span class="number">4.7</span> <span class="keyword">is</span> required <span class="keyword">to</span> run VidCoder.</span><br><span class="line">IDP_RetryCancel=Click <span class="string">'Retry'</span> <span class="keyword">to</span> <span class="keyword">try</span> downloading the files again, <span class="keyword">or</span> click <span class="string">'Cancel'</span> <span class="keyword">to</span> terminate setup.</span><br><span class="line">InstallingDotNetFramework=Installing .NET Framework <span class="number">4.7</span>.<span class="number">2</span>. This might take a few minutes...</span><br><span class="line">DotNetFrameworkFailedToLaunch=Failed to launch .NET Framework Installer with error "%1". Please fix the error then run this installer again.</span><br><span class="line">DotNetFrameworkFailed1602=.NET Framework installation was cancelled. This installation can <span class="keyword">continue</span>, but be aware that this application may <span class="keyword">not</span> run unless the .NET Framework installation <span class="keyword">is</span> completed successfully.</span><br><span class="line">DotNetFrameworkFailed1603=A fatal error occurred <span class="keyword">while</span> installing the .NET Framework. Please fix the error, <span class="keyword">then</span> run the installer again.</span><br><span class="line">DotNetFrameworkFailed5100=Your computer does <span class="keyword">not</span> meet the requirements <span class="keyword">of</span> the .NET Framework. Please consult the documentation.</span><br><span class="line">DotNetFrameworkFailedOther=The .NET Framework installer exited with an unexpected status code "%1". Please review any other messages shown by the installer to determine whether the installation completed successfully, and abort this installation and fix the problem if it did not.</span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  requiresRestart: boolean;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NetFrameworkIsMissing</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  bSuccess: Boolean;</span><br><span class="line">  regVersion: Cardinal;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := True;</span><br><span class="line"></span><br><span class="line">  bSuccess := RegQueryDWordValue(HKLM, <span class="string">'Software\Microsoft\NET Framework Setup\NDP\v4\Full'</span>, <span class="string">'Release'</span>, regVersion);</span><br><span class="line">  <span class="keyword">if</span> (True = bSuccess) <span class="keyword">and</span> (regVersion &gt;= <span class="number">461308</span>) <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">    Result := False;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> NetFrameworkIsMissing() <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    idpAddFile(<span class="string">'http://go.microsoft.com/fwlink/?LinkId=863262'</span>, ExpandConstant(<span class="string">'&#123;tmp&#125;\NetFrameworkInstaller.exe'</span>));</span><br><span class="line">    idpDownloadAfter(wpReady);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFramework</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  StatusText: <span class="keyword">string</span>;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  StatusText := WizardForm.StatusLabel.Caption;</span><br><span class="line">  WizardForm.StatusLabel.Caption := CustomMessage(<span class="string">'InstallingDotNetFramework'</span>);</span><br><span class="line">  WizardForm.ProgressGauge.Style := npbstMarquee;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\NetFrameworkInstaller.exe'</span>), <span class="string">'/passive /norestart /showrmui /showfinalerror'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedToLaunch'</span>), [SysErrorMessage(resultCode)]);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      <span class="comment">// See https://msdn.microsoft.com/en-us/library/ee942965(v=vs.110).aspx#return_codes</span></span><br><span class="line">      <span class="keyword">case</span> resultCode <span class="keyword">of</span></span><br><span class="line">        <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// Successful</span></span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">          MsgBox(CustomMessage(<span class="string">'DotNetFrameworkFailed1602'</span>), mbInformation, MB_OK);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">          Result := CustomMessage(<span class="string">'DotNetFrameworkFailed1603'</span>);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">          requiresRestart := True;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">          requiresRestart := True;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">          Result := CustomMessage(<span class="string">'DotNetFrameworkFailed5100'</span>);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">          MsgBox(FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedOther'</span>), [IntToStr(resultCode)]), mbError, MB_OK);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">      <span class="keyword">end</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.StatusLabel.Caption := StatusText;</span><br><span class="line">    WizardForm.ProgressGauge.Style := npbstNormal;</span><br><span class="line"></span><br><span class="line">    DeleteFile(ExpandConstant(<span class="string">'&#123;tmp&#125;\NetFrameworkInstaller.exe'</span>));</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PrepareToInstall</span><span class="params">(<span class="keyword">var</span> NeedsRestart: Boolean)</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// 'NeedsRestart' only has an effect if we return a non-empty string, thus aborting the installation.</span></span><br><span class="line">  <span class="comment">// If the installers indicate that they want a restart, this should be done at the end of installation.</span></span><br><span class="line">  <span class="comment">// Therefore we set the global 'restartRequired' if a restart is needed, and return this from NeedRestart()</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> NetFrameworkIsMissing() <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    Result := InstallFramework();</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NeedRestart</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := requiresRestart;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>根据此版本修改后适用于自己项目的.NET框架安装代码如下：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFrameworkWebRuntime</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WasVisible: Boolean;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkWebInstaller&#125;'</span>);</span><br><span class="line">  WasVisible := WizardForm.PreparingLabel.Visible;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      WizardForm.PreparingLabel.Visible := True;</span><br><span class="line">      WizardForm.PreparingLabel.Caption := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkWebInstallerCaption'</span>), [TO_COMPARE_DOT_NET]);</span><br><span class="line">      ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkWebInstaller&#125;'</span>);</span><br><span class="line">      <span class="comment">//if not Exec(ExpandConstant('&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;'), '/q /norestart', '', SW_SHOW, ewWaitUntilTerminated, ResultCode) then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;'</span>), <span class="string">'/passive /norestart /showrmui /showfinalerror'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-</span></span><br><span class="line">          <span class="comment">// you can interact with the user that the installation failed, for example: error code 2: the system cannot find the file specified.</span></span><br><span class="line">          Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedToLaunch'</span>), [SysErrorMessage(ResultCode)])     </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">case</span> ResultCode <span class="keyword">of</span></span><br><span class="line">            <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">// Successful</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">              MsgBox(CustomMessage(<span class="string">'DotNetFrameworkFailed1602'</span>), mbInformation, MB_OK);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed1603'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed5100'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">//MsgBox(FmtMessage(CustomMessage('DotNetFrameworkFailedOther'), [IntToStr(resultCode)]), mbError, MB_OK);</span></span><br><span class="line">              Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedOther'</span>), IntToStr(ResultCode));     </span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">          <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.PreparingLabel.Visible := WasVisible;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  DeleteFile(ExpandConstant(<span class="string">'&#123;tmp&#125;&#123;#DotNetFrameWorkWebInstaller&#125;'</span>));</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>上述代码中</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkWebInstaller&#125;'</span>);</span><br></pre></td></tr></table></figure>

<p>强制解压安装文件。该动作早于[Files]的运行。在安装结束之后删除该文件，使用代码如：</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DeleteFile(ExpandConstant(<span class="string">'&#123;tmp&#125;&#123;#DotNetFrameWorkWebInstaller&#125;'</span>));</span><br></pre></td></tr></table></figure>

<p>有关.NET安装包运行时的错误代码可以参考连接：</p>
<p>// See <a href="https://msdn.microsoft.com/en-us/library/ee942965%28v=vs.110%29.aspx#return_codes" target="_blank" rel="noopener">https://msdn.microsoft.com/en-us/library/ee942965(v=vs.110).aspx#return_codes</a></p>
<p>有关Exec函数，其错误代码为Windows系统错误代码，运行时的错误文本，可以参考连接：</p>
<p>// See [<a href="https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-]" target="_blank" rel="noopener">https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-]</a>(</p>
<h3 id="9-Inno-Setup-对注册表的操作"><a href="#9-Inno-Setup-对注册表的操作" class="headerlink" title="9. Inno Setup 对注册表的操作"></a>9. Inno Setup 对注册表的操作</h3><p>由于安装.NET的框架的目的就是要使用一下依赖.NET框架的动态库文件。而这部分DLL文件能够顺利使用就需要对该DLL文件进行注册。</p>
<h4 id="9-1-Regasm-程序集注册工具"><a href="#9-1-Regasm-程序集注册工具" class="headerlink" title="9.1 Regasm  程序集注册工具"></a>9.1 Regasm  程序集注册工具</h4><p><strong>Regasm 简介 ：</strong></p>
<p>EXE files such as RegAsm.exe are categorized as Executable Application (Windows Executable) files. As a Windows Executable file, it was created for use in Windows 10 by [Microsoft].</p>
<p>像RegAsm.exe这样的EXE文件都被分类为可执行应用程序（Windows Executable）文件。 作为Windows可执行文件，它由Microsoft创建供Windows 10使用。</p>
<p>The first version of RegAsm.exe for Windows Vista was introduced on 11/08/2006 in Windows Vista. The most recent version [file version 10] was introduced on 07/29/2015 for Windows 10. RegAsm.exe is bundled with the software package in Windows 10, Windows 8.1, and Windows 8.</p>
<p>Windows Vista的RegAsm.exe的第一版于2006年11月8日在Windows Vista中引入。 Windows 10的最新版本（文件版本10）已于07/29/2015引入。RegAsm.exe与Windows 10，Windows 8.1和Windows 8中的软件包捆绑在一起。</p>
<p>Please see below for more detailed information, <a href="https://www.exefiles.com/en/extensions/exe/all-files/" target="_blank" rel="noopener">EXE</a> file troubleshooting instructions, and free downloads of different versions of RegAsm.exe.</p>
<p>请参阅下面的详细信息，EXE文件故障排除说明以及RegAsm.exe不同版本的免费下载。</p>
<p><strong>作用：</strong> 读取程序集中的元数据，并将所需的项添加到注册表中。注册表允许 COM 客户程序以透明方式创建 .NET Framework 类。类一经注册，任何 COM 客户程序都可以使用它，就好像该类是一个 COM 类。类仅在安装程序集时注册一次。程序集中的类实例直到被实际注册时，才能从 COM 中创建。</p>
<p><strong>使用方法：</strong></p>
<p>regasm assemblyFile [options]</p>
<p><strong>重要参数：</strong></p>
<p>/codebase 在注册表中创建一个 Codebase 项。Codebase 项指定未安装到全局程序集缓存中的程序集的文件路径。如果随后要安装正在注册到全局程序集缓存中的程序集，则不应指定此选项。用 /codebase 选项指定的 assemblyFile 参数必须是具有强名称的程序集。</p>
<h4 id="9-2-Regsvr32-程序集注册工具"><a href="#9-2-Regsvr32-程序集注册工具" class="headerlink" title="9.2 Regsvr32  程序集注册工具"></a>9.2 Regsvr32  程序集注册工具</h4><p><strong>作用：</strong> Regsvr32命令用于注册COM组件，是 Windows 系统提供的用来向系统注册控件或者卸载控件的命令，以命令行方式运行。WinXP及以上系统的regsvr32.exe在windows\system32文件夹下；2000系统的regsvr32.exe在winnt\system32文件夹下。</p>
<h4 id="9-3-两个DLL注册工具的差异"><a href="#9-3-两个DLL注册工具的差异" class="headerlink" title="9.3 两个DLL注册工具的差异"></a>9.3 两个DLL注册工具的差异</h4><p>使用regasm.exe来注册.NET 组件，regsvr32并不适用于.NET组件。 （或者您也可以将regasm.exe理解为.NET的regsvr32）。regsvr32不适用于.NET的组件的注册，感觉意思是对于非托管的代码使用regsvr32来注册，对于托管的代码使用regasm来注册。</p>
<p><code>regsvr32</code> will load the library and try to call the <code>DllRegisterServer()</code> from that library. It doesn’t care what <code>DllRegisterServer()</code> actually does - it just calls that function and checks the returned value. You use it to register COM servers in unmanaged DLLs. It can’t generate a .tlb file.</p>
<p>regsvr32将加载该库并尝试从该库中调用DllRegisterServer（）。 不管DllRegisterServer（）实际做什么，它只是调用该函数并检查返回的值。 您可以使用它在非托管DLL中注册COM服务器。 无法生成.tlb文件。</p>
<p><code>regasm</code> will register a COM-exposed .NET assembly as a COM server. You use it for .NET assemblies. It can generate a .tlb file given the assembly only - it inspects the type infromation stored in the assembly and includes the COM-exposed entities into the type library.</p>
<p>regasm将把暴露于COM的.NET程序集注册为COM服务器。 您将其用于.NET程序集。 仅在给定程序集的情况下，它可以生成.tlb文件-它检查存储在程序集中的类型信息，并将COM公开的实体包括到类型库中。</p>
<h4 id="9-4-NET中“托管代码”和“非托管代码”的区别"><a href="#9-4-NET中“托管代码”和“非托管代码”的区别" class="headerlink" title="9.4  .NET中“托管代码”和“非托管代码”的区别"></a>9.4  .NET中“托管代码”和“非托管代码”的区别</h4><p><strong>托管代码</strong> <strong>(managed code)</strong></p>
<p>托管代码是Visual Basic .NET和C#编译器创建的代码。它运行在CLR(公共语言运行时)，除其他外，它提供像垃圾收集，运行时类型检查和引用检查的服务。所以，认为它是，“我的代码是由CLR管理。</p>
<p>Visual Basic和C#只能生成托管代码，所以，如果你正在用这些语言编写一个应用程序，你正在写一个由CLR管理的应用程序。如果您在Visual C .NET中编写应用程序，您可以根据需要生成托管代码，但它是可选的。</p>
<p><strong>非托管代码</strong> <strong>(unmanaged code)</strong></p>
<p>非托管代码直接编译为机器代码。因此，通过该定义，所有由传统C/C++编译器编译的代码是“非托管代码”。此外，由于它编译为机器代码而不是中间语言，所以它是不可移植的。</p>
<p>没有可用的内存管理或任何其他CLR提供。</p>
<p>由于您不能使用Visual Basic或C#创建非托管代码，在Visual Studio中，所有非托管代码都用C/C++编写。</p>
<p><strong>混合两者</strong></p>
<p>由于Visual C可以编译为托管代码或非托管代码，因此可以在同一个应用程序中混合这两个代码。这模糊了两者之间的界限，并使定义复杂化，但值得一提的是，你知道，如果你使用的第三方库有一些严重的非托管代码，你仍然可能有内存泄漏。</p>
<p><strong>区别：</strong></p>
<p>1、托管代码是一种中间语言，运行在CLR上；</p>
<p> 非托管代码被编译为机器码，运行在机器上。</p>
<p>2、托管代码独立于平台和语言，能更好的实现不同语言平台之间的兼容；</p>
<p> 非托管代码依赖于平台和语言。</p>
<p>3、托管代码可享受CLR提供的服务（如安全检测、垃圾回收等），不需要自己完成这些操作；</p>
<p> 非托管代码需要自己提供安全检测、垃圾回收等操作。</p>
<p>托管代码就意味着托管数据？答案是否定的。</p>
<p>对于Visual Basic和C#来说，生活是简单的，因为你没有其它选择。当你在那些语言里面声明一个类，那么这个类的实例会在托管堆中被创建，垃圾收集器(GC)会帮我们管理这些对象的回收。但是在Visual C++中，你有另一个选择。即使你正创建一个托管程序，你可以决定哪些类是托管类型，哪些类是非托管类型的。</p>
<p>这就是非托管类型：</p>
<p>class Foo { private: int x; public: Foo(): x(0){} Foo(int xx): x(xx) {} };</p>
<p>这就是托管类型</p>
<p>__gc class Bar { private: int x; public: Bar(): x(0){} Bar(int xx): x(xx) {} };</p>
<p>他们唯一的区别就是类Bar的定义中有__gc关键字。这个关键字会给代码带来巨大的区别。</p>
<h4 id="9-5-使用Inno-Setup的-Registry-段注册-NET相关DLL文件"><a href="#9-5-使用Inno-Setup的-Registry-段注册-NET相关DLL文件" class="headerlink" title="9.5 使用Inno Setup的 [Registry] 段注册.NET相关DLL文件"></a>9.5 使用Inno Setup的 [Registry] 段注册.NET相关DLL文件</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[Registry]</span><br><span class="line">; ProgID part, TechTemp</span><br><span class="line">Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletekeyifempty</span><br><span class="line">Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID"; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID"; ValueType: string; ValueName: ""; ValueData: "&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part, TechTemp </span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; Flags: uninsdeletekeyifempty</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; ValueType: string; ValueName: ""; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part\InprocServer32, TechTemp</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: ""; ValueData: "mscoree.dll"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "ThreadingModel"; ValueData: "Both"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "Class"; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "Assembly"; ValueData: "xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "RuntimeVersion"; ValueData: "v4.0.30319"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "CodeBase"; ValueData: "file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll"; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part\InprocServer32\<span class="number">1.0</span>.<span class="number">0.0</span>, TechTemp</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "Class"; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "Assembly"; ValueData: "xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "RuntimeVersion"; ValueData: "v4.0.30319"; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "CodeBase"; ValueData: "file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll"; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part\Implemented Categories, TechTemp</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories"; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories\&#123;&#123;&#123;#DotNetDllCLSIDImplementedCategories&#125;&#125;"; Flags: uninsdeletekey</span><br><span class="line">; CLSID Part\ProgId, TechTemp</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId"; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId"; ValueType: string; ValueName: ""; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br></pre></td></tr></table></figure>

<h3 id="10-项目完整代码，最小测试版"><a href="#10-项目完整代码，最小测试版" class="headerlink" title="10. 项目完整代码，最小测试版"></a>10. 项目完整代码，最小测试版</h3><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br></pre></td><td class="code"><pre><span class="line">; -- Example1.iss --</span><br><span class="line">; Demonstrates copying <span class="number">3</span> files <span class="keyword">and</span> creating an icon.</span><br><span class="line"></span><br><span class="line">; SEE THE DOCUMENTATION <span class="keyword">FOR</span> DETAILS <span class="keyword">ON</span> CREATING .ISS SCRIPT FILES!</span><br><span class="line"></span><br><span class="line">#define ********AppPath</span><br><span class="line">#expr ********AppPath = "\********\trunk\hcnt\wire\"</span><br><span class="line"></span><br><span class="line">#define DotNetRegistToolPath</span><br><span class="line">#expr DotNetRegistToolPath = ""</span><br><span class="line"></span><br><span class="line">#define DotNetFrameWorkInstallerPath</span><br><span class="line">#expr DotNetFrameWorkInstallerPath = "..\NET\NET_Framework_Runtime\462\"</span><br><span class="line"></span><br><span class="line">#define DotNet4OCTechTemplDllPath</span><br><span class="line">#expr DotNet4OCTechTemplDllPath = "..\helper\xxxxxxxxxxxxxxxxxxx"</span><br><span class="line"></span><br><span class="line">#define DotNetFrameWorkOfflineInstaller</span><br><span class="line">#expr DotNetFrameWorkOfflineInstaller = "ndp48-x86-x64-allos-enu.exe"</span><br><span class="line"></span><br><span class="line">#define DotNetFrameWorkWebInstaller</span><br><span class="line">#expr DotNetFrameWorkWebInstaller = "ndp48-web.exe"</span><br><span class="line"></span><br><span class="line">;#define DotNetDllCLSID</span><br><span class="line">;#expr DotNetDllCLSID = "62519924-26A8-3770-9F82-0A0BC26EE7D4"</span><br><span class="line"></span><br><span class="line">;#define DotNetDllCLSIDImplementedCategories</span><br><span class="line">;#expr DotNetDllCLSIDImplementedCategories = "62C8FE65-4EBB-45E7-B440-6E39B2CDBF29"</span><br><span class="line"></span><br><span class="line">;#define AppPathBackSlash</span><br><span class="line">;#expr AppPathBackSlash = "********/trunk/hcnt/wire"</span><br><span class="line"></span><br><span class="line">;#define CommonappdataPathBackSlash</span><br><span class="line">;#expr CommonappdataPathBackSlash = "C:/ProgramData"</span><br><span class="line"></span><br><span class="line">[Setup]</span><br><span class="line">;SignTool=MyCustom sign /a /tr http:<span class="comment">//sha256timestamp.ws.symantec.com/sha256/timestamp /d $q******** for SolidWorks 2020 Beta3$q $f</span></span><br><span class="line">PrivilegesRequired=admin </span><br><span class="line">AppName=My <span class="keyword">Program</span></span><br><span class="line">AppVersion=<span class="number">1.5</span></span><br><span class="line">WizardStyle=modern</span><br><span class="line">DefaultDirName=<span class="comment">&#123;autopf&#125;</span>\My <span class="keyword">Program</span></span><br><span class="line">DefaultGroupName=My <span class="keyword">Program</span></span><br><span class="line">UninstallDisplayIcon=<span class="comment">&#123;app&#125;</span>\MyProg.exe</span><br><span class="line">Compression=lzma2</span><br><span class="line">SolidCompression=yes</span><br><span class="line">OutputDir=userdocs:Inno Setup Examples Output</span><br><span class="line">ArchitecturesInstallIn64BitMode = x64</span><br><span class="line">ArchitecturesAllowed = x64</span><br><span class="line">SetupLogging=yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Languages]</span><br><span class="line"><span class="keyword">Name</span>: ENGLISH; MessagesFile: compiler:<span class="keyword">Default</span>.isl</span><br><span class="line"><span class="keyword">Name</span>: DEUTSCH; MessagesFile: compiler:Languages\German.isl; </span><br><span class="line"></span><br><span class="line">[Files]</span><br><span class="line">; .NET Part</span><br><span class="line">; .NET Framework Runtime, offline installer english all os runtime </span><br><span class="line">Source: "&#123;#DotNetFrameWorkInstallerPath&#125;&#123;#DotNetFrameWorkOfflineInstaller&#125;"; DestDir: "&#123;tmp&#125;"; Flags: dontcopy noencryption;</span><br><span class="line">; .NET Framework Runtime, web installer <span class="keyword">for</span> other languages</span><br><span class="line">Source: "&#123;#DotNetFrameWorkInstallerPath&#125;&#123;#DotNetFrameWorkWebInstaller&#125;"; DestDir: "&#123;tmp&#125;"; Flags: dontcopy noencryption;</span><br><span class="line">; xxxxxxxxxxxxxxxxxxx.dll + Hilfsdlls</span><br><span class="line">Source: "&#123;#DotNet4OCTechTemplDllPath&#125;\*.*"; DestDir: "&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\"; Flags: ignoreversion recursesubdirs; Permissions: everyone-full;</span><br><span class="line"></span><br><span class="line">Source: "MyProg.exe"; DestDir: "&#123;app&#125;"</span><br><span class="line">Source: "MyProg.chm"; DestDir: "&#123;app&#125;"</span><br><span class="line">Source: "Readme.txt"; DestDir: "&#123;app&#125;"; Flags: isreadme</span><br><span class="line"></span><br><span class="line">[Run]</span><br><span class="line">; Regist the .NET DLL <span class="keyword">file</span> by using the tool regasm.exe, return <span class="number">0</span>: ERROR_SUCCESS; <span class="number">1</span>:ERROR_INVALID_FUNCTION; <span class="number">2</span>:ERROR_FILE_NOT_FOUND; <span class="number">3</span>: ERROR_PATH_NOT_FOUND  </span><br><span class="line">Filename:  &#123;code:GetCurrentRegAsmPath|&#123;#DotNetRegistToolPath&#125;&#125;\regasm.exe; Parameters: " ""&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\xxxxxxxxxxxxxxxxxxx.dll"" /codebase /verbose"; WorkingDir: "&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\"; StatusMsg: Registering DLLs; Flags: 64bit runhidden waituntilterminated;</span><br><span class="line"></span><br><span class="line">[UninstallRun]</span><br><span class="line">; Regist the .NET DLL <span class="keyword">file</span> by using the tool regasm.exe, return <span class="number">0</span>: ERROR_SUCCESS; <span class="number">1</span>:ERROR_INVALID_FUNCTION; <span class="number">2</span>:ERROR_FILE_NOT_FOUND; <span class="number">3</span>: ERROR_PATH_NOT_FOUND  </span><br><span class="line">Filename:  &#123;code:GetCurrentRegAsmPath|&#123;#DotNetRegistToolPath&#125;&#125;\regasm.exe; Parameters: "/unregister ""&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\xxxxxxxxxxxxxxxxxxx.dll"" /codebase /verbose"; WorkingDir: "&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\"; StatusMsg: Unregistering DLLs; Flags: 64bit runhidden waituntilterminated;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[CustomMessages]</span><br><span class="line">; .NET Framwork installation processing </span><br><span class="line">ENGLISH.DotNetFrameworkOfflineInstallerCaption = Installing Microsoft .NET framework %<span class="number">1</span> offline installer <span class="keyword">for</span> Windows...</span><br><span class="line">ENGLISH.DotNetFrameworkWebInstallerCaption = Installing Microsoft .NET framework %<span class="number">1</span> Web installer <span class="keyword">for</span> Windows...</span><br><span class="line">ENGLISH.DotNetFrameworkFailedToLaunch = .NET installation failed <span class="keyword">with</span> code: %<span class="number">1</span>. Please fix the error <span class="keyword">then</span> run this installer again.</span><br><span class="line">ENGLISH.DotNetFrameworkFailed1602 = .NET Framework installation was cancelled. This installation can <span class="keyword">continue</span>, but be aware that this application may <span class="keyword">not</span> run unless the .NET Framework installation <span class="keyword">is</span> completed successfully.</span><br><span class="line">ENGLISH.DotNetFrameworkFailed1603 = A fatal error occurred <span class="keyword">while</span> installing the .NET Framework. Please fix the error, <span class="keyword">then</span> run the installer again.</span><br><span class="line">ENGLISH.DotNetFrameworkFailed5100 = Your computer does <span class="keyword">not</span> meet the requirements <span class="keyword">of</span> the .NET Framework. Please consult the documentation.</span><br><span class="line">ENGLISH.DotNetFrameworkFailedOther = The .NET Framework installer exited with an unexpected status code "%1". Please review any other messages shown by the installer to determine whether the installation completed successfully, and abort this installation and fix the problem if it did not.</span><br><span class="line"></span><br><span class="line">; .NET Framwork installation processing </span><br><span class="line">DEUTSCH.DotNetFrameworkOfflineInstallerCaption = Installation von Microsoft .NET Framework %<span class="number">1</span> offline Installationsprogramm für Windows ...</span><br><span class="line">DEUTSCH.DotNetFrameworkWebInstallerCaption = Installation von Microsoft .NET Framework %<span class="number">1</span> Web Installationsprogramm für Windows ...</span><br><span class="line">DEUTSCH.DotNetFrameworkFailedToLaunch = .NET Installation fehlgeschlagen mit Code: %<span class="number">1</span>. Bitte beheben Sie den Fehler und führen Sie das Installationsprogramm erneut aus.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailed1602 = .NET Framework-Installation wurde abgebrochen. Diese Installation kann fortgesetzt werden. Beachten Sie jedoch, dass diese Anwendung möglicherweise erst ausgeführt wird, wenn die .NET Framework-Installation erfolgreich abgeschlossen wurde.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailed1603 = Bei der Installation von .NET Framework ist ein schwerwiegender Fehler aufgetreten. Bitte beheben Sie den Fehler und führen Sie das Installationsprogramm erneut aus.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailed5100 = Ihr Computer entspricht nicht den Anforderungen von .NET Framework. Bitte konsultieren Sie die Dokumentation.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailedOther = Das .NET Framework-Installationsprogramm wurde mit dem unerwarteten Statuscode "%1" beendet. Überprüfen Sie alle anderen vom Installationsprogramm angezeigten Meldungen, um festzustellen, ob die Installation erfolgreich abgeschlossen wurde, und brechen Sie diese Installation ab, und beheben Sie das Problem, wenn dies nicht der Fall ist.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;; Please <span class="keyword">do</span> <span class="keyword">not</span> delete the following, you can use it <span class="keyword">to</span> check the resgition <span class="keyword">of</span> the .NET DLL xxxxxxxxxxxxxxxxxxx.dll </span><br><span class="line">;; ProgID part, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletekeyifempty</span><br><span class="line">;Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID"; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID"; ValueType: string; ValueName: ""; ValueData: "&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part, TechTemp </span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; Flags: uninsdeletekeyifempty</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;"; ValueType: string; ValueName: ""; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part\InprocServer32, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: ""; ValueData: "mscoree.dll"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "ThreadingModel"; ValueData: "Both"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "Class"; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "Assembly"; ValueData: "xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "RuntimeVersion"; ValueData: "v4.0.30319"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32"; ValueType: string; ValueName: "CodeBase"; ValueData: "file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll"; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part\InprocServer32\<span class="number">1.0</span>.<span class="number">0.0</span>, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "Class"; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "Assembly"; ValueData: "xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "RuntimeVersion"; ValueData: "v4.0.30319"; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0"; ValueType: string; ValueName: "CodeBase"; ValueData: "file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll"; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part\Implemented Categories, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories"; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories\&#123;&#123;&#123;#DotNetDllCLSIDImplementedCategories&#125;&#125;"; Flags: uninsdeletekey</span><br><span class="line">;; CLSID Part\ProgId, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId"; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: "CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId"; ValueType: string; ValueName: ""; ValueData: "XXXXXXXXXXXX.MMMMMMMMMMMMMMM"; Flags: uninsdeletevalue</span><br><span class="line"></span><br><span class="line">[Icons]</span><br><span class="line">Name: "&#123;group&#125;\My Program"; Filename: "&#123;app&#125;\MyProg.exe"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"><span class="keyword">const</span> TO_COMPARE_DOT_NET = <span class="string">'v4.6.2'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bCancelWithoutPrompt: boolean;</span><br><span class="line">    bConnectWithNetwork: boolean;</span><br><span class="line">    bRequiresRestart: boolean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetCurrentRegAsmPath</span><span class="params">(S: <span class="keyword">String</span>)</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span> version: <span class="keyword">String</span>;</span><br><span class="line">    key: <span class="keyword">String</span>;</span><br><span class="line">    installPath: <span class="keyword">String</span>;</span><br><span class="line">    success: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    Result := S;</span><br><span class="line">    <span class="comment">// .NET 4.6.2 installs also as update to .NET 4.0 Full, you can also be on the safe side, check the windows 10 anniversary update</span></span><br><span class="line">    <span class="comment">// if the build was newer than (build 10.0.14393) with the code GetWindowsVersion &gt;= $A003839</span></span><br><span class="line">    <span class="keyword">if</span> TO_COMPARE_DOT_NET = <span class="string">'v4.6.2'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">'v4\Full'</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">    <span class="comment">// .NET 4.5 installs as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">if</span> TO_COMPARE_DOT_NET = <span class="string">'v4.5'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">'v4\Full'</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">'SOFTWARE\Microsoft\NET Framework Setup\NDP\'</span> + version;</span><br><span class="line">    success := RegQueryStringValue(HKLM, key, <span class="string">'InstallPath'</span>, installPath);</span><br><span class="line">    <span class="keyword">if</span> (success = True) <span class="keyword">and</span> (S = <span class="string">''</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      Result := installPath;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFrameworkWebRuntime</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WasVisible: Boolean;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkWebInstaller&#125;'</span>);</span><br><span class="line">  WasVisible := WizardForm.PreparingLabel.Visible;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      WizardForm.PreparingLabel.Visible := True;</span><br><span class="line">      WizardForm.PreparingLabel.Caption := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkWebInstallerCaption'</span>), [TO_COMPARE_DOT_NET]);</span><br><span class="line">      ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkWebInstaller&#125;'</span>);</span><br><span class="line">      <span class="comment">//if not Exec(ExpandConstant('&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;'), '/q /norestart', '', SW_SHOW, ewWaitUntilTerminated, ResultCode) then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;'</span>), <span class="string">'/passive /norestart /showrmui /showfinalerror'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-</span></span><br><span class="line">          <span class="comment">// you can interact with the user that the installation failed, for example: error code 2: the system cannot find the file specified.</span></span><br><span class="line">          Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedToLaunch'</span>), [SysErrorMessage(ResultCode)])     </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">case</span> ResultCode <span class="keyword">of</span></span><br><span class="line">            <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">// Successful</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">              MsgBox(CustomMessage(<span class="string">'DotNetFrameworkFailed1602'</span>), mbInformation, MB_OK);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed1603'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed5100'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">//MsgBox(FmtMessage(CustomMessage('DotNetFrameworkFailedOther'), [IntToStr(resultCode)]), mbError, MB_OK);</span></span><br><span class="line">              Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedOther'</span>), IntToStr(ResultCode));     </span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">          <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.PreparingLabel.Visible := WasVisible;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  DeleteFile(ExpandConstant(<span class="string">'&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;'</span>));</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFrameworkOfflineRuntime</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WasVisible: Boolean;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  WasVisible := WizardForm.PreparingLabel.Visible;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      WizardForm.PreparingLabel.Visible := True;</span><br><span class="line">      WizardForm.PreparingLabel.Caption := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkOfflineInstallerCaption'</span>), [TO_COMPARE_DOT_NET]);</span><br><span class="line">      ExtractTemporaryFile(<span class="string">'&#123;#DotNetFrameWorkOfflineInstaller&#125;'</span>);</span><br><span class="line">      <span class="comment">//if not Exec(ExpandConstant('&#123;tmp&#125;\&#123;#DotNetFrameWorkOfflineInstaller&#125;'), '/q /norestart', '', SW_SHOW, ewWaitUntilTerminated, ResultCode) then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">'&#123;tmp&#125;\&#123;#DotNetFrameWorkOfflineInstaller&#125;'</span>), <span class="string">'/passive /norestart /showrmui /showfinalerror'</span>, <span class="string">''</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-</span></span><br><span class="line">          <span class="comment">// you can interact with the user that the installation failed, for example: error code 2: the system cannot find the file specified.</span></span><br><span class="line">          Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedToLaunch'</span>), [SysErrorMessage(ResultCode)])     </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">case</span> ResultCode <span class="keyword">of</span></span><br><span class="line">            <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">// Successful</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">              MsgBox(CustomMessage(<span class="string">'DotNetFrameworkFailed1602'</span>), mbInformation, MB_OK);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed1603'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">'DotNetFrameworkFailed5100'</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">//MsgBox(FmtMessage(CustomMessage('DotNetFrameworkFailedOther'), [IntToStr(resultCode)]), mbError, MB_OK);</span></span><br><span class="line">              Result := FmtMessage(CustomMessage(<span class="string">'DotNetFrameworkFailedOther'</span>), IntToStr(ResultCode));</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">          <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.PreparingLabel.Visible := WasVisible;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  DeleteFile(ExpandConstant(<span class="string">'&#123;tmp&#125;\&#123;#DotNetFrameWorkOfflineInstaller&#125;'</span>));</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsNetWorkActivatedTried</span>:</span> boolean;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WinHttpReq: Variant;</span><br><span class="line">  Connected: Boolean;</span><br><span class="line">  iTriedTime: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Connected := False;</span><br><span class="line">  iTriedTime := <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">repeat</span></span><br><span class="line">    iTriedTime := iTriedTime + <span class="number">1</span>;</span><br><span class="line">    Log(<span class="string">'Checking connection to the server, try '</span> +  + IntToStr(iTriedTime) + <span class="string">' time.'</span>);</span><br><span class="line">    <span class="keyword">try</span> </span><br><span class="line">      WinHttpReq := CreateOleObject(<span class="string">'WinHttp.WinHttpRequest.5.1'</span>);</span><br><span class="line">      WinHttpReq.SetTimeouts(<span class="string">'3000'</span>, <span class="string">'3000'</span>, <span class="string">'3000'</span>, <span class="string">'3000'</span>);</span><br><span class="line">      <span class="comment">// Use your real server host name </span></span><br><span class="line">      WinHttpReq.Open(<span class="string">'GET'</span>, <span class="string">'https://www.camtek.de/'</span>, False);</span><br><span class="line">      WinHttpReq.Send(<span class="string">''</span>);</span><br><span class="line">      Log(<span class="string">'Connected to the server; status: '</span> + IntToStr(WinHttpReq.Status) + <span class="string">' '</span> +</span><br><span class="line">          WinHttpReq.StatusText);</span><br><span class="line">      Connected := True;</span><br><span class="line">    <span class="keyword">except</span></span><br><span class="line">      Log(<span class="string">'Error connecting to the server, msg: '</span> + GetExceptionMessage + <span class="string">'try again! '</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">until</span> (iTriedTime = <span class="number">3</span>) <span class="keyword">or</span> (Connected = True) ;</span><br><span class="line">  Result := Connected;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsDotNetDetected</span><span class="params">(version: <span class="keyword">string</span>; service: cardinal)</span>:</span> boolean;</span><br><span class="line"><span class="comment">// Indicates whether the specified version and service pack of the .NET Framework is installed.</span></span><br><span class="line"><span class="comment">// see the link: https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed?redirectedfrom=MSDN#net_b</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// version -- Specify one of these strings for the required .NET Framework version:</span></span><br><span class="line"><span class="comment">//    'v1.1.4322'     .NET Framework 1.1</span></span><br><span class="line"><span class="comment">//    'v2.0.50727'    .NET Framework 2.0</span></span><br><span class="line"><span class="comment">//    'v3.0'          .NET Framework 3.0</span></span><br><span class="line"><span class="comment">//    'v3.5'          .NET Framework 3.5</span></span><br><span class="line"><span class="comment">//    'v4\Client'     .NET Framework 4.0 Client Profile</span></span><br><span class="line"><span class="comment">//    'v4\Full'       .NET Framework 4.0 Full Installation</span></span><br><span class="line"><span class="comment">//    'v4.5'          .NET Framework 4.5 378389</span></span><br><span class="line"><span class="comment">//    'v4.6'          .NET Framework 4.6 393295</span></span><br><span class="line"><span class="comment">//    'v4.6.1'        .NET Framework 4.6.1 394254</span></span><br><span class="line"><span class="comment">//    'v4.6.2'        .NET Framework 4.6.2 394802</span></span><br><span class="line"><span class="comment">//    'v4.7'          .NET Framework 4.7 393295</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// service -- Specify any non-negative integer for the required service pack level:</span></span><br><span class="line"><span class="comment">//    0               No service packs required</span></span><br><span class="line"><span class="comment">//    1, 2, etc.      Service pack 1, 2, etc. required</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    key: <span class="keyword">string</span>;</span><br><span class="line">    install, release, serviceCount: cardinal;</span><br><span class="line">    check45, check462, success: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.6.2 installs also as update to .NET 4.0 Full, you can also be on the safe side, check the windows 10 anniversary update</span></span><br><span class="line">    <span class="comment">// if the build was newer than (build 10.0.14393) with the code GetWindowsVersion &gt;= $A003839</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">'v4.6.2'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">'v4\Full'</span>;</span><br><span class="line">        check462 := true;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        check462 := false;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 installs as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">'v4.5'</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">'v4\Full'</span>;</span><br><span class="line">        check45 := true;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        check45 := false;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">'SOFTWARE\Microsoft\NET Framework Setup\NDP\'</span> + version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 3.0 uses value InstallSuccess in subkey Setup</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v3.0'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key + <span class="string">'\Setup'</span>, <span class="string">'InstallSuccess'</span>, install);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key, <span class="string">'Install'</span>, install);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.0/4.5 uses value Servicing instead of SP</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">'v4'</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Servicing'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'SP'</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 uses additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> check45 <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Release'</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= <span class="number">378389</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.6.2 uses additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> check462 <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">'Release'</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= <span class="number">394802</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    Result := success <span class="keyword">and</span> (install = <span class="number">1</span>) <span class="keyword">and</span> (serviceCount &gt;= service);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsRequiredDotNetDetected</span>:</span> Boolean;  </span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    Result := IsDotNetDetected(TO_COMPARE_DOT_NET, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallDotNetOfflineRuntime</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bConnectWithNetwork <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        Result := True;</span><br><span class="line">      <span class="keyword">end</span> </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> ActiveLanguage = <span class="string">'ENGLISH'</span> <span class="keyword">then</span></span><br><span class="line">          <span class="keyword">begin</span></span><br><span class="line">             Result := True;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">          <span class="keyword">begin</span></span><br><span class="line">            Result := False;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallDotNetWebRuntime</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> bConnectWithNetwork) <span class="keyword">and</span> ( <span class="keyword">not</span> ActiveLanguage = <span class="string">'ENGLISH'</span>) <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        Result := True;</span><br><span class="line">      <span class="keyword">end</span> </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        Result := False;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InitializeSetup</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    bConnectWithNetwork := IsNetWorkActivatedTried;</span><br><span class="line">    Result := True;</span><br><span class="line"><span class="keyword">end</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PrepareToInstall</span><span class="params">(<span class="keyword">var</span> NeedsRestart: Boolean)</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span> bInstallWeb: boolean;</span><br><span class="line">    bInstallStd: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// 'NeedsRestart' only has an effect if we return a non-empty string, thus aborting the installation.</span></span><br><span class="line">  <span class="comment">// If the installers indicate that they want a restart, this should be done at the end of installation.</span></span><br><span class="line">  <span class="comment">// Therefore we set the global 'restartRequired' if a restart is needed, and return this from NeedRestart()</span></span><br><span class="line">  bCancelWithoutPrompt := false;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> IsRequiredDotNetDetected <span class="keyword">then</span> </span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      bInstallWeb := InstallDotNetWebRuntime;</span><br><span class="line">      bInstallStd := InstallDotNetOfflineRuntime;</span><br><span class="line">      <span class="keyword">if</span> ( bInstallWeb = True) <span class="keyword">then</span> </span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          Result := InstallFrameworkWebRuntime</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( bInstallStd = True) <span class="keyword">then</span> </span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          Result := InstallFrameworkOfflineRuntime</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          Result := InstallFrameworkWebRuntime</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;          </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NeedRestart</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := bRequiresRestart;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>

<p>欢迎订阅我的个人微信公众号，一起讨论学习。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/06/30/inno-02-installdotnet/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/06/25/inno-01-run-as-admin/"
                            aria-label=": Inno Setup 如何以管理员的身份运行"
                        >
                            Inno Setup 如何以管理员的身份运行
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-06-25T08:11:08+08:00">
	
		    6月 25, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Inno-Setup-%E7%9B%B8%E5%85%B3/">Inno Setup 相关</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="Inno-Setup-如何以管理员的身份相关"><a href="#Inno-Setup-如何以管理员的身份相关" class="headerlink" title="Inno Setup 如何以管理员的身份相关"></a>Inno Setup 如何以管理员的身份相关</h2><h3 id="1-如何以管理员身份运行一个Batch脚本文件"><a href="#1-如何以管理员身份运行一个Batch脚本文件" class="headerlink" title="1. 如何以管理员身份运行一个Batch脚本文件"></a>1. 如何以管理员身份运行一个Batch脚本文件</h3><p>If you are using <code>[Run]</code> section then make sure you use <code>runascurrentuser</code> flag (If this flag is specified, the spawned process will inherit Setup/Uninstall’s user credentials (typically, full administrative privileges))</p>
<p>Else there are three ways how to run applications programatically (recommended way):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function Exec(const Filename, Params, WorkingDir: String; const ShowCmd: Integer; const Wait: TExecWait; var ResultCode: Integer): Boolean;</span><br><span class="line"></span><br><span class="line">function ShellExec(const Verb, Filename, Params, WorkingDir: String; const ShowCmd: Integer; const Wait: TExecWait; var ErrorCode: Integer): Boolean;</span><br><span class="line"></span><br><span class="line">function ShellExecAsOriginalUser(const Verb, Filename, Params, WorkingDir: String; const ShowCmd: Integer; const Wait: TExecWait; var ErrorCode: Integer): Boolean;</span><br></pre></td></tr></table></figure>

<p>You should use <code>Exec()</code> or <code>ShellExec()</code> because they open the specified file or performs another action specified by Verb, using the same credentials as Setup/Uninstall.</p>
<p>But none of mentioned ways will work if your installer is not running in elevated mode. So make sure the UAC window will appear before installer starts:</p>
<p>In section <code>[Setup]</code> use directive <code>PrivilegesRequired</code></p>
<p>Valid values:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">none&#96;, &#96;poweruser&#96;, &#96;admin&#96;, or &#96;lowest</span><br></pre></td></tr></table></figure>

<p>Use admin to ensure appropriate credentials.</p>
<h3 id="2-各个合法值在不同版本中的表现"><a href="#2-各个合法值在不同版本中的表现" class="headerlink" title="2. 各个合法值在不同版本中的表现"></a>2. 各个合法值在不同版本中的表现</h3><h4 id="合法值为："><a href="#合法值为：" class="headerlink" title="合法值为："></a>合法值为：</h4><ul>
<li>none, poweruser, admin, or lowest</li>
</ul>
<h4 id="默认值为：Default-value"><a href="#默认值为：Default-value" class="headerlink" title="默认值为：Default value:"></a>默认值为：Default value:</h4><ul>
<li>admin</li>
</ul>
<h4 id="描述Description"><a href="#描述Description" class="headerlink" title="描述Description:"></a>描述Description:</h4><p>The effect of this directive depends on which version of Windows the user is running:</p>
<p>此参数的效果取决于用户运行的Windows版本：</p>
<p><strong>On Windows Vista and later:</strong></p>
<p>This directive affects whether elevated rights are requested (via a User Account Control dialog) when the installation is started.</p>
<p>该指令影响安装开始时是否要求提升权限（通过“用户帐户控制”对话框）。</p>
<p>When set to admin (the default) or poweruser, Setup will always run with administrative privileges. If Setup was started by an unprivileged user, Windows will ask for the password to an account that has administrative privileges, and Setup will then run under that account.</p>
<p>当设置为admin（默认）或超级用户时，安装程序将始终以管理特权运行。 如果安装程序是由非特权用户启动的，则Windows将要求输入具有管理特权的帐户的密码，然后安装程序将在该帐户下运行。</p>
<p>When set to none, Setup will only run with administrative privileges if it was started by a member of the Administrators group. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p>
<p>如果设置为none，则安装程序仅由Administrators组的成员启动时才具有管理特权。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p>
<p>When set to lowest, Setup will not request to be run administrative privileges even if it was started by a member of the Administrators group. Additionally, the uninstall info root key will always be HKEY_CURRENT_USER, and the “common” forms of the Shell Folder constants are mapped to the “user” forms, even if administrative privileges are available. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p>
<p>设置为最低时，即使安装程序是由Administrators组的成员启动的，它也不会请求运行管理权限。 此外，卸载信息的根密钥将始终为HKEY_CURRENT_USER，并且即使具有管理特权，Shell文件夹常量的“公共”形式也将映射到“用户”形式。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p>
<p><strong>On Windows NT/2000/XP/2003</strong></p>
<p>This directive specifies the minimum user privileges required to run the installation.</p>
<p>该指令指定运行安装所需的最低用户特权。</p>
<p>When set to admin (the default), Setup will only run if the user is a member of the Administrators group. Otherwise, it will display the following message and exit: “You must be logged in as an administrator when installing this program.”</p>
<p>当设置为admin（默认值）时，仅当用户是Administrators组的成员时，安装程序才会运行。 否则，它将显示以下消息并退出：“安装此程序时，您必须以管理员身份登录。”</p>
<p>When set to poweruser, Setup will only run if the user is a member of the Administrators or Power Users groups. Otherwise, it will display the following message and exit: “You must be logged in as an administrator or as a member of the Power Users group when installing this program.”</p>
<p>设置为poweruser时，仅当用户是Administrators或Power Users组的成员时，安装程序才会运行。 否则，它将显示以下消息并退出：“安装此程序时，您必须以管理员或Power Users组成员的身份登录。”</p>
<p>When set to none Setup will not check the user’s group membership. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p>
<p>设置为none时，安装程序将不检查用户的组成员身份。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p>
<p>When set to lowest Setup will not check the user’s group membership. Additionally, the uninstall info root key will always be HKEY_CURRENT_USER, and the “common” forms of the Shell Folder constants are mapped to the “user” forms, even if administrative privileges are available. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p>
<p>设置为最低时，安装程序将不检查用户的组成员身份。 此外，卸载信息的根密钥将始终为HKEY_CURRENT_USER，并且即使具有管理特权，Shell文件夹常量的“公共”形式也将映射到“用户”形式。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p>
<p><strong>On Windows 95/98/Me</strong></p>
<p>This directive has no effect on these versions of Windows.</p>
<p>该指令对这些版本的Windows无效。</p>
<h3 id="以管理员身份安装和非管理员身份安装的区别"><a href="#以管理员身份安装和非管理员身份安装的区别" class="headerlink" title="以管理员身份安装和非管理员身份安装的区别"></a>以管理员身份安装和非管理员身份安装的区别</h3><p>An installation can run in one of two modes: administrative or non administrative. Which mode is selected is specified by the <a href="http://www.jrsoftware.org/ishelp/topic_setup_privilegesrequired.htm" target="_blank" rel="noopener">PrivilegesRequired</a> and <a href="http://www.jrsoftware.org/ishelp/topic_setup_privilegesrequiredoverridesallowed.htm" target="_blank" rel="noopener">PrivilegesRequiredOverridesAllowed</a> [Setup] section directives.</p>
<p>In administrative install mode:</p>
<ul>
<li>The <code>{group}</code> folder is created in the <em>All Users</em> profile.</li>
<li>The “auto” form of the directory and Shell Folder constants is mapped to the “common” form.</li>
<li>The <a href="http://www.jrsoftware.org/ishelp/topic_registrysection.htm" target="_blank" rel="noopener">HKA</a> and uninstall info root keys will be HKEY_LOCAL_MACHINE.</li>
</ul>
<p>In non administrative install mode:</p>
<ul>
<li>The <code>{group}</code> folder is created in the current user’s profile.</li>
<li>The “auto” form of the directory and Shell Folder constants is mapped to the “user” form.</li>
<li>The <a href="http://www.jrsoftware.org/ishelp/topic_registrysection.htm" target="_blank" rel="noopener">HKA</a> and uninstall info root keys will be HKEY_CURRENT_USER.</li>
</ul>
<p><strong>Notes:</strong></p>
<p>Regardless of the version of Windows, if the installation is running in administrative install mode then you should be careful about making any per-user area changes: such changes may not achieve what you are intending. The compiler will warn you about this, which can be disabled using <a href="http://www.jrsoftware.org/ishelp/topic_setup_useduserareaswarning.htm" target="_blank" rel="noopener">UsedUserAreasWarning</a>.</p>
<p>无论Windows的版本如何，如果安装均以管理安装模式运行，则应谨慎进行每个用户区域的更改：此类更改可能无法实现您的预期。 编译器将对此警告，可以使用<a href="http://www.jrsoftware.org/ishelp/topic_setup_useduserareaswarning.htm" target="_blank" rel="noopener">UsedUserAreasWarning</a>禁用。</p>
<p>If the installation is running in non administrative install mode, but administrative privileges are available anyway then Setup or the [Code] section might still make use of these privileges. For this reason the uninstaller will always be marked as requiring administrative privileges in this case, just as if the installation was running in administrative install mode.</p>
<p>如果安装程序在非管理安装模式下运行，但是仍然具有管理特权，则安装程序或[Code]部分可能仍会使用这些特权。 因此，在这种情况下，卸载程序将始终被标记为需要管理特权，就像安装在管理安装模式下运行一样。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/06/25/inno-01-run-as-admin/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2019/04/25/0807-ma-auto-generic-function/"
                            aria-label=": Python 杂记之 根据版本号自动调用泛函数"
                        >
                            Python 杂记之 根据版本号自动调用泛函数
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2019-04-25T08:11:08+08:00">
	
		    4月 25, 2019
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/">Python 相关 - 8. Python 杂记</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<p>在未来使用中，窗口的表现形式可能根据版本的不同而不同，但又需要同时要保证代码的向下兼容，也就说可以不断地添加了新的窗口，那老用户的老版本也应该能够继续使用。所以要根据版本信息进行代码（至少是窗体生成部分的代码）的调度。</p>
<ol>
<li><p>调度方式1， 传统设计理念中，也就是预定义一部分类方法，在根据实际需求，用字典索引的方式查找类方法或者函数。如下，</p>
<ul>
<li><p>可以如下方式进行调度:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p1</span><span class="params">(args)</span>:</span></span><br><span class="line">    whatever</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p2</span><span class="params">(more args)</span>:</span></span><br><span class="line">    whatever</span><br><span class="line"></span><br><span class="line">myDict = &#123;</span><br><span class="line">    <span class="string">"P1"</span>: p1,</span><br><span class="line">    <span class="string">"P2"</span>: p2,</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">"Pn"</span>: pn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myMain</span><span class="params">(name)</span>:</span></span><br><span class="line">    myDict[name]()</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者以下列方式进行调度：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myMain</span><span class="params">(key)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ExecP1</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ExecP2</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ExecP3</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ExecPn</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">pass</span> </span><br><span class="line">    locals()[<span class="string">'Exec'</span> + key]()</span><br></pre></td></tr></table></figure>

<p>两种的调度思路是一致的。</p>
</li>
</ul>
</li>
<li><p>调度方式2， Python标准库种有一个functools模块，该模块可以为可调用对象定义高阶函数和操作。即，依据现有函数定义新的函数。我们实现的方式运用了partial函数和singledispatch函数，parital由于定义偏函数，也就是为了固定函数或者方法的一个参数，在该实现方式种用于向Event的Handler传递第二个参数。singledispatch是用于函数调度，即将函数装饰为泛函数。其根据参数的数据类型实现函数的自主调度。因为我们要实现类方法根据不同的版本进行自主调度，就意味着需要将版本作为一种新的数据类型。</p>
<ul>
<li><p>基本代码如下：</p>
<p>```python import wx import wx.adv from sys import modules from functools import singledispatch, update_wrapper, partial</p>
<p>def methdispatch(func): dispatcher = singledispatch(func) def wrapper(_args, **kw): return dispatcher.dispatch(args[1].<strong>class</strong>)(_args, **kw) wrapper.register = dispatcher.register update_wrapper(wrapper, func) return wrapper</p>
<p>thisModule = modules[<strong>name</strong>]</p>
<p><strong>assign the new types inodule level m</strong></p>
<p>setattr(thisModule, ‘v1_20’, type(‘v1_20’, (object,), {})) setattr(thisModule, ‘v1_30’, type(‘v1_30’, (object,), {})) setattr(thisModule, ‘v1_40’, type(‘v1_40’, (object,), {})) setattr(thisModule, ‘v1_50’, type(‘v1_50’, (object,), {})) setattr(thisModule, ‘v1_60’, type(‘v1_60’, (object,), {}))</p>
</li>
</ul>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">class ClassDialog(wx.Dialog):</span><br><span class="line"></span><br><span class="line">    def __init__(self, parent, title&#x3D;&quot;Test Demo&quot;, size&#x3D;wx.DefaultSize, pos&#x3D;wx.DefaultPosition, style&#x3D;wx.DEFAULT_DIALOG_STYLE, strVersion&#x3D;&quot;v1_20&quot;, name&#x3D;&quot;TestDemo&quot;):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        strVersion, format v1_20</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        wx.Dialog.__init__(self, parent, wx.ID_ANY, title,</span><br><span class="line">                               size&#x3D;size,</span><br><span class="line">                               pos&#x3D;pos,</span><br><span class="line">                               style&#x3D;style,</span><br><span class="line">                               name&#x3D;name)</span><br><span class="line">        try:</span><br><span class="line">            self.objVersion &#x3D; eval(strVersion)()</span><br><span class="line">        except:</span><br><span class="line">            self.objVersion &#x3D; None</span><br><span class="line">        self.CreateWidgets(self.objVersion)</span><br><span class="line"></span><br><span class="line">    @methdispatch</span><br><span class="line">    def CreateWidgets(self, objVersion):  # @UnusedVariable</span><br><span class="line">        self.panel &#x3D; wx.Panel(self)</span><br><span class="line">        vBoxSizer &#x3D; wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">        self.quote &#x3D; wx.StaticText(self.panel, label&#x3D;&quot;Your quote: Default &quot;, pos&#x3D;(20, 30))</span><br><span class="line">        vBoxSizer.Add(self.quote, 5)</span><br><span class="line">        self.btn &#x3D; wx.Button(self.panel, wx.ID_ANY, size&#x3D;wx.DefaultSize, label&#x3D;&quot;Test&quot;)</span><br><span class="line">        vBoxSizer.Add(self.btn, 1)</span><br><span class="line">        self.panel.SetSizer(vBoxSizer)</span><br><span class="line">        self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br><span class="line"></span><br><span class="line">    @CreateWidgets.register(v1_20)  # @UndefinedVariable</span><br><span class="line">    def _(self, objVersion):  # @UnusedVariable</span><br><span class="line">        self.panel &#x3D; wx.Panel(self)</span><br><span class="line">        vBoxSizer &#x3D; wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">        self.quote &#x3D; wx.StaticText(self.panel, label&#x3D;&quot;Your quote: 1.20 &quot;, pos&#x3D;(20, 30))</span><br><span class="line">        vBoxSizer.Add(self.quote, 5)</span><br><span class="line">        self.btn &#x3D; wx.Button(self.panel, wx.ID_ANY, size&#x3D;wx.DefaultSize, label&#x3D;&quot;Test&quot;)</span><br><span class="line">        vBoxSizer.Add(self.btn, 1)</span><br><span class="line">        self.panel.SetSizer(vBoxSizer)</span><br><span class="line">        self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br><span class="line"></span><br><span class="line">    @CreateWidgets.register(v1_30)  # @UndefinedVariable</span><br><span class="line">    def _(self, objVersion):  # @UnusedVariable @DuplicatedSignature</span><br><span class="line">        self.panel &#x3D; wx.Panel(self)</span><br><span class="line">        vBoxSizer &#x3D; wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">        self.quote &#x3D; wx.StaticText(self.panel, label&#x3D;&quot;Your quote: 1.30 &quot;, pos&#x3D;(20, 30))</span><br><span class="line">        vBoxSizer.Add(self.quote, 5)</span><br><span class="line">        self.btn &#x3D; wx.Button(self.panel, wx.ID_ANY, size&#x3D;wx.DefaultSize, label&#x3D;&quot;Test&quot;)</span><br><span class="line">        vBoxSizer.Add(self.btn, 1)</span><br><span class="line">        self.panel.SetSizer(vBoxSizer)</span><br><span class="line">        self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br><span class="line"></span><br><span class="line">    @methdispatch </span><br><span class="line">    def OnButtonClicked(self, objVersion, event):  # @UnusedVariable</span><br><span class="line">        print(&quot;aaaaa&quot;)</span><br><span class="line"></span><br><span class="line">    @OnButtonClicked.register(v1_20)  # @UndefinedVariable</span><br><span class="line">    def _(self, objVersion, event):  # @UndefinedVariable @DuplicatedSignature @UnusedVariable</span><br><span class="line">        print(event.EventObject.Name)</span><br><span class="line">        print(&quot;bbbbb&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class SubClassDialog(ClassDialog):</span><br><span class="line">    def __init__(self, parent, title&#x3D;&quot;Test Demo&quot;, size&#x3D;wx.DefaultSize, pos&#x3D;wx.DefaultPosition, style&#x3D;wx.DEFAULT_DIALOG_STYLE, strVersion&#x3D;&quot;v1_20&quot;, name&#x3D;&quot;TestDemo&quot;):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        strVersion, format v1_20</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        ClassDialog.__init__(self, parent, title&#x3D;title, size&#x3D;size, pos&#x3D;pos, style&#x3D;style, strVersion&#x3D;strVersion, name&#x3D;name)  # @UndefinedVariable</span><br><span class="line"></span><br><span class="line">    @ClassDialog.CreateWidgets.register(v1_40)  # @UndefinedVariable</span><br><span class="line">    def _(self, objVersion):  # @DuplicatedSignature @UnusedVariable</span><br><span class="line">        print(&quot;1.40&quot;)</span><br><span class="line"></span><br><span class="line">    @ClassDialog.CreateWidgets.register(v1_50)  # @UndefinedVariable</span><br><span class="line">    def _(self, objVersion):  # @DuplicatedSignature @UnusedVariable</span><br><span class="line">        print(&quot;1.50&quot;)</span><br><span class="line"></span><br><span class="line">class MyFrame(wx.Frame):</span><br><span class="line">    &quot;&quot;&quot; We simply derive a new class of Frame. &quot;&quot;&quot;</span><br><span class="line">    def __init__(self, parent, title):  # @DuplicatedSignature</span><br><span class="line">        wx.Frame.__init__(self, parent, title&#x3D;title, size&#x3D;(200,100))</span><br><span class="line">        dlg&#x3D;SubClassDialog(self, strVersion&#x3D;&quot;v1_x0&quot;)</span><br><span class="line">        res &#x3D; dlg.ShowModal()</span><br><span class="line">        #self.Show(True)</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    app &#x3D; wx.App(False)</span><br><span class="line">    frame &#x3D; MyFrame(None, &#39;Small editor&#39;)  # @UnusedVariable</span><br><span class="line">    app.MainLoop()</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p> 在日常实践种singledispatch都是用来调度函数的，如果直接用在类方法上，会出现输入参数异常的问题。在这里我们就需要重新定义singledispatch进而得到一个methdispatch的函数。因为类方法的第一个参数为self即实例，所以我们要在函数种dispatch()第二个个参数。检查其数据类型然后调度注册的函数。</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">methdispatch</span><span class="params">(func)</span>:</span></span><br><span class="line">    dispatcher = singledispatch(func)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> dispatcher.dispatch(args[<span class="number">1</span>].__class__)(*args, **kw)</span><br><span class="line">    wrapper.register = dispatcher.register</span><br><span class="line">    update_wrapper(wrapper, func)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure>

<p> 为了实现类方法依照版本类型自主调度，上文中说到，我们要将版本注册成新的数据类型，或者类。在未来任何需要新的版本，都要将该版本好吧注册成新的类，代码如下：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">thisModule = modules[__name__]</span><br><span class="line"><span class="comment"># assign the new types inodule level m</span></span><br><span class="line">setattr(thisModule, <span class="string">'v1_20'</span>, type(<span class="string">'v1_20'</span>, (object,), &#123;&#125;))</span><br><span class="line">setattr(thisModule, <span class="string">'v1_30'</span>, type(<span class="string">'v1_30'</span>, (object,), &#123;&#125;))</span><br><span class="line">setattr(thisModule, <span class="string">'v1_40'</span>, type(<span class="string">'v1_40'</span>, (object,), &#123;&#125;))</span><br><span class="line">setattr(thisModule, <span class="string">'v1_50'</span>, type(<span class="string">'v1_50'</span>, (object,), &#123;&#125;))</span><br><span class="line">setattr(thisModule, <span class="string">'v1_60'</span>, type(<span class="string">'v1_60'</span>, (object,), &#123;&#125;))</span><br></pre></td></tr></table></figure>

<p> 普通的类方法可以用如下的代码实现调度，如果采用上述的方式进行版本数据类型的声明，一些IDE并不能够自动找到新注册的数据类型，就会出现该类型未找到的错，如果使用Eclipse就需要添加特别注释@UndefinedVariable：</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CreateWidgets.register(v1_30)  # @UndefinedVariable</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_</span><span class="params">(self, objVersion)</span>:</span>  <span class="comment"># @UnusedVariable @DuplicatedSignature</span></span><br><span class="line">    self.panel = wx.Panel(self)</span><br><span class="line">    vBoxSizer = wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">    self.quote = wx.StaticText(self.panel, label=<span class="string">"Your quote: 1.30 "</span>, pos=(<span class="number">20</span>, <span class="number">30</span>))</span><br><span class="line">    vBoxSizer.Add(self.quote, <span class="number">5</span>)</span><br><span class="line">    self.btn = wx.Button(self.panel, wx.ID_ANY, size=wx.DefaultSize, label=<span class="string">"Test"</span>)</span><br><span class="line">    vBoxSizer.Add(self.btn, <span class="number">1</span>)</span><br><span class="line">    self.panel.SetSizer(vBoxSizer)</span><br><span class="line">    self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br></pre></td></tr></table></figure>

<p> 针对一些特别的类方法如，事件处理函数，就要用到partial函数，代码如下。需要注意的是在这里partial固定的是类方法OnButtonClicked的第一个参数，第二个参数是Event。 理解了这些，我们就可以根据版本的不同调度同一事件的不同时间的处理方法了。</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br></pre></td></tr></table></figure>

<p> 注册同一事件处理函数的泛函数方法如下，泛函数的名称可以自由定义，但是_在这里确实是一个很好的选择，如果某一版本的泛函数没被注册，就会使用函数的本体:</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@methdispatch </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">OnButtonClicked</span><span class="params">(self, objVersion, event)</span>:</span>  <span class="comment"># @UnusedVariable</span></span><br><span class="line">    print(<span class="string">"aaaaa"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@OnButtonClicked.register(v1_20)  # @UndefinedVariable</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_</span><span class="params">(self, objVersion, event)</span>:</span>  <span class="comment"># @DuplicatedSignature @UnusedVariable</span></span><br><span class="line">    print(event.EventObject.Name)</span><br><span class="line">    print(<span class="string">"bbbbb"</span>)</span><br></pre></td></tr></table></figure>

<p> 上述的内容都是在一个Python种的使用情况，下面我们介绍一下如何跨模块实现上述内容，在跨模块使用该调度方式的时候，需要注意要从基本模块加载版本的数据类型，在注册泛函数的时候写法也于在同一模块种的不同，本例种：@ClassDialog.CreateWidgets.register(v1_60)，从类名，类方法名再进而注册版本类型。</p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="keyword">from</span> test <span class="keyword">import</span> ClassDialog, v1_60 <span class="comment"># @UnusedImport @UnresolvedImport</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubClassDialogInExtraModule</span><span class="params">(ClassDialog)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, parent, title=<span class="string">"Test Demo"</span>, size=wx.DefaultSize, pos=wx.DefaultPosition, style=wx.DEFAULT_DIALOG_STYLE, strVersion=<span class="string">"v1_20"</span>, name=<span class="string">"TestDemo"</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        strVersion, format v1_20</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ClassDialog.__init__(self, parent, title=title, size=size, pos=pos, style=style, strVersion=strVersion, name=name)  <span class="comment"># @UndefinedVariable</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @ClassDialog.CreateWidgets.register(v1_60)  # @UndefinedVariable</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_</span><span class="params">(self, objVersion)</span>:</span>  <span class="comment"># @UnusedVariable @DuplicatedSignature</span></span><br><span class="line">        self.panel = wx.Panel(self)</span><br><span class="line">        vBoxSizer = wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">        self.quote = wx.StaticText(self.panel, label=<span class="string">"Your quote: 1.60 "</span>, pos=(<span class="number">20</span>, <span class="number">30</span>))</span><br><span class="line">        vBoxSizer.Add(self.quote, <span class="number">5</span>)</span><br><span class="line">        self.btn = wx.Button(self.panel, wx.ID_ANY, size=wx.DefaultSize, label=<span class="string">"Test"</span>)</span><br><span class="line">        vBoxSizer.Add(self.btn, <span class="number">1</span>)</span><br><span class="line">        self.panel.SetSizer(vBoxSizer)</span><br><span class="line">        self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFrame</span><span class="params">(wx.Frame)</span>:</span></span><br><span class="line">    <span class="string">""" We simply derive a new class of Frame. """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, parent, title)</span>:</span>  <span class="comment"># @DuplicatedSignature</span></span><br><span class="line">        wx.Frame.__init__(self, parent, title=title, size=(<span class="number">200</span>,<span class="number">100</span>))</span><br><span class="line">        dlg=SubClassDialogInExtraModule(self, strVersion=<span class="string">"v1_60"</span>)</span><br><span class="line">        res = dlg.ShowModal()  <span class="comment"># @UnusedVariable</span></span><br><span class="line">        <span class="comment">#self.Show(True)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    app = wx.App(<span class="literal">False</span>)</span><br><span class="line">    frame = MyFrame(<span class="literal">None</span>, <span class="string">'Small editor'</span>)  <span class="comment"># @UnusedVariable</span></span><br><span class="line">    app.MainLoop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p> 上述就是使用functools种的两个函数实现依据不同版本调度不同的泛函数的全部内容</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2019/04/25/0807-ma-auto-generic-function/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2018/12/25/0806-ma-string-similarity/"
                            aria-label=": Python 杂记之 如何确定两个字符串的相似度"
                        >
                            Python 杂记之 如何确定两个字符串的相似度
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-12-25T08:11:08+08:00">
	
		    12月 25, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/">Python 相关 - 8. Python 杂记</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    
                    
                        


                    
                    
                        <p>
                            <a
                                href="/2018/12/25/0806-ma-string-similarity/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2018/12/20/0805-ma-compability-issue/"
                            aria-label=": Python 杂记之 不同版本间剪切板代码兼容性问题"
                        >
                            Python 杂记之 不同版本间剪切板代码兼容性问题
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-12-20T08:11:08+08:00">
	
		    12月 20, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/">Python 相关 - 8. Python 杂记</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="剪切板的基本操作"><a href="#剪切板的基本操作" class="headerlink" title="剪切板的基本操作"></a>剪切板的基本操作</h2><p>在Python的实际应用中有时候会遇到对剪切板进行操作的问题。剪切板的基本操作需求如下：</p>
<ul>
<li>获取剪切板中的内容。</li>
<li>向剪切板中注入内容。</li>
<li>清除剪切板的内容。</li>
</ul>
<p>使用Python对剪切板进行操作，可以使用tkinter和ctypes这两个标准库。或者使用Qt或者wxpython这些第三方模块（库）来实现。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/LNbO7CDlxmad3eibCibvYHAE43LAlxR0KtSSXwcJAlficsqnvlLNnicHfJPN2C4VYBICeeVI71H81mkWvViaMdQ4KDw/640?wx_fmt=png" alt="img"></p>
<h2 id="使用ctypes标准库操作剪切板"><a href="#使用ctypes标准库操作剪切板" class="headerlink" title="使用ctypes标准库操作剪切板"></a>使用ctypes标准库操作剪切板</h2><p>使用tkinter标准库或者第三方的Qt或者wxpython，这些实现方式常常是用在在<strong>图形界面化</strong>的项目中的，比如结合按钮事件等。使用ctypes就可以直接在<strong>非图形化界面</strong>项目中实现对剪切板的操作。或者使用pyperclip第三方模块也可实现跨平台的普通项目中对剪切板的操作，基本实现代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line">CF_TEXT = <span class="number">1</span></span><br><span class="line">kernel32 = ctypes.windll.kernel32</span><br><span class="line">user32 = ctypes.windll.user32</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">()</span>:</span></span><br><span class="line">    rts = <span class="string">""</span></span><br><span class="line">    user32.OpenClipboard(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> user32.IsClipboardFormatAvailable(CF_TEXT):</span><br><span class="line">        data = user32.GetClipboardData(CF_TEXT)</span><br><span class="line">        data_locked = kernel32.GlobalLock(data)</span><br><span class="line">        text = ctypes.c_char_p(data_locked)</span><br><span class="line">        print(text.value)</span><br><span class="line">        rts = text.value</span><br><span class="line">        kernel32.GlobalUnlock(data_locked)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'no text in clipboard'</span>)</span><br><span class="line">    user32.CloseClipboard()</span><br><span class="line">    <span class="keyword">return</span> rts</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(text)</span>:</span></span><br><span class="line">    GMEM_DDESHARE = <span class="number">0x2000</span></span><br><span class="line">    user32.OpenClipboard(<span class="number">0</span>)</span><br><span class="line">    user32.EmptyClipboard()</span><br><span class="line">    hCd = ctypes.windll.kernel32.GlobalAlloc(GMEM_DDESHARE, len(bytes(text))+<span class="number">1</span>)</span><br><span class="line">    pchData = ctypes.windll.kernel32.GlobalLock(hCd)</span><br><span class="line">    ctypes.cdll.msvcrt.strcpy(ctypes.c_char_p(pchData), bytes(text))</span><br><span class="line">    kernel32.GlobalUnlock(hCd)</span><br><span class="line">    user32.SetClipboardData(CF_TEXT, hCd)</span><br><span class="line">    user32.CloseClipboard()</span><br></pre></td></tr></table></figure>

<p>上述代码中，比较难以理解的应该是GlobalLock和GlobalUnlock，如果有C++的开发背景应该很容易理解这两个函数。简单解释：</p>
<blockquote>
<p>GlobalLock()函数 说明：锁定内存中指定的内存块，并返回一个地址值，令其指向内存块的起始处。除非用 GlobalUnlock 函数将内存块解锁，否则地址会一直保持有效。Windows 为每个内存对象都维持着一个锁定计数。对这个函数的每次调用都应有一个对应的 GlobalUnlock 调用 返回值 Long，如成功，返回内存块的地址；如出错，或者这是一个已被丢弃的“可丢弃”内存块，则返回零。通常我们在编程的时候，给应用程序分配的内存都是可以移动的或者是可以丢弃的，这样能使有限的内存资源充分利用，所以，在某一个时候我们分配 的那块内存的地址是不确定的，因为他是可以移动的，所以得先锁定那块内存块，这儿应用程序需要调用API函数GlobalLock函数来锁定句柄。如下：lpMem=GlobalLock(hMem)（数据类型应该是指针类型）; 这样应用程序才能存取这块内存。</p>
</blockquote>
<h2 id="剪切板操作的兼容性问题"><a href="#剪切板操作的兼容性问题" class="headerlink" title="剪切板操作的兼容性问题"></a>剪切板操作的兼容性问题</h2><p>上述代码我在公司的项目中也有使用。但是自从公司决定将软件中内嵌的Python2.7升级到Python3.7之后，类似上述的代码就不能在继续运行了。经过调试之后，发现了问题所在，请看下面代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_clipboard_text</span><span class="params">()</span>:</span></span><br><span class="line">    user32.OpenClipboard(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> user32.IsClipboardFormatAvailable(CF_TEXT):</span><br><span class="line">        data = user32.GetClipboardData(CF_TEXT)</span><br><span class="line">        data_locked = kernel32.GlobalLock(data)</span><br><span class="line">        text = ctypes.c_char_p(data_locked)</span><br><span class="line">        value = text.value <span class="comment"># 问题所在位置。</span></span><br><span class="line">        kernel32.GlobalUnlock(data_locked)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    user32.CloseClipboard()</span><br></pre></td></tr></table></figure>

<p>在上述代码中，在调试代码时，代码可以运行至带有注释的这一行的前一行。当试图尝试使用便利text时，程序就会出错，从而引发崩溃。可以肯定的是text变量并不为None，在一开始一直以为是锁定内存带来的问题。但是最后发现整个代码都有问题的。</p>
<p>在不断尝试之后，项目背景是，剪切板的中不会存在特殊字符或者宽字符。本着最少代码修改量就能解决问题的原则，以及“简单胜过复杂”的设计哲学。我们用下列代码解决了这部分代码对Python3的兼容。</p>
<p><strong>“Simple is better than complicated”</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kernel32.GlobalLock.argtypes = [ctypes.c_void_p]</span><br><span class="line">kernel32.GlobalLock.restype = ctypes.c_void_p</span><br><span class="line">kernel32.GlobalUnlock.argtypes = [ctypes.c_void_p]</span><br><span class="line">user32.GetClipboardData.restype = ctypes.c_void_p</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_clipboard_text</span><span class="params">()</span>:</span></span><br><span class="line">    user32.OpenClipboard(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> user32.IsClipboardFormatAvailable(CF_TEXT):</span><br><span class="line">            data = user32.GetClipboardData(CF_TEXT)</span><br><span class="line">            data_locked = kernel32.GlobalLock(data)</span><br><span class="line">            text = ctypes.c_char_p(data_locked)</span><br><span class="line">            value = text.value</span><br><span class="line">            kernel32.GlobalUnlock(data_locked)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        user32.CloseClipboard()</span><br></pre></td></tr></table></figure>

<p>在使用函数的时候，只要提前申明了函数参数的数据类型，和函数返回值的数据类型。就解决了兼容性问题。虽然解决了问题，但是总觉得有种知其然不知所以然的感觉。为什么Python2中不需要声明，而Python3中却需要。经过不断地查找，找到了下面的解决方案。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> ctypes.wintypes <span class="keyword">as</span> w</span><br><span class="line"></span><br><span class="line">CF_UNICODETEXT = <span class="number">13</span></span><br><span class="line"></span><br><span class="line">u32 = ctypes.WinDLL(<span class="string">'user32'</span>)</span><br><span class="line">k32 = ctypes.WinDLL(<span class="string">'kernel32'</span>)</span><br><span class="line"></span><br><span class="line">OpenClipboard = u32.OpenClipboard</span><br><span class="line">OpenClipboard.argtypes = w.HWND,</span><br><span class="line">OpenClipboard.restype = w.BOOL</span><br><span class="line">GetClipboardData = u32.GetClipboardData</span><br><span class="line">GetClipboardData.argtypes = w.UINT,</span><br><span class="line">GetClipboardData.restype = w.HANDLE</span><br><span class="line">GlobalLock = k32.GlobalLock</span><br><span class="line">GlobalLock.argtypes = w.HGLOBAL,</span><br><span class="line">GlobalLock.restype = w.LPVOID</span><br><span class="line">GlobalUnlock = k32.GlobalUnlock</span><br><span class="line">GlobalUnlock.argtypes = w.HGLOBAL,</span><br><span class="line">GlobalUnlock.restype = w.BOOL</span><br><span class="line">CloseClipboard = u32.CloseClipboard</span><br><span class="line">CloseClipboard.argtypes = <span class="literal">None</span></span><br><span class="line">CloseClipboard.restype = w.BOOL</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_clipboard_text</span><span class="params">()</span>:</span></span><br><span class="line">    text = <span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> OpenClipboard(<span class="literal">None</span>):</span><br><span class="line">        h_clip_mem = GetClipboardData(CF_UNICODETEXT)</span><br><span class="line">        text = ctypes.wstring_at(GlobalLock(h_clip_mem))</span><br><span class="line">        GlobalUnlock(h_clip_mem)</span><br><span class="line">        CloseClipboard()</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">print(get_clipboard_text())</span><br></pre></td></tr></table></figure>

<p>乍一看，很复杂，其实其实现过程和第一个解决方案相似，而且上述的代码够同时在Python2.x和Python3.x中完美运行，也同时支持ascii与unicode字符，算是一个完美的解决方案。</p>
<p>这个解决方案的提供者Mark Tolonen也解释道，由于Python3是64位的，如果我们在Python3.x的环境下使用原来在Python2.x中的代码。默认情况下，我们传递是句柄就是c_int(32bit)的，存储长度不够。超出会存在负值，导致代码不兼容的主要问题就在这儿。</p>
<p>kernel内核和windows的句柄都是32位的。如果在64位环境中使用这些句柄就会存在负值，为了避免这种情况发生，就应该将这些句柄扩展至64位。而且一些句柄实际上是内存的地址，例如HMODULE和HGLOBAL，以及GlobalLock的返回结果也应该得到扩展。总的来讲，在处理句柄和指针的时候总是声明参数argtypes和返回值restype，就可以避免硬编码实现细节和假设。</p>
<p>学无止境，总有高手，在这些高手的解释中也学习到了很多，了解一些问题出现的根本原因，和这些高手在面对这些问题时所思考的内容。然后学以致用，来提高自己。</p>
<p>参考目录：</p>
<p><strong>Stackflow：</strong><a href="https://stackoverflow.com/questions/46132401/read-text-from-clipboard-in-windows-using-ctypes" target="_blank" rel="noopener">https://stackoverflow.com/questions/46132401/read-text-from-clipboard-in-windows-using-ctypes</a></p>
<p><strong>CSDN：</strong><a href="https://blog.csdn.net/longxin5/article/details/83394388" target="_blank" rel="noopener">https://blog.csdn.net/longxin5/article/details/83394388</a></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2018/12/20/0805-ma-compability-issue/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2018/12/15/0804-ma-list-leftadd-selfadd-op/"
                            aria-label=": Python 杂记之 实现列表的自加和左移等操作"
                        >
                            Python 杂记之 实现列表的自加和左移等操作
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-12-15T08:11:08+08:00">
	
		    12月 15, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/">Python 相关 - 8. Python 杂记</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="列表与操作方法"><a href="#列表与操作方法" class="headerlink" title="列表与操作方法"></a>列表与操作方法</h2><p>列表<strong>list</strong>是Python语言中的标准数据类型，进一步讲list是一种可变的序列类型，不可变的有tuple和range（注：Python 3.x中xrange已经不存在了）。<strong>可变序列类型</strong>，<strong>可变</strong>就是长度可以改变，所含元素数值可以改变，元素数据类型可以改变；<strong>序列</strong>意指成员有序排列，可以通过索引访问元素。既然是序列类型，就一定可以迭代（for 循环），所以列表是<strong>可迭代</strong>的对象，请注意<strong>可迭代</strong>和<strong>迭代器</strong>的差异。</p>
<p>列表的常用操作包括，索引，切片，改变与排序。而这几种操作要属<strong>改变</strong>最多样。改变包括，一、<strong>长度改变</strong>，成员的<strong>添加</strong>（常用方法append，insert和extend）与<strong>删除</strong>（常用方法pop与remove）。二、<strong>数值改变</strong>，通过索引访问与重新赋值来实现。</p>
<h2 id="列表操作的延伸思考"><a href="#列表操作的延伸思考" class="headerlink" title="列表操作的延伸思考"></a>列表操作的延伸思考</h2><p>由于上一篇文章是与运算符相关，所以在准备文字的时候就思索，作为标准数据类型的列表，能和它组合使用的运算符都有什么呢？今天我就和大家一起总结，共同学习一下。</p>
<p>一般情况下，Python中列表只能与➕操作符组合使用，前提是➕号左右都是序列类型。可能别的教程里面规定➕左右都应该是一样的列表类型。我们今天扩展一下，定义：➕号左右都是序列类型。</p>
<ul>
<li>当加号➕右侧为列表，或者range()时，代码表现符合正常预期，请参看下面例子：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m3 = [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 + m3</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 + range(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ss = range(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(ss)</span><br><span class="line">&lt;type <span class="string">'list'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 + (<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: can only concatenate list (<span class="keyword">not</span> <span class="string">"tuple"</span>) to list</span><br></pre></td></tr></table></figure>

<p>List作为唯一的可变序列类型，而且与加号左侧数据类型一直，它的加法运算正常且容易理解。range， str与tuple是不可变的数据类型，理论上与列表相加时肯定会出错的，但是在Python 2.x 中却没有问题，结果如上。其原因为: Python 2.x 中range返回的是一个列表。而在Python 3.x 中这样写就会引发异常，参考如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 + range(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: can only concatenate list (<span class="keyword">not</span> <span class="string">"range"</span>) to list</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ss = range(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(ss)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">range</span>'&gt;</span></span><br></pre></td></tr></table></figure>

<p>因为Python 3.x 中返回的是一个真正的range类实例，是一个不可变的序列类型。</p>
<ul>
<li>当加号➕右侧为其它序列类型，即不可变序列类型，如 tuple 或 str 时，请参看下面例子：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 += <span class="string">"hello"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="string">'h'</span>, <span class="string">'e'</span>, <span class="string">'l'</span>, <span class="string">'l'</span>, <span class="string">'o'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = m2 + <span class="string">"hello"</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: can only concatenate list (<span class="keyword">not</span> <span class="string">"str"</span>) to list</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 += (<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = m2 + (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: can only concatenate list (<span class="keyword">not</span> <span class="string">"tuple"</span>) to list</span><br></pre></td></tr></table></figure>

<p>理论上肯定不行的，毕竟左右两侧的数据类型不同。但是总会有些意外，有些惊喜。虽然在<strong>运算符</strong>的章节中，我们了解到自加操作符与加法和赋值的组合等效，即 a += 1 等效于 a = a + 1。但是参照上方的例子，我们发现应该在解析运行的时候。两种数据操作方式还是有些不一样的，比如在参与的数据有列表是，<strong>自加</strong>时，因为列表（等号左侧）为可变对象，原则上仅需要本地对象（这里指m2）进行修改，不需要产生新的对象。那么在修改的时候解释器会讲右侧的对象尝试数据类型转换，上述的例子中讲字符穿转换为字符列表，将tuple转换为列表，进而对本地m2对象进行修改，所以我们就实现了所有<strong>序列类型</strong>的加法操作，注意非序列的数据类型不行，是不是有点神奇。</p>
<h2 id="进一步延伸思考"><a href="#进一步延伸思考" class="headerlink" title="进一步延伸思考"></a>进一步延伸思考</h2><p>上一节，我们通过总结可知：1. 列表的加法操作，并不是全效的加法，因为对数据只能对序列操作，那么如果仅需要添加一个成员的时候，加法操作就不再适用。2. 列表没有减法操作。那么有解决方法吗？了解到Python<strong>万物皆对象</strong>（必定不单身）。那么如果继承列表基本类，创建自有字类，通过重写方法就是实现Python的全效加法于减法。有想法之后就实现一下，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyList</span><span class="params">(list)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="comment">#Function is called by + command</span></span><br><span class="line">        self.addObj(obj)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="comment">#Function is called by - command</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(obj, list) <span class="keyword">or</span> isinstance(obj, tuple):</span><br><span class="line">        <span class="comment">#if isinstance(obj, list) or isinstance(obj, tuple) or isinstance(obj, range): # Python 3.x</span></span><br><span class="line">            <span class="keyword">for</span> o <span class="keyword">in</span> obj: </span><br><span class="line">                <span class="keyword">return</span> self.__class__([item <span class="keyword">for</span> item <span class="keyword">in</span> self <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> obj])</span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> self.__class__([item <span class="keyword">for</span> item <span class="keyword">in</span> self <span class="keyword">if</span> item != obj])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lshift__</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="comment">#Function is called by &lt;&lt; command</span></span><br><span class="line">        self += obj</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iadd__</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="comment">#Function is called by += command</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(obj, list) <span class="keyword">or</span> isinstance(obj, tuple):</span><br><span class="line">        <span class="comment">#if isinstance(obj, list) or isinstance(obj, tuple) or isinstance(obj, range): # Python 3.x</span></span><br><span class="line">            <span class="keyword">for</span> o <span class="keyword">in</span> obj: </span><br><span class="line">                self.addObj(o)</span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            self.addObj(obj)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addObj</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        self.append(obj)</span><br></pre></td></tr></table></figure>

<p>在使用需要注意，由于Python默认的列表类为list，传统的列表赋值方式只能产生list的实例对象，那么如果初始化玩MyList类的实例后，再为实例变量使用传统方式赋值时，那么就会产生新的对象，而且新类的<strong>属性</strong>与<strong>方法</strong>将丢失。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> test <span class="keyword">import</span> MyList</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml = MyList([<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(ml)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">test</span>.<span class="title">MyList</span>'&gt;</span></span><br><span class="line">&gt;&gt;&gt; ml = MyList()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(ml)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">test</span>.<span class="title">MyList</span>'&gt;</span></span><br><span class="line">&gt;&gt;&gt; ml = ["a", "b", "c"]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(ml)</span><br><span class="line">&lt;type <span class="string">'list'</span>&gt;</span><br></pre></td></tr></table></figure>

<p>实际使用结果如下，因为在加法运算时，我们返回类实例本身，所以列表的值在做加法是会发生变化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml = MyList([<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml + [<span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, [<span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml = MyList([<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml + [<span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, [<span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml = MyList([<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml += [<span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml = MyList([<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml + <span class="string">"e"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'e'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml + <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'e'</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml - <span class="number">1</span></span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'e'</span>]  <span class="comment"># 新的列表对象</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'e'</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml - [<span class="string">'c'</span>, <span class="number">1</span>]</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'e'</span>] <span class="comment"># 新的列表对象</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'e'</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml &lt;&lt; <span class="string">"e"</span></span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'e'</span>, <span class="number">1</span>, <span class="string">'e'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml &lt;&lt; [<span class="string">'d'</span>, <span class="string">'f'</span>]</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'e'</span>, <span class="number">1</span>, <span class="string">'e'</span>, <span class="string">'d'</span>, <span class="string">'f'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tt = ml - [<span class="string">'c'</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>type(tt)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">test</span>.<span class="title">MyList</span>'&gt;</span></span><br></pre></td></tr></table></figure>

<p>而在做减法运算时，我们创建并返回一个新的类实例，所以减数，即原始列表值不发生改变，请参见上述代码中带注释的内容。有心的同学可能也发现了，我们重写__iadd__()， 实现了我们预期的自加，重写__add__()， 实现了我们预期的加法，重写__sub__()， 实现了我们预期的列表减法运算和重写__lshift__()， 实现了我们预期的列表的左移运算，怎么样是不是也有一点成就感。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在之前的文章中我们介绍了如何动态重写类方法，那么我们的上述的方法能不能也动态地写入基类list中，使其所有实例都有新的方法呢？感兴趣的童鞋可以自己可以试一下。我把结果写出来, 就不再举例分析。<strong>是不行的</strong>，由于基类是由别的语言实现的属于built-in类型，虽然也是动态的类，但是却因为别的语言限制了访问，所以其<em>\</em>iadd__()方法，在实例中是<strong>仅可读的</strong>。所以就没办法实现list基类，这些方法的动态绑定和重写。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2018/12/15/0804-ma-list-leftadd-selfadd-op/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2018/12/10/0803-ma-dynamic-classmethod-override/"
                            aria-label=": Python 杂记之 如何动态重写类方法"
                        >
                            Python 杂记之 如何动态重写类方法
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-12-10T08:11:08+08:00">
	
		    12月 10, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/">Python 相关 - 8. Python 杂记</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>作者: Barbossa 公众号: <a href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzU3MTI2ODk0MA==#wechat_redirect" target="_blank" rel="noopener">巴博萨船长</a></p>
<h2 id="Python-是动态的编程语言"><a href="#Python-是动态的编程语言" class="headerlink" title="Python 是动态的编程语言"></a>Python 是动态的编程语言</h2><p> 在自己有关Python的第一篇文章中就介绍了Python的特性与优势，在文章中也介绍了其是一种动态的编程语言。在这里我再简单在当前文章中介绍一下，如下：</p>
<blockquote>
<p>能够在运行时修改自身程序结构的语言，就属于动态语言。那怎样才算是“运行时修改自身程序结构”捏？比如下面这几个例子都 算：在运行时给某个类增加成员函数及成员变量；在运行时改变某个类的父类；在运行时创建出某个函数.。 Python是可以实现动态类的创建类（在任意代码位置，符合正确的书写格式），或者给类增加删除属性。因为类也是对象，你可以在运行时动态的创建它们，就像其他任何对象一样。比如，你可以在函数中创建类，使用class关键字即可。” 既然是一种动态的高级语言，那么就意味着，其是在运行时就能改变其结构的编程语言。这在调试代码时，可以动态实时地改变变量，重写函数等，比起传统的C++与广泛运用的Java具有很强的优势。所叙述的结构包括：函数、变量与对象。已有的函数或方法可以被删除或是其他结构上的变化。</p>
</blockquote>
<h2 id="任务描述"><a href="#任务描述" class="headerlink" title="任务描述"></a>任务描述</h2><p> 最近在工作中遇到了一个问题：现有一Wxpython的Widget类，即继承TextCtrl的自定义类，该类有一个实例方法，在这暂且就称作method_x吧，整个项目都在使用该实例方法，虽然其内在调用关系十分复杂，这也是我一直诟病我们项目代码的地方，但其一直表现良好。我的需求是：在不改变这个类的，也不影响其他代码的的情况下，重写或者重新定义这个方法。这些只并且仅对特定实例有效。</p>
<p> 首先我能想到的就是继承该类，进而得到一个子类，在子类里面仅Override覆盖该实例方法。这应该是最正常的方法，或者大部分人能想到的方法。可是我又不希望这样做，这样在后期维护的该类的时候还要为子类针对一下改变做出调整。而且在文章中还要import一下。那么有没有别的方法呢？考虑到Python是动态语言，动态调整函数和变量都是自己应用过的，那么这样的动态语言，能不能动态地修改（重写）一个类的实例方法呢？抱着这样的想法，我查阅了一些网页，成功实现了这样的想法，也在完成该任务，解决该问题的过程中更深层的理解了Python这种语言的动态特性。</p>
<p> 最终我归纳出三种方法，可以实现类的实例方法的动态重写，在此我针对每种方法列出范例代码，并给出运行结果，并对这三种方法进行比较说明，本人并非专家，有见解不足之处，也希望各位高手留言赐教。</p>
<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p> 使用函数的_<em>get()__内置方法，也是一个描述符，其本质是一个新式类, 在这个新式类中, 至少实现了<em>\</em>_get()_\</em>, __set()__, <em>\</em>delete()__中的一个, 这也被称为描述符协议，其中__get()<em>\</em>:在调用一个属性时被触发。 __get__(self, instance, owner) 定义当描述器的值被取得的时候的行为， instance 是拥有者对象的一个实例。 owner 是拥有者类本身。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>:</span>    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(self)</span>:</span>        </span><br><span class="line">        <span class="keyword">print</span> <span class="string">"I am old func1"</span>        </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_func1</span><span class="params">(self)</span>:</span>        </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"I am new func1"</span></span><br><span class="line"></span><br><span class="line">objTest1 = Test()</span><br><span class="line"><span class="keyword">print</span> id(new_func1)</span><br><span class="line">objTest2 = Test()</span><br><span class="line">objTest1.func1()</span><br><span class="line">objTest2.func1() </span><br><span class="line"></span><br><span class="line"><span class="comment"># 仅对该实例重写这个方法</span></span><br><span class="line"><span class="keyword">print</span> new_func1.__get__(objTest1, Test)</span><br><span class="line">objTest1.func1 = new_func1.__get__(objTest1, Test)</span><br><span class="line">objTest1.func1()</span><br><span class="line">objTest2.func1()</span><br></pre></td></tr></table></figure>

<p>代码输出如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\\&gt;python test.py</span><br><span class="line">55131384</span><br><span class="line">I am old func1</span><br><span class="line">Iam old func1</span><br><span class="line">&lt;bound method Test.new_func1 of &lt;__main__.Test instance at 0x0000000002F60C88&gt;&gt;</span><br><span class="line">I am new func1</span><br><span class="line">I am old func1</span><br></pre></td></tr></table></figure>

<p>那么现在我们来尝试来理解一下这个方法的原理，上文说到__get()__是一个描述符，或称描述器，描述器分为两种，一共是资料描述器（data-descriptor), 一种是非资料描述器(non-data descriptor)。我们在这里使用的是非资料描述器， __get__(self, instance, owner) ，该方法的第二个参数是可选的（非必需）。 上面代码在使用该描述器的时候，就是将函数new_func1()绑定在类Test的实例objTest1上，而等号前面的是objTest1.func1 意味这，要将新绑定的实例方法覆盖到func1上，进而在再次调用实例方法func1()的时候，其实是在调用new_func1()。 该方法很有好处，可以理解为”几乎”是实现了一个方法的覆盖，你可以在新定义的方法中使用关键字self。 但是不能使用关键字super，即不能访问类的父类。</p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>使用Python的偏函数，Python的偏函数，与数学意义上的偏函数不同。其偏函数的思想可以理解为绑定了一部分参数的函数，其作用就是减少传入函数，使函数更短，更简洁。在这儿使用偏函数重写实例方法，目的就在与保证第一个参数self的传入。也就是partial()的第二个参数。把new_func1()的第一个参数固定了下来。保证重写的实例方法能访问self关键字。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.m = <span class="string">"message"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"I am old func1"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_func1</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> self.m</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"I am new func1"</span></span><br><span class="line"></span><br><span class="line">objTest1 = Test()</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> id(new_func1)</span><br><span class="line"></span><br><span class="line">objTest2 = Test()</span><br><span class="line"></span><br><span class="line">objTest1.func1()</span><br><span class="line"></span><br><span class="line">objTest2.func1() </span><br><span class="line"></span><br><span class="line"><span class="comment"># 仅对该实例重写这个方法</span></span><br><span class="line"><span class="comment">#print new_func1.__get__(objTest1, Test)</span></span><br><span class="line"><span class="comment">#objTest1.func1 = new_func1.__get__(objTest1, Test)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> id(objTest1.func1)</span><br><span class="line">objTest1.func1 = partial(new_func1, objTest1)</span><br><span class="line"><span class="keyword">print</span> id(objTest1.func1)</span><br><span class="line"></span><br><span class="line">objTest1.func1()</span><br><span class="line"></span><br><span class="line">objTest2.func1()</span><br></pre></td></tr></table></figure>

<p>输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\\&gt;python test.py</span><br><span class="line">52313336</span><br><span class="line">I am old func1</span><br><span class="line">I am old func1</span><br><span class="line">47500528</span><br><span class="line">47692840</span><br><span class="line">message</span><br><span class="line">I am new func1</span><br><span class="line">I am old func1</span><br></pre></td></tr></table></figure>

<p>该种方法也简单有效，但是也要从functool中引入partial。也算是一种有效的解决方案。但是其也不能访问关键字super。输出的结果也显示，这样的改变只对特定实例有效。我个人觉得这也是一个简单容易理解的方法，相比较方法一而言，其原理理解起来也并不困难。也不需要更深层次的Python理论知识。</p>
<h3 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h3><p>使用types包中的MethodType 函数。这个方法理解起来就相对更为简单。MethodType可以将一个函数绑定在特定的实例，或者类上。而且该类或者实例，可以没有方法，如果有相同名字的方法，就视为重写。如果绑定在实例上，则完全覆盖其实例的方法。如果绑定在类上，则对所有实例有效。两个绑定方法的区别就在与函数的第二个参数上。 MethodType把方法绑定在类实例上时，每个实例有自己单独的指向区域，互不干扰。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="comment">#from functools import partial</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.m = <span class="string">"message"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"I am old func1"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_func1</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">print</span> self.m</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"I am new func1"</span></span><br><span class="line"></span><br><span class="line">objTest1 = Test()</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> id(new_func1)</span><br><span class="line"></span><br><span class="line">objTest2 = Test()</span><br><span class="line"></span><br><span class="line">objTest1.func1()</span><br><span class="line"></span><br><span class="line">objTest2.func1() </span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> id(objTest1.func1)</span><br><span class="line"><span class="comment"># 仅对该实例重写这个方法</span></span><br><span class="line"><span class="comment">#print new_func1.__get__(objTest1, Test)</span></span><br><span class="line"><span class="comment">#objTest1.func1 = new_func1.__get__(objTest1, Test)</span></span><br><span class="line"><span class="comment">#objTest1.func1 = partial(new_func1, objTest1)</span></span><br><span class="line"></span><br><span class="line">objTest1.func1 = types.MethodType(new_func1, objTest1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> id(objTest1.func1)</span><br><span class="line"></span><br><span class="line">objTest1.func1()</span><br><span class="line"></span><br><span class="line">objTest2.func1()</span><br></pre></td></tr></table></figure>

<p>输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">C:\\&gt;python test.py</span><br><span class="line">60046584</span><br><span class="line">I am old func1</span><br><span class="line">I am old func1</span><br><span class="line">55233776</span><br><span class="line">55233776</span><br><span class="line">message</span><br><span class="line">I am new func1</span><br><span class="line">I am old func1</span><br></pre></td></tr></table></figure>

<p>从上面的输出结果来看，时候该方法重写实例方法的时候，实例方法的id也没有改变，这是完全意义上方法重写，使用该方法重写类的实例方法，可以访问类的所有关键字。该方法绑定类方法时有一个很有趣区别，因为并不是当前任务需要，这些内容，我们以后在别的文章中进行讨论。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>三种方法以三个不同方向，三种不同的Python背景知识诠释了如何动态的重写（或绑定）一个实例的方法。在分析利弊与结合自己的使用需求，我个人最终选择了方法三, 每种方法都有自己的优缺点，比如方法一就不需要引入别的Python模块。但是至于那个方法是最优的解决方法，那应该是仁者见仁智者见智。这样的经历也是在自己在解决问题的过程中常常经历的。不断地思考探究，也能扎实自己的理论知识，向大拿高手学习的过程中，也为自己在以后遇见问题是，扩展了思考方向。让自己不断拷问自己，同样的需求是不是还有别的解决方案。然后探究，学习，尝试，掌握。 上述内容实自己总结归纳的，总有不足之处，望见谅并指正。</p>
<p>参考目录：</p>
<p><strong>Stackoverflow：</strong> <a href="https://stackoverflow.com/questions/394770/override-a-method-at-instance-level" target="_blank" rel="noopener">https://stackoverflow.com/questions/394770/override-a-method-at-instance-level</a></p>
<p><strong>CSDN Blog:</strong> [<a href="https://blog.csdn.net/yuanyangsdo/article/details/60776612]" target="_blank" rel="noopener">https://blog.csdn.net/yuanyangsdo/article/details/60776612]</a>(</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2018/12/10/0803-ma-dynamic-classmethod-override/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                评论和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
          <li class="pagination-next">
            <a
                class="btn btn--default btn--small"
                href="/archives/page/2/"
                aria-label="下一页"
            >
              <span>下一页</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">第 1 页 共 3 页</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Jim Wang. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avater.png" alt="作者的图片"/>
        
            <h4 id="about-card-name">Jim Wang</h4>
        
            <div id="about-card-bio"> <hr style='margin: 5px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 20%;'> <span>全栈探索之路<span> <hr style='margin: 8px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 60%;'> 记录个人对技术的理解和开发过程中遇到的问题，欢迎了解更多。 </div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>软件工程师</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                河南，中国
            </div>
        
    </div>
</div>

        




    
        
    



    
        
    

<div id="wechat">
    <div id="wechat-card">
        <div id="wechat-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="wechat-qrcode-picture" src="/assets/images/wechat-qrcode.jpg" alt="global.wechat_public_qr_code_image"/>
        
        
            <div id="wechat-qrcode-desc"><p>请扫描上方的二维码订阅我的个人微信公众号</p> <hr style='margin: 8px auto; border-top: 2px solid rgba(1, 1, 1, 0.14); width: 60%;'> <p>原创不易，多多点赞分享支持。</p></div>
        
        
            <img id="wechat-searchbar-picture" src="/assets/images/wechat-search-white.png" alt="global.wechat_public_search_bar_image"/>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/background-cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-xhlmbqja5kwmltzbaayc6g6t89ar6upohvttvjy1yj82zeldvqjoa2ctjwl3.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
