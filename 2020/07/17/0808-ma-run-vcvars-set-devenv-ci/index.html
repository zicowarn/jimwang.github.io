
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Jim Wang 的个人技术博客">
    <title>Python 杂记之 如何在实现子进程到父进程的环境变量更新 - Jim Wang 的个人技术博客</title>
    <meta name="author" content="Jim Wang">
    
        <meta name="keywords" content="个人博客,实践,技术,经验,分享,全栈,Technology,blog,Python,Inno Setup,TypeScript,SQLite,AWS,CAM,EDM,">
    
    
        <link rel="icon" href="https://zicowarn.github.io/assets/images/favicon.png">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jim Wang","sameAs":["https://github.com/zicowarn","#wechat","https://twitter.com/zuiwuxin?s=09","https://www.linkedin.com/in/zhichao-wang-a16662109","mailto:zicowarn@hotmail.com"],"image":"avater.png"},"articleBody":"\n\n作者: Jim Wang 公众号:  巴博萨船长\n任务背景 该任务是：当前所用的完成持续集成的脚本是Python语言实现的。在现有的脚本的核心内容是，使用subprocess.Popen方法来调用devenv命令，从而实现项目的清理clean和构建build。\n今年伊始，项目中引用了.NET组件。一部分代码使用.NET完成了一个交互界面窗口。由于使用了.NET，编译的时候就需要对.NET的程序集进行强名称签名等一系列操作。例如，在导出类型库时会使用到的类型库导出工具Tlbexp.exe（一般在Visual Studio项目属性中[生成]部分中的“为COM互操作注册”被勾选时），以及程序集注册工具Regasm.exe等。此类工具的路径为：C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\Tools\\。理论上，当在命令行中使用devenv命令工具时，该工具就会自动查找上述的工具目录，并保证在编译解决方案的时候能够访问到这些工具。实践得知，devenv不能完成诸如此类环境变量的设置。进而在使用devenv时，因为项目配置中的所用到的工具因为无法找到会发生编译错误。\n既然devenv不能实现理论结果，那就需要用到vsvars32.bat个batch文件了了。该文件是visual studio自带的文件，本质就是配置环境变量，工作目录的一些批处理命令。任务中遇到的问题是Tlbexp.exe无法找到，问题的本质是工具的路径不在系统环境中：\n1VS140COMNTOOLS&#x3D;C:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\Common7\\Tools\\\n\n初始代码话不多少，直接上代码，项目一开始我们使用的是如下的代码，代码的主要内容是使用subprocess模块下的Popen方法来调用cmd命令devenv完成代码的清除clean和构建build，部分代码如下：\n12345678910111213141516171819202122232425262728293031323334353637import osimport subprocess as sp# 省略部分def mCompile(slnPath, compilArgs):    \"\"\"[summary]    Args:        slnPath ([type]): [description]        compilArgs ([type]): [description]    Raises:        RuntimeError: [description]        ValueError: [description]    \"\"\"    compilerExe = \"C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//IDE//devenv\"    startupinfo = sp.STARTUPINFO()    startupinfo.dwFlags |= sp.STARTF_USESHOWWINDOW    logClean = \"clean.txt\"    stepClean = sp.Popen([compilerExe, \"/clean\", compilArgs, slnPath, \"/OUT\", logClean ], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)    stdoutdata, stderrdata = stepClean .communicate()    if stepClean.returncode != 0:        msg = \"Error: Failed to clean the solution \" + slnPath        if stdoutdata != None:            msg = msg + \"\\nError Message: \" + stdoutdata        raise RuntimeError(msg)        logBuild = \"build.txt\"    stepCompile = sp.Popen([compilerExe, \"/rebuild\", compilArgs, slnPath, \"/OUT\", logBuild], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)    stdoutdata, stderrdata = stepCompile.communicate()    if stepCompile.returncode != 0:        msg = \"Error: Failed to compile the solution \" + slnPath        if stdoutdata != None:            msg = msg + \"\\nError Message: \" + stdoutdata        raise RuntimeError(msg)\n\n上述代码中有STARTUPINFO相关内容，为了方便代码解释在此列出如下清单，清单中对每个结构体每个成员都通过注释的方式对成员的功能一一进行了解释：\n12345678910111213141516171819202122typedef struct _STARTUPINFO&#123;    DWORD cb;            //包含STARTUPINFO结构中的字节数.如果Microsoft将来扩展该结构,它可用作版本控制手段.应用程序必须将cb初始化为sizeof ( STARTUPINFO )    PSTR lpReserved;      //保留。必须初始化为N U L L    PSTR lpDesktop;    //用于标识启动应用程序所在的桌面的名字。如果该桌面存在，新进程便与指定的桌面相关联。如果桌面不存在，便创建一个带有默认属性的桌面，并使用为新进程指定的名字。    如果lpDesktop是NULL（这是最常见的情况 ),那么该进程将与当前桌面相关联    PSTR lpTitle;    //用于设定控制台窗口的名称。如果l p Ti t l e 是N U L L ，则可执行文件的名字将用作窗口名    DWORD dwX;       //用于设定应用程序窗口在屏幕上应该放置的位置的x 和y 坐标（以像素为单位）。    DWORD dwY;       //只有当子进程用CW_USEDEFAULT作为CreateWindow的x参数来创建它的第一个重叠窗口时,    才使用这两个坐标。若是创建控制台窗口的应用程序，这些成员用于指明控制台窗口的左上角    DWORD dwXSize;  //用于设定应用程序窗口的宽度和长度（以像素为单位）只有dwYsize    DWORD dwYSize;  // 当子进程将CW_USEDEFAULT 用作CreateWindow 的nWidth参数来创建它的第一个重叠窗口时，才使用这些值。若是创建控制台窗口的应用程序，这些成员将用于指明控制台窗口的宽度    DWORD dwXCountChars;  //用于设定子应用程序的控制台窗口的宽度和高度（以字符为单位）    DWORD dwYCountChars;    DWORD dwFillAttribute;   //用于设定子应用程序的控制台窗口使用的文本和背景颜色    DWORD dwFlags;           //请参见下一段和表4 - 7 的说明    WORD wShowWindow;        //用于设定如果子应用程序初次调用的ShowWindow 将SW_SHOWDEFAULT 作为    nCmdShow 参数传递时，该应用程序的第一个重叠窗口应该如何出现。本成员可以是通常用于ShowWindow 函数的任何一个SW_*标识符    WORD cbReserved2;        //保留。必须被初始化为0    PBYTE lpReserved2;       //保留。必须被初始化为N U L L    HANDLE hStdInput;        //用于设定供控制台输入和输出用的缓存的句柄。按照默认设置，hStdInput 用于标识键盘缓存，hStdOutput 和hStdError用于标识控制台窗口的缓存    HANDLE hStdOutput;    HANDLE hStdError;&#125; STARTUPINFO, *LPSTARTUPINFO;\n\n在原始代码中使用上述结构体的dwFlags成员，该成员的值被设定为STARTF_USESHOWWINDOW，意指使用wShowWindow这个成员属性，其他相关值，请参阅下列清单。这样做的目的是，当需要隐藏窗口时，结合示例代码，仅需要在代码中添加startupinfo.wShowWindow = sp.SW_HIDE即可，但因devenv这样的命令不包含窗体，为了保持简约，所以就没有写入这些代码。\n12345678910                      表4-7 dwFlags 使用标志及含义标志                                    含义STARTF_USESIZE                 &#x2F;&#x2F; 使用dwXSize 和dwYSize 成员STARTF_USESHOWWINDOW              &#x2F;&#x2F;使用wShowWindow 成员STARTF_USEPOSITION              &#x2F;&#x2F;使用dwX 和dwY 成员STARTF_USECOUNTCHARS                &#x2F;&#x2F;使用dwXCountChars 和dwYCount Chars 成员STARTF_USEFILLATTRIBUTE          &#x2F;&#x2F;使用dwFillAttribute 成员STARTF_USESTDHANDLES              &#x2F;&#x2F;使用hStdInput 、hStdOutput 和hStdError 成员STARTF_RUN_FULLSCREEN              &#x2F;&#x2F;强制在x86 计算机上运行的控制台应用程序以全屏幕方式启动运行\n\n初步修改我们要解决的“工具Tlbexp.exe无法找到”这个问题，就需要运行vsvars32.bat这batch文件，完成系统环境变量的更新。理论上仅需要在mComple这个函数中，即clean步骤前再次使用subprocess模块下的Popen方法来运行vsvars32.bat即可，相应代码应为：\n1234567891011121314151617181920212223242526272829303132333435363738import osimport subprocess as sp# 省略部分    def mCompile(slnPath, compilArgs):    \"\"\"[summary]    Args:        slnPath ([type]): [description]        compilArgs ([type]): [description]    Raises:        RuntimeError: [description]        ValueError: [description]    \"\"\"    vsvarsbatch = \"C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//Tools//vsvars32.bat\"    compilerExe = \"C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//IDE//devenv\"    startupinfo = sp.STARTUPINFO()    startupinfo.dwFlags |= sp.STARTF_USESHOWWINDOW    if vsvarsbatch != \"\":  #  run vsvars32.bat of visual studio        cmd = [vsvarsbatch]        stepVSARS = sp.Popen(cmd, stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)        stdoutdata, stderrdata = stepVSARS.communicate()                if stepVSARS.returncode != 0:            msg = \"Error: Failed to raun vsvars32.bat\"            if stdoutdata != None:                msg = msg + \"\\nError Message: \" + stdoutdata            raise RuntimeError(msg)        if stepVSARS.wait() != 0:            raise ValueError(stderrdata.decode(\"mbcs\"))    logClean = \"clean.txt\"    stepClean = sp.Popen([compilerExe, \"/clean\", compilArgs, slnPath, \"/OUT\", logClean ], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)    stdoutdata, stderrdata = stepClean .communicate()        # 省略部分\n\n可现实是这样的代码达不到预期的结果，根本原因在于：程序中，进程之间的数据是隔离的，内存空间是不能共享的，进程之间要进行数据通信必须借助其他手段。子进程的结果父进程获取不到，其他的子进程当然也无法得到。\n还会有疑问的地方可能是，可我们的问题焦点是系统的环境变量？程序中，每个进程都有自己的运行环境，这样的环境只能从父进程被继承到子进程中，而不能反向地从子进程传递到父进程。实际上，默认情况下subprocess模块下的Popen方法一直践行着这种规则，Popen方法有env这个参数，该参数用于指定子进程的环境变量，如果 env = None，子进程的环境变量将从父进程中继承。也就是说，如果环境变量不加修改，那么子进程的环境变量与父进程一致，与其他子进程也一致。由于环境变量传递的单向性，我们上述的初始修改代码是不能完成任务要求的。\n既然常规方法不行，那就使用一个非常规的方式，我们可以使用被称为“外带数据”（out-of-band）的进程通讯方式，将子进程中环境变量的变化传递给父进程。\n最终修改针对初始修改中依旧存在的问题，我们再次对代码进行了修改。最终版本如下：\n123456789101112131415161718192021222324252627282930313233343536373839404142import osimport subprocess as sp# 省略部分def mCompile(slnPath, compilArgs):    \"\"\"[summary]    Args:        slnPath ([type]): [description]        compilArgs ([type]): [description]    Raises:        RuntimeError: [description]        ValueError: [description]    \"\"\"    vvsvarsbatch = \"C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//Tools//vsvars32.bat\"    compilerExe = \"C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//IDE//devenv\"    startupinfo = sp.STARTUPINFO()    startupinfo.dwFlags |= sp.STARTF_USESHOWWINDOW    if vsvarsbatch != \"\":  #  run vsvars32.bat of visual studio        cmd = [vsvarsbatch, '&amp;&amp;', 'set']        stepVSARS = sp.Popen(cmd, stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)        stdoutdata, stderrdata = stepVSARS.communicate()                if stepVSARS.returncode != 0:            msg = \"Error: Failed to raun vsvars32.bat\"            if stdoutdata != None:                msg = msg + \"\\nError Message: \" + stdoutdata            raise RuntimeError(msg)        if stepVSARS.wait() != 0:            raise ValueError(stderrdata.decode(\"mbcs\"))        output = stdoutdata.decode(\"mbcs\").split(\"\\r\\n\")        dict_new_env = dict((e[0].upper(), e[1]) for e in [p.rstrip().split(\"=\", 1) for p in output] if len(e) == 2)        os.environ.update(dict_new_env)    logClean = \"clean.txt\"    stepClean = sp.Popen([compilerExe, \"/clean\", compilArgs, slnPath, \"/OUT\", logClean ], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)    stdoutdata, stderrdata = stepClean .communicate()        # 省略部分\n\n在这次修改中，代码cmd = [vsvarsbatch] 变成了cmd = [vsvarsbatch, ‘&amp;&amp;’, ‘set’]，因为vsvars32.bat脚本对环境变量的更新，是没有标准输出（stdout）的，即直接是看不到变化的，所以这里使用set，将子进程所有环境变量都打印到标准输出中，当组合命令运行结束之后，在检查命令是否异常结束之后，通过stdoutdata获取set命令的标准输出，然后在将得到的标准输出转换为字典格式，再然后更新当前的环境变量，这样父进程中的环境变量得到了更新。之后代码中的子进程都会使用更新之后的环境变量，这样就达到了任务要求，解决了任务难题。\n小结个人认为，项目发生变化会带来新的问题，这并不意外。解决问题时，初始思考的不全面也是正常的，遇见问题认真分析仔细研究终究会找到解决问题的方法的。当然，解决一个问题的可以有很多不同的方法，上述方法也仅仅是一家之言，并非最优，若读者有别的思路也欢迎关注我的个人微信公众号，一起讨论学习。","dateCreated":"2020-07-17T17:11:08+08:00","dateModified":"2020-07-17T17:11:08+08:00","datePublished":"2020-07-17T17:11:08+08:00","description":"作者: Jim Wang 公众号:  巴博萨船长\n摘要：Python 是如何访问和控制系统的环境变量的，Python中的父进程与子进程间的环境变量关系是何？能不能在运行时修改环境变量？子进程中对环境变量修改能不能传递给对父进程？如果能，怎么样实现这样的变化？如何使用subprocess.Popen运行vcvars.bat，然后在持续集成时，完成devenv清理和创建的前期准备。\nAbstract: How does Python access and control the system‘s environment variables？ What is the relationship between the environment variables of the parent process and the child process in Python? Can environment variables be modified at runtime? Can the modification of environment variables in the child process be passed to the parent process? If so, how to achieve such a change? How to use subprocess.Popen to run vcvars.bat, and then complete the preliminary preparations for the Clean and Build of devenv during CI.","headline":"Python 杂记之 如何在实现子进程到父进程的环境变量更新","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"},"publisher":{"@type":"Organization","name":"Jim Wang","sameAs":["https://github.com/zicowarn","#wechat","https://twitter.com/zuiwuxin?s=09","https://www.linkedin.com/in/zhichao-wang-a16662109","mailto:zicowarn@hotmail.com"],"image":"avater.png","logo":{"@type":"ImageObject","url":"avater.png"}},"url":"https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/","keywords":"Python, 杂记, 系统变量, 持续集成"}</script>
    <meta name="description" content="作者: Jim Wang 公众号:  巴博萨船长 摘要：Python 是如何访问和控制系统的环境变量的，Python中的父进程与子进程间的环境变量关系是何？能不能在运行时修改环境变量？子进程中对环境变量修改能不能传递给对父进程？如果能，怎么样实现这样的变化？如何使用subprocess.Popen运行vcvars.bat，然后在持续集成时，完成devenv清理和创建的前期准备。 Abstract:">
<meta property="og:type" content="blog">
<meta property="og:title" content="Python 杂记之 如何在实现子进程到父进程的环境变量更新">
<meta property="og:url" content="https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/index.html">
<meta property="og:site_name" content="Jim Wang 的个人技术博客">
<meta property="og:description" content="作者: Jim Wang 公众号:  巴博萨船长 摘要：Python 是如何访问和控制系统的环境变量的，Python中的父进程与子进程间的环境变量关系是何？能不能在运行时修改环境变量？子进程中对环境变量修改能不能传递给对父进程？如果能，怎么样实现这样的变化？如何使用subprocess.Popen运行vcvars.bat，然后在持续集成时，完成devenv清理和创建的前期准备。 Abstract:">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-07-17T09:11:08.000Z">
<meta property="article:modified_time" content="2020-07-17T09:11:08.000Z">
<meta property="article:author" content="Jim Wang">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="杂记">
<meta property="article:tag" content="系统变量">
<meta property="article:tag" content="持续集成">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://zicowarn.github.io/assets/images/avater.png"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-qf6kli8atum89hwig7cxpdmxj43v3mpl45frwkkd1jv7ocme0vfierrpxeez.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-172143513-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-172143513-1');
    </script>


    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1d51896cc9cd82561c7c8e353bb78c0d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Jim Wang 的个人技术博客
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/avater.png" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="阅读有关作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/avater.png" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">Jim Wang</h4>
                <h5 class="sidebar-profile-subtitle"><p>个人技术博客</p>
</h5>
                
                    <h5 class="sidebar-profile-bio"> <hr style='margin: 5px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 20%;'> <span>全栈探索之路<span> <hr style='margin: 8px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 60%;'> 记录个人对技术的理解和开发过程中遇到的问题，欢迎了解更多。 </h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/zicowarn"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#wechat"
                            
                            rel="noopener"
                            title="微信公众号"
                        >
                        <i class="sidebar-button-icon fab fa-weixin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">微信公众号</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/zuiwuxin?s=09"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/zhichao-wang-a16662109"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="领英"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">领英</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:zicowarn@hotmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="邮箱"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Python 杂记之 如何在实现子进程到父进程的环境变量更新
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-07-17T17:11:08+08:00">
	
		    7月 17, 2020
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/">Python 相关 - 8. Python 杂记</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <!-- excerpt -->

<p>作者: Jim Wang 公众号:  <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p>
<h3 id="任务背景"><a href="#任务背景" class="headerlink" title="任务背景"></a>任务背景</h3><p> 该任务是：当前所用的完成持续集成的脚本是Python语言实现的。在现有的脚本的核心内容是，使用subprocess.Popen方法来调用devenv命令，从而实现项目的清理clean和构建build。</p>
<p>今年伊始，项目中引用了.NET组件。一部分代码使用.NET完成了一个交互界面窗口。由于使用了.NET，编译的时候就需要对.NET的程序集进行强名称签名等一系列操作。例如，在导出类型库时会使用到的类型库导出工具Tlbexp.exe（一般在Visual Studio项目属性中<strong>[生成]</strong>部分中的“为COM互操作注册”被勾选时），以及程序集注册工具Regasm.exe等。此类工具的路径为：C:\Program Files (x86)\Microsoft Visual Studio 14.0\Common7\Tools\。理论上，当在命令行中使用devenv命令工具时，该工具就会自动查找上述的工具目录，并保证在编译解决方案的时候能够访问到这些工具。实践得知，devenv不能完成诸如此类环境变量的设置。进而在使用devenv时，因为项目配置中的所用到的工具因为无法找到会发生编译错误。</p>
<p>既然devenv不能实现理论结果，那就需要用到vsvars32.bat个batch文件了了。该文件是visual studio自带的文件，本质就是配置环境变量，工作目录的一些批处理命令。任务中遇到的问题是Tlbexp.exe无法找到，问题的本质是工具的路径不在系统环境中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VS140COMNTOOLS&#x3D;C:\Program Files (x86)\Microsoft Visual Studio 14.0\Common7\Tools\</span><br></pre></td></tr></table></figure>

<h3 id="初始代码"><a href="#初始代码" class="headerlink" title="初始代码"></a>初始代码</h3><p>话不多少，直接上代码，项目一开始我们使用的是如下的代码，代码的主要内容是使用subprocess模块下的Popen方法来调用cmd命令devenv完成代码的清除clean和构建build，部分代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略部分</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mCompile</span><span class="params">(slnPath, compilArgs)</span>:</span></span><br><span class="line">    <span class="string">"""[summary]</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        slnPath ([type]): [description]</span></span><br><span class="line"><span class="string">        compilArgs ([type]): [description]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        RuntimeError: [description]</span></span><br><span class="line"><span class="string">        ValueError: [description]</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    compilerExe = <span class="string">"C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//IDE//devenv"</span></span><br><span class="line">    startupinfo = sp.STARTUPINFO()</span><br><span class="line">    startupinfo.dwFlags |= sp.STARTF_USESHOWWINDOW</span><br><span class="line"></span><br><span class="line">    logClean = <span class="string">"clean.txt"</span></span><br><span class="line">    stepClean = sp.Popen([compilerExe, <span class="string">"/clean"</span>, compilArgs, slnPath, <span class="string">"/OUT"</span>, logClean ], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">    stdoutdata, stderrdata = stepClean .communicate()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> stepClean.returncode != <span class="number">0</span>:</span><br><span class="line">        msg = <span class="string">"Error: Failed to clean the solution "</span> + slnPath</span><br><span class="line">        <span class="keyword">if</span> stdoutdata != <span class="literal">None</span>:</span><br><span class="line">            msg = msg + <span class="string">"\nError Message: "</span> + stdoutdata</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(msg)</span><br><span class="line">    </span><br><span class="line">    logBuild = <span class="string">"build.txt"</span></span><br><span class="line">    stepCompile = sp.Popen([compilerExe, <span class="string">"/rebuild"</span>, compilArgs, slnPath, <span class="string">"/OUT"</span>, logBuild], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">    stdoutdata, stderrdata = stepCompile.communicate()</span><br><span class="line">    <span class="keyword">if</span> stepCompile.returncode != <span class="number">0</span>:</span><br><span class="line">        msg = <span class="string">"Error: Failed to compile the solution "</span> + slnPath</span><br><span class="line">        <span class="keyword">if</span> stdoutdata != <span class="literal">None</span>:</span><br><span class="line">            msg = msg + <span class="string">"\nError Message: "</span> + stdoutdata</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(msg)</span><br></pre></td></tr></table></figure>

<p>上述代码中有STARTUPINFO相关内容，为了方便代码解释在此列出如下清单，清单中对每个结构体每个成员都通过注释的方式对成员的功能一一进行了解释：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">STARTUPINFO</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    DWORD cb;            <span class="comment">//包含STARTUPINFO结构中的字节数.如果Microsoft将来扩展该结构,它可用作版本控制手段.应用程序必须将cb初始化为sizeof ( STARTUPINFO )</span></span><br><span class="line">    PSTR lpReserved;      <span class="comment">//保留。必须初始化为N U L L</span></span><br><span class="line">    PSTR lpDesktop;    <span class="comment">//用于标识启动应用程序所在的桌面的名字。如果该桌面存在，新进程便与指定的桌面相关联。如果桌面不存在，便创建一个带有默认属性的桌面，并使用为新进程指定的名字。    如果lpDesktop是NULL（这是最常见的情况 ),那么该进程将与当前桌面相关联</span></span><br><span class="line">    PSTR lpTitle;    <span class="comment">//用于设定控制台窗口的名称。如果l p Ti t l e 是N U L L ，则可执行文件的名字将用作窗口名</span></span><br><span class="line">    DWORD dwX;       <span class="comment">//用于设定应用程序窗口在屏幕上应该放置的位置的x 和y 坐标（以像素为单位）。</span></span><br><span class="line">    DWORD dwY;       <span class="comment">//只有当子进程用CW_USEDEFAULT作为CreateWindow的x参数来创建它的第一个重叠窗口时,    才使用这两个坐标。若是创建控制台窗口的应用程序，这些成员用于指明控制台窗口的左上角</span></span><br><span class="line"></span><br><span class="line">    DWORD dwXSize;  <span class="comment">//用于设定应用程序窗口的宽度和长度（以像素为单位）只有dwYsize</span></span><br><span class="line">    DWORD dwYSize;  <span class="comment">// 当子进程将CW_USEDEFAULT 用作CreateWindow 的nWidth参数来创建它的第一个重叠窗口时，才使用这些值。若是创建控制台窗口的应用程序，这些成员将用于指明控制台窗口的宽度</span></span><br><span class="line">    DWORD dwXCountChars;  <span class="comment">//用于设定子应用程序的控制台窗口的宽度和高度（以字符为单位）</span></span><br><span class="line">    DWORD dwYCountChars;</span><br><span class="line">    DWORD dwFillAttribute;   <span class="comment">//用于设定子应用程序的控制台窗口使用的文本和背景颜色</span></span><br><span class="line">    DWORD dwFlags;           <span class="comment">//请参见下一段和表4 - 7 的说明</span></span><br><span class="line">    WORD wShowWindow;        <span class="comment">//用于设定如果子应用程序初次调用的ShowWindow 将SW_SHOWDEFAULT 作为    nCmdShow 参数传递时，该应用程序的第一个重叠窗口应该如何出现。本成员可以是通常用于ShowWindow 函数的任何一个SW_*标识符</span></span><br><span class="line">    WORD cbReserved2;        <span class="comment">//保留。必须被初始化为0</span></span><br><span class="line">    PBYTE lpReserved2;       <span class="comment">//保留。必须被初始化为N U L L</span></span><br><span class="line">    HANDLE hStdInput;        <span class="comment">//用于设定供控制台输入和输出用的缓存的句柄。按照默认设置，hStdInput 用于标识键盘缓存，hStdOutput 和hStdError用于标识控制台窗口的缓存</span></span><br><span class="line">    HANDLE hStdOutput;</span><br><span class="line">    HANDLE hStdError;</span><br><span class="line">&#125; STARTUPINFO, *LPSTARTUPINFO;</span><br></pre></td></tr></table></figure>

<p>在原始代码中使用上述结构体的<strong>dwFlags</strong>成员，该成员的值被设定为<strong>STARTF_USESHOWWINDOW</strong>，意指使用wShowWindow这个成员属性，其他相关值，请参阅下列清单。这样做的目的是，当需要隐藏窗口时，结合示例代码，仅需要在代码中添加startupinfo.wShowWindow = sp.SW_HIDE即可，但因devenv这样的命令不包含窗体，为了保持简约，所以就没有写入这些代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">                      表4-7 dwFlags 使用标志及含义</span><br><span class="line">标志                                    含义</span><br><span class="line"></span><br><span class="line">STARTF_USESIZE                 &#x2F;&#x2F; 使用dwXSize 和dwYSize 成员</span><br><span class="line">STARTF_USESHOWWINDOW              &#x2F;&#x2F;使用wShowWindow 成员</span><br><span class="line">STARTF_USEPOSITION              &#x2F;&#x2F;使用dwX 和dwY 成员</span><br><span class="line">STARTF_USECOUNTCHARS                &#x2F;&#x2F;使用dwXCountChars 和dwYCount Chars 成员</span><br><span class="line">STARTF_USEFILLATTRIBUTE          &#x2F;&#x2F;使用dwFillAttribute 成员</span><br><span class="line">STARTF_USESTDHANDLES              &#x2F;&#x2F;使用hStdInput 、hStdOutput 和hStdError 成员</span><br><span class="line">STARTF_RUN_FULLSCREEN              &#x2F;&#x2F;强制在x86 计算机上运行的控制台应用程序以全屏幕方式启动运行</span><br></pre></td></tr></table></figure>

<h3 id="初步修改"><a href="#初步修改" class="headerlink" title="初步修改"></a>初步修改</h3><p>我们要解决的“工具Tlbexp.exe无法找到”这个问题，就需要运行vsvars32.bat这batch文件，完成系统环境变量的更新。理论上仅需要在mComple这个函数中，即clean步骤前再次使用subprocess模块下的Popen方法来运行vsvars32.bat即可，相应代码应为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略部分</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mCompile</span><span class="params">(slnPath, compilArgs)</span>:</span></span><br><span class="line">    <span class="string">"""[summary]</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        slnPath ([type]): [description]</span></span><br><span class="line"><span class="string">        compilArgs ([type]): [description]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        RuntimeError: [description]</span></span><br><span class="line"><span class="string">        ValueError: [description]</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    vsvarsbatch = <span class="string">"C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//Tools//vsvars32.bat"</span></span><br><span class="line">    compilerExe = <span class="string">"C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//IDE//devenv"</span></span><br><span class="line">    startupinfo = sp.STARTUPINFO()</span><br><span class="line">    startupinfo.dwFlags |= sp.STARTF_USESHOWWINDOW</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> vsvarsbatch != <span class="string">""</span>:  <span class="comment">#  run vsvars32.bat of visual studio</span></span><br><span class="line">        cmd = [vsvarsbatch]</span><br><span class="line">        stepVSARS = sp.Popen(cmd, stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">        stdoutdata, stderrdata = stepVSARS.communicate()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> stepVSARS.returncode != <span class="number">0</span>:</span><br><span class="line">            msg = <span class="string">"Error: Failed to raun vsvars32.bat"</span></span><br><span class="line">            <span class="keyword">if</span> stdoutdata != <span class="literal">None</span>:</span><br><span class="line">                msg = msg + <span class="string">"\nError Message: "</span> + stdoutdata</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(msg)</span><br><span class="line">        <span class="keyword">if</span> stepVSARS.wait() != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(stderrdata.decode(<span class="string">"mbcs"</span>))</span><br><span class="line"></span><br><span class="line">    logClean = <span class="string">"clean.txt"</span></span><br><span class="line">    stepClean = sp.Popen([compilerExe, <span class="string">"/clean"</span>, compilArgs, slnPath, <span class="string">"/OUT"</span>, logClean ], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">    stdoutdata, stderrdata = stepClean .communicate()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 省略部分</span></span><br></pre></td></tr></table></figure>

<p>可现实是这样的代码达不到预期的结果，根本原因在于：<strong>程序中，进程之间的数据是隔离的，内存空间是不能共享的，进程之间要进行数据通信必须借助其他手段。子进程的结果父进程获取不到，其他的子进程当然也无法得到。</strong></p>
<p>还会有疑问的地方可能是，<strong>可我们的问题焦点是系统的环境变量？</strong>程序中，每个进程都有自己的运行环境，这样的环境只能从父进程被继承到子进程中，而不能反向地从子进程传递到父进程。实际上，默认情况下subprocess模块下的Popen方法一直践行着这种规则，Popen方法有env这个参数，该参数用于指定子进程的环境变量，如果 env = None，子进程的环境变量将从父进程中继承。也就是说，如果环境变量不加修改，那么子进程的环境变量与父进程一致，与其他子进程也一致。由于环境变量传递的单向性，我们上述的初始修改代码是不能完成任务要求的。</p>
<p>既然常规方法不行，那就使用一个<strong>非常规</strong>的方式，我们可以使用被称为“<strong>外带数据</strong>”（out-of-band）的进程通讯方式，将子进程中环境变量的变化传递给父进程。</p>
<h3 id="最终修改"><a href="#最终修改" class="headerlink" title="最终修改"></a>最终修改</h3><p>针对初始修改中依旧存在的问题，我们再次对代码进行了修改。最终版本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略部分</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mCompile</span><span class="params">(slnPath, compilArgs)</span>:</span></span><br><span class="line">    <span class="string">"""[summary]</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        slnPath ([type]): [description]</span></span><br><span class="line"><span class="string">        compilArgs ([type]): [description]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        RuntimeError: [description]</span></span><br><span class="line"><span class="string">        ValueError: [description]</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    vvsvarsbatch = <span class="string">"C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//Tools//vsvars32.bat"</span></span><br><span class="line">    compilerExe = <span class="string">"C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//IDE//devenv"</span></span><br><span class="line">    startupinfo = sp.STARTUPINFO()</span><br><span class="line">    startupinfo.dwFlags |= sp.STARTF_USESHOWWINDOW</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> vsvarsbatch != <span class="string">""</span>:  <span class="comment">#  run vsvars32.bat of visual studio</span></span><br><span class="line">        cmd = [vsvarsbatch, <span class="string">'&amp;&amp;'</span>, <span class="string">'set'</span>]</span><br><span class="line">        stepVSARS = sp.Popen(cmd, stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">        stdoutdata, stderrdata = stepVSARS.communicate()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> stepVSARS.returncode != <span class="number">0</span>:</span><br><span class="line">            msg = <span class="string">"Error: Failed to raun vsvars32.bat"</span></span><br><span class="line">            <span class="keyword">if</span> stdoutdata != <span class="literal">None</span>:</span><br><span class="line">                msg = msg + <span class="string">"\nError Message: "</span> + stdoutdata</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(msg)</span><br><span class="line">        <span class="keyword">if</span> stepVSARS.wait() != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(stderrdata.decode(<span class="string">"mbcs"</span>))</span><br><span class="line"></span><br><span class="line">        output = stdoutdata.decode(<span class="string">"mbcs"</span>).split(<span class="string">"\r\n"</span>)</span><br><span class="line">        dict_new_env = dict((e[<span class="number">0</span>].upper(), e[<span class="number">1</span>]) <span class="keyword">for</span> e <span class="keyword">in</span> [p.rstrip().split(<span class="string">"="</span>, <span class="number">1</span>) <span class="keyword">for</span> p <span class="keyword">in</span> output] <span class="keyword">if</span> len(e) == <span class="number">2</span>)</span><br><span class="line">        os.environ.update(dict_new_env)</span><br><span class="line"></span><br><span class="line">    logClean = <span class="string">"clean.txt"</span></span><br><span class="line">    stepClean = sp.Popen([compilerExe, <span class="string">"/clean"</span>, compilArgs, slnPath, <span class="string">"/OUT"</span>, logClean ], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">    stdoutdata, stderrdata = stepClean .communicate()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 省略部分</span></span><br></pre></td></tr></table></figure>

<p>在这次修改中，代码<strong>cmd = [vsvarsbatch]</strong> 变成了<strong>cmd = [vsvarsbatch, ‘&amp;&amp;’, ‘set’]</strong>，因为vsvars32.bat脚本对环境变量的更新，是没有<strong>标准输出</strong>（stdout）的，即直接是看不到变化的，所以这里使用<strong>set</strong>，将子进程所有环境变量都打印到<strong>标准输出</strong>中，当<strong>组合命令</strong>运行结束之后，在检查命令是否异常结束之后，通过stdoutdata获取set命令的标准输出，然后在将得到的标准输出转换为字典格式，再然后更新当前的环境变量，这样父进程中的环境变量得到了更新。之后代码中的子进程都会使用更新之后的环境变量，这样就达到了任务要求，解决了任务难题。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>个人认为，项目发生变化会带来新的问题，这并不意外。解决问题时，初始思考的不全面也是正常的，遇见问题认真分析仔细研究终究会找到解决问题的方法的。当然，解决一个问题的可以有很多不同的方法，上述方法也仅仅是一家之言，并非最优，若读者有别的思路也欢迎关注我的个人微信公众号，一起讨论学习。</p>
            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Python/" rel="tag">Python</a> <a class="tag tag--primary tag--small t-link" href="/tags/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/" rel="tag">持续集成</a> <a class="tag tag--primary tag--small t-link" href="/tags/%E6%9D%82%E8%AE%B0/" rel="tag">杂记</a> <a class="tag tag--primary tag--small t-link" href="/tags/%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F/" rel="tag">系统变量</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/07/13/inno-06-gacinstall/"
                    data-tooltip="Inno Setup 如何将.NET程序集（DLL）安装到GAC中"
                    aria-label="下一篇: Inno Setup 如何将.NET程序集（DLL）安装到GAC中"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/&amp;title=Python 杂记之 如何在实现子进程到父进程的环境变量更新"
                    title="分享到 QQ"
                    aria-label="分享到 QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Jim Wang. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a
                        class="post-action-btn btn btn--disabled"
                        aria-hidden="true"
                    >
                        
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2020/07/13/inno-06-gacinstall/"
                    data-tooltip="Inno Setup 如何将.NET程序集（DLL）安装到GAC中"
                    aria-label="下一篇: Inno Setup 如何将.NET程序集（DLL）安装到GAC中"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/&amp;title=Python 杂记之 如何在实现子进程到父进程的环境变量更新"
                    title="分享到 QQ"
                    aria-label="分享到 QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Nach oben">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                        aria-label="分享到 Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>分享到 Google+</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://service.weibo.com/share/share.php?&amp;title=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"
                        aria-label="分享到 Weibo"
                    >
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>分享到 Weibo</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://connect.qq.com/widget/shareqq/index.html?url=https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/&amp;title=Python 杂记之 如何在实现子进程到父进程的环境变量更新"
                        aria-label="分享到 QQ"
                    >
                        <i class="fab fa-qq" aria-hidden="true"></i><span>分享到 QQ</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avater.png" alt="作者的图片"/>
        
            <h4 id="about-card-name">Jim Wang</h4>
        
            <div id="about-card-bio"> <hr style='margin: 5px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 20%;'> <span>全栈探索之路<span> <hr style='margin: 8px auto; border-top: 1px solid rgba(255,255,255,0.14); width: 60%;'> 记录个人对技术的理解和开发过程中遇到的问题，欢迎了解更多。 </div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>软件工程师</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                河南，中国
            </div>
        
    </div>
</div>

        




    
        
    



    
        
    

<div id="wechat">
    <div id="wechat-card">
        <div id="wechat-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="wechat-qrcode-picture" src="/assets/images/wechat-qrcode.jpg" alt="global.wechat_public_qr_code_image"/>
        
        
            <div id="wechat-qrcode-desc"><p>请扫描上方的二维码订阅我的个人微信公众号</p> <hr style='margin: 8px auto; border-top: 2px solid rgba(1, 1, 1, 0.14); width: 60%;'> <p>原创不易，多多点赞分享支持。</p></div>
        
        
            <img id="wechat-searchbar-picture" src="/assets/images/wechat-search-white.png" alt="global.wechat_public_search_bar_image"/>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/background-cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-dyygqsv8rvipcxlm9mjaaxhijpqtac483g9zfmmksnciwm37lnfqp6l7anta.min.js"></script>

<!--SCRIPTS END-->


    




    </body>
</html>
