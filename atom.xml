<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jim Wang 的个人技术博客</title>
  
  <subtitle>全栈探索之路</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://zicowarn.github.io/"/>
  <updated>2020-11-28T23:56:11.496Z</updated>
  <id>https://zicowarn.github.io/</id>
  
  <author>
    <name>Jim Wang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>机械加工 之表面粗糙度的定义与总结</title>
    <link href="https://zicowarn.github.io/2020/11/28/machining-01-surface-roughness-knowledge/"/>
    <id>https://zicowarn.github.io/2020/11/28/machining-01-surface-roughness-knowledge/</id>
    <published>2020-11-28T15:24:37.000Z</published>
    <updated>2020-11-28T23:56:11.496Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>作者: Jim Wang 公众号:  <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><h3 id="表面粗糙度定义">表面粗糙度定义</h3><p>是通过真实表面法线向量方向与其理想形式的偏差来量化的。理解为加工表面具有的较小间距和微小峰谷的不平度。其两波峰或两波谷之间的距离（波距）很小（在1mm以下），它属于微观几何形状误差如果这些偏差大，则表面粗糙；如果它们很小，则表面是光滑的。理论（几何）表面粗糙度。如何获得表面粗糙度值车削时的理论表面粗糙度表示最小值切削条件下的粗糙度值，由公式如下：</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201129004330995.png" alt="image-20201129004330995"><br>上述公式中:</p><ul><li><p>Rz<sub>h</sub> ：理论表面粗糙度，单位µm。</p></li><li><p>f：进给速率（每转进给，Feed per revolution），单位mm/rev。</p><p>进给速率的的计算公式如下：</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201129004401554.png" alt="image-20201129004401554"></p><p>上述公式中</p><ul><li><strong>l</strong>为切割每分钟长度，单位mm/min。</li><li><strong>n</strong>为主轴转速（Main Axis Spindle Speed），单位为min<sup>-1</sup>。</li></ul><p>例，当主轴转速为500min-1且每分钟切削长度为120mm / min时，每转进给量是多少？</p><p>答，将n = 500，I = 120代入公式。</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201129004431547.png" alt="image-20201129004431547"></p><p>即为0.24 mm/rev。</p></li><li><p>R<sub>rε</sub>：也记作R<sub>e</sub>，内转角半径（Corner Radius of Insert），单位mm。</p></li></ul><p>理解上述公式可参考下图。</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128115916694.png" alt="image-20201128115916694"></p><h3 id="Ra，Rz与Ry-定义">Ra，Rz与Ry 定义</h3><p>Ra：轮廓算术平均偏差，取度L内轮廓偏距绝值算术平均值。主要的评定参数。<br>Rz：微观不平度十点高度，取度L内5轮廓峰高平均值与 5轮廓谷深平均值。一般只用来表示比较短小的表面。<br>Ry：轮廓最大高度，取度L内轮廓峰顶线与轮廓谷底线间距离。基本不单独使用，算是一个极限偏差值吧。</p><h4 id="算数平均偏差Ra">算数平均偏差Ra</h4><p>Ra 的计算公式如下：</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201129004450644.png" alt="image-20201129004450644"></p><p>当粗糙度曲线用y = f（x）表示时，以X轴为平均线方向，以Y轴为粗糙度曲线的垂直放大倍率在采样参考长度“ℓ”的范围内时用微米表示。Ra能客观地反映被测轮廓的几何特性。Ra值可用电动轮廓仪直接测量，但不够直观。</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128130650419.png" alt="image-20201128130650419"></p><h4 id="微观不平度十点高度Rz">微观不平度十点高度Rz</h4><p>Rz的计算公式如下：</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201129004534086.png" alt="image-20201129004534086"></p><p>从平均线与最高峰之间的5个峰（Yp）之间的平均距离以及平均线与5个谷值之间的各个距离（Yv）的平均值（以微米为单位）即可得出Rz。Rz用于评定表面粗糙度高度参数有较好的直观性，易在光学仪器上测量，但反映被测轮廓几何形状特性有局限性。</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128132407456.png" alt="image-20201128132407456"></p><p>上图中Yp1，Yp2，Yp3，Yp4，Yp5，为从平均线到采样参考长度“ℓ”范围内最高的5个峰的距离。而Yv1，Yv2，Yv3，Yv4，Yv5，则为从平均线到最低5米谷在取样基准长度“ℓ”的范围内的距离。</p><h4 id="轮廓最大高度Ry">轮廓最大高度Ry</h4><p>Ry的计算公式如下：</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201129004548681.png" alt="image-20201129004548681"></p><p>Ry是从采样基准长度（ℓ）范围内的最高峰和最低谷之间的距离（以微米为单位）到粗糙度曲线的平均线方向得出的。参数Ry，测量简单，当被测表面很小，不适宜采用Rz，Rz评定时，可采用Ry。</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128133525881.png" alt="image-20201128133525881"></p><h4 id="均方根值RMS">均方根值RMS</h4><p>RMS的计算公式如下：</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201129004604616.png" alt="image-20201129004604616"></p><p>上述式子中：</p><ul><li>L， 为评估长度</li><li>Z(x)，为轮廓高度函数</li></ul><p>该公式近似等效于：</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201129004615765.png" alt="image-20201129004615765"></p><p>RMS是轮廓长度与平均线偏差的均方根平均值，记录在评估长度内。Ra和RMS都是表面粗糙度的表示，但是各自的计算方式不同。Ra被计算为表面的微观粗糙度的平均峰和谷。RMS计算为表面的微观均方根的均方根。每个值都使用相同的表面峰和谷高度测量值，但使用不同的公式进行测量。</p><h4 id="JIS标准中Ra，Rz与Ry符号与变化">JIS标准中Ra，Rz与Ry符号与变化</h4><table><thead><tr><th>类型</th><th>依据JIS B 0601-1994 标准</th><th>依据JIS B 0601-2001 标准</th></tr></thead><tbody><tr><td>轮廓最大高度</td><td>R<sub>y</sub></td><td>R<sub>z</sub></td></tr><tr><td>微观不平度十点高度</td><td>R<sub>z</sub></td><td>R<sub>zJIS</sub></td></tr><tr><td>轮廓算术平均偏差</td><td>R<sub>a</sub></td><td>R<sub>a</sub></td></tr></tbody></table><h3 id="各国对于表面精度的定义工业标准（部分）">各国对于表面精度的定义工业标准（部分）</h3><h4 id="中国：">中国：</h4><ul><li>GB/T 3505 2000 表面粗糙度术语表面及其参数；</li><li>GB/T 1031-1995 表面粗糙度参数及其数值；</li><li>GB/T 131-1993 机械制图表面粗糙度符号、代号及其注法。</li></ul><h4 id="日本：">日本：</h4><ul><li>JIS B 0601-2001，定义和名称JISB图。表面粗糙度。</li><li>JIS B 0601-1982，定义和名称JISB图。表面粗糙度，旧版。</li><li>JIS B 0031-1982，定义和名称JISB图。表面粗糙度，旧版。</li><li>JIS B 0031-1994，定义和名称JISB图。表面粗糙度，旧版。</li><li>JIS B 0601-1994，定义和名称JISB图。表面粗糙度，旧版。</li></ul><h4 id="英国：">英国：</h4><ul><li>BS EN ISO 4287:2000，常用参数的定义。</li></ul><h4 id="德国：">德国：</h4><ul><li>DIN 4768 （1990）各个领域（包括金属铸件）表面粗糙度的标准。</li><li>DIN 4771 （1977）测量表面轮廓高度Pₜ。</li><li>DIN 4775 （1982）测量工件的表面粗糙度。</li><li>DIN 4776 （1990）测量表面粗糙度； 参数R 1，R 4，Rvk，Mr1，Mr2用于描述粗糙度轮廓中的材料部分（轮廓承载长度比）； 测量条件和评估程序。</li><li>DIN 4777 （1982）表面计量； 电接触式测针仪器的轮廓过滤器； 相位校正滤波器。</li><li>DIN ISO 1302 各个领域（包括金属铸件）表面粗糙度的标准。</li></ul><h4 id="法国：">法国：</h4><ul><li>NF E05-015 （1984），产品几何规格（GPS）-表面纹理：轮廓法-术语，定义和表面纹理参数</li><li>NF E05-016 （1978），几何产品规范（GPS）-技术产品文档中的表面纹理指示</li><li>NF E05-017 （1972），产品的表面状况，表面的测定方法。</li></ul><h4 id="欧洲：">欧洲：</h4><ul><li>EN 10049 2005， 该欧洲标准定义了未镀膜（冷轧和热轧酸洗钢）和镀有金属涂层（例如锌，铝，锡，铬）的金属扁平产品的表面粗糙度参数的测量条件</li></ul><h4 id="美国国家标准">美国国家标准:</h4><ul><li>ASME B46.1-2009，表面纹理（表面粗糙度，  波度和位置）。</li><li>ASME B46.1-1995，表面纹理（表面粗糙度，  波度和位置），旧版。</li><li>ASME B46.1-1985，表面纹理（表面粗糙度，  波度和位置），旧版。</li><li>ANSI B4.2-1978，表面纹理。 表面ANSI粗糙度，起伏和起伏。</li></ul><h4 id="国际标准：">国际标准：</h4><ul><li><p>ISO 1320-2002，主要标准，提供常用参数的定义。</p></li><li><p>ISO 25178-71-2012， 几何技术规范(GPS)，表面纹理.</p></li><li><p>ISO 468-1982，表面粗糙度—参数，其值和用于指定要求的一般规则</p></li><li><p>ISO 4287-1997，常用参数的定义，例如Rx给出的定义。</p></li><li><p>ISO 4287/1-1984，</p></li><li><p>ISO 4288-1996，产品几何技术规范，轮廓法-表面纹理评估的规则和程序</p></li><li><p>ISO 4288-1985，</p></li><li><p>ISO 1320-1978，</p></li><li><p>ISO 12085-1996，轮廓方法—图案参数</p></li></ul><h3 id="表面粗糙度的符号、代号">表面粗糙度的符号、代号</h3><h4 id="基本概念">基本概念</h4><p>如下图所示，在表面符号的周围表示表面粗糙度值，截止值或基准长度，加工方法，晶粒方向，表面起伏等。</p><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128211851279.png" alt="image-20201128211851279"></p><ul><li>a，Ra值</li><li>b，加工方式</li><li>c，临界值，评估长度</li><li>c´,  参考长度，评估长度</li><li>d，纹理方向</li><li>f，Ra以外的参数（例如：参数/切断水平）</li><li>g，表面起伏</li></ul><h4 id="基本符号样式-JIS-B-0610-与DIN-ISO-1302-DIN-4768">基本符号样式 (JIS B 0610 与DIN ISO 1302, DIN 4768 )</h4><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128212523571.png" alt="image-20201128212523571"></p><h4 id="加工需去除材料-JIS-B-0610-与DIN-ISO-1302-DIN-4768">加工需去除材料 (JIS B 0610 与DIN ISO 1302, DIN 4768 )</h4><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128212639604.png" alt="image-20201128212639604"></p><h4 id="加工时禁止去除材料-JIS-B-0610-与DIN-ISO-1302-DIN-4768">加工时禁止去除材料(JIS B 0610 与DIN ISO 1302, DIN 4768 )</h4><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128212737091.png" alt="image-20201128212737091"></p><h4 id="预设Ra的上限-JIS-B-0610-与DIN-ISO-1302-DIN-4768">预设Ra的上限(JIS B 0610 与DIN ISO 1302, DIN 4768 )</h4><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128212913244.png" alt="image-20201128212913244"></p><h4 id="标定纹理方向-JIS-B-0610-与DIN-ISO-1302-DIN-4768">标定纹理方向(JIS B 0610 与DIN ISO 1302, DIN 4768 )</h4><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128213020074.png" alt="image-20201128213020074"></p><h4 id="预设Ra的上限与下限-JIS-B-0610-与DIN-ISO-1302-DIN-4768">预设Ra的上限与下限(JIS B 0610 与DIN ISO 1302, DIN 4768 )</h4><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128213048947.png" alt="image-20201128213048947"></p><h4 id="标定加工方式-JIS-B-0610-与DIN-ISO-1302-DIN-4768">标定加工方式(JIS B 0610 与DIN ISO 1302, DIN 4768 )</h4><p><img src="/2020/11/28/machining-01-surface-roughness-knowledge/image-20201128213122267.png" alt="image-20201128213122267"></p><h3 id="表面粗糙度三角形符号与Ra，Rz和Ry对照表">表面粗糙度三角形符号与Ra，Rz和Ry对照表</h3><p>三角形符号是是在加工设计是，对加工表面精度等级进行简单标记的一种方式。需要说明的是：从1994年修订版的JIS标准中取消了精加工符号（三角形▽和波〜）。在这里也就对三角形符号进行简单介绍。</p><table><thead><tr><th>Ra 单位µm</th><th>Ry 单位µm</th><th>RzJIS 单位µm</th><th>三角形符号</th></tr></thead><tbody><tr><td>0.0025<br>0.05<br>0.1<br>0.2</td><td>0.1<br>0.2<br>0.4<br>0.8</td><td>0.1<br>0.2<br>0.4<br>0.8</td><td>∇∇∇∇</td></tr><tr><td>0.4<br>0.8<br>1.6</td><td>1.6<br>3.2<br>6.3</td><td>1.6<br>3.2<br>6.3</td><td>∇∇∇</td></tr><tr><td>3.2<br>6.3</td><td>12.5<br>25</td><td>12.5<br>25</td><td>∇∇</td></tr><tr><td>12.5<br>25</td><td>50<br>100</td><td>50<br>100</td><td>∇</td></tr></tbody></table><h3 id="表面粗糙度对照表">表面粗糙度对照表</h3><table><thead><tr><th>Rz (µm)</th><th>VDI-3400</th><th>Ra (µm)</th><th>RMS (µinch)</th><th>Class ISO 1302</th></tr></thead><tbody><tr><td>0.08</td><td>-</td><td>0.0125</td><td>0.5</td><td></td></tr><tr><td>0.16</td><td>-</td><td>0.025</td><td>1</td><td></td></tr><tr><td>0.32</td><td>-</td><td>0.05</td><td>2</td><td></td></tr><tr><td>0.64</td><td>0</td><td>0.10</td><td>4.1</td><td>N3</td></tr><tr><td>0.70</td><td>1</td><td>0.11</td><td>4.5</td><td></td></tr><tr><td>0.76</td><td>2</td><td>0.12</td><td>4.9</td><td></td></tr><tr><td>0.90</td><td>3</td><td>0.14</td><td>5.7</td><td></td></tr><tr><td>1.02</td><td>4</td><td>0.15</td><td>6.6</td><td></td></tr><tr><td>1.15</td><td>5</td><td>0.17</td><td>7.4</td><td></td></tr><tr><td>1.28</td><td>6</td><td>0.20</td><td>8.2</td><td>N4</td></tr><tr><td>1.41</td><td>7</td><td>0.23</td><td>9.0</td><td></td></tr><tr><td>1.60</td><td>8</td><td>0.25</td><td>10.2</td><td></td></tr><tr><td>1.79</td><td>9</td><td>0.28</td><td>11.5</td><td></td></tr><tr><td>2.05</td><td>10</td><td>0.32</td><td>13.1</td><td></td></tr><tr><td>2.24</td><td>11</td><td>0.35</td><td>14.3</td><td></td></tr><tr><td>2.56</td><td>12</td><td>0.40</td><td>16.4</td><td>N5</td></tr><tr><td>2.88</td><td>13</td><td>0.45</td><td>18.4</td><td></td></tr><tr><td>3.20</td><td>14</td><td>0.50</td><td>20.5</td><td></td></tr><tr><td>3.58</td><td>15</td><td>0.56</td><td>22.9</td><td></td></tr><tr><td>4.03</td><td>16</td><td>0.63</td><td>25.8</td><td></td></tr><tr><td>4.48</td><td>17</td><td>0.70</td><td>28.7</td><td></td></tr><tr><td>5.12</td><td>18</td><td>0.80</td><td>32.8</td><td></td></tr><tr><td>5.76</td><td>19</td><td>0.90</td><td>36.9</td><td>N6</td></tr><tr><td>6.40</td><td>20</td><td>1.00</td><td>41.0</td><td></td></tr><tr><td>7.17</td><td>21</td><td>1.12</td><td>45.8</td><td></td></tr><tr><td>8.06</td><td>22</td><td>1.26</td><td>51.6</td><td></td></tr><tr><td>8.96</td><td>23</td><td>1.40</td><td>57.3</td><td></td></tr><tr><td>10.24</td><td>24</td><td>1.60</td><td>65.5</td><td></td></tr><tr><td>11.52</td><td>25</td><td>1.80</td><td>73.7</td><td>N7</td></tr><tr><td>12.80</td><td>26</td><td>2.00</td><td>81.9</td><td></td></tr><tr><td>14.08</td><td>27</td><td>2.20</td><td>90.1</td><td></td></tr><tr><td>16.00</td><td>28</td><td>2.50</td><td>102.4</td><td></td></tr><tr><td>17.92</td><td>29</td><td>2.80</td><td>114.6</td><td></td></tr><tr><td>20.48</td><td>30</td><td>3.20</td><td>131.1</td><td>N8</td></tr><tr><td>22.40</td><td>31</td><td>3.50</td><td>143.4</td><td></td></tr><tr><td>25.60</td><td>32</td><td>4.00</td><td>163.8</td><td></td></tr><tr><td>-</td><td>33</td><td>4.50</td><td>-</td><td></td></tr><tr><td>32.00</td><td>34</td><td>5.00</td><td>204.8</td><td></td></tr><tr><td>-</td><td>35</td><td>5.60</td><td>-</td><td></td></tr><tr><td>40.32</td><td>36</td><td>6.30</td><td>258.0</td><td>N9</td></tr><tr><td>-</td><td>37</td><td>7.00</td><td>-</td><td></td></tr><tr><td>51.20</td><td>38</td><td>8.00</td><td>327.7</td><td></td></tr><tr><td>-</td><td>39</td><td>9.00</td><td>-</td><td></td></tr><tr><td>64.00</td><td>40</td><td>10.00</td><td>409.6</td><td></td></tr><tr><td>-</td><td>41</td><td>11.20</td><td>-</td><td></td></tr><tr><td>-</td><td>42</td><td>12.60</td><td>-</td><td>N10</td></tr><tr><td>-</td><td>43</td><td>14.00</td><td>-</td><td></td></tr><tr><td>-</td><td>44</td><td>16.00</td><td>-</td><td></td></tr><tr><td>-</td><td>45</td><td>18.00</td><td>-</td><td></td></tr></tbody></table><p>*VDI：Verein Deutscher Ingenieure 德国工业协会</p><p>*RMS：Root mean square 均方根</p><h3 id="加工方式与加工精度对照表">加工方式与加工精度对照表</h3><p>表内符号 ○ 默认加工(Standard)，●  精密加工 (Precision)，◇  粗加工(Rough)，◈ 中等 (Medium)，◆ 精密(Fine)</p><table style="border: 1px solid black;border-collapse: collapse;">      <thead style="font-size:x-small">        <tr>            <th colspan="2" style="font-size:x-small;border: 1px solid black;border-collapse: collapse;">Ra算术平均</th>            <th style="border: 1px solid black;border-collapse: collapse;">0.025</th>            <th style="border: 1px solid black;border-collapse: collapse;">0.05</th>            <th style="border: 1px solid black;border-collapse: collapse;">0.1</th>            <th style="border: 1px solid black;border-collapse: collapse;">0.2</th>            <th style="border: 1px solid black;border-collapse: collapse;">0.4</th>            <th style="border: 1px solid black;border-collapse: collapse;">0.8</th>            <th style="border: 1px solid black;border-collapse: collapse;">1.6</th>            <th style="border: 1px solid black;border-collapse: collapse;">3.2</th>            <th style="border: 1px solid black;border-collapse: collapse;">6.3</th>            <th style="border: 1px solid black;border-collapse: collapse;">12.5</th>            <th style="border: 1px solid black;border-collapse: collapse;">25</th>            <th style="border: 1px solid black;border-collapse: collapse;">50</th>            <th style="border: 1px solid black;border-collapse: collapse;">100</th>        </tr>        <tr>            <th colspan="2" style="font-size:x-small;border: 1px solid black;border-collapse: collapse;">Ry最大峰值</th>            <th style="border: 1px solid black;border-collapse: collapse;">0.1</th>            <th style="border: 1px solid black;border-collapse: collapse;">0.2</th>            <th style="border: 1px solid black;border-collapse: collapse;">0.4</th>            <th style="border: 1px solid black;border-collapse: collapse;">0.8</th>            <th style="border: 1px solid black;border-collapse: collapse;">1.6</th>            <th style="border: 1px solid black;border-collapse: collapse;">3.2</th>            <th style="border: 1px solid black;border-collapse: collapse;">6.3</th>            <th style="border: 1px solid black;border-collapse: collapse;">3.2</th>            <th style="border: 1px solid black;border-collapse: collapse;">12.5</th>            <th style="border: 1px solid black;border-collapse: collapse;">25</th>            <th style="border: 1px solid black;border-collapse: collapse;">100</th>            <th style="border: 1px solid black;border-collapse: collapse;">200</th>            <th style="border: 1px solid black;border-collapse: collapse;">400</th>        </tr>        <tr>            <th colspan="2" style="font-size:x-small;border: 1px solid black;border-collapse: collapse;">评定长度 mm</th>            <th colspan="4" style="text-align:center;border: 1px solid black;border-collapse: collapse;">0.25</th>            <th colspan="3" style="text-align:center;border: 1px solid black;border-collapse: collapse;">0.8</th>            <th colspan="2" style="text-align:center;border: 1px solid black;border-collapse: collapse;">2.5</th>            <th colspan="2" style="text-align:center;border: 1px solid black;border-collapse: collapse;">8</th>            <th colspan="2" style="text-align:center;border: 1px solid black;border-collapse: collapse;">25</th>        </tr>        <tr>            <th colspan="2" style="font-size:x-small;border: 1px solid black;border-collapse: collapse;">三角指示</th>            <th colspan="4" style="text-align:center;border: 1px solid black;border-collapse: collapse;">&nabla;&nabla;&nabla;&nabla;</th>            <th colspan="3" style="text-align:center;border: 1px solid black;border-collapse: collapse;">&nabla;&nabla;&nabla;</th>            <th colspan="2" style="text-align:center;border: 1px solid black;border-collapse: collapse;">&nabla;&nabla;</th>            <th colspan="2" style="text-align:center;border: 1px solid black;border-collapse: collapse;">&nabla;</th>            <th colspan="2" style="text-align:center;border: 1px solid black;border-collapse: collapse;">-</th>        </tr>    </thead>    <tbody style="font-size:x-small;background-color:white">        <tr>                     <td rowspan="35" style="font-size:x-small;transform: rotate(-90deg);white-space:nowrap;border: 1px solid black;border-collapse: collapse;">加工工艺</td>                     <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">锻造（Forging）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>        </tr>             <tr>                            <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">铸造（Casting）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>        </tr>        <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">压造（Die casting）</td>                 <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">热轧（Hot rolling）</td>             <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">冷轧（Cold rolling）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td><td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">拉丝（Drawing）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">挤压（Extruding）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">滚光（Tumbling ）</td>                 <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>        <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">喷砂（Sandblasting）</td>                 <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">轧制（Rolling）</td>                 <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">平面铣（Face cutter grinding）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">刨削（Planing）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">刻蚀（Carving Slotting）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">刀具磨削（Cutter grinding）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">精镗（Precision boring）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">锉（Filing）</td>             <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">圆磨（Round grinding）</td>                <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9670;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9670;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9672;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9672;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9671;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9671;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9671;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9671;</td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">镗孔（Boring）</td>                 <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">钻孔（Drilling）</td>              <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">扩孔（Reaming）</td>              <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">拉刀研磨（Broach grinding）</td>               <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">剃齿（Shaving）</td>              <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">磨削（Grinding）</td>              <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9670;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9670;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9672;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9672;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9671;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9671;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9671;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">珩磨（Hone finishing）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">超精研磨（Super finishing）</td>              <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">抛光（Buffing）</td>              <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">纸张研磨（Paper finishing）</td>              <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">抛光研磨（Lapping）</td>              <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>         <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">液体珩磨（Liquid honing）</td>               <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>        <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">打磨抛光（Burnishing）</td>                <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>        <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">表面轧制（Surface rolling）</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>        <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">放电雕刻（Electric discharge carving）</td>             <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>        <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">线切割（Wire cut electric spark）</td>              <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>        <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">化学抛光（Chemical polishing）</td>             <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>        <tr>                             <td style="white-space:nowrap;border: 1px solid black;border-collapse: collapse;">电解磨损（Electrolytic abrasion）</td>             <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9679;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;">&#9675;</td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>            <td style="border: 1px solid black;border-collapse: collapse;"></td>        </tr>    </tbody></table><h3 id="小结">小结</h3><p>文中内容为个人总结，本人虽从事工业软件行业四年，机械加工方面的知识却不敢自称精通。目前正在总结相关知识，文章粗陋必有不足之处，也望各位不吝赐教，多多指正。若读者有别的见解与认识也欢迎关注我的个人微信公众号，一起讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">    版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，    转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。</div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号:  &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;摘要：本文内容涉及：机械加工时，用于指示加工质量的表面粗糙度的定义是什么？其计算方法与表示方法又是如何？各国工业加工对表面粗糙度的工业标准总结。各种加工工艺所能达到的表面精度总结与分析。&lt;/p&gt;
&lt;p&gt;Abstract: The content of this article involves: What is the definition of surface roughness used to indicate the quality of machining during machining? What is the calculation method and representation method? A summary of the industrial standards for surface roughness in industrial processing in various countries. Summary and analysis of the surface accuracy that can be achieved by various processing techniques.&lt;/p&gt;
    
    </summary>
    
    
      <category term="机械加工 相关 - 知识总结" scheme="https://zicowarn.github.io/categories/%E6%9C%BA%E6%A2%B0%E5%8A%A0%E5%B7%A5-%E7%9B%B8%E5%85%B3-%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="加工工艺" scheme="https://zicowarn.github.io/tags/%E5%8A%A0%E5%B7%A5%E5%B7%A5%E8%89%BA/"/>
    
      <category term="表面粗糙度" scheme="https://zicowarn.github.io/tags/%E8%A1%A8%E9%9D%A2%E7%B2%97%E7%B3%99%E5%BA%A6/"/>
    
  </entry>
  
  <entry>
    <title>AWS 使用CloudFront创建CDN网络</title>
    <link href="https://zicowarn.github.io/2020/11/07/aws-cloudfront-01-create-cdn-network/"/>
    <id>https://zicowarn.github.io/2020/11/07/aws-cloudfront-01-create-cdn-network/</id>
    <published>2020-11-07T01:39:50.000Z</published>
    <updated>2020-11-08T18:10:00.507Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a> </p><h3 id="CDN-内容分发网络"><a href="#CDN-内容分发网络" class="headerlink" title="CDN 内容分发网络"></a>CDN 内容分发网络</h3><p>CDN 全程:Content Delivery Network或Content Ddistribute Network，即内容分发网络。基本思想是：尽可能避开互联网上有可能影响数据传输速度和稳定性的瓶颈和环节，使内容传输的更快、更稳定。通过在网络各处放置节点服务器所构成的在现有的互联网基础之上的一层智能虚拟网络，CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。</p><p><img src="/2020/11/07/aws-cloudfront-01-create-cdn-network/%E5%8E%9F%E7%90%86.gif" alt="cdn原理图-西部数码知识库"></p><p>基本目的为解决因分布、带宽、服务器性能带来的访问延迟问题，适用于站点加速、点播、直播等场景。使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度和成功率。</p><p>控制时延无疑是现代信息科技的重要指标，CDN的意图就是尽可能的减少资源在转发、传输、链路抖动等情况下顺利保障信息的连贯性。</p><h3 id="Amazon-CloudFront-简介"><a href="#Amazon-CloudFront-简介" class="headerlink" title="Amazon CloudFront 简介"></a>Amazon CloudFront 简介</h3><p>Amazon CloudFront 是一种全球内容分发网络服务，可以安全地以低延迟和高传输速度向浏览者分发数据、视频、应用程序和 API。CloudFront 与 AWS  与多种 AWS 产品集成，如用于 DDoS 缓解的 AWS Shield、应用程序防火墙 AWS WAF、 Amazon S3、 Elastic Load Balancing、 Amazon EC2 以及 Amazon Route 53，以及可在 AWS 全球基础设施运行用户代码的 Lambda@Edge。</p><p>截止目前（2020年11月），为了以更低的延迟向最终用户提供内容，Amazon CloudFront 使用了一个包含超过 220 个节点（超过 210 个边缘站点和 12 个区域性边缘缓存）的全球网络，该网络覆盖 44 个国家/地区的 87 个城市。</p><h3 id="Amazon-CloudFront-基本运行机制"><a href="#Amazon-CloudFront-基本运行机制" class="headerlink" title="Amazon CloudFront 基本运行机制"></a>Amazon CloudFront 基本运行机制</h3><p>举例说明，当客户端发起对 <a href="http://www.customer.com/">www.customer.com</a> 的访问时，首先需要 DNS系统解析出该域名对应的主机 IP，通过本地 ISP DNS 递归查询到 <a href="http://customer.com/">customer.com</a> 的 DNS 域名服务器并了解到该域名是指向了 <a href="http://xxx.cloudfront.net/">xxx.cloudfront.net</a>，进一步解析 <a href="http://xxx.cloudfront.net/">xxx.cloudfront.net</a>，CloudFront 的 DNS 域名服务器会根据请求来源的 IP 等信息，返回适合当前该客户端访问的边缘节点的主机 IP 如1.1.1.1，最终该客户端向1.1.1.1发出请求。如果该边缘节点已经缓存了该客户端请求的内容（图片、视频等静态文件），则直接返回给客户端，如果未缓存，则首先回源取回该内容，并存储在边缘节点，以便下次客户端对该内容请求时可以直接返回该内容。</p><p><img src="/2020/11/07/aws-cloudfront-01-create-cdn-network/cloudf(2).png" alt="img"></p><p>更好的 CDN 性能表现带来更多的访问流量，以及更好的用户体验，下面我们将介绍如何配置以及优化建议。</p><h3 id="Amazon-CloudFront-创建CDN网络"><a href="#Amazon-CloudFront-创建CDN网络" class="headerlink" title="Amazon CloudFront 创建CDN网络"></a>Amazon CloudFront 创建CDN网络</h3><h4 id="1-创建分配"><a href="#1-创建分配" class="headerlink" title="1. 创建分配"></a>1. 创建分配</h4><p>登陆aws，选择CloudFront服务，即可打开**[Amazon CloudFront – 入门]<strong>, 然后点击<code>创建分配</code>按钮。目前CloudFront支持的内容分发方式为Web和RTMP，但根据最新的公告信息（2020年10月），</strong>CloudFront 在 2020 年 12 月 31 日停止支持 RTMP 分配。**本文示例中，选用Web分发方式。</p><h4 id="2-创建分配-源设置"><a href="#2-创建分配-源设置" class="headerlink" title="2. 创建分配-源设置"></a>2. 创建分配-源设置</h4><p>配置页面中，需要配置的第一部分内容为源设置。所需设置内容如下，需要注意的是，根据分发源的类型不同，该部分的所需设置项也不同，本文中选用的Amazon S3作为分发源，所需配置内容为下图左半部分。</p><ul><li>源域名 （Origin Domain Name），仅支持域名方式。下拉列表中可以看到帐号里已经创建过的 ELB，S3，Elemental Media Service。如果是自定义站点，需先给该站点配置域名，不能填写 IP。</li><li>源路径（Origin Path），为可选项，如果源站内容有多层目录且希望回源的时候路径上不体现这些目录，可以在此设置要隐藏的目录层级。如果您希望 CloudFront 从 Amazon S3 存储桶或自定义源的目录中请求内容，请在此处输入目录路径名称(以 / 开头)。在将请求转发到源时，CloudFront 会将目录名追加到“源域名”的值，例如 myawsbucket/production。请勿在目录名称末尾包含 /。</li><li>启用源护盾（Origin Protocol Policy），  即CloudFront 回源协议，可以是 HTTP 或 HTTPS，或者与client 发出请求时一样的协议。需要注意在这儿设置的是 CloudFront 回源站时用的协议，而不是 client 到达 CloudFront PoP 点的协议。如果选用了 HTTPS，一定要注意源站配置对应回源域名（Origin Domain Name）的 SSL 证书。</li><li>源ID（Origin ID），为源的描述标识。此值允许您区分同一分配中的多个源。每个源的描述在分配中必须是唯一的。</li><li>限制存储桶访问（Restrict Bucket Access），如果希望要求用户始终使用 CloudFront URL 而非 Amazon S3 URL 访问您的 Amazon S3 内容，请单击“是”。当您使用签名的 URL 或签名的 Cookies 来限制对您的内容的访问时，这会很有用。请参阅“帮助”中的“通过 CloudFront 提供私有内容”。</li><li>源连接尝试次数（Origin Connection Attempts），顾名思义，即CloudFront 尝试连接到源的次数。有效值为 1 到 3。默认值为 3 次尝试。这在分发源为非aws存储产品时较为重要。</li><li>源连接超时（Origin Connection Timeout），尝试建立与源的连接时，CloudFront 等待的时间(单位为秒)。有效值为 1 到 10 秒。默认值为 10 秒。</li><li>源协议策略（Origin Protocol Policy），  CloudFront 至源的访问协议，可以是 HTTP 或 HTTPS，或者与client 发出请求时一样的协议。注意这儿是 CloudFront 回源站时用的协议，而不是 client 到达 CloudFront PoP 点的协议。如果选用了 HTTPS，一定要注意源站配置对应回源域名（Origin Domain Name）的 SSL 证书。</li><li>最低源SSL协议（Minimum Origin SSL Protocol），选择适用于 CloudFront 的最低 SSL 协议，以在建立到源的 HTTPS 连接时使用。我们建议您选择服务器支持的最新协议。</li><li>源自定义标头（Origin Custom Headers）， 可选项。自定义回源 Header，即回源的时候添加的 Header，可以是一些自定义的 Header，通常用于由源站对该 Header 进行检测，如果有该 Header 则提供服务，没有则返回错误码，可用于内容访问的安全加强。</li></ul><p><img src="/2020/11/07/aws-cloudfront-01-create-cdn-network/image-20201107182108663.png" alt="image-20201107182108663"></p><h4 id="2-创建分配-默认缓存行为设置"><a href="#2-创建分配-默认缓存行为设置" class="headerlink" title="2. 创建分配-默认缓存行为设置"></a>2. 创建分配-默认缓存行为设置</h4><p>缓存行为让您为您网站上文件的特定 URL 路径模式配置各种 CloudFront 功能。例如，一个缓存行为可能适用于用作 CloudFront 源服务器的 Web 服务器上的 <code>images</code> 目录中的所有 <code>.jpg</code> 文件。您可为每个缓存行为配置的功能包括：</p><ul><li><p>路径模式（Path Pattern），默认缓存行为仅允许 * 的路径模式(将所有请求转发到“源”指定的源)。要更改其他请求的行为或路由(例如 *.jpg)，请在创建分配后添加更多缓存行为。也就是说如果要细化配置，需要在创建完成之后才能过进行。</p></li><li><p>查看器协议策略（Viewer Protocol Policy），即选择您希望查看器，即客户端用来访问 CloudFront 边缘站点中的内容时采用协议策略。</p></li><li><p>允许的HTTP方法（Allowed HTTP Methods），指定您希望 CloudFront 处理并转发从客户端到源的 HTTP 方法。需要注意的是，如果将 Amazon S3 存储桶用作分配的源并使用 CloudFront 源访问身份，则在某些 Amazon S3 区域中不支持 <code>POST</code> 请求，并且这些区域中的 <code>PUT</code> 请求需要使用额外的标头。当GET，HEAD或POST且content-type的值仅限于下列三者之一</p><ul><li><code>text/plain</code></li><li><code>multipart/form-data</code></li><li><code>application/x-www-form-urlencoded</code></li></ul><p>除了上面三种情况外都会触发预检，所以发送一个content-type为application/json的post请求会触发CORS预检，而text/plain不会触发。所以可以通过修改content-type的值为text/plain规避CORS的问题。所以在上述三种情况之外，就需要允许OPTION方法了。</p></li><li><p>字段级加密配置（Field-level Encryption Config），如果您要对特定数据字段强制实施字段级加密，则在下拉列表中选择一个字段级加密配置。在使用POST方法时，会被用到。CloudFront 字段级加密使用非对称加密，也称为公有密钥加密。您需要向 CloudFront 提供一个公有密钥，之后系统会自动加密您指定的所有敏感数据。不能使用您向 CloudFront 提供的密钥解密经过加密的值；只有您的私有密钥才能执行解密。</p></li><li><p>缓存的HTTP方法（Cached HTTP Methods），指定您是否希望 CloudFront 在查看器提交 <code>OPTIONS</code> 请求时缓存来自源的响应。CloudFront 始终缓存 <code>GET</code> 和 <code>HEAD</code> 请求的响应。当开始CORS时，个人建议不应该缓存OPTIONS方法。因为如果缓存该方法，如果原访问限制规则发生变化时，检查器不会在第一时间发现该变化。</p></li><li><p>缓存和源请求设置（Cache and origin request settings），指定您是否要 CloudFront 基于指定标头的值缓存对象：</p><ul><li><strong>无（改进缓存）</strong> – CloudFront 不根据标头值缓存您的对象。</li><li><strong>白名单</strong> – CloudFront 仅根据指定标头的值缓存您的对象。使用<strong>白名单标头</strong>选择您希望 CloudFront 进行缓存所基于的标头。</li><li><strong>所有</strong> – CloudFront 不缓存与该缓存行为关联的对象。相反，CloudFront 将每个请求发送到源。(不建议对 Amazon S3 源使用。)</li></ul><p>无论您选择哪个选项，CloudFront 都会将特定标头转发到源并根据您转发的标头执行特定操作。</p></li><li><p>缓存策略（Cache Policy），CloudFront 提供了一组托管缓存策略，您可以将这些策略附加到分配的任意缓存行为。有了托管缓存策略，您无需编写或维护自己的缓存策略。托管策略使用已针对特定使用案例优化的设置。要使用托管缓存策略，请将它附加到分配中的缓存行为。此过程与创建缓存策略时的过程相同，只不过您只需附加一个托管缓存策略，而不是创建新的缓存策略。您可以按名称（使用控制台）或 ID（使用 AWS CLI 或开发工具包）附加策略。以下部分列出了名称和 ID。以下列表描述了托管缓存策略，详情<a href="https://docs.aws.amazon.com/zh_cn/AmazonCloudFront/latest/DeveloperGuide/using-managed-cache-policies.html">参看</a>。</p><ul><li><strong>Managed-CachingOptimized</strong>，此策略旨在通过最大程度地减少 CloudFront 在缓存键中包含的值来优化缓存效率。CloudFront 不在缓存键中包含任何查询字符串或 Cookie，并且仅包含标准化的 <code>Accept-Encoding</code> 标头。这使 CloudFront 能够在源返回对象或在启用 CloudFront 边缘压缩时以 Gzip 和 Brotli 压缩格式分别缓存对象。</li><li><strong>Managed-CachingOptimizedForUncompressedObjects</strong>，此策略旨在通过最大程度地减少缓存键中包含的值来提高缓存效率。不包括查询字符串、标头或 Cookie。此策略与前一个策略相同，但它禁用了缓存压缩对象设置。</li><li><strong>Managed-CachingDisabled</strong>，此策略禁用缓存。此策略对于动态内容和不可缓存的请求很有用。</li><li><strong>Managed-Elemental-MediaPackage</strong>，此策略旨在用于作为 AWS Elemental MediaPackage 终端节点的源。</li></ul></li><li><p>源请求策略（Origin Request Policy），CloudFront 提供了一组托管源请求策略，您可以将这些策略附加到分配的任意缓存行为。有了托管源请求策略，您无需编写或维护自己的源请求策略。托管策略使用已针对特定使用案例优化的设置。要使用托管源请求策略，请将它附加到分配中的缓存行为。此过程与创建源请求策略时的过程相同，只不过您只需附加一个托管源请求策略，而不是创建新的源请求策略。您可以按名称（使用控制台）或 ID（使用 AWS CLI 或开发工具包）附加策略。以下部分列出了名称和 ID。详情<a href="https://docs.aws.amazon.com/zh_cn/AmazonCloudFront/latest/DeveloperGuide/using-managed-origin-request-policies.html">参考</a></p><ul><li><strong>Managed-UserAgentRefererHeaders</strong>，此策略仅包含 <code>User-Agent</code> 和 <code>Referer</code> 标头。它不包含任何查询字符串或 Cookie。</li><li><strong>Managed-CORS-CustomOrigin</strong>，此策略包含在源为自定义源时启用跨源资源共享 (CORS) 请求的标头。</li><li><strong>Managed-CORS-S3Origin</strong>，此策略包含在源为 Amazon S3 存储桶时启用跨源资源共享 (CORS) 请求的标头。选择该策略即会在原请求Origin Request Content中的白名单中添加如下参数。白名单中的这些项目很多教程中都是需要依次手动添加的，aws设置此策略简便了用户操作。<ul><li>origin</li><li>access-control-request-headers</li><li>access-control-request-method</li></ul></li><li><strong>Managed-AllViewer</strong>，此策略包含查看器请求中的所有值（查询字符串、标头和 Cookie）。</li><li><strong>Managed-Elemental-MediaTailor-PersonalizedManifests</strong>，此策略旨在用于作为 AWS Elemental MediaTailor 终端节点的源。</li></ul></li><li><p>平滑流（Smooth Streamig），该配置项仅当源服务器使用 Microsoft IIS时会有作用。启用此选项可使用 Smooth Streaming 来流式处理实时事件。如果您在此处启用 Smooth Streaming，则 CloudFront 无法将 Microsoft IIS 服务器作为源。</p></li><li><p>限制查看器访问（使用签名 URL 或签名 Cookie），如果您希望与该缓存行为的 <code>PathPattern</code> 匹配的对象请求使用公共 URL，请选择 <strong>No</strong>。如果您希望与该缓存行为的 <code>PathPattern</code> 匹配的对象请求使用签名 URL，请选择 <strong>Yes</strong>。然后指定您希望用于创建签名 URL 的 AWS 账户；这些账户被称为可信签署人。</p></li><li><p>自动压缩对象，如果您希望 CloudFront 在查看器支持压缩内容时自动压缩某些类型的文件，请选择<strong>是</strong>。当 CloudFront 压缩内容时，由于文件更小，因此下载速度更快，并会更快地为用户呈现网页。</p></li></ul><p><img src="/2020/11/07/aws-cloudfront-01-create-cdn-network/image-20201107184032233.png" alt="image-20201107184032233"></p><h4 id="3-创建分配-分配设置"><a href="#3-创建分配-分配设置" class="headerlink" title="3. 创建分配-分配设置"></a>3. 创建分配-分配设置</h4><p>该部分主要为了设置分配的价格级别和CloudFront使用备用域名时所需要完成的配置选项。本文简单介绍部分配置。有关备用域名时相关设置会在另一篇文章中介绍。</p><ul><li>AWS WAF Web ACL， 如果要使用 AWS WAF 根据您指定的条件来允许或阻止请求，请选择要与该分配关联的 Web ACL。AWS WAF 是一种 Web 应用程序防火墙，可让您监视转发到 CloudFront 的 HTTP 和 HTTPS 请求，并控制对您的内容的访问。根据指定的条件 (如请求源自的 IP 地址或查询字符串的值)，CloudFront 会使用所请求的内容或使用 HTTP 状态代码 403 (Forbidden) 来响应请求。还可以将 CloudFront 配置为在请求被阻止时返回自定义错误页面。</li><li>备用域名 (CNAME)，可选。指定要用于对象 URL 的一个或多个域名，而不是您在创建分配时 CloudFront 所指定的域名。您必须拥有该域名，或有权使用它，您可以通过添加 SSL/TLS 证书来验证这一点。</li><li>支持的 HTTP 版本，选择您希望分配在查看器与 CloudFront 通信时支持的 HTTP 版本。要使查看器和 CloudFront 使用 HTTP/2，查看器必须支持 TLS 1.2 或更高版本，并且必须支持服务器名称标识 (SNI)。一般情况下，将 CloudFront 配置为使用 HTTP/2 与查看器进行通信可降低延迟。您可以针对 HTTP/2 进行优化以提高性能。有关更多信息，请在 Internet 上搜索“http/2 optimization”。</li><li>默认根对象，可选。当浏览者请求分配的根 URL (<code>http://www.example.com/</code>) 而不是分配中的对象 (<code>http://www.example.com/product-description.html</code>) 时，您希望 CloudFront 从源（例如，<code>index.html</code>）中请求的对象。指定一个默认根对象，以避免公开分配的内容。</li></ul><p><img src="/2020/11/07/aws-cloudfront-01-create-cdn-network/image-20201109015314326.png" alt="image-20201109015314326"></p><p>选用默认配置项即可完成CloudFront的基本配置，有关，如何使用备用域名和开启CORS的内容会在其他文章中介绍。文章部分选项在自己的项目中有用到，会被详细介绍。还有部分选项没有使用到，就使用官方文档中的描述。总的来说使用aws的CloudFront完成CDN网络的搭建比自己单独建设相关网络要简便的多。由于目前还在免费使用周期，也就没有费用上的对比。aws 相关服务也是刚刚开始接触，文中定有不足之处，也希望经验丰富的朋友多多指教，感兴趣的朋友可以关注我的个人公众号一起来讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">    版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，    转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。</div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;摘要：为了解决部分内容网络分发时高延时的问题，为了提高网页加载速度，提高内容分发速度进而给客户跟好的使用体验，会考虑到CDN网络。如何使用aws CloudFront 与 aws S3 bucket的组合，创建自己的CDN网络，会在本文中介绍相关内容。&lt;/p&gt;
&lt;p&gt;Abstract: In order to solve the problem of high latency in the distribution of some content on the network, in order to increase the loading speed of web pages, increase the speed of content distribution, and provide customers with a better user experience, the CDN network will be considered. How to use the combination of aws CloudFront and aws S3 bucket to create your own CDN network will be introduced in this article.&lt;/p&gt;
    
    </summary>
    
    
      <category term="AWS 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/AWS-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="AWS" scheme="https://zicowarn.github.io/tags/AWS/"/>
    
      <category term="CloudFront" scheme="https://zicowarn.github.io/tags/CloudFront/"/>
    
  </entry>
  
  <entry>
    <title>Angular 如何使用结构型指令*ngFor历遍json对象</title>
    <link href="https://zicowarn.github.io/2020/10/13/angular-01-use-ngfor-a-json-object/"/>
    <id>https://zicowarn.github.io/2020/10/13/angular-01-use-ngfor-a-json-object/</id>
    <published>2020-10-13T01:39:50.000Z</published>
    <updated>2020-11-14T11:52:35.335Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a> </p><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p><code>NgFor</code> 会需要一个循环变量和一个列表。通过Pipe, PipeTransform来完成。也就是说ngfor主要是历遍列表的。一般情况下，遇到此类问题，首先想到的就是获取所有json对象中的键名，并定义一个类的公共属性，并将列表传入该属性，就可以在前端html代码中使用ngFor历遍键名并根据键值访问json对象，从而完成json对象的历遍。那有没有更加简单与直接的方法呢？本文就讨论一下我在项目中遇到类似的问题的解决方法。</p><h3 id="方法一，管道Pipe"><a href="#方法一，管道Pipe" class="headerlink" title="方法一，管道Pipe"></a>方法一，管道Pipe</h3><p>管道的方法也是Angular官方比较推荐的，也是遇到类似问题应该想到并能够使用解决问题的方法。管道可以理解为一些简单的函数，其可以在<a href="https://angular.cn/guide/glossary#template-expression">模板表达式</a>中用来接受输入值并返回一个转换后的值。管道的导入和实现代码如下。管道的类使用<code>@Pipe</code>装饰器。在自定义管道类中实现 <a href="https://angular.cn/api/core/PipeTransform"><code>PipeTransform</code></a> 接口来执行转换。Angular 调用 <code>transform</code> 方法，该方法使用绑定的值作为第一个参数，即下方代码中的value，把其它任何参数（如下方代码中的args）都以列表的形式作为第二个参数，并返回转换后的值。通过管道中的数据绑定来检测变更，你可以通过带有管道的<a href="https://angular.cn/guide/glossary#data-binding">数据绑定</a>来显示值并响应用户操作。如果是原始类型的输入值，比如 <code>String</code> 或 <code>Number</code> ，或者是对象引用型的输入值，比如 <code>Date</code> 或 <code>Array</code> ，那么每当 Angular 检测到输入值或引用有变化时，就会执行该输入管道。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Pipe, PipeTransform &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Pipe</span>(&#123;<span class="attr">name</span>: <span class="string">&#x27;keys&#x27;</span>&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">KeysPipe</span> <span class="title">implements</span> <span class="title">PipeTransform</span> </span>&#123;</span><br><span class="line">  transform(value, <span class="attr">args</span>:<span class="built_in">string</span>[]) : <span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> keys = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> value) &#123;</span><br><span class="line">      keys.push(&#123;<span class="attr">key</span>: key, <span class="attr">value</span>: value[key]&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keys;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前端HTML模版，使用管道的示例代码如下，</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> *<span class="attr">ngFor</span>=<span class="string">&quot;#entry of content | keys&quot;</span>&gt;</span>           </span><br><span class="line">  Key: &#123;&#123;entry.key&#125;&#125;, value: &#123;&#123;entry.value&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure><p>由名为<code>keys</code>的管道转换得来的值，每个元素entry，都包含key和value。使用管道的还有另一个好处，在使用管道的时候除了穿入需要转换的值以外还可以穿入其他的参数，书写方式如下。下方模版中<code>param</code>即为参数，在上面管道定义的代码中可以通过args[0]获取该参数。进而在转换json对象时，可以根据穿入的参数进行诸如“修改”，“过滤”，“添加”与“删除”等操作。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> *<span class="attr">ngFor</span>=<span class="string">&quot;#entry of content | keys:&#x27;param&#x27;&quot;</span>&gt;</span>           </span><br><span class="line">  Key: &#123;&#123;entry.key&#125;&#125;, value: &#123;&#123;entry.value&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在Angular中，管道Pipe分为 pure pipe (纯管道) 和 impure pipe (非纯管道)。纯管道和非纯管道是相对于管道所传的参数（如上例的 param）而言的。如果管道是纯管道，则管道的触发只会针对基本类型的参数的变化或者引用类型引用的变化（ a primitive input value (<code>String</code>, <code>Number</code>, <code>Boolean</code>, <code>Symbol</code>) or a changed object reference (<code>Date</code>, <code>Array</code>, <code>Function</code>, <code>Object</code>)）；然而， 对于非纯管道，不管是基本类型参数的改变还是引用类型内部数据变化（而非引用变化）都可以触发管道。管道时纯管道还是非纯管道的设置时通过把 <code>pure</code> 标志设置来实现的。当为 <code>false</code>时就可以来把管道设置成非纯。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pipe</span>(&#123;</span><br><span class="line">  name: <span class="string">&#x27;keys&#x27;</span>,</span><br><span class="line">  pure: <span class="literal">true</span> <span class="comment">// default</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>本文示例使用的默认值，即纯管道。</p><h3 id="方法二，使用Object-keys方法"><a href="#方法二，使用Object-keys方法" class="headerlink" title="方法二，使用Object.keys方法"></a>方法二，使用Object.keys方法</h3><p>JSON 作为存储和传输数据的一种格式。本身是没有类似于Python中Dictionary数据类型的诸如keys()和values()的内置方法的。ES5中内置了一个名为Object.keys的方法，用于返回一个对象的属性名称数组，其使用方法如下。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> object1 = &#123;</span><br><span class="line">  a: <span class="string">&#x27;somestring&#x27;</span>,</span><br><span class="line">  b: <span class="number">42</span>,</span><br><span class="line">  c: <span class="literal">false</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.keys(object1));</span><br></pre></td></tr></table></figure><p>虽然有了获取json对象属性（键）名称数组的方法。但是在Angular的HTML模版中是不能直接使用该方法是非法的。既然如此就可以换个思路，由于在模版中，使用组件的公共属性是合法的，那么就可以先定义一个组件的公共属性，并将方法Object.keys以别名的方法赋值至该公共属性。具体代码实现如下。代码中<code>objectKeys = Object.keys;</code>就是为了完成上述操作的。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, ElementRef, OnInit &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  selector: <span class="string">&#x27;app-demo&#x27;</span>,</span><br><span class="line">  templateUrl: <span class="string">&#x27;./demo.component.html&#x27;</span>,</span><br><span class="line">  styleUrls: [<span class="string">&#x27;./demo.component.scss&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> objectKeys = <span class="built_in">Object</span>.keys;</span><br><span class="line">  <span class="keyword">public</span> datas = &#123;</span><br><span class="line">    <span class="string">&#x27;Block1&#x27;</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;data1&#x27;</span> : <span class="string">&quot;Block 1 data 1&quot;</span>,</span><br><span class="line">      <span class="string">&#x27;data1-pop&#x27;</span>: <span class="number">.035</span>,</span><br><span class="line">      <span class="string">&#x27;data2&#x27;</span> : <span class="string">&quot;Block 1 data 1&quot;</span>,</span><br><span class="line">      <span class="string">&#x27;data2-pop&#x27;</span>: <span class="number">.2</span>,</span><br><span class="line">      <span class="string">&#x27;data3&#x27;</span> : <span class="string">&quot;Block 1 data 1&quot;</span>,</span><br><span class="line">      <span class="string">&#x27;data3-pop&#x27;</span>: <span class="number">.35</span>,</span><br><span class="line">      <span class="string">&#x27;data4&#x27;</span> : <span class="string">&quot;Block 1 data 1&quot;</span>,</span><br><span class="line">      <span class="string">&#x27;data4-pop&#x27;</span>: <span class="number">.5</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;Block2&#x27;</span>: &#123;</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">  ngOnInit(): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>前端模版的书写方式如下。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ng-container</span> *<span class="attr">ngFor</span>=<span class="string">&quot;let itemkey of objectKeys(datas[entry])&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> *<span class="attr">ngIf</span>=<span class="string">&quot;!itemkey.includes(&#x27;pop&#x27;)&quot;</span> <span class="attr">fxLayout</span>=<span class="string">&quot;column&quot;</span> <span class="attr">class</span>=<span class="string">&quot;signleitem&quot;</span> <span class="attr">fxFlex</span>=<span class="string">50</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span>&gt;</span>&#123;&#123;itemkey&#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">fxLayout</span>=<span class="string">&quot;row&quot;</span> <span class="attr">fxLayoutAlign</span>=<span class="string">&quot;start none&quot;</span> <span class="attr">class</span>=<span class="string">&quot;item-content&quot;</span> <span class="attr">fxFill</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">placeholder</span>=<span class="string">&quot;&quot;</span> [(<span class="attr">ngModel</span>)]=<span class="string">datas[entry][itemkey]</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; (datas[entry][itemkey+&#x27;-pop&#x27;] * 100) | number:&#x27;1.0-0&#x27;&#125;&#125; %<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ng-container</span>&gt;</span></span><br></pre></td></tr></table></figure><p>与方法一不同的是，此时历遍的数组中的元素仅为json对象的键名。此种方法也不能在历遍完成对键值的过滤。但在一些应用场景下，该方法要比方法一更加直接和高效。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>两种方法都能解决问题，在使用中可以根据实际需要选的最合适的自己项目的方法。文中内容就是对这个两种方法进行简单对比。Angular相关内容为自己新学知识，文章有不足之处也实属正常。见解不同，诚切赐教，关注微信公众号，一起讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">    版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，    转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。</div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;摘要：本文主要介绍如何使用Angular三个常用的内置结构型指令 —— NgIf、NgFor和NgSwitch之一ngFor历遍一个json对象。Ngfor历遍列表很简单，ngfor历遍json实例又该如何操作呢？&lt;/p&gt;
&lt;p&gt;Abstract: This article mainly introduces how to in Angular use ngFor, one of Three of the common, built-in structural directives—NgIf, NgFor, and NgSwitch, to traverse a json object. Ngfor traverses the array is very simple, how should ngfor traverse the json instance?&lt;/p&gt;
    
    </summary>
    
    
      <category term="Angular 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/Angular-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="Angular" scheme="https://zicowarn.github.io/tags/Angular/"/>
    
      <category term="*ngFor" scheme="https://zicowarn.github.io/tags/ngFor/"/>
    
      <category term="json" scheme="https://zicowarn.github.io/tags/json/"/>
    
      <category term="历遍" scheme="https://zicowarn.github.io/tags/%E5%8E%86%E9%81%8D/"/>
    
  </entry>
  
  <entry>
    <title>AWS 如何使用IAM创建一个最小访问权限的用户并使用aws-cli来部署lambda函数程序包</title>
    <link href="https://zicowarn.github.io/2020/09/24/aws-common-02-awscli-configuration/"/>
    <id>https://zicowarn.github.io/2020/09/24/aws-common-02-awscli-configuration/</id>
    <published>2020-09-24T12:39:50.000Z</published>
    <updated>2020-09-27T08:48:53.413Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a> </p><h3 id="任务背景"><a href="#任务背景" class="headerlink" title="任务背景"></a>任务背景</h3><p>AWS的用户和用户权限可以通过AWS IAM来创建和实现，本文主要尝试的是在IAM中，在为aws cli创建编程访问类型用户时，如果仅用于部署aws lambda函数，那么用户的访问权限应该如何限制。如何在保证安全的下，完成一个最小权限的用户用于部署aws lamdba函数。之所以需要设计一个最小访问权限的用户，是为了以后使用github中的actions实现函数代码的自动持续部署。</p><h3 id="准备用户"><a href="#准备用户" class="headerlink" title="准备用户"></a>准备用户</h3><p>AWS IAM 提供两种用户访问类型，<strong>编程访问类型</strong>与<strong>AWS 管理控制台访问</strong>，基本的差别如下，在本文中需要的是编程访问类型，以此类型，我们先创建一个用户，用户名暂定test，在创建用户时，我们先不为其设置访问权限。</p><ul><li>编程访问：为 AWS API、CLI、SDK 和其他开发工具启用 <strong>访问密钥 ID</strong> 和 <strong>私有访问密钥</strong> 。</li><li>AWS 管理控制台访问： 启用密码 、使得用户可以登录到 AWS 管理控制台。</li></ul><h3 id="访问策略"><a href="#访问策略" class="headerlink" title="访问策略"></a>访问策略</h3><p>AWS IAM提供两种访问策略，托管策略（AWS托管和用户托管）和内联策略。<em>AWS托管策略</em> 是由 AWS 创建和管理的独立策略。这里的<em>独立策略</em> 意味着策略有自己的 Amazon 资源名称 (ARN)，其中包含策略名称。自己不能更改 AWS 托管策略中定义的权限。内联策略 是用户自己创建与管理的独立策略，内联策略应该算得上是<em>用户托管策略</em>的一种特殊使用方式，内联策略是嵌入在 IAM 身份（用户、组或角色）中的策略。也就是说，策略是身份的固有组成部分。内联策略与应用它的身份之间维持严格的一对一关系，如果要确保策略中的权限不会无意中分配给预期身份之外的身份，则可使用内联策略。请参看下方三种策略的对比示意图，</p><p><img src="/2020/09/24/aws-common-02-awscli-configuration/aws-common-02-01.png"></p><p>我们先看一下AWS托管策略，试着分析一下策略运行的服务是否符合我们对最小用户访问策略的预期。</p><h5 id="AWSLambdaFullAccess"><a href="#AWSLambdaFullAccess" class="headerlink" title="AWSLambdaFullAccess"></a>AWSLambdaFullAccess</h5><p>为AWS托管策略，该托管策略允许访问18个服务（AWS的服务共计239）。其中包括了，其中针对lambda服务的策略有50个，提供了lambda相关的所有权限，该策略能够最终能够实现使用github的actions来自动持续部署代码的任务需求，但是并不是所要求的最小访问策略。</p><h5 id="AWSCodeDeployRoleForLambda"><a href="#AWSCodeDeployRoleForLambda" class="headerlink" title="AWSCodeDeployRoleForLambda"></a>AWSCodeDeployRoleForLambda</h5><p>为AWS托管策略，该托管策略允许访问4个服务（AWS的服务共计239）。</p><ul><li>CloudWatch 仅读</li><li>Lambda 读写<ul><li>GetAlias    仅读</li><li>GetProvisionedConcurrencyConfig   仅读</li><li>UpdateAlias  仅写</li></ul></li><li>S3 仅读</li><li>SNS 仅写</li></ul><h5 id="AWSLambdaExecute"><a href="#AWSLambdaExecute" class="headerlink" title="AWSLambdaExecute"></a>AWSLambdaExecute</h5><p>为AWS托管策略，主要对S3资源的读写和运行日志CloudWatch Logs的读写访问。</p><h5 id="AWSLambdaRole"><a href="#AWSLambdaRole" class="headerlink" title="AWSLambdaRole"></a>AWSLambdaRole</h5><p>为AWS托管策略，赋予的是调用invoke函数的权限</p><h5 id="AWSLambdaReadOnlyAccess"><a href="#AWSLambdaReadOnlyAccess" class="headerlink" title="AWSLambdaReadOnlyAccess"></a>AWSLambdaReadOnlyAccess</h5><p>为AWS托管策略，顾名思义，该策略主要提供的是<strong>仅读</strong>资源访问权限。</p><p>当然涉及lambda函数的权限还有很多，分析相关权限后发现AWS的托管权限，都没有与任务完全匹配的。因为部署lambda函数这个操作，对aws lambda服务这部的权限，至少应该有CreateFunction这个操作的写入权限，和UpdateFunctionCode这个操作的写入权限。另外对于IAM这项服务，也应该至少有ListRoles这个列表读取权限，以这些信息为基础，我们创建一个用户托管策略，该策略名称定为UserCustomDeployLambdaFunctionCode，策略具体内容如下，</p><h5 id="UserCustomDeployLambdaFunctionCode"><a href="#UserCustomDeployLambdaFunctionCode" class="headerlink" title="UserCustomDeployLambdaFunctionCode"></a>UserCustomDeployLambdaFunctionCode</h5><ul><li>IAM 列表<ul><li>ListRoles 所有资源</li></ul></li><li>Lambda 仅写<ul><li>CreateFunction 所有资源</li><li>UpdateFunctionCode 所有资源</li></ul></li></ul><p>该用户策略权限的JSON文件如下，可以直接使用JSON文件来创建该用户托管策略。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Version&quot;</span>: <span class="string">&quot;2020-10-17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span>: <span class="string">&quot;VisualEditor0&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Action&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;lambda:CreateFunction&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lambda:UpdateFunctionCode&quot;</span>,</span><br><span class="line">                <span class="string">&quot;iam:ListRoles&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span>: <span class="string">&quot;*&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建这个用户托管策略时，我们没有对资源进行限制。在后期，可以限定访问资源，实现基于资源的用户托管策略。</p><p>用户策略限定好之后，就需要给之前创建的test用户添加这个托管策略。添加完策略之后就可以尝试使用aws cli来部署lambda 函数代码了，这也是为了以后使用github actions时需要做的前期准备工作。</p><h3 id="配置AWS-CLI"><a href="#配置AWS-CLI" class="headerlink" title="配置AWS CLI"></a>配置AWS CLI</h3><p>使用aws cli之前需要对其进行配置。AWS 的CLI配置官方教程也有介绍，基本上按照官方教程即可完成配置，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % aws configure</span><br><span class="line">AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE</span><br><span class="line">AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br><span class="line">Default region name [None]: us-west-2</span><br><span class="line">Default output format [None]: json</span><br></pre></td></tr></table></figure><p>完成配置后我们就可以准备部署代码了，这里假设，已经使用aws lambda 网页端创建了一个名为test的lambda函数，函数的runtime为Python 3.6。函数的处理程序为lambda_function.lambda_handler，即我们需要创建的py文件为lambda_function.py, 文件内容如下，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lambda_handler</span>(<span class="params">event, context</span>):</span></span><br><span class="line">    <span class="comment"># TODO implement</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;statusCode&#x27;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span>: json.dumps(<span class="string">&#x27;Hello from Lambda!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>python文件创建完之后就需要对其进行打包，生成名为test.zip的压缩文档，这个zip压缩文档现在就可以理解为一个程序包。创建程序包相关命令如下，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">username@mac aws-cli-test % nano lambda_function.py</span><br><span class="line">username@mac aws-cli-test % ls</span><br><span class="line">lambda_function.py</span><br><span class="line">username@mac aws-cli-test % zip test.zip lambda_function.py</span><br><span class="line">  adding: lambda_function.py (deflated 19%)</span><br><span class="line">username@mac aws-cli-test % ls</span><br><span class="line">lambda_function.py test.zip</span><br><span class="line">username@mac aws-cli-test % </span><br></pre></td></tr></table></figure><p>程序包创建结束后，就可以尝试使用aws-cli来部署这个lambda函数的程序包了，相关命令和输出结果如下，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">username@mac aws-cli-test % aws lambda update-function-code --function-name <span class="built_in">test</span> --zip-file fileb://test.zip    </span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;FunctionName&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="string">&quot;FunctionArn&quot;</span>: <span class="string">&quot;arn:aws:lambda:ap-northeast-1:XXXXXXXXXX:function:test&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Runtime&quot;</span>: <span class="string">&quot;python3.6&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Role&quot;</span>: <span class="string">&quot;arn:aws:iam::XXXXXXXXXX:role/service-role/test-role-mu5rmz0t&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Handler&quot;</span>: <span class="string">&quot;lambda_function.lambda_handler&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CodeSize&quot;</span>: 321,</span><br><span class="line">    <span class="string">&quot;Description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Timeout&quot;</span>: 3,</span><br><span class="line">    <span class="string">&quot;MemorySize&quot;</span>: 128,</span><br><span class="line">    <span class="string">&quot;LastModified&quot;</span>: <span class="string">&quot;2020-09-22T06:02:26.878+0000&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CodeSha256&quot;</span>: <span class="string">&quot;XXXXXXXXXXCCCCCCCCCCCCCCCCCCC/zBBvIU4+1oAzeo=&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;<span class="variable">$LATEST</span>&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TracingConfig&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Mode&quot;</span>: <span class="string">&quot;PassThrough&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;RevisionId&quot;</span>: <span class="string">&quot;87a0f614-401d-420f-a338-78a54bd8ba40&quot;</span>,</span><br><span class="line">    <span class="string">&quot;State&quot;</span>: <span class="string">&quot;Active&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LastUpdateStatus&quot;</span>: <span class="string">&quot;Successful&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回的更新结果为”Successful”，说明更新成功，然后可以在aws lambda网页版的页面上看到更新的lambda函数内容，如下图，</p><p><img src="/2020/09/24/aws-common-02-awscli-configuration/aws-common-02-02.png"></p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>至此，创建一个用户托管策略，来实现一个最小用户访问权限，并使用这样一个用户终端里借助aws-cli实现lambda函数的程序包的部署内容也就结束了。aws lambda也是刚刚开始接触，文中定有不足之处，也希望经验丰富的朋友多多指教，感兴趣的朋友可以关注我的个人公众号一起来讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">    版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，    转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。</div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;摘要：如何配置aws-cli？如何使用aws-cli来部署lamdba函数的程序包？配置aws-cli时，用户访问权限的策略应该是什么样的？如何创建一个最小访问权限的用户，在保证安全的同时实现lambda程序包的部署？这样的用户的访问策略是什么样的？&lt;/p&gt;
&lt;p&gt;Abstract: How to configure aws-cli? How to use aws-cli to deploy lamdba function package? When configuring aws-cli, what should be the user access policy? How to create a user with minimal access rights to complete the lambda package deployment task while ensuring security? What is the access strategy for such users?&lt;/p&gt;
    
    </summary>
    
    
      <category term="AWS 相关 - 基本知识" scheme="https://zicowarn.github.io/categories/AWS-%E7%9B%B8%E5%85%B3-%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/"/>
    
    
      <category term="AWS" scheme="https://zicowarn.github.io/tags/AWS/"/>
    
      <category term="lambda" scheme="https://zicowarn.github.io/tags/lambda/"/>
    
      <category term="aws-cli" scheme="https://zicowarn.github.io/tags/aws-cli/"/>
    
      <category term="IAM" scheme="https://zicowarn.github.io/tags/IAM/"/>
    
  </entry>
  
  <entry>
    <title>Python 杂记之 如何使用pyenv管理python版本管理与如何使用virtualenv创建python虚拟运行环境</title>
    <link href="https://zicowarn.github.io/2020/09/22/0809-python-hwoto-install-pyevn-virtualenv/"/>
    <id>https://zicowarn.github.io/2020/09/22/0809-python-hwoto-install-pyevn-virtualenv/</id>
    <published>2020-09-22T15:11:08.000Z</published>
    <updated>2020-11-14T12:16:16.380Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>作者: Jim Wang 公众号:  <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>Python的版本管理非常有必要，这种想法在第一次接触到python3的时候就开始有的想法。但是工作中所遇项目主要是在windows系统下，开发环境并不复杂，又使用Eclipse的项目设定结合windows的环境变量。所以也一直没有去尝试着安装配置pyevn，但是自己工作之余学些aws lambda函数时，就遇到了需要隔离python版本与创建虚拟运行环境的使用场景，最终还是逃不过这部分内容，因此也就有了这篇网文。</p><h3 id="什么是pyenv和为什么要版本隔离"><a href="#什么是pyenv和为什么要版本隔离" class="headerlink" title="什么是pyenv和为什么要版本隔离"></a>什么是pyenv和为什么要版本隔离</h3><p>Pyenv主要是用于Python版本隔离，所谓版本隔离，就是同时安装与使用不同版本的Python在一个主机里，且彼此之间没有交叉也不相互影响。在没有Pyenv之前，在windows系统下也可以实现多python版本共存，可以使用环境变量进行隔离。在Linux系统下则可以使用update-alternatives这一系统命令链接符工具来进行版本管理。</p><p>那为什么需要版本管理。假设你有两个Python项目，一个是Python2.x另一个是Python3.x，这是你就可以考虑版本隔离了，或者需要同时测试，管理很多不同版本的Python项目，也可以考虑版本隔离。</p><h3 id="什么是virtualenv和为什么需要虚拟环境"><a href="#什么是virtualenv和为什么需要虚拟环境" class="headerlink" title="什么是virtualenv和为什么需要虚拟环境"></a>什么是virtualenv和为什么需要虚拟环境</h3><p>virtualenv主要是为了创建Python运行的虚拟环境。所谓虚拟环境，就是Python运行时，库依赖性的隔离。比如项目一需要A依赖包，项目二需要B依赖包。传统习惯是，将A包与B包都使用pip install命令进行安装，就可以同时完成项目一与项目二的开发工作，但是这在开发时是没问题的，但在部署时就不一定了，如果部署环境与开发环境不一致，就可能需要花时间去从新安装依赖包，如果部署平台与开发平台也不一致，或者部署环境中的存储限制就需要在开发的时候创建一个虚拟环境，创建一个最小依赖的开发环境。</p><p>常见的一些定义virtualenv和pyvenv（同venv）都是用于创建虚拟运行环境，实现库依赖性的隔离。区别是前者支持Python不同版本，可以为不同python创建虚拟环境，而后者仅支持python3.x，venv仅支持python3.6以后不的版本。另一点区别是，virtualenv是PyPI软件包，pyvenv（同venv）是标准库。</p><h3 id="什么是pipenv和什么是依赖管理"><a href="#什么是pipenv和什么是依赖管理" class="headerlink" title="什么是pipenv和什么是依赖管理"></a>什么是pipenv和什么是依赖管理</h3><p>另一些常见的定义还有pipevn，pipenv可以视为pip命令和virtualenv命令的组合命令。virtualenv创建的虚拟环境仅仅实现了Python库的依赖性隔离。但是一个虚拟环境下随着项目功能的增加，依赖包的变化，一段时间之后这个虚拟环境下第三方库的依赖具体什么样，就很难弄明白了。pipenv就是为了解决这一问题而存在的。这点很像nodejs的依赖包管理工具npm（或cnpm）。使用Pipenv时，Pipenv会自动管理python库依赖。Pipenv会在创建虚拟环境时自动创建Pipfile和Pipfile.lock文件，之后在安装和卸载第三方依赖包的时候，这两个文件都会得到更新被维护。Pipfile记录项目依赖包列表，Pipfile.lock记录固定版本的详细依赖包列表。</p><h3 id="其他相关定义"><a href="#其他相关定义" class="headerlink" title="其他相关定义"></a>其他相关定义</h3><p>virtualenvwrapper是对virtualenv命令的扩展。pyenv-virtualenv是pyenv的插件，主要用于确保pyenv和virtualenv能够同时使用。如果使用的是python3.3以上的版本，则默认python自带venv，pyenv-virtualenv插件就是可选内容。pyenv-virtualenvwrapper也是pyenv的插件，主要是为了是pyenv中能集成virtualenvwrapper。</p><h3 id="安装pvenv"><a href="#安装pvenv" class="headerlink" title="安装pvenv"></a>安装pvenv</h3><p>本文的安装环境为mac os Catalina 版本为10.5.5。在终端输入一下命令, pyenv目前不支持windows （windows可以使用pyenv-win来代替），只支持mac和linux。官方提供了一个安装脚本，安装起来非常简单，它会自动安装<code>pyenv</code>和<code>pyenv-virtualenv</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/pyenv/pyenv-installer/raw/master/bin/pyenv-installer | bash</span><br></pre></td></tr></table></figure><p>也可使用git命令克隆pyenv源代码至本地，命令如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/pyenv/pyenv.git ~/.pyenv</span><br></pre></td></tr></table></figure><p>完成上述步骤就需要修改环境变量了，打开bash配置文件.bash_profile或者.bashrc，在文档末尾添加如下内容，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$HOME</span>/.pyenv/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv init -)</span>&quot;</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv virtualenv-init -)</span>&quot;</span></span><br></pre></td></tr></table></figure><p>Mac环境下可以尝试直接使用下列命令来进行安装，需要注意的是，使用brew 安装 pyenv 是不需要进行环境配置的，brew 在安装 pyenv 时已经自动设定了相关内容。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install pyenv</span><br></pre></td></tr></table></figure><h3 id="配置pyenv"><a href="#配置pyenv" class="headerlink" title="配置pyenv"></a>配置pyenv</h3><p>完成安装知乎，配置部分的内容其实很简单，仅需要在bash配置文件中添加如下内容，完成pyenv的初始化即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv init -)</span>&quot;</span></span><br></pre></td></tr></table></figure><h3 id="使用pyenv"><a href="#使用pyenv" class="headerlink" title="使用pyenv"></a>使用pyenv</h3><p>pyenv提供了11个可用命令，可以参考<a href="https://github.com/pyenv/pyenv/blob/master/COMMANDS.md">文档</a>来查看具体内容，在这里简单介绍几个常用命令。</p><h5 id="pyenv-versions"><a href="#pyenv-versions" class="headerlink" title="pyenv versions"></a>pyenv versions</h5><p>用于检查当前系统中已经安装的python版本，命令输出如下内容，带星号为当前系统默认使用的python版本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username@mac~ % pyenv versions         </span><br><span class="line">* system (<span class="built_in">set</span> by /Users/username/.pyenv/version)</span><br><span class="line">  2.7.10</span><br><span class="line">  2.7.15</span><br></pre></td></tr></table></figure><h5 id="pyenv-version"><a href="#pyenv-version" class="headerlink" title="pyenv version"></a>pyenv version</h5><p>用于查看当前系统默认使用的python版本，命令输出如下内容，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % pyenv version </span><br><span class="line">system (<span class="built_in">set</span> by /Users/username/.pyenv/version)</span><br></pre></td></tr></table></figure><h5 id="pyevn-install-–list"><a href="#pyevn-install-–list" class="headerlink" title="pyevn install –list"></a>pyevn install –list</h5><p>用于检查，所有可安装的python版本，输出内容如下，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % pyenv install --list</span><br><span class="line">Available versions:</span><br><span class="line">  2.1.3</span><br><span class="line">  2.2.3</span><br><span class="line">  2.3.7</span><br><span class="line">  2.4.0</span><br><span class="line">  2.4.1</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>输出列表里纯数字的表示官方版本，其他的版本注释如下：</p><ul><li>activepython (ActiveState公司) 主要面向企业用户与数据科学家，可以节省大量精力在Python的组装与管理方面</li><li>anaconda (Anaconda公司)主要用例包括数学、统计学、工程、数据分析、机器学习以及其他相关应用</li><li>ironPython 属于一套立足.Net运行时——或者CLR（公共语言运行时）——的Python实现方</li><li>jython 能够将Python 2.x编译为JVM字节码，并在JVM上运行生成的程序，其仅支持Python 2.x</li><li>pypy 属于CPython解释器的替代品，其利用即时（JIT）编译以加速Python程序的执行</li><li>micropython 是Python 3的一个完整软件实现，用C语言编写，被优化于运行在微控制器之上， 如Arduino等</li><li>miniconda 只包含最基本的内容：python与conda，以及相关的必须依赖项，是conda的最小依赖开发环境</li><li>stackless 是python的一个增强版本，是python协程的一个实现。 使用它可以避免创建线程所引起的不必要的开销， 同时也可以实现无锁编程。</li></ul><h5 id="python-install-3-7-0"><a href="#python-install-3-7-0" class="headerlink" title="python install 3.7.0"></a>python install 3.7.0</h5><p>该命令意指安装Python 3.7.0的官方版本版本，该命令输出如下内容，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % pyenv install 3.7.0  </span><br><span class="line">...</span><br><span class="line">python-build: use openssl@1.1 from homebrew</span><br><span class="line">python-build: use readline from homebrew</span><br><span class="line">Installing Python-3.7.0...</span><br><span class="line">python-build: use readline from homebrew</span><br><span class="line">python-build: use zlib from xcode sdk</span><br><span class="line">Installed Python-3.7.0 to /Users/username/.pyenv/versions/3.7.0</span><br></pre></td></tr></table></figure><h5 id="python-uninstall"><a href="#python-uninstall" class="headerlink" title="python uninstall"></a>python uninstall</h5><p>该命令用于卸载特定版本的python</p><h5 id="python-rehash"><a href="#python-rehash" class="headerlink" title="python rehash"></a>python rehash</h5><p>在安装新一个版本的python后可以执行此命令，使其pyenv更新自己要管理的所有python版本的相关信息。</p><h3 id="卸载pyenv"><a href="#卸载pyenv" class="headerlink" title="卸载pyenv"></a>卸载pyenv</h3><p>pyenv的卸载非常简单，删除.pyenv目录与bash配置文件的相关内容即可。</p><h3 id="更新pyenv"><a href="#更新pyenv" class="headerlink" title="更新pyenv"></a>更新pyenv</h3><p>在mac中，可以使用brew upgrade pyenv来完成pyenv的更新，也可以通过从github中克隆新版本的源码到本地安装目录完成相应更新工作。</p><h3 id="安装pyenv-virtualenv"><a href="#安装pyenv-virtualenv" class="headerlink" title="安装pyenv-virtualenv"></a>安装pyenv-virtualenv</h3><p>在完成python版本的隔离之后，就可以尝试实现项目依赖的隔离，这就需要借助pyenv-virtualenv来完成，安装pyenv-virtualenv也有两种方法，在mac中使用brew 安装或者，从github中克隆源码到本地。</p><p>mac中使用brew install pyenv-virtualenv命令则可以完成安装，该命令的输出内容如下，按照输出内容的提示，我们需要在完成安装之后对其进行配置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % brew install pyenv-virtualenv</span><br><span class="line">==&gt; Downloading https://github.com/pyenv/pyenv-virtualenv/archive/v1.1.5.tar.gz</span><br><span class="line">==&gt; Downloading from https://codeload.github.com/pyenv/pyenv-virtualenv/tar.gz/v</span><br><span class="line"><span class="comment">######################################################################## 100.0%</span></span><br><span class="line">==&gt; ./install.sh</span><br><span class="line">==&gt; Caveats</span><br><span class="line">To <span class="built_in">enable</span> auto-activation add to your profile:</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">which</span> pyenv-virtualenv-init &gt; /dev/null; <span class="keyword">then</span> <span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv virtualenv-init -)</span>&quot;</span>; <span class="keyword">fi</span></span><br><span class="line">==&gt; Summary</span><br><span class="line"> /usr/<span class="built_in">local</span>/Cellar/pyenv-virtualenv/1.1.5: 22 files, 65.7KB, built <span class="keyword">in</span> 2 seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>从github中克隆源码到本地的命令如下，这里需要注意的是，需要在当前用户的home目录运行该命令，因为源码的本地目录为pyenv的子目录，如有必要也需要手动创建子目录plugins。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/pyenv/pyenv-virtualenv.git .pyenv/plugins/pyenv-virtualenv</span><br></pre></td></tr></table></figure><h3 id="配置pyenv-virtualenv"><a href="#配置pyenv-virtualenv" class="headerlink" title="配置pyenv-virtualenv"></a>配置pyenv-virtualenv</h3><p>根据brew install pyenv-virtualenv，完成配置仅需在bash配置文件中加入如下内容即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">which</span> pyenv-virtualenv &gt;/dev/null; <span class="keyword">then</span> <span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv virtualenv-init -)</span>&quot;</span>;<span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>然后可以使用如下命令，更新bash配置的修改，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> .bash_profile</span><br></pre></td></tr></table></figure><h3 id="使用pyenv-virtualenv"><a href="#使用pyenv-virtualenv" class="headerlink" title="使用pyenv-virtualenv"></a>使用pyenv-virtualenv</h3><p>pyenv-virtualenv的具体使用方法，可以参考<a href="https://github.com/pyenv/pyenv-virtualenv/blob/master/README.md">文档</a>本文简单介绍一下部分命令。</p><h5 id="pyenv-virtualenv-版本号-虚拟环境名"><a href="#pyenv-virtualenv-版本号-虚拟环境名" class="headerlink" title="pyenv virtualenv 版本号 虚拟环境名"></a>pyenv virtualenv 版本号 虚拟环境名</h5><p>比如，由于项目中aws 的lambda函数中使用python 3.6.0 的是最终是需要完成一个python 3.6.0的虚拟运行环境，那么就可以使用如下命令，这里版本号为3.6.0， 虚拟环境名为env360。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % pyenv virtualenv 3.6.0 env360</span><br><span class="line">Requirement already satisfied: setuptools <span class="keyword">in</span> /Users/username/.pyenv/versions/3.6.0/envs/env360/lib/python3.6/site-packages</span><br><span class="line">Requirement already satisfied: pip <span class="keyword">in</span> /Users/username/.pyenv/versions/3.6.0/envs/env360/lib/python3.6/site-packages</span><br></pre></td></tr></table></figure><h5 id="pyenv-virtualenvs"><a href="#pyenv-virtualenvs" class="headerlink" title="pyenv virtualenvs"></a>pyenv virtualenvs</h5><p>用于查看当前所有存在的环境名，命令输出内容如下，每个虚拟环境会出现两次，分别为虚拟环境目录的真实目录和目录链接。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % pyenv virtualenvs            </span><br><span class="line">  3.6.0/envs/env360 (created from /Users/username/.pyenv/versions/3.6.0)</span><br><span class="line">  3.8.5/envs/env385 (created from /Users/username/.pyenv/versions/3.8.5)</span><br><span class="line">  env360 (created from /Users/username/.pyenv/versions/3.6.0)</span><br><span class="line">  env385 (created from /Users/username/.pyenv/versions/3.8.5)</span><br></pre></td></tr></table></figure><h5 id="pyenv-activate-虚拟环境名"><a href="#pyenv-activate-虚拟环境名" class="headerlink" title="pyenv activate 虚拟环境名"></a>pyenv activate 虚拟环境名</h5><p>用于激活特定名称的虚拟运行环境，命令输出如下内容。激活后有如下提示信息。如提示信息所述，在非虚拟环境下运行export PYENV_VIRTUALENV_DISABLE_PROMPT=1，则可以在以后激活虚拟环境时，关闭该提示信息。虚拟环境激活之后，命令行提示符部分会有(env360)类似字样，说明当前在env360的虚拟运行环境下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % pyenv activate env360</span><br><span class="line">pyenv-virtualenv: prompt changing will be removed from future release. configure `<span class="built_in">export</span> PYENV_VIRTUALENV_DISABLE_PROMPT=1<span class="string">&#x27; to simulate the behavior.</span></span><br><span class="line"><span class="string">(env360) username@mac ~ % </span></span><br></pre></td></tr></table></figure><h5 id="pyenv-virtualenv-delete-虚拟环境名-或-pyenv-uninstall-虚拟环境名"><a href="#pyenv-virtualenv-delete-虚拟环境名-或-pyenv-uninstall-虚拟环境名" class="headerlink" title="pyenv virtualenv-delete 虚拟环境名 或 pyenv uninstall 虚拟环境名"></a>pyenv virtualenv-delete 虚拟环境名 或 pyenv uninstall 虚拟环境名</h5><p>这两个命令都是用于删除特定名称的虚拟运行环境，以命令<code>pyenv virtualenv-delete</code>为例，输出入如下内容。命令运行后会有提示信息用于确认操作，输入yes即可确认操作，完成虚拟运行环境的删除工作。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % pyenv virtualenv-delete env385          </span><br><span class="line">pyenv-virtualenv: remove /Users/username/.pyenv/versions/3.8.5/envs/env385? yes</span><br><span class="line">username@mac ~ %</span><br></pre></td></tr></table></figure><h3 id="卸载-pyenv-virtualenv"><a href="#卸载-pyenv-virtualenv" class="headerlink" title="卸载 pyenv-virtualenv"></a>卸载 pyenv-virtualenv</h3><p>pyenv-virtualenv的卸载和pyenv的卸载过程类似，删除bash配置文件的相关内容，在pyenv目录中的删除相对应的pyenv-virtualenv子目录即可。</p><h3 id="更新-pyenv-virtualenv"><a href="#更新-pyenv-virtualenv" class="headerlink" title="更新 pyenv-virtualenv"></a>更新 pyenv-virtualenv</h3><p>如图pyenv一样，在mac中，可以使用brew upgrade pyenv-virtualenv来完成pyenv-virtualenv的更新，也可以通过从github中克隆新版本的源码到本地安装目录完成相应更新工作。</p><h3 id="所遇问题与解决方案"><a href="#所遇问题与解决方案" class="headerlink" title="所遇问题与解决方案"></a>所遇问题与解决方案</h3><h4 id="问题：Ubuntu-下使用pyenv安装3-7-0版本时，遇到的安装错误"><a href="#问题：Ubuntu-下使用pyenv安装3-7-0版本时，遇到的安装错误" class="headerlink" title="问题：Ubuntu 下使用pyenv安装3.7.0版本时，遇到的安装错误"></a>问题：Ubuntu 下使用pyenv安装3.7.0版本时，遇到的安装错误</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@R021:~<span class="comment"># pyenv install -v 3.6.12</span></span><br><span class="line">Downloading Python-3.6.12.tar.xz...</span><br><span class="line">-&gt; https://www.python.org/ftp/python/3.6.12/Python-3.6.12.tar.xz</span><br><span class="line">/tmp/python-build.20200916030737.1554 ~</span><br><span class="line">Installing Python-3.6.12...</span><br><span class="line">/tmp/python-build.20200916030737.1554/Python-3.6.12 /tmp/python-build.20200916030737.1554 ~</span><br><span class="line">checking build system <span class="built_in">type</span>... x86_64-pc-linux-gnu</span><br><span class="line">checking host system <span class="built_in">type</span>... x86_64-pc-linux-gnu</span><br><span class="line">checking <span class="keyword">for</span> python3.6... no</span><br><span class="line">checking <span class="keyword">for</span> python3... python3</span><br><span class="line">checking <span class="keyword">for</span> --enable-universalsdk... no</span><br><span class="line">checking <span class="keyword">for</span> --with-universal-archs... no</span><br><span class="line">checking MACHDEP... linux</span><br><span class="line">checking <span class="keyword">for</span> --without-gcc... no</span><br><span class="line">checking <span class="keyword">for</span> --with-icc... no</span><br><span class="line">checking <span class="keyword">for</span> gcc... no</span><br><span class="line">checking <span class="keyword">for</span> cc... no</span><br><span class="line">checking <span class="keyword">for</span> cl.exe... cl.exe</span><br><span class="line"></span><br><span class="line">BUILD FAILED (Ubuntu 16.04 using python-build 1.2.20-6-gd1ae4a1)</span><br><span class="line"></span><br><span class="line">Inspect or clean up the working tree at /tmp/python-build.20200916030737.1554</span><br><span class="line">Results logged to /tmp/python-build.20200916030737.1554.log</span><br></pre></td></tr></table></figure><p>出现上述问题的原因为，部分pyenv所需的内容没有安装，可以尝试使用如下命令来检查和安装pyenv的所需组建，然后再使用pyenv安装所需python版本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y make build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev xz-utils tk-dev</span><br></pre></td></tr></table></figure><h4 id="问题：Mac-下使用pyenv安装3-7-0版本时，遇到的安装错误"><a href="#问题：Mac-下使用pyenv安装3-7-0版本时，遇到的安装错误" class="headerlink" title="问题：Mac 下使用pyenv安装3.7.0版本时，遇到的安装错误"></a>问题：Mac 下使用pyenv安装3.7.0版本时，遇到的安装错误</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % pyenv install 3.7.0 </span><br><span class="line">Downloading openssl-1.0.2k.tar.gz...</span><br><span class="line">-&gt; https://www.openssl.org/<span class="built_in">source</span>/openssl-1.0.2k.tar.gz</span><br><span class="line">Installing openssl-1.0.2k...</span><br><span class="line"></span><br><span class="line">BUILD FAILED (OS X 10.15.5 using python-build 20180424)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">configure: error: C compiler cannot create executables</span><br><span class="line">See `config.log<span class="string">&#x27; for more details.</span></span><br></pre></td></tr></table></figure><p>上述错误中的关键内容为C 编译器错误，解决方法。这时候就要检查xcode comand line组件是否安装，使用如下命令检测xcode command line是否安装，如果有输出内容，则说明已经安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % xcode-select -p</span><br><span class="line">/Library/Developer/CommandLineTools</span><br></pre></td></tr></table></figure><p>如果想检查xcode command line的版本，则可以使用如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">username@mac ~ % pkgutil --pkg-info=com.apple.pkg.CLTools_Executables</span><br><span class="line">package-id: com.apple.pkg.CLTools_Executables</span><br><span class="line">version: 12.0.0.0.1.1599194153</span><br><span class="line">volume: /</span><br><span class="line">location: /</span><br><span class="line">install-time: 1600823154</span><br><span class="line">groups: com.apple.FindSystemFiles.pkg-group </span><br></pre></td></tr></table></figure><p>如果没有安装，则需要安装Xcode command line， 然后重新使用pyenv安装所需版本的python。</p><h4 id="问题：Mac-终端启动虚拟环境时，遇到错误"><a href="#问题：Mac-终端启动虚拟环境时，遇到错误" class="headerlink" title="问题：Mac 终端启动虚拟环境时，遇到错误"></a>问题：Mac 终端启动虚拟环境时，遇到错误</h4><p>在Mac上安装完pyenv和pyenv-virtualenv后，当重新启动终端后，运行pyenv activate xxx启动虚拟环境时会遇到如下提示，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Failed to deactivate virtualenv.</span><br><span class="line"></span><br><span class="line">Perhaps pyenv-virtualenv has not been loaded into your shell properly.</span><br><span class="line">Please restart current shell and try again.</span><br></pre></td></tr></table></figure><p>检查bash的配置<code>.bash_profile</code>中内容也没有发现问题，这时候就要查看Mac中启动的终端时bash还是zsh。bash与zsh都是mac终端自带的shell命令解释器，早期Mac OS系统默认使用bash解释器，在10.15之后的系统中官方推荐使用zsh解释器。如果当前终端启动的是zsh，就需要创建zsh的配置文件<code>.zshrc</code>文件，并在该文件中添加如下相关配置即可，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv init -)</span>&quot;</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(pyenv virtualenv-init -)</span>&quot;</span></span><br></pre></td></tr></table></figure><p>当然在Mac中bash和zsh是可以自由切换的，切换方式如下：</p><ul><li>切换bash：<code>chsh -s /bin/bash</code></li><li>切换zsh：<code>chsh -s /bin/zsh</code></li><li><strong>终端</strong>的系统偏好设置里手动设置。</li></ul><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>以上即为本人在安装和配置pyenv和pyenv-virtualenv整个过程，也包括自己在不同系统下安装这两个组建所遇问题和找到的解决方案。Python版本隔离与Python开发运行环境隔离，两者哪一个更有必要了解安装？哪种方案最优？个人觉得没必要过多纠结，适合自己需求的就是最合适的。上述方案也仅为一家之言，并非最优，若读者有别的思路也欢迎关注我的个人微信公众号，一起讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">    版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，    转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。</div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号:  &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;摘要：为何需要使用pyenv来管理python的版本？为何需要使用virtualenv来创建python虚拟运行环境？pyenv与pipenv和virtualenv的关系是什么样的？在自己使用pyenv的时候遇见过什么样的问题，又是如何解决所遇问题的。如果遇见诸如“BUILD FAILED”的安装错误，出现该错误的原因可能是什么？&lt;/p&gt;
&lt;p&gt;Abstract: Why do we need to manage the use pyenv python version？Why do I need to use virtualenv to create a python virtual runtime environment? What is the relationship with pyenv, pipenv, and virtualenv ?What kind of problems have been encountered when using pyenv and how have they been solved？ If you encounter an installation error such as “BUILD FAILED”, what could be the cause of the error?&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python 相关 - 8. Python 杂记" scheme="https://zicowarn.github.io/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/"/>
    
    
      <category term="Python" scheme="https://zicowarn.github.io/tags/Python/"/>
    
      <category term="杂记" scheme="https://zicowarn.github.io/tags/%E6%9D%82%E8%AE%B0/"/>
    
      <category term="Pyenv" scheme="https://zicowarn.github.io/tags/Pyenv/"/>
    
      <category term="版本管理" scheme="https://zicowarn.github.io/tags/%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>AWS 如何在lambda函数中使用Python依赖库pymssql</title>
    <link href="https://zicowarn.github.io/2020/09/20/aws-lambda-02-use-pythonpackage-pymssql/"/>
    <id>https://zicowarn.github.io/2020/09/20/aws-lambda-02-use-pythonpackage-pymssql/</id>
    <published>2020-09-20T01:39:50.000Z</published>
    <updated>2020-11-14T11:56:36.155Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a> </p><h3 id="任务背景"><a href="#任务背景" class="headerlink" title="任务背景"></a>任务背景</h3><p>任务为使用aws的lambda函数从一个MS SQL数据库中读取部分的数据，然后对数据处理后，转存至aws的DyanmoDB上，因为需要从MS SQL数据库中读取信息，代码就需要相关依赖，Python对MS SQL的依赖库为<a href="https://pypi.org/project/pymssql/"><strong>pymssql</strong></a>，初步计划lambda 的函数使用Python来完成，版本为Python 3.6。本文主要介绍，如何在aws lambda函数中使用python依赖库<strong>pymssql</strong>。</p><h3 id="所遇问题"><a href="#所遇问题" class="headerlink" title="所遇问题"></a>所遇问题</h3><p>aws lambda 的 Python 3.6 的运行环境，是不具有pymssql这个依赖包的，该依赖包并非标准库，又<strong>PyPI</strong>(<em>Python Package Index</em>)是python<strong>官方的第三方库的仓库</strong>管理维护，可以通过pip命令获取和安装。aws lambda 函数Python Runtime 运行时与操作系统如下，总的来说lambda函数是运行在Amazon Linux的操作系统上的，Amazon Linux和Amazon Linux2的区别就是内核版本有区别。</p><table><thead><tr><th align="left">Python 运行时</th><th align="left"></th><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">名称</td><td align="left">标识符</td><td align="left">适用于 Python 的 AWS 开发工具包</td><td align="left">操作系统</td></tr><tr><td align="left">Python 3.8</td><td align="left"><code>python3.8</code></td><td align="left">boto3-1.14.17 botocore-1.17.17</td><td align="left">Amazon Linux 2</td></tr><tr><td align="left">Python 3.7</td><td align="left"><code>python3.7</code></td><td align="left">boto3-1.14.17 botocore-1.17.17</td><td align="left">Amazon Linux</td></tr><tr><td align="left">Python 3.6</td><td align="left"><code>python3.6</code></td><td align="left">boto3-1.14.17 botocore-1.17.17</td><td align="left">Amazon Linux</td></tr><tr><td align="left">Python 2.7</td><td align="left"><code>python2.7</code></td><td align="left">boto3-1.14.17 botocore-1.17.17</td><td align="left">Amazon Linux</td></tr></tbody></table><p>在测试中，我们使用的lambda函数名为<strong>test</strong>，Python文件名为lambda_function.py，该文件内容为，lambda函数的范例代码，内容如下。其中第二行为修改内容，主要为了引入pymssql模块。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pymssql</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lambda_handler</span>(<span class="params">event, context</span>):</span></span><br><span class="line">    <span class="comment"># TODO implement</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;statusCode&#x27;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span>: json.dumps(<span class="string">&#x27;Hello from Lambda!&#x27;</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>由于pymssql不是标准库，所以如果直接在lambda函数中引用该包，则lambda的执行结果为：<strong>失败</strong>，错误信息为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;errorMessage&quot;</span>: <span class="string">&quot;Unable to import module &#x27;lambda_function&#x27;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>日志输出为，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">START RequestId: d77542a0-d9c0-426a-a050-04948dc8464a Version: <span class="variable">$LATEST</span></span><br><span class="line">Unable to import module <span class="string">&#x27;lambda_function&#x27;</span>: No module named <span class="string">&#x27;pymssql&#x27;</span></span><br><span class="line"></span><br><span class="line">END RequestId: d77542a0-d9c0-426a-a050-04948dc8464a</span><br><span class="line">REPORT RequestId: d77542a0-d9c0-426a-a050-04948dc8464aDuration: 0.32 msBilled Duration: 100 msMemory Size: 128 MBMax Memory Used: 43 MBInit Duration: 1.32 ms</span><br></pre></td></tr></table></figure><p>可以看出，程序错误的原因为无法引入pymssql这个模块，是一个依赖问题。基本的共识为：不同版本的Python的相同第三方依赖包的内容是不同的，同样的不同操作系统的相同第三方依赖包的内容也是不同的。所以在调试代码也好，解决依赖也好，就需要创建一个Python版本隔离并且依赖隔离的环境，这部分内容，在python相关的文章里都有介绍，若有需要可以查看相关文章。</p><h3 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h3><p>解决问题的思路有两种：第一种，使用lambda 层（Layer）的方式解决依赖问题，另一种为将依赖内容与lambda函数的py文件整合在一起解决依赖问题。lambda函数代码更新可以通过，网页端，上传zip程序包或Amazone S3中引用，三种方式完成，本文主要讨论的以zip压缩文件作为程序包来更新lambda的相关代码部分。</p><h4 id="创建-lambda-程序的依赖项程序包"><a href="#创建-lambda-程序的依赖项程序包" class="headerlink" title="创建 lambda 程序的依赖项程序包"></a>创建 lambda 程序的依赖项程序包</h4><p>要创建一个运行在linux系统下，Python 3.6运行时的lambda函数相关依赖项的程序包，就要创建并启动一个Python的隔离运行环境。关于如何创建这样一个隔离环境，也请参考python相关文章。</p><h5 id="启动虚拟环境"><a href="#启动虚拟环境" class="headerlink" title="启动虚拟环境"></a>启动虚拟环境</h5><p>比如，在Linux系统下，我们有如下的一个名为env3612的python虚拟环境，则可以在终端里输入pyenv activate env3612命令来启动这个虚拟环境，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">username@mac:~<span class="comment"># pyenv virtualenvs</span></span><br><span class="line">  3.6.12/envs/env3612 (created from /root/.pyenv/versions/3.6.12)</span><br><span class="line">  env3612 (created from /root/.pyenv/versions/3.6.12)</span><br><span class="line"></span><br><span class="line">username@mac:~<span class="comment"># pyenv activate env3612</span></span><br><span class="line">(env3612) username@mac:~<span class="comment">#</span></span><br></pre></td></tr></table></figure><h5 id="创建工作文件夹"><a href="#创建工作文件夹" class="headerlink" title="创建工作文件夹"></a>创建工作文件夹</h5><p>在相关虚拟运行环境启动后，就可以创建一个工作目录，下面代码中第一层目录的文件夹pymssql-dependencies这个名字可以自定义，其不对后续操作产生影响，第二层目录的文件夹python，该文件夹名非常重要，请保持一致。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username@mac:~<span class="comment"># mkdir pymssql-dependencies</span></span><br><span class="line">username@mac:~<span class="comment"># cd pymssql-dependencies/</span></span><br><span class="line">username@mac:~/pymssql-dependencies<span class="comment"># mkdir python</span></span><br><span class="line">username@mac:~/pymssql-dependencies<span class="comment"># cd python/</span></span><br></pre></td></tr></table></figure><h5 id="安装单一Python库"><a href="#安装单一Python库" class="headerlink" title="安装单一Python库"></a>安装单一Python库</h5><p>进入最终工作目录python之后，即可使用pip命令<code>pip install pymssql -t ./ </code>，就可以单独安装pymssql这个依赖库安装到这个python文件夹内，安装之后，文件夹内仅有pymssql相关内容。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(env3612) username@mac:~/pymssql-dependencies/python<span class="comment"># pip install pymssql -t ./</span></span><br></pre></td></tr></table></figure><h5 id="压缩程序包"><a href="#压缩程序包" class="headerlink" title="压缩程序包"></a>压缩程序包</h5><p>完成pymssql之后，需要从python这个文件夹返回至上一级目录，再使用<code>zip -r ~/tmp/pymssql-dependencies.zip . </code>将python目录内的所有内容压缩成zip文件。该文件可以理解为lambda函数的程序包。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(env3612) username@mac:~/pymssql-dependencies/python<span class="comment"># cd ..</span></span><br><span class="line">(env3612) username@mac:~/pymssql-dependencies<span class="comment"># mkdir ~/tmp</span></span><br><span class="line">(env3612) username@mac:~/pymssql-dependencies<span class="comment"># zip -r ~/tmp/pymssql-dependencies.zip .</span></span><br><span class="line">  adding: python/ (stored 0%)</span><br><span class="line">  adding: python/_mssql.cpython-36m-x86_64-linux-gnu.so (deflated 73%)</span><br><span class="line">...</span><br><span class="line">  adding: python/pymssql.libs/libsybdb-98ddd287.so.5.1.0 (deflated 64%)</span><br></pre></td></tr></table></figure><h4 id="一、通过-lambda-层解决依赖问题"><a href="#一、通过-lambda-层解决依赖问题" class="headerlink" title="一、通过 lambda 层解决依赖问题"></a>一、通过 lambda 层解决依赖问题</h4><p>该方法解决问题是，首先要创建一个lambda 函数的层，配置信息请参考下方图片。在这里层的名称可以自定义，因为其只做为索引，在lambda函数引入层时，被用于索引。与之后要上传至层的zip文件名，和zip文件内的文件都无关系。</p><h5 id="创建lambda层"><a href="#创建lambda层" class="headerlink" title="创建lambda层"></a>创建lambda层</h5><p><img src="/2020/09/20/aws-lambda-02-use-pythonpackage-pymssql/aws-lambda-02-creatlayer.png" alt="Lambda Create Layer"></p><p>然后选择之前创建的zip文件，上传后点击<code>创建</code>，就可以完成相关lambda层的创建。再在lambda函数的配置页面点击<code>Layers</code>，然后选择<code>添加层</code>，为test这个lambda函数的指定一个layer。</p><p><img src="/2020/09/20/aws-lambda-02-use-pythonpackage-pymssql/aws-lambda-0203.png" alt="aws-lambda-0203"></p><p>然后在如下页面选择<code>自定义层</code>，选择层的名称，点击<code>添加</code>即可完成配置。</p><p><img src="/2020/09/20/aws-lambda-02-use-pythonpackage-pymssql/aws-lambda-0204.png" alt="aws-lambda-0204"></p><p>然后就可以再次测试该lambda函数。这时候lambda的执行结果为：<strong>成功</strong>，详细信息为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;statusCode&quot;: 200,</span><br><span class="line">  &quot;body&quot;: &quot;\&quot;Hello from Lambda!\&quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>日志输出为，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">START RequestId: ee1f059b-8288-4463-8501-8f36df9a6d67 Version: <span class="variable">$LATEST</span></span><br><span class="line">END RequestId: ee1f059b-8288-4463-8501-8f36df9a6d67</span><br><span class="line">REPORT RequestId: ee1f059b-8288-4463-8501-8f36df9a6d67Duration: 0.33 msBilled Duration: 100 msMemory Size: 128 MBMax Memory Used: 48 MBInit Duration: 29.24 ms</span><br></pre></td></tr></table></figure><p>如上的信息表明，上述方法已经通过lambda函数的层的方式解决了依赖问题，通过该方法也可以解决其他相关依赖的相似问题。</p><h4 id="二、通过-lambda-代码解决依赖问题"><a href="#二、通过-lambda-代码解决依赖问题" class="headerlink" title="二、通过 lambda 代码解决依赖问题"></a>二、通过 lambda 代码解决依赖问题</h4><p>该方法前期准备工作与方法一相同，都需要创建Python的隔离运行环境，并安装pymssql至python文件夹内，在安装以后，python文件夹的具体情况如下，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(env3612) username@mac:~/pymssql-dependencies/python<span class="comment"># ls -al</span></span><br><span class="line">total 7392</span><br><span class="line">drwxr-xr-x@   7 username  staff      224  9 27 16:23 .</span><br><span class="line">drwx------+ 145 username  staff     4640  9 27 16:24 ..</span><br><span class="line">-rwxr-xr-x@   1 username  staff  2287480  9 27 11:07 _mssql.cpython-36m-x86_64-linux-gnu.so</span><br><span class="line">drwxr-xr-x@   9 username  staff      288  9 27 11:07 pymssql-2.1.5.dist-info</span><br><span class="line">-rwxr-xr-x@   1 username  staff  1490808  9 27 11:07 pymssql.cpython-36m-x86_64-linux-gnu.so</span><br><span class="line">drwxr-xr-x@   4 username  staff      128  9 27 16:20 pymssql.libs</span><br></pre></td></tr></table></figure><p>这时候需要将lambda函数的py文件，即lambda_function.py拷贝至该目录，然后在python目录下，运行<code>zip -r ~/Downloads/test.zip .</code>命令，将python文件内的所有文件压缩成为一个名为test.zip的压缩文档，如下，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(env3612) username@mac:~/pymssql-dependencies/python<span class="comment">#  zip -r ~/Downloads/test.zip . </span></span><br><span class="line">updating: _mssql.cpython-36m-x86_64-linux-gnu.so (deflated 73%)</span><br><span class="line">updating: pymssql.cpython-36m-x86_64-linux-gnu.so (deflated 72%)</span><br><span class="line">updating: lambda_function.py (deflated 24%)</span><br><span class="line">  adding: pymssql-2.1.5.dist-info/ (stored 0%)</span><br><span class="line">  adding: pymssql-2.1.5.dist-info/RECORD (deflated 39%)</span><br><span class="line">...</span><br><span class="line">  adding: pymssql.libs/lambda_function.py (deflated 24%)</span><br></pre></td></tr></table></figure><p>在这里，zip的文件名最好与lambda函数保持一致，文件名称字母大小写不敏感。然后点击lambda函数中<code>函数代码</code>部分的<code>操作</code>按钮，然后选择<code>上传.zip文件</code>项，接着选择test.zip压缩文件，点击<code>保存</code>即可。</p><p><img src="/2020/09/20/aws-lambda-02-use-pythonpackage-pymssql/aws-lambda-0204-1195705.png" alt="aws-lambda-0204"></p><p>完成上述内容，然后点击测试，就可以得到与方法一一样的成功执行结果。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>上述两个方法中，程序包的部署，可以通过网页端完成，也可以通过aws-cli来实现。zip的文件包也可以先上传至Amazone S3存储内，然后在页面端选择使用。在尝试两个方法的时候，要注意打包zip程序包时，命令行的当前目录，方法一需要在python上一级目录。方法二需要确保在python目录内。上述两个方案仅为一家之言，并非最优，若读者有别的思路也欢迎关注我的个人微信公众号，一起讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">    版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，    转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。</div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;摘要：使用Python实现aws lambda函数时，如何解决代码依赖问题？如何在aws lambda中配置并安装Python的依赖包Packages？以pymssql依赖包为例，如何在aws lambda的Python代码中import该依赖？&lt;/p&gt;
&lt;p&gt;Abstract: How to solve the problem of code dependency when using Python to implement aws lambda function? How to configure and install Python’s dependency package Packages in aws lambda? This article takes the pymssql dependency package as an example. How to import the dependency in the Python code of aws lambda?&lt;/p&gt;
    
    </summary>
    
    
      <category term="AWS 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/AWS-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="AWS" scheme="https://zicowarn.github.io/tags/AWS/"/>
    
      <category term="lambda" scheme="https://zicowarn.github.io/tags/lambda/"/>
    
  </entry>
  
  <entry>
    <title>Hexo 如何在VS Code中调试Hexo的相关代码</title>
    <link href="https://zicowarn.github.io/2020/09/03/hexo-03-howto-debug-hexo-in-vscode/"/>
    <id>https://zicowarn.github.io/2020/09/03/hexo-03-howto-debug-hexo-in-vscode/</id>
    <published>2020-09-03T01:25:45.000Z</published>
    <updated>2020-09-03T09:30:40.266Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>按理说，日常Hexo的使用是不需要考虑代码调试的。一般情况下使用到的Hexo版本也是经过充分测试才发布的正式版本。可能还会有一些隐藏的小问题，但也足以应对日常使用。能想起来调试Hexo的相关代码，完全是出于好奇，想知道hexo deploy命令运行时到底做了些什么，hexo deploy背后的具体流程是什么，如何将项目中的README.md文件在部署时同时被拷贝到**.deploy_git**目录中，进而部署到Github中。带着这些问题，花费了点时间尝试之后，现将调试环境的部署方式记录下来，以便自己以后回顾学习。 </p><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>VS Code 编辑器对Node的调试环境做了很大的优化和支持。实际应用中，需要自己做的是很少的，在VS Code中<strong>运行</strong>和<strong>调试</strong>的设置都在launch.json这个配置文件中。VS Code也为Node项目提供了多配置模版snippets（点击按钮Add Configuration…即可看见配置模版列表），在方法一中我们先选择一个“<strong>Launch Program</strong>”的模版，基本的配置内容如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Launch&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;$&#123;workspaceRoot&#125;/index.js&quot;</span></span><br><span class="line">        &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中重要的参数<strong>request</strong>的取值和基本区别如下，两者的应用场景差异的具体细节不是本文重点，就不在本文中进行详细解释。</p><ul><li>launch 模式：VS Code会启动一个独立的具有debug模式的程序。</li><li>attach 模式：用于监听一个已经启动的程序。</li></ul><p>由于我们选择的是Lauch Program的配置模版，其<code>request</code>的参数默认为launch，该模式也是我们本文中使用的。在添加相应的内容之后，就可以在VS Code中，调试诸如hexo deploy的命令相关代码。接下来，只需要在Javascript文件“./node_modules/hexo-deployer-git/lib/deployer.js”中合适的位置添加断点，然后启动该配置，就可以看到程序在断点停留。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Debug Hexo Deploy Direct&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;runtimeArgs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;--nolazy&quot;</span> <span class="comment">// 强制V8引擎完成代码的编译工作，这在远程调试时比较有用，可选</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;./node_modules/hexo-cli/bin/hexo&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;args&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;deploy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;--debug&quot;</span> <span class="comment">//设置Hexo的 log基本，以便输出更多的日志内容</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;console&quot;</span>: <span class="string">&quot;internalConsole&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;outputCapture&quot;</span>: <span class="string">&quot;std&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>我们也可以选择使用“<strong>Launch via npm</strong>”的模版，选用这个配置模版后会得到以下配置内容。npm作为node第三方依赖模块的管理工具，用npm运行js文件和node运行js文件的差异，我们不在本文中进行讨论。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span>: [&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Launch via NPM&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;runtimeArgs&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;run-script&quot;</span>,</span><br><span class="line">      <span class="string">&quot;debug&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;runtimeExecutable&quot;</span>: <span class="string">&quot;npm&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;skipFiles&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;&lt;node_internals&gt;/**&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;pwa-node&quot;</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上述模版信息为基础，修改添加一些选项后，我们得到以下配置内容。使用该配置内容，也能完成调试环境的搭建。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Debug Hexo Deploy via npm&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;runtimeExecutable&quot;</span>: <span class="string">&quot;npm&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;runtimeArgs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;run&quot;</span>, <span class="string">&quot;deploy&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;console&quot;</span>: <span class="string">&quot;internalConsole&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;outputCapture&quot;</span>: <span class="string">&quot;std&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上述配置中的<code>runtimeArgs</code>配置项中的<code>deploy</code>参数，意指Hexo项目的配置文件package.json中的<code>scripts</code>配置项目中的<code>deploy</code>，参见下列内容：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;hexo-site&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;private&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;build&quot;</span>: <span class="string">&quot;hexo generate&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;clean&quot;</span>: <span class="string">&quot;hexo clean&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;deploy&quot;</span>: <span class="string">&quot;hexo deploy&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;server&quot;</span>: <span class="string">&quot;hexo server&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h4><p>有些人也推荐使用另一种方法，该方法以本文中的方法二为基础，不过需要安装依赖模块<strong>node-cli</strong>。安装该依赖模块的时候，需使用下列命令，以确保该模块被安装在devDependencies节点下，以便以后初始化项目时，运行npm install –production命令时，该依赖模块不会被安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -save-dev node-cli</span><br></pre></td></tr></table></figure><p>在安装完node的CLI后，就需要对Hexo的package.json文件进行修改，在<code>scripts</code>中添加以下内容：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;hexo-site&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.0.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;private&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;build&quot;</span>: <span class="string">&quot;hexo generate&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;clean&quot;</span>: <span class="string">&quot;hexo clean&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;deploy&quot;</span>: <span class="string">&quot;hexo deploy&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;server&quot;</span>: <span class="string">&quot;hexo server&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;debug-deploy&quot;</span>: <span class="string">&quot;node ./node_modules/hexo-cli/bin/hexo deploy --debug&quot;</span> <span class="comment">// 该行</span></span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后修改VS Code的launch.json文件，选用方法二中使用的“<strong>Launch via npm</strong>”模版，然后参照以下内容完成配置，就可以搭建Hexo代码的调试环境。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Debug Hexo Deploy via npm&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;runtimeExecutable&quot;</span>: <span class="string">&quot;npm&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;runtimeArgs&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;run&quot;</span>, <span class="string">&quot;debug-deploy&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;console&quot;</span>: <span class="string">&quot;internalConsole&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;outputCapture&quot;</span>: <span class="string">&quot;std&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上三种方法都能用于VS Code中Hexo调试环境的搭建工作，三种方法也没有优劣之分，正所谓萝卜白菜各有所爱，使用哪一种方法全凭个人喜好。</p><h3 id="应用技巧"><a href="#应用技巧" class="headerlink" title="应用技巧"></a>应用技巧</h3><p>Hexo的日志组件Logger的部分方法如下。前文中介绍的相关配置中的“–debug”，就是为了设置日志的输出等级，以便获取更多的程序运行信息。</p><ul><li>log.info()</li><li>log.debug()</li><li>log.warn()</li><li>log.error()</li></ul><p>默认情况下，由于VS Code存在问题（<a href="https://github.com/Microsoft/vscode/issues/19750">Issues 19750</a>，请点击查看具体内容），所以上述的logger方法，因其内部使用了“<strong>process.stdout.write()**”方法，这个方法输出的文本和</strong>“console.log()”<strong>方法所输出的文本，会输出到不同的地方（虽然理论上console.log内部使用的也是process.stdout.write方法，输出的文本内容应该位于同一地方），仅代码中的console.log输出的内容会显示在VS Code的</strong>DEBUG CONSOLE中**。这种情况下，由于缺少日志信息不利于调试，就需要解决该问题。解决方法就是在配置中添加下列代码：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">//&quot;port&quot;: 9229,</span></span><br><span class="line">  <span class="attr">&quot;console&quot;</span>: <span class="string">&quot;internalConsole&quot;</span>, <span class="comment">//integratedTerminal意指 VS Code 的 TERMINAL</span></span><br><span class="line">  <span class="attr">&quot;outputCapture&quot;</span>: <span class="string">&quot;std&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>outputCapture</code> 这项配置，如果设置为std，则标准输出stdout 与标准错误stderr的输出都将显示在调试控制台中，而不是在调试端口上的输出。这对于直接写入stdout / stderr流而不是使用console.*的程序或在使用其他第三方日志库时会很有帮助。</p><p>能有此文全因自己好奇。在文章最后想说一下，这里没有专家，记录这些主要是为了自己以后回顾学习之方便，文章有不足之处也实属正常。见解不同，诚切赐教，关注微信公众号，一起讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">    版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，    转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。</div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;摘要：在使用Hexo部署自己的博客时，常常接触hexo generater，hexo clean和hexo deploy等命令，估计很少人想过如何调试Hexo这些命令的相关代码。作为基于Node的开源blog项目，其在VS Code中的调试环境是什么样的？如何建立这样的调试环境？调试时需要注意什么？ 在VSCode调试Node代码时，可能会遇见方法process.stdout.write和方法console.log的输出内容不在同一位置的问题，该问题如何解决?&lt;/p&gt;
&lt;p&gt;Abstract: When using hexo to deploy the blog, often use commands such as hexo generator, hexo clean and hexo deploy. Few people have thought about how to debug the Hexo codes related to these commands. As a node-based open source blog project, what is its debugging environment in VS Code? How to build a debugging environment for debugging Hexo code? What should pay attention to when debugging? When debugging Node code in VS Code, the output content of process.stdout.write and console.log are not in the same location, why? How to solve the problem?&lt;/p&gt;
    
    </summary>
    
    
      <category term="Hexo 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/Hexo-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="Hexo" scheme="https://zicowarn.github.io/tags/Hexo/"/>
    
      <category term="调试" scheme="https://zicowarn.github.io/tags/%E8%B0%83%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Hexo 解决嵌入的html被渲染的问题和code_dir的配置项的用法</title>
    <link href="https://zicowarn.github.io/2020/09/02/hexo-02-embed-html-and-downloads-code/"/>
    <id>https://zicowarn.github.io/2020/09/02/hexo-02-embed-html-and-downloads-code/</id>
    <published>2020-09-02T00:11:08.000Z</published>
    <updated>2020-09-03T10:01:09.871Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><h3 id="嵌入式html渲染异常"><a href="#嵌入式html渲染异常" class="headerlink" title="嵌入式html渲染异常"></a>嵌入式html渲染异常</h3><p>在使用Hexo管理自己的技术博客文章时，有时候需要在文中嵌入html代码。例如使用iframe嵌入html网页，这时候常常会遇见渲染异常，即嵌入的html也被hexo的主题代码渲染了。解决这部分异常的方法很简单。假设文章中嵌入的html代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">width</span>=<span class="string">&quot;200&quot;</span> <span class="attr">height</span>=<span class="string">&quot;300&quot;</span> <span class="attr">src</span>=<span class="string">&quot;demo/demo-1.html&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;40&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><p>解决该问题的方法很简单，仅需在Hexo的配置文件_config.yml中找到<code>skip_render</code>这一配置项，按照如下修改配置文件即可：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Directory</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">skip_render:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">demo/*.html</span></span><br></pre></td></tr></table></figure><p>出现问题的原因是：在渲染markdown文章的时候，内部的html也一并被渲染了，修改这一项则可以在渲染的时候过滤指定文件。该配置支持通配模式。相同方法，嵌入文章的CSS和Javascript文件也可以在渲染时被忽略。</p><h3 id="code-dir配置项的用法"><a href="#code-dir配置项的用法" class="headerlink" title="code_dir配置项的用法"></a>code_dir配置项的用法</h3><p>在hexo的配置文件_config.yml中有<code>code_dir</code>这一配置项，这个配置项也是在修改<code>skip_render</code>的时候发现的，就好奇它的作用，弄清楚之后记录下来，以便以后回顾学习。了解发现这个配置的用处很大。之前写文章时，为了解决文章配图的问题，当时学会了<code>post_asset_folder</code>配置项，为此也安装了<strong>hexo-asset-image</strong>包。所以一开始在使用iframe尝试在文章中嵌入html页面时，就把相应的html文件，css文件，js文件全部放在了与post同名的文件夹中，但是学会<code>code_dir</code>这一配置项后，就可以更优雅地处理这些文件了。</p><p><code>code_dir</code>的默认值为路径<strong>downloads/code</strong>。问题是该文件夹应该位于何处，才能在确保使用hexo server和hexo deploy两个命令时，文章被正确处理。经过尝试之后得知，文件夹downloads/code应位于<strong>source</strong>文件夹内，如下图。这样的话可以确保，无论文章是在编辑、预览或发布时，文章中的相关内容都有效。</p><p><img src="/2020/09/02/hexo-02-embed-html-and-downloads-code/hexo-02-01.png" alt="截屏2020-09-02 下午4.52.28"></p><p>这个文件夹，不仅可以用于本文提到嵌入式的html，css和js文件的保存目录，也可以作为示例代码的保存路径以供读者下载尝试。即在markdown文章内使用下列代码：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">donwload file</span>](<span class="link">/downloads/code/demo.html</span>)</span><br></pre></td></tr></table></figure><p>文章发布时，读者就可以使用右键菜单“储存为…”下载所需文件。</p><p>这里没有专家，记录这些主要是为了自己以后回顾学习之方便，文章有不足之处也实属正常。见解不同，诚切赐教，关注微信公众号，一起讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">    版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，    转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。</div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;摘要：使用Hexo时，如何解决嵌入的html也被hexo的主题代码渲染的问题？hexo中的code_dir的文件夹的作用是？&lt;/p&gt;
&lt;p&gt;Abstract: How to solve the problem that embedded html is also rendered by hexo theme code. What does the code_dir folder in hexo for? &lt;/p&gt;
    
    </summary>
    
    
      <category term="Hexo 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/Hexo-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="Hexo" scheme="https://zicowarn.github.io/tags/Hexo/"/>
    
      <category term="使用技巧" scheme="https://zicowarn.github.io/tags/%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>CSS 如何运用CSS来隐藏页面文本</title>
    <link href="https://zicowarn.github.io/2020/08/29/css-01-use-css-hide-content/"/>
    <id>https://zicowarn.github.io/2020/08/29/css-01-use-css-hide-content/</id>
    <published>2020-08-29T09:13:51.000Z</published>
    <updated>2020-08-31T11:08:03.533Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>开篇立意，在探索全栈程序猿的路上我还坚持爬行着。在本文伊始想给大家大家讲一下，这里没有什么所谓专家和也没有能独挡一面的技术大拿，有的仅仅是一个愿意不断尝试，愿意学习的学生而已。不忘初心，正所谓阅文无数，不如明师指路；明师指路，不如自己去悟。说到底，学习知识做到知行合一才是真理。</p><h3 id="任务背景"><a href="#任务背景" class="headerlink" title="任务背景"></a>任务背景</h3><p>为了学会CSS相关的内容，更为了把学到的东西用到实处，在实践中发现问题，再回过头来继续学习，螺旋上升，加快成长。从今天开始，所发的CSS相关的文章就是在记录自己学习使用CSS的时候走的每一步。</p><p>为了学习前端知识，在过去一段时间尝试完成的项目是一个管理构建项目和查看构建状态的网页工具，在该项目中使用了Material Design Lite组件用于解决页面布局和基本的元素样式。使这个该组建也是为了学习和了解Material Design这种扁平化设计理念。官方网页介绍的使用方法如下，是在html页面中导入CSS和JavaScript两者资源。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;./material.min.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./material.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://fonts.googleapis.com/icon?family=Material+Icons&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中material.min.css文件，是自己在<a href="https://getmdl.io/customize">https://getmdl.io/customize</a> 官方页面下，按照说明文档，自定义生成的，其使用的默认主色为indigo和强调色为pink。相关的使用方法与规范，请参见官方文档，本文不再做说明。</p><h3 id="所遇问题"><a href="#所遇问题" class="headerlink" title="所遇问题"></a>所遇问题</h3><p>有关Material Design Lite使用方法的内容中关于字体图标Material+Icons的链接的部分，由于大家熟知的原因，使用这个地址的CDN是不被推荐的，另一方面，因为该小型管理项目最终也是在内部网络使用的，再者初始版本中使用的是w3 css开源主题，Roboto免费字体与Font Awesome开源图表库，这些内容也希望能新的样式中继续使用。所以类似这样的外部链接就有悖项目现实情况。当然网络中也有此类资源本地使用方法的介绍，相关内容因与本文无关，不在赘述。</p><p>自己项目页面基本布局如下图所示，左侧为导航navibar部分，底部为页脚footer部分，右上为页眉header部分与右侧中部为主要内容显示部分。navibar会根据页面宽度自动显示与隐藏，这是Material Design Lite的组件特性。</p><p><img src="/2020/08/29/css-01-use-css-hide-content/css-01-03.png"></p><p>项目中header部分的代码如下，注意，这里使用的是jade模版。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; header part</span><br><span class="line">header(class&#x3D;&quot;mdl-layout__header&quot;)</span><br><span class="line">  div(class&#x3D;&quot;mdl-layout__header-row&quot;)</span><br><span class="line">    span(class&#x3D;&quot;mdl-layout-title&quot;). </span><br><span class="line">      #&#123;t(&#39;index.title&#39;, &#39;My header title&#39;)&#125;</span><br><span class="line">    div(class&#x3D;&quot;mdl-layout-spacer&quot;)</span><br></pre></td></tr></table></figure><p>由于是响应式的UI布局，当页面尺寸低于一个值时，左侧导航菜单就会被隐藏，同时按钮图标会显示在Header部分，估计很多朋友都见过类似的响应式布局，如此一来，就遇到了本文所述的关键问题。前文说道项目中没有引入Material+Icons的链接。也就无法显示正确显示这个按钮，具体情况如图所示：</p><p><img src="/2020/08/29/css-01-use-css-hide-content/css-01-02.png"></p><p>该按钮是由material.min.js自动生成的，当页面宽度缩小到一定值时，页眉header部分的代码变为如下所示，对比之间的代码可见在div(class=”mdl-layout__header-row”)上面出现了一个新的div块，内部为一个图标元素，该图标即为上图中的菜单按钮，由于定义图标的资源未被引入，所以图标未正确显示。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">&quot;mdl-layout__header is-casting-shadow&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">div</span> <span class="attr">aria-expanded</span>=<span class="string">&quot;false&quot;</span> <span class="attr">role</span>=<span class="string">&quot;button&quot;</span> <span class="attr">tabindex</span>=<span class="string">&quot;0&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mdl-layout__drawer-button&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;material-icons&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mdl-layout__header-row&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;mdl-layout-title&quot;</span>&gt;</span>My header title<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">   ...</span><br></pre></td></tr></table></figure><p>按钮图标的内容content是由常量MaterialLayout.prototype.Constant_中的MENU_ICON来定义的，可以通过查看未压缩的material.js文档找到如下的定义：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MaterialLayout.prototype.Constant_ = &#123;</span><br><span class="line">    MAX_WIDTH: <span class="string">&#x27;(max-width: 1024px)&#x27;</span>,</span><br><span class="line">    TAB_SCROLL_PIXELS: <span class="number">100</span>,</span><br><span class="line">    RESIZE_TIMEOUT: <span class="number">100</span>,</span><br><span class="line">    MENU_ICON: &#x27;&amp;#xE5D2;&#x27;, # 按钮图标的值</span><br><span class="line">    CHEVRON_LEFT: <span class="string">&#x27;chevron_left&#x27;</span>,</span><br><span class="line">    CHEVRON_RIGHT: <span class="string">&#x27;chevron_right&#x27;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>由于项目现实条件约束，不能引入Material+Icons的链接，又因为最后使用的是压缩后的min.js文件，文件可读性太差，再者修改代码就要理解机制，所以修改相应的js代码也不现实。那能不能通过CSS控制元素的样式隐藏这个图标内容呢？这就是今天文章的主要内容。使用CSS来隐藏页面文本元素的方法很简单，关键代码如下：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.hide-text</span> &#123;</span><br><span class="line">  <span class="attribute">text-indent</span>: <span class="number">100%</span>; </span><br><span class="line">  <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实验表明，该方法适用于现有项目，解决了所遇问题，再使用的时候我就好奇背后的原理。也想知道上述CSS代码是如何实现隐藏文本的呢？背后逻辑与思想究竟又是什么？（诸位前辈莫笑，毕竟本人CSS理论知识不足，大部分就是现学现用的）。结合上述方法和项目本身条件，由于隐藏该内容的目的是想使用新的图标，所以，最终相关的CSS代码如下，由于文本文档被隐藏，这时使用新的按钮图标&lt;i&gt;来替换原始按钮图标也会被隐藏，所以就需要以背景的方式显示新的图标，由于Font Awesome图标的颜色为黑色，为此我还修改了相应svg文件中的“<strong>fill</strong>”属性，使其图标颜色为白色。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.mdl-layout__header</span> <span class="selector-class">.mdl-layout__drawer-button</span> <span class="selector-class">.material-icons</span> &#123;</span><br><span class="line">  <span class="attribute">background-size</span>: <span class="number">30px</span> <span class="number">30px</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">url</span>(../fonts/bars-solid.svg) no-repeat;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">30px</span>;</span><br><span class="line">  <span class="attribute">color</span>: white;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin</span>: auto;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">0.3em</span>;</span><br><span class="line">  <span class="attribute">text-indent</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法被称为为Kellum方法，在方法溯源上我没有去深究。在搜索外文资料时，输入该关键字确实能够过滤结果。该方法主要思想就是在设置文中不换行white-space: nowrap的前提下，无限制地增加首行缩进text-indent: 100%从而将文本内容推出到页面的显示范围。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">overflow</span>: <span class="selector-tag">hidden</span></span><br></pre></td></tr></table></figure><p>该方法内overflow: hidden的使用算是非常聪明的地方，也说明了该方法设计者对CSS的经验之丰富。测试表明，如果在该方法中不使用overflow:hidden，那么如果文本中包含&lt;a&gt;元素的话，左侧的边界会被击穿，即文本中的第一个字符还是会被显示出来，感兴趣可以测试下下列代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span></span><br><span class="line">p &#123;</span><br><span class="line"><span class="css"><span class="selector-tag">text-indent</span><span class="selector-pseudo">:100</span>%;</span></span><br><span class="line">white-space: nowrap;</span><br><span class="line"><span class="css">//<span class="selector-tag">overflow</span><span class="selector-pseudo">:hidden</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>122345678abcdefghijklmnopqrstuvwxy</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&quot;</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>对该方法的讨论还远不止如此，有人建议使用“text-indent: 9999px”来替代“text-indent:100%”从而保证文本内容一定会被推出显示范围，而且如果使用9999px的话，可以不需结合overflow:hidden，此时文本的左侧边界不会被击穿。感兴趣的话，也可以结合上面的示例页面代码自己尝试一下。但也有一部分人对“9999px”在该方法中替代“100%”持反对态度，因为如果使用绝对值的话，浏览器就需要画出9999px边框，这样的话在性能方面就会有些损失。</p><p>也有人在使用时发现，该方法并不适用于html的&lt;button&gt;元素，使用此方法时，Button元素的右侧，即带有缩进的文本的左侧边界也会被击穿，此时情况与上文中文本包含&lt;a&gt;元素时一致，可以使用下方代码进行测试：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span></span><br><span class="line">button</span><br><span class="line">&#123;</span><br><span class="line">width: 120px;</span><br><span class="line">  height: 32px;</span><br><span class="line">  text-indent: 100%; </span><br><span class="line">  white-space: nowrap;</span><br><span class="line">  overflow: hidden</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span>&gt;</span>Button<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上述代码的结果如下，可以看出文本左侧边界被“<strong>击穿</strong>”了。</p><p><img src="/2020/08/29/css-01-use-css-hide-content/css-01-04.png"></p><p>为什么遇到&lt;button&gt;元素时，即便结合使用了overflow: hidden还是会出现页面被击穿的现象呢？这是因为一些类似于&lt;button&gt;的html元素本身自带内部填充intrinsic padding。重置button的padding属性就可以解决这一问题，当然将text-indent的值设置为大于100%，或使用前文中所说的9999px也能达到相似的结果。将下面的代码添加至上面的html代码中就能解决这个问题：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本人在CSS方面的知识并不丰富，一直在不断学习，文章中所述所写必然存在不足之处，望各位读者多多指正。如果哪位朋友有更好的解决方案，更希望能不吝赐教，大家一同学习，共同进步。欢迎关注我的微信公众号，留言讨论。</p><h3 id="参考目录"><a href="#参考目录" class="headerlink" title="参考目录"></a>参考目录</h3><p>Hide text using css: <a href="https://stackoverflow.com/questions/471510/hide-text-using-css">https://stackoverflow.com/questions/471510/hide-text-using-css</a></p><p>why the kellum method doesn’t work with button elements? : <a href="https://stackoverflow.com/questions/26992552/css-image-replacement-why-the-kellum-method-doesnt-work-with-button-elements">https://stackoverflow.com/questions/26992552/css-image-replacement-why-the-kellum-method-doesnt-work-with-button-elements</a></p><p>CSS white-space 属性: <a href="https://www.w3school.com.cn/cssref/pr_text_white-space.asp">https://www.w3school.com.cn/cssref/pr_text_white-space.asp</a></p><p>CSS text-indent 属性: <a href="https://www.w3school.com.cn/cssref/pr_text_text-indent.asp">https://www.w3school.com.cn/cssref/pr_text_text-indent.asp</a></p><p>Replacing the -9999px hack (new image replacement) : <a href="http://www.zeldman.com/2012/03/01/replacing-the-9999px-hack-new-image-replacement/">http://www.zeldman.com/2012/03/01/replacing-the-9999px-hack-new-image-replacement/</a></p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">    版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，    转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。</div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;摘要：究竟什么样的应用场景中才需要使用CSS来隐藏文本，为什么不直接修改HTML来删除想要隐藏的内容呢？使用CSS来隐藏页面文本，究竟是如何实现的？为什么要在项目中这么做，究竟为何？究竟什么是Kellum方法，该方法的使用范围与方法的局限性是？&lt;/p&gt;
&lt;p&gt;Abstract: What kind of application scenarios need to use CSS to hide text, why not directly modify the HTML to delete the content that you want to hide? How to use CSS to hide page text? Why do I do this in my own project? When is the Kellum method, the scope of use of the method and the limitations of the method?&lt;/p&gt;
    
    </summary>
    
    
      <category term="CSS 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/CSS-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="前端" scheme="https://zicowarn.github.io/tags/%E5%89%8D%E7%AB%AF/"/>
    
      <category term="CSS" scheme="https://zicowarn.github.io/tags/CSS/"/>
    
  </entry>
  
  <entry>
    <title>Python 杂记之 如何在实现子进程到父进程的环境变量更新</title>
    <link href="https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/"/>
    <id>https://zicowarn.github.io/2020/07/17/0808-ma-run-vcvars-set-devenv-ci/</id>
    <published>2020-07-17T09:11:08.000Z</published>
    <updated>2020-08-19T05:26:58.778Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>作者: Jim Wang 公众号:  <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><h3 id="任务背景"><a href="#任务背景" class="headerlink" title="任务背景"></a>任务背景</h3><p> 该任务是：当前所用的完成持续集成的脚本是Python语言实现的。在现有的脚本的核心内容是，使用subprocess.Popen方法来调用devenv命令，从而实现项目的清理clean和构建build。</p><p>今年伊始，项目中引用了.NET组件。一部分代码使用.NET完成了一个交互界面窗口。由于使用了.NET，编译的时候就需要对.NET的程序集进行强名称签名等一系列操作。例如，在导出类型库时会使用到的类型库导出工具Tlbexp.exe（一般在Visual Studio项目属性中**[生成]**部分中的“为COM互操作注册”被勾选时），以及程序集注册工具Regasm.exe等。此类工具的路径为：C:\Program Files (x86)\Microsoft Visual Studio 14.0\Common7\Tools\。理论上，当在命令行中使用devenv命令工具时，该工具就会自动查找上述的工具目录，并保证在编译解决方案的时候能够访问到这些工具。实践得知，devenv不能完成诸如此类环境变量的设置。进而在使用devenv时，因为项目配置中的所用到的工具因为无法找到会发生编译错误。</p><p>既然devenv不能实现理论结果，那就需要用到vsvars32.bat个batch文件了了。该文件是visual studio自带的文件，本质就是配置环境变量，工作目录的一些批处理命令。任务中遇到的问题是Tlbexp.exe无法找到，问题的本质是工具的路径不在系统环境中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VS140COMNTOOLS&#x3D;C:\Program Files (x86)\Microsoft Visual Studio 14.0\Common7\Tools\</span><br></pre></td></tr></table></figure><h3 id="初始代码"><a href="#初始代码" class="headerlink" title="初始代码"></a>初始代码</h3><p>话不多少，直接上代码，项目一开始我们使用的是如下的代码，代码的主要内容是使用subprocess模块下的Popen方法来调用cmd命令devenv完成代码的清除clean和构建build，部分代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略部分</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mCompile</span>(<span class="params">slnPath, compilArgs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;[summary]</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        slnPath ([type]): [description]</span></span><br><span class="line"><span class="string">        compilArgs ([type]): [description]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        RuntimeError: [description]</span></span><br><span class="line"><span class="string">        ValueError: [description]</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    compilerExe = <span class="string">&quot;C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//IDE//devenv&quot;</span></span><br><span class="line">    startupinfo = sp.STARTUPINFO()</span><br><span class="line">    startupinfo.dwFlags |= sp.STARTF_USESHOWWINDOW</span><br><span class="line"></span><br><span class="line">    logClean = <span class="string">&quot;clean.txt&quot;</span></span><br><span class="line">    stepClean = sp.Popen([compilerExe, <span class="string">&quot;/clean&quot;</span>, compilArgs, slnPath, <span class="string">&quot;/OUT&quot;</span>, logClean ], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">    stdoutdata, stderrdata = stepClean .communicate()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> stepClean.returncode != <span class="number">0</span>:</span><br><span class="line">        msg = <span class="string">&quot;Error: Failed to clean the solution &quot;</span> + slnPath</span><br><span class="line">        <span class="keyword">if</span> stdoutdata != <span class="literal">None</span>:</span><br><span class="line">            msg = msg + <span class="string">&quot;\nError Message: &quot;</span> + stdoutdata</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(msg)</span><br><span class="line">    </span><br><span class="line">    logBuild = <span class="string">&quot;build.txt&quot;</span></span><br><span class="line">    stepCompile = sp.Popen([compilerExe, <span class="string">&quot;/rebuild&quot;</span>, compilArgs, slnPath, <span class="string">&quot;/OUT&quot;</span>, logBuild], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">    stdoutdata, stderrdata = stepCompile.communicate()</span><br><span class="line">    <span class="keyword">if</span> stepCompile.returncode != <span class="number">0</span>:</span><br><span class="line">        msg = <span class="string">&quot;Error: Failed to compile the solution &quot;</span> + slnPath</span><br><span class="line">        <span class="keyword">if</span> stdoutdata != <span class="literal">None</span>:</span><br><span class="line">            msg = msg + <span class="string">&quot;\nError Message: &quot;</span> + stdoutdata</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(msg)</span><br></pre></td></tr></table></figure><p>上述代码中有STARTUPINFO相关内容，为了方便代码解释在此列出如下清单，清单中对每个结构体每个成员都通过注释的方式对成员的功能一一进行了解释：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">STARTUPINFO</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    DWORD cb;            <span class="comment">//包含STARTUPINFO结构中的字节数.如果Microsoft将来扩展该结构,它可用作版本控制手段.应用程序必须将cb初始化为sizeof ( STARTUPINFO )</span></span><br><span class="line">    PSTR lpReserved;      <span class="comment">//保留。必须初始化为N U L L</span></span><br><span class="line">    PSTR lpDesktop;    <span class="comment">//用于标识启动应用程序所在的桌面的名字。如果该桌面存在，新进程便与指定的桌面相关联。如果桌面不存在，便创建一个带有默认属性的桌面，并使用为新进程指定的名字。    如果lpDesktop是NULL（这是最常见的情况 ),那么该进程将与当前桌面相关联</span></span><br><span class="line">    PSTR lpTitle;    <span class="comment">//用于设定控制台窗口的名称。如果l p Ti t l e 是N U L L ，则可执行文件的名字将用作窗口名</span></span><br><span class="line">    DWORD dwX;       <span class="comment">//用于设定应用程序窗口在屏幕上应该放置的位置的x 和y 坐标（以像素为单位）。</span></span><br><span class="line">    DWORD dwY;       <span class="comment">//只有当子进程用CW_USEDEFAULT作为CreateWindow的x参数来创建它的第一个重叠窗口时,    才使用这两个坐标。若是创建控制台窗口的应用程序，这些成员用于指明控制台窗口的左上角</span></span><br><span class="line"></span><br><span class="line">    DWORD dwXSize;  <span class="comment">//用于设定应用程序窗口的宽度和长度（以像素为单位）只有dwYsize</span></span><br><span class="line">    DWORD dwYSize;  <span class="comment">// 当子进程将CW_USEDEFAULT 用作CreateWindow 的nWidth参数来创建它的第一个重叠窗口时，才使用这些值。若是创建控制台窗口的应用程序，这些成员将用于指明控制台窗口的宽度</span></span><br><span class="line">    DWORD dwXCountChars;  <span class="comment">//用于设定子应用程序的控制台窗口的宽度和高度（以字符为单位）</span></span><br><span class="line">    DWORD dwYCountChars;</span><br><span class="line">    DWORD dwFillAttribute;   <span class="comment">//用于设定子应用程序的控制台窗口使用的文本和背景颜色</span></span><br><span class="line">    DWORD dwFlags;           <span class="comment">//请参见下一段和表4 - 7 的说明</span></span><br><span class="line">    WORD wShowWindow;        <span class="comment">//用于设定如果子应用程序初次调用的ShowWindow 将SW_SHOWDEFAULT 作为    nCmdShow 参数传递时，该应用程序的第一个重叠窗口应该如何出现。本成员可以是通常用于ShowWindow 函数的任何一个SW_*标识符</span></span><br><span class="line">    WORD cbReserved2;        <span class="comment">//保留。必须被初始化为0</span></span><br><span class="line">    PBYTE lpReserved2;       <span class="comment">//保留。必须被初始化为N U L L</span></span><br><span class="line">    HANDLE hStdInput;        <span class="comment">//用于设定供控制台输入和输出用的缓存的句柄。按照默认设置，hStdInput 用于标识键盘缓存，hStdOutput 和hStdError用于标识控制台窗口的缓存</span></span><br><span class="line">    HANDLE hStdOutput;</span><br><span class="line">    HANDLE hStdError;</span><br><span class="line">&#125; STARTUPINFO, *LPSTARTUPINFO;</span><br></pre></td></tr></table></figure><p>在原始代码中使用上述结构体的<strong>dwFlags</strong>成员，该成员的值被设定为<strong>STARTF_USESHOWWINDOW</strong>，意指使用wShowWindow这个成员属性，其他相关值，请参阅下列清单。这样做的目的是，当需要隐藏窗口时，结合示例代码，仅需要在代码中添加startupinfo.wShowWindow = sp.SW_HIDE即可，但因devenv这样的命令不包含窗体，为了保持简约，所以就没有写入这些代码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">                      表4-7 dwFlags 使用标志及含义</span><br><span class="line">标志                                    含义</span><br><span class="line"></span><br><span class="line">STARTF_USESIZE                 &#x2F;&#x2F; 使用dwXSize 和dwYSize 成员</span><br><span class="line">STARTF_USESHOWWINDOW              &#x2F;&#x2F;使用wShowWindow 成员</span><br><span class="line">STARTF_USEPOSITION              &#x2F;&#x2F;使用dwX 和dwY 成员</span><br><span class="line">STARTF_USECOUNTCHARS                &#x2F;&#x2F;使用dwXCountChars 和dwYCount Chars 成员</span><br><span class="line">STARTF_USEFILLATTRIBUTE          &#x2F;&#x2F;使用dwFillAttribute 成员</span><br><span class="line">STARTF_USESTDHANDLES              &#x2F;&#x2F;使用hStdInput 、hStdOutput 和hStdError 成员</span><br><span class="line">STARTF_RUN_FULLSCREEN              &#x2F;&#x2F;强制在x86 计算机上运行的控制台应用程序以全屏幕方式启动运行</span><br></pre></td></tr></table></figure><h3 id="初步修改"><a href="#初步修改" class="headerlink" title="初步修改"></a>初步修改</h3><p>我们要解决的“工具Tlbexp.exe无法找到”这个问题，就需要运行vsvars32.bat这batch文件，完成系统环境变量的更新。理论上仅需要在mComple这个函数中，即clean步骤前再次使用subprocess模块下的Popen方法来运行vsvars32.bat即可，相应代码应为：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略部分</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mCompile</span>(<span class="params">slnPath, compilArgs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;[summary]</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        slnPath ([type]): [description]</span></span><br><span class="line"><span class="string">        compilArgs ([type]): [description]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        RuntimeError: [description]</span></span><br><span class="line"><span class="string">        ValueError: [description]</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    vsvarsbatch = <span class="string">&quot;C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//Tools//vsvars32.bat&quot;</span></span><br><span class="line">    compilerExe = <span class="string">&quot;C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//IDE//devenv&quot;</span></span><br><span class="line">    startupinfo = sp.STARTUPINFO()</span><br><span class="line">    startupinfo.dwFlags |= sp.STARTF_USESHOWWINDOW</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> vsvarsbatch != <span class="string">&quot;&quot;</span>:  <span class="comment">#  run vsvars32.bat of visual studio</span></span><br><span class="line">        cmd = [vsvarsbatch]</span><br><span class="line">        stepVSARS = sp.Popen(cmd, stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">        stdoutdata, stderrdata = stepVSARS.communicate()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> stepVSARS.returncode != <span class="number">0</span>:</span><br><span class="line">            msg = <span class="string">&quot;Error: Failed to raun vsvars32.bat&quot;</span></span><br><span class="line">            <span class="keyword">if</span> stdoutdata != <span class="literal">None</span>:</span><br><span class="line">                msg = msg + <span class="string">&quot;\nError Message: &quot;</span> + stdoutdata</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(msg)</span><br><span class="line">        <span class="keyword">if</span> stepVSARS.wait() != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(stderrdata.decode(<span class="string">&quot;mbcs&quot;</span>))</span><br><span class="line"></span><br><span class="line">    logClean = <span class="string">&quot;clean.txt&quot;</span></span><br><span class="line">    stepClean = sp.Popen([compilerExe, <span class="string">&quot;/clean&quot;</span>, compilArgs, slnPath, <span class="string">&quot;/OUT&quot;</span>, logClean ], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">    stdoutdata, stderrdata = stepClean .communicate()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 省略部分</span></span><br></pre></td></tr></table></figure><p>可现实是这样的代码达不到预期的结果，根本原因在于：<strong>程序中，进程之间的数据是隔离的，内存空间是不能共享的，进程之间要进行数据通信必须借助其他手段。子进程的结果父进程获取不到，其他的子进程当然也无法得到。</strong></p><p>还会有疑问的地方可能是，<strong>可我们的问题焦点是系统的环境变量？</strong>程序中，每个进程都有自己的运行环境，这样的环境只能从父进程被继承到子进程中，而不能反向地从子进程传递到父进程。实际上，默认情况下subprocess模块下的Popen方法一直践行着这种规则，Popen方法有env这个参数，该参数用于指定子进程的环境变量，如果 env = None，子进程的环境变量将从父进程中继承。也就是说，如果环境变量不加修改，那么子进程的环境变量与父进程一致，与其他子进程也一致。由于环境变量传递的单向性，我们上述的初始修改代码是不能完成任务要求的。</p><p>既然常规方法不行，那就使用一个<strong>非常规</strong>的方式，我们可以使用被称为“<strong>外带数据</strong>”（out-of-band）的进程通讯方式，将子进程中环境变量的变化传递给父进程。</p><h3 id="最终修改"><a href="#最终修改" class="headerlink" title="最终修改"></a>最终修改</h3><p>针对初始修改中依旧存在的问题，我们再次对代码进行了修改。最终版本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略部分</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mCompile</span>(<span class="params">slnPath, compilArgs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;[summary]</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        slnPath ([type]): [description]</span></span><br><span class="line"><span class="string">        compilArgs ([type]): [description]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        RuntimeError: [description]</span></span><br><span class="line"><span class="string">        ValueError: [description]</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    vvsvarsbatch = <span class="string">&quot;C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//Tools//vsvars32.bat&quot;</span></span><br><span class="line">    compilerExe = <span class="string">&quot;C://Porgamm Files (x86)//Microsoft Visual Studio XX.X/CommonX//IDE//devenv&quot;</span></span><br><span class="line">    startupinfo = sp.STARTUPINFO()</span><br><span class="line">    startupinfo.dwFlags |= sp.STARTF_USESHOWWINDOW</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> vsvarsbatch != <span class="string">&quot;&quot;</span>:  <span class="comment">#  run vsvars32.bat of visual studio</span></span><br><span class="line">        cmd = [vsvarsbatch, <span class="string">&#x27;&amp;&amp;&#x27;</span>, <span class="string">&#x27;set&#x27;</span>]</span><br><span class="line">        stepVSARS = sp.Popen(cmd, stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">        stdoutdata, stderrdata = stepVSARS.communicate()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> stepVSARS.returncode != <span class="number">0</span>:</span><br><span class="line">            msg = <span class="string">&quot;Error: Failed to raun vsvars32.bat&quot;</span></span><br><span class="line">            <span class="keyword">if</span> stdoutdata != <span class="literal">None</span>:</span><br><span class="line">                msg = msg + <span class="string">&quot;\nError Message: &quot;</span> + stdoutdata</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(msg)</span><br><span class="line">        <span class="keyword">if</span> stepVSARS.wait() != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(stderrdata.decode(<span class="string">&quot;mbcs&quot;</span>))</span><br><span class="line"></span><br><span class="line">        output = stdoutdata.decode(<span class="string">&quot;mbcs&quot;</span>).split(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">        dict_new_env = <span class="built_in">dict</span>((e[<span class="number">0</span>].upper(), e[<span class="number">1</span>]) <span class="keyword">for</span> e <span class="keyword">in</span> [p.rstrip().split(<span class="string">&quot;=&quot;</span>, <span class="number">1</span>) <span class="keyword">for</span> p <span class="keyword">in</span> output] <span class="keyword">if</span> <span class="built_in">len</span>(e) == <span class="number">2</span>)</span><br><span class="line">        os.environ.update(dict_new_env)</span><br><span class="line"></span><br><span class="line">    logClean = <span class="string">&quot;clean.txt&quot;</span></span><br><span class="line">    stepClean = sp.Popen([compilerExe, <span class="string">&quot;/clean&quot;</span>, compilArgs, slnPath, <span class="string">&quot;/OUT&quot;</span>, logClean ], stdout=sp.PIPE, stderr=sp.STDOUT, startupinfo=startupinfo)</span><br><span class="line">    stdoutdata, stderrdata = stepClean .communicate()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 省略部分</span></span><br></pre></td></tr></table></figure><p>在这次修改中，代码<strong>cmd = [vsvarsbatch]</strong> 变成了<strong>cmd = [vsvarsbatch, ‘&amp;&amp;’, ‘set’]**，因为vsvars32.bat脚本对环境变量的更新，是没有</strong>标准输出<strong>（stdout）的，即直接是看不到变化的，所以这里使用</strong>set<strong>，将子进程所有环境变量都打印到</strong>标准输出<strong>中，当</strong>组合命令**运行结束之后，在检查命令是否异常结束之后，通过stdoutdata获取set命令的标准输出，然后在将得到的标准输出转换为字典格式，再然后更新当前的环境变量，这样父进程中的环境变量得到了更新。之后代码中的子进程都会使用更新之后的环境变量，这样就达到了任务要求，解决了任务难题。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>个人认为，项目发生变化会带来新的问题，这并不意外。解决问题时，初始思考的不全面也是正常的，遇见问题认真分析仔细研究终究会找到解决问题的方法的。当然，解决一个问题的可以有很多不同的方法，上述方法也仅仅是一家之言，并非最优，若读者有别的思路也欢迎关注我的个人微信公众号，一起讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号:  &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;摘要：Python 是如何访问和控制系统的环境变量的，Python中的父进程与子进程间的环境变量关系是何？能不能在运行时修改环境变量？子进程中对环境变量修改能不能传递给对父进程？如果能，怎么样实现这样的变化？如何使用subprocess.Popen运行vcvars.bat，然后在持续集成时，完成devenv清理和创建的前期准备。&lt;/p&gt;
&lt;p&gt;Abstract: How does Python access and control the system‘s environment variables？ What is the relationship between the environment variables of the parent process and the child process in Python? Can environment variables be modified at runtime? Can the modification of environment variables in the child process be passed to the parent process? If so, how to achieve such a change? How to use subprocess.Popen to run vcvars.bat, and then complete the preliminary preparations for the &lt;strong&gt;Clean&lt;/strong&gt; and &lt;strong&gt;Build&lt;/strong&gt; of &lt;strong&gt;devenv&lt;/strong&gt; during &lt;strong&gt;CI&lt;/strong&gt;.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python 相关 - 8. Python 杂记" scheme="https://zicowarn.github.io/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/"/>
    
    
      <category term="Python" scheme="https://zicowarn.github.io/tags/Python/"/>
    
      <category term="杂记" scheme="https://zicowarn.github.io/tags/%E6%9D%82%E8%AE%B0/"/>
    
      <category term="系统变量" scheme="https://zicowarn.github.io/tags/%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F/"/>
    
      <category term="持续集成" scheme="https://zicowarn.github.io/tags/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"/>
    
  </entry>
  
  <entry>
    <title>Inno Setup 如何将.NET程序集（DLL）安装到GAC中</title>
    <link href="https://zicowarn.github.io/2020/07/13/inno-06-gacinstall/"/>
    <id>https://zicowarn.github.io/2020/07/13/inno-06-gacinstall/</id>
    <published>2020-07-13T10:11:08.000Z</published>
    <updated>2020-09-29T13:33:10.710Z</updated>
    
    <content type="html"><![CDATA[<!-- excerpt --><p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a> </p><h2 id="Inno-Setup-注册-Windows-中的COM程序集DLL"><a href="#Inno-Setup-注册-Windows-中的COM程序集DLL" class="headerlink" title="Inno Setup 注册 Windows 中的COM程序集DLL"></a>Inno Setup 注册 Windows 中的COM程序集DLL</h2><p>Inno Setup在设计程序安装包的时候，如果所需安装的文件中有DLL文件，而这些件又需要注册，一般情况下最容易想到且便于实施的，就是在**[Run]**段使用诸如下列的代码：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Filename: regsvr32; Parameters: &quot;/s &quot;</span><br><span class="line">&quot;&quot;&lt;FilePath&gt;\demo1.dll&quot;&quot;&quot;; WorkingDir: &#123;commonappdata&#125;; StatusMsg: Registering DLLs</span><br><span class="line"></span><br><span class="line">Filename: &#123;#DotNetRegistToolPath&#125;&#125;\regasm.exe; Parameters: &quot; &quot;&quot;&lt;FilePath&gt;\demo2.dll&quot;&quot; /codebase /verbose&quot;; WorkingDir: &quot;&#123;commonappdata&#125;&quot;; StatusMsg: Registering DLLs; Flags: 64bit runhidden waituntilterminated;</span><br></pre></td></tr></table></figure><p>代码中<strong>regsvr32</strong>和<strong>regasm.exe</strong>都是用来在Windows系统下注册DLL文件的，需要知道的是，不是所有的DLL都需要在Windwos系统中注册的，需要注册的只有COM（Compoment Object Modal，组件对象模型）组件。所谓的<strong>注册</strong>就是向注册表的相应位置写入一些数据，该数据一般包含GUID（Global Unique Identity）与DLL文件的绝对路径，且两者间一一对应。这里的GUID可以理解为COM对象的统一入口，应用在使用该COM组件的时候，就是在使用这个GUID，而不需要关注该DLL文件具体在哪。</p><p>注册COM组件是为了什么呢？COM的最大特点就是：<strong>复用</strong>。注册的核心目的就是为了代码复用，在Windows中，我们可以把DLL文件存放在一些公共位置（例如C：Windows\System32文件夹中）这样也可以实现相同的目的，但是这写公共位置的DLL可能由于加载机制的问题被先使用，就容易出问题，判断加载的是自己想要的DLL也比较困难，在此列出Windwos系统查找并加载DLL的顺序，如下：</p><blockquote><p>系统标准DLL查找顺序（非安全模式）：</p><ol><li>应用程序所在目录；</li><li>当前目录。GetCurrentDirectory返回的目录；</li><li>系统目录。<a href="http://msdn.microsoft.com/en-us/library/ms724373(v=vs.85).aspx"><strong>GetSystemDirectory</strong></a>返回的目录，通常是系统盘\Windows\System32；</li><li>16位系统目录。该项只是为了向前兼容的处理，可以不考虑；</li><li> Windows目录。<a href="http://msdn.microsoft.com/en-us/library/ms724454(v=vs.85).aspx"><strong>GetWindowsDirectory</strong></a>返回的目录，通常是系统盘\Windows；</li><li> 环境变量PATH中所有目录。</li></ol></blockquote><p><strong>Regsvr32</strong> 是用于注册COM组件的，具体的使用参数和注册机制和DLL内部的与注册相关的函数不在这里赘述。</p><p><strong>Regasm</strong>是.NET下注册COM组件的工具。因为Regsvr32不适用于注册.NET组件。可以理解为专为.NET设计的Regsvr32。</p><h2 id="全局程序集缓存GAC"><a href="#全局程序集缓存GAC" class="headerlink" title="全局程序集缓存GAC"></a>全局程序集缓存GAC</h2><p>GAC的全称是Global Assembly Cache，主要目的是存放一些公共的程序集。这样程序就可以从GAC中取得并使用程序集，而不需要将这些拷贝到应用程序的执行目录下面。换句话说，如果没有GAC的话，每个.NET的WinForm程序的目录下都有一份C:\WINDOWS\Microsoft.NET\Framework\<version>\System.Windows.Forms.dll的拷贝，这样既浪费存储空间也不利于升级和应用程序的版本控制。</version></p><p>在程序开发和测试阶段，可以使用.NET自带的工具gacutil.exe把程序集添加到GAC中和从GAC中删除出去，命令如下。在版本2.0的.NET中有一个名为Microsoft .NET Framework 2.0 Configuration的图形化界面GAC管理工具，也可以实现DLL在GAC中的安装与卸载，但该工具在之后的.NET版本中就不再存在。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gacutil /i &lt;path&gt;\sample.dll (参数 /i 是安装的意思 )</span><br><span class="line">gacutil /u sample.dll (参数 /u 是移除，不需要路径，仅DLL文件名即可 )</span><br></pre></td></tr></table></figure><p>需要注意的是，GAC中保存的都是强命名的程序集（Strong-named assemblies）。<strong>强命名</strong>的目的在于保持程序集的在系统中的唯一性。因为可能不同的公司会开发出具有相同名字的程序集，如果这样的程序集被复制到同一个目录内，最后一次安装的程序集会代替前面安装的，这就是著名的Windows “DLL Hell”问题。所以说，单单使用文件名，是不足以来区分程序集的，所以CLR（Common Language Runtime）就引入了一种新的程序集唯一标识机制，这就是所谓的强命名程序集。这样的程序集里会包含四个唯一标识：文件名（不带扩展名），版本号，语言文化信息（如果存在）和公有密钥，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">“MyType, Version&#x3D;1.0.0.0, Culture&#x3D;neutral, PublicKeyToken&#x3D;af5779ac332fc045”</span><br></pre></td></tr></table></figure><p>至于如何创建强命名的.NET程序集，在这儿就不再详细介绍了。想提示的是，.NET附带的有一名为sn.exe的工具。该工具可以对程序集进行签名，也可以查看已签名的程序集的公有密钥。</p><h2 id="Inno-Setup-安装强命名-NET程序集到GAC中"><a href="#Inno-Setup-安装强命名-NET程序集到GAC中" class="headerlink" title="Inno Setup 安装强命名.NET程序集到GAC中"></a>Inno Setup 安装强命名.NET程序集到GAC中</h2><p>Inno Setup 在程序安装过程中，可以使用类似在本文第一章节中介绍的添加一个**[Run]**字段的条目，通过使用gacutils工具，在程序安装完成后，在安装程序显示最终向导页面前，通过执行这个条目来实现强命名.NET程序集安装到GAC中。虽然这样可行，但在前面也说过，gacutils该工具在开发环境用起来还可以，如果到了生产环境，由于无法保证该工具在目标主机里也存在，所以这个方法失败风险很大。</p><p>另一个方法是使用名为<strong>gacinstall</strong>的标记（Flags），这样的标记常用在**[Files]**段里，需要注意的是Inno Setup在<a href="https://jrsoftware.org/files/is5.5-whatsnew.htm">5.3.0-beta (2009-04-22)</a>版和其以后的版本中才支持该标记，所以在使用标记时请检查Inno Setup的版本，以免出错。</p><p>使用该标记的时，可以在**[Files]<strong>添加如下条目内容。需要注意的是类似</strong>ignoreversion**标记的不应该在类似的条目中被使用，因为.NET的DLL应该是版本敏感的，不应该忽略版本的变化。</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">; NOTE: Don<span class="string">&#x27;t use &quot;Flags: ignoreversion&quot; on any shared system files</span></span><br><span class="line"><span class="string">Source: &quot;Demo.dll&quot;; DestDir: &quot;&#123;app&#125;&quot;; StrongAssemblyName: &quot;Demo, Version=7.0.3300.0, Culture=neutral, PublicKeyToken=B03F5F7F11D50A3A, ProcessorArchitecture=MSIL&quot;; Flags: &quot;gacinstall sharedfile uninsnosharedfileprompt&quot;</span></span><br></pre></td></tr></table></figure><p>StrongAssemblyName关键字后面的内容就是上文提到的强命名程序的四个唯一标识。<strong>sharefile</strong>标记用于更新相关注册表信息，切勿略去。<strong>uninsnosharedfileprompt</strong>标记是为了保证在卸载该共享文件时，如果其引用计数为零，则自动删除文件，而不需要询问用户。 该标记必须与<strong>sharefile</strong>标志结合使用才能生效。</p><h3 id="补充内容"><a href="#补充内容" class="headerlink" title="补充内容"></a>补充内容</h3><p>.NET 3.5 版本及之前版本 GAC 路径在： C:\windows\Assembly</p><p>.NET 4.0 版本及之后版本 GAC 路径在：C:\Windows\Microsoft.Net\version\</p><p>文章中介绍了很多背景知识，仅最后一部分是才是文章中心内容。这些背景知识是自己在完成该项任务的一开始具有的疑问，进而在茫茫文海中查阅，再收集整理成文的，这利于自己，也方便你我。如果你有问题或者不同的见解，欢迎关注我的微信公众号，然后留言讨论。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;摘要：Inno Setup 生成的安装包是如何在安装的过程中注册COM组件DLL文件的，.NET的DLL为什么需要注册？如何将.NET程序集安装到GAC中，这样做的目的又是什么？在这项任务的一开始，我也有类似的疑问，查找归纳后就有了这篇文章。&lt;/p&gt;
&lt;p&gt;Abstract: How does the installation package generated by Inno Setup register COM component DLL files during installation? What is the difference between .NET DLL and general DLL registration?&lt;/p&gt;
    
    </summary>
    
    
      <category term="Inno Setup 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/Inno-Setup-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="Inno Setup" scheme="https://zicowarn.github.io/tags/Inno-Setup/"/>
    
      <category term=".NET" scheme="https://zicowarn.github.io/tags/NET/"/>
    
      <category term="GAC" scheme="https://zicowarn.github.io/tags/GAC/"/>
    
      <category term="COM" scheme="https://zicowarn.github.io/tags/COM/"/>
    
  </entry>
  
  <entry>
    <title>Hexo 中特殊纯文本字符串引起异常</title>
    <link href="https://zicowarn.github.io/2020/02/25/hexo-01-code-raise-error/"/>
    <id>https://zicowarn.github.io/2020/02/25/hexo-01-code-raise-error/</id>
    <published>2020-02-25T00:11:08.000Z</published>
    <updated>2020-08-25T03:13:46.664Z</updated>
    
    <content type="html"><![CDATA[<p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><p>在转移自己的文章的时候发现了一个很有意思的事情，现在记录下来，咱们一起看看问题在哪。问题是这样的的，我之前的文章有如下文字</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExtractTemporaryFile(<span class="string">&#x27;&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure><p>如果上述字符以纯文本的形式，即非代码样式和引用样式存在于md文件中，如果这时尝试使用hexo s命令的话，就会有如下异常被抛出。</p><a id="more"></a><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">someone@somenode-Pro TestBlog % hexo s</span><br><span class="line">INFO  Start processing</span><br><span class="line">FATAL Something<span class="string">&#x27;s wrong. Maybe you can find the solution here: https://hexo.io/docs/troubleshooting.html</span></span><br><span class="line"><span class="string">Template render error: (unknown path)</span></span><br><span class="line"><span class="string">  Error: expected end of comment, got end of file</span></span><br><span class="line"><span class="string">    at Object._prettifyError (/Users/someone/workspace/TestBlog/node_modules/nunjucks/src/lib.js:36:11)</span></span><br><span class="line"><span class="string">    at Template.render (/Users/someone/workspace/TestBlog/node_modules/nunjucks/src/environment.js:536:21)</span></span><br><span class="line"><span class="string">    at Environment.renderString (/Users/someone/workspace/TestBlog/node_modules/nunjucks/src/environment.js:378:17)</span></span><br><span class="line"><span class="string">    at /Users/someone/workspace/TestBlog/node_modules/hexo/lib/extend/tag.js:120:48</span></span><br><span class="line"><span class="string">    at tryCatcher (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/util.js:16:23)</span></span><br><span class="line"><span class="string">    at Function.Promise.fromNode.Promise.fromCallback (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/promise.js:209:30)</span></span><br><span class="line"><span class="string">    at Tag.render (/Users/someone/workspace/TestBlog/node_modules/hexo/lib/extend/tag.js:120:18)</span></span><br><span class="line"><span class="string">    at Object.onRenderEnd (/Users/someone/workspace/TestBlog/node_modules/hexo/lib/hexo/post.js:291:22)</span></span><br><span class="line"><span class="string">    at /Users/someone/workspace/TestBlog/node_modules/hexo/lib/hexo/render.js:79:21</span></span><br><span class="line"><span class="string">    at tryCatcher (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/util.js:16:23)</span></span><br><span class="line"><span class="string">    at Promise._settlePromiseFromHandler (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/promise.js:547:31)</span></span><br><span class="line"><span class="string">    at Promise._settlePromise (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/promise.js:604:18)</span></span><br><span class="line"><span class="string">    at Promise._settlePromise0 (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/promise.js:649:10)</span></span><br><span class="line"><span class="string">    at Promise._settlePromises (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/promise.js:729:18)</span></span><br><span class="line"><span class="string">    at _drainQueueStep (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/async.js:93:12)</span></span><br><span class="line"><span class="string">    at _drainQueue (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/async.js:86:9)</span></span><br><span class="line"><span class="string">    at Async._drainQueues (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/async.js:102:5)</span></span><br><span class="line"><span class="string">    at Immediate.Async.drainQueues (/Users/someone/workspace/TestBlog/node_modules/bluebird/js/release/async.js:15:14)</span></span><br><span class="line"><span class="string">    at processImmediate (internal/timers.js:456:21)</span></span><br></pre></td></tr></table></figure><p>上述异常信息中，重点为Template render error: (unknown path)。应该是，Markdown文件在渲染成html时，<strong>ExtractTemporaryFile</strong>被视为代码了，而如果修改括号中的参数值为空，异常就不存在了，如下纯文本：</p><p>ExtractTemporaryFile(‘’);</p><p>确实非常有意思。我了如下的文本，也同样会抛出相同的异常。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">render(<span class="string">&#x27;&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>如果试一试一个随意的函数名称呢？比如hello这个作为函数的姓名，如下，一样会抛出异常。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello(<span class="string">&#x27;&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure><p>这样的话问题应该位于参数部分，即：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;#DotNetFrameWorkWebInstaller&#125;</span><br></pre></td></tr></table></figure><p>我也做了尝试，如果上述内容作为纯文本出现在Markdown文件内，则会抛出异常。那么如果换个变量名字呢？比如，newparams，即参数部分如下，一行会抛出异常。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;#newparams&#125;</span><br></pre></td></tr></table></figure><p>问题在于#这个符号，#后面跟着英文字符就会被理解成<strong>锚点</strong>了。该错误与圆括号有关，即Markdown文件中任何以：<strong>左圆括号 + #号 + 英文字符</strong> 形式存在的纯文本字符串都会引发上述异常（右侧圆括号可以不存在，例如，下列的字符若以纯文本存在就会引发异常：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;#dedee</span><br></pre></td></tr></table></figure><p>目前找到的解决方法为在#号前输入两个\ 反斜杠。但是渲染后，还会存在一个反斜杠，所以要额外对此进行说明。感兴趣关注微信公众号，一起讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在转移自己的文章的时候发现了一个很有意思的事情，现在记录下来，咱们一起看看问题在哪。问题是这样的的，我之前的文章有如下文字&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ExtractTemporaryFile(&lt;span class=&quot;string&quot;&gt;&amp;#x27;&amp;#123;#DotNetFrameWorkWebInstaller&amp;#125;&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;如果上述字符以纯文本的形式，即非代码样式和引用样式存在于md文件中，如果这时尝试使用hexo s命令的话，就会有如下异常被抛出。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Hexo 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/Hexo-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="Hexo" scheme="https://zicowarn.github.io/tags/Hexo/"/>
    
      <category term="异常处理" scheme="https://zicowarn.github.io/tags/%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Inno Setup 如何更换向导页面标题部分的背景</title>
    <link href="https://zicowarn.github.io/2019/08/10/inno-05-beautify-wizard-laben/"/>
    <id>https://zicowarn.github.io/2019/08/10/inno-05-beautify-wizard-laben/</id>
    <published>2019-08-10T00:11:08.000Z</published>
    <updated>2020-08-25T03:14:03.640Z</updated>
    
    <content type="html"><![CDATA[<p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><p>开发部领导新的要求，希望在产品安装包的向导页面做些美化。比如，显示公司的logo在向导页面的标题部分。</p><a id="more"></a><p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-label-part.png"></p><p>所谓标题即Label部分就是上图中红色方格标注的部分。 标注部分右侧是logo图标。</p><h3 id="1-初探，如何更换logo部分"><a href="#1-初探，如何更换logo部分" class="headerlink" title="1. 初探，如何更换logo部分"></a>1. 初探，如何更换logo部分</h3><p>Inno Setup开发文档里里有介绍如何更换Label中右侧的logo的方法。可以通过在**[Setup]**可以定义<code>WizardSmallImageFile</code>=”logo文件路径”来实现。但其要求的logo图片都是长宽相等的。长款不等的图片在显示会被拉伸，其效果惨不忍睹。该选项支持多重文件，即:你可以一次定义多个分辨率的logo文件，Inno Setup在安装的时候会根据系统当前的DPI设置，来自动选择合适分辨率的图片。多重定义的方法如下：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Example:</span><br><span class="line">WizardSmallImageFile=mysmallimage.bmp,mysmallimage2.bmp</span><br></pre></td></tr></table></figure><p>Logo文件分辨率要求如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">100%55x55</span><br><span class="line">125%64x68</span><br><span class="line">150%83x80</span><br><span class="line">175%92x97</span><br><span class="line">200%110x106</span><br><span class="line">225%119x123</span><br><span class="line">250%138x140</span><br></pre></td></tr></table></figure><p>图片被拉伸通常发生在以下两种情况，一、显示器的设置发生了变化。二、Inno Setup向导页面被设定未可缩放。向导页面的缩放可以通过<code>WizardSizePercen</code>和<code>WizardResizable</code>。<code>WizardSizePercent</code>的合法值为从100值150。该参数的目的是允许你在不改变文字大小的前提下等比例缩放所以的安装和卸载向导页面。150意思是缩放为默认大小的150%，即增到50%。这里<code>WizardResizable</code>的合法值为yes和no，而当<code>WizardStyle</code>（其合法值为classic和modern）被设置为modern的时候，就默认为<code>WizardResizable</code>的值为yes，也同时默认为<code>WizardSizePercen</code>为120%。具体解释可以查看Inno Setup的官方文档。</p><h3 id="2-深入，如何得到当前的显示器的DPI"><a href="#2-深入，如何得到当前的显示器的DPI" class="headerlink" title="2. 深入，如何得到当前的显示器的DPI"></a>2. 深入，如何得到当前的显示器的DPI</h3><p>上文说到，图片的拉伸除了与向导页面有关，与系统的显示设置也相关，那如何得到当前显示的DPI呢？在Win7之前的系统中，要得到当前显示器的DPI，在Inno Setup的**[Code]**部分可以使用<code>TGraphicsObject.PixelsPerInch</code> 这个属性得到当前系统显示器设定的DPI。TGraphicsObject 这里有个小例子，代码如下：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">CheckDPI</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  CurrentDPI, StandardDPI, MediumDPI, LargeDPI: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">&#123; Get the current DPI, 从向导页面的字体中得到当前的DPI &#125;</span> </span><br><span class="line">  CurrentDPI  := WizardForm.Font.PixelsPerInch;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">&#123; Store defaults determined from Windows DPI settings &#125;</span></span><br><span class="line">  StandardDPI := <span class="number">96</span>;  <span class="comment">&#123; 100% &#125;</span></span><br><span class="line">  MediumDPI   := <span class="number">120</span>; <span class="comment">&#123; 125% &#125;</span></span><br><span class="line">  LargeDPI    := <span class="number">144</span>; <span class="comment">&#123; 150% &#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (CurrentDPI &gt;= StandardDPI) <span class="keyword">and</span> (CurrentDPI &lt; MediumDPI) <span class="keyword">then</span> </span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; Execute some custom code for small to medium DPI &#125;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (CurrentDPI &gt;= MediumDPI) <span class="keyword">and</span> (CurrentDPI &lt; LargeDPI) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; Execute some custom code for medium to large DPI &#125;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (CurrentDPI &gt;= LargeDPI) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; Execute some custom code for large DPI or above &#125;</span></span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>从Inno Setup 的5.6的版本开始，在多重定义的时候，Inno Setup就会根据当前DPI自动选择图片大小。这个自动选择是如何实现的呢。 下面的代码就使用了<code>PixelsPerInch</code>这个属性，并尝试模拟了自动选择这部分功能。</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[Setup]</span><br><span class="line">; Use <span class="number">100</span>% images by <span class="keyword">default</span></span><br><span class="line">WizardImageFile=WizardImage <span class="number">100</span>.bmp</span><br><span class="line">WizardSmallImageFile=WizardSmallImage <span class="number">100</span>.bmp</span><br><span class="line"></span><br><span class="line">[Files]</span><br><span class="line">; Embed all other sizes <span class="keyword">to</span> the installer</span><br><span class="line">Source: &quot;WizardImage *.bmp&quot;; Excludes: &quot;* 100.bmp&quot;; Flags: dontcopy</span><br><span class="line">Source: &quot;WizardSmallImage *.bmp&quot;; Excludes: &quot;* 100.bmp&quot;; Flags: dontcopy</span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetScalingFactor</span>:</span> Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> WizardForm.Font.PixelsPerInch &gt;= <span class="number">192</span> <span class="keyword">then</span> Result := <span class="number">200</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> WizardForm.Font.PixelsPerInch &gt;= <span class="number">144</span> <span class="keyword">then</span> Result := <span class="number">150</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> WizardForm.Font.PixelsPerInch &gt;= <span class="number">120</span> <span class="keyword">then</span> Result := <span class="number">125</span></span><br><span class="line">    <span class="keyword">else</span> Result := <span class="number">100</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">LoadEmbededScaledBitmap</span><span class="params">(Image: TBitmapImage; NameBase: <span class="keyword">string</span>)</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  <span class="keyword">Name</span>: <span class="keyword">String</span>;</span><br><span class="line">  FileName: <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">Name</span> := Format(<span class="string">&#x27;%s %d.bmp&#x27;</span>, [NameBase, GetScalingFactor]);</span><br><span class="line">  ExtractTemporaryFile(<span class="keyword">Name</span>);</span><br><span class="line">  FileName := ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\&#x27;</span> + <span class="keyword">Name</span>);</span><br><span class="line">  Image.Bitmap.LoadFromFile(FileName);</span><br><span class="line">  DeleteFile(FileName);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">&#123; If using larger scaling, load the correct size of images &#125;</span></span><br><span class="line">  <span class="keyword">if</span> GetScalingFactor &gt; <span class="number">100</span> <span class="keyword">then</span> </span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    LoadEmbededScaledBitmap(WizardForm.WizardBitmapImage, <span class="string">&#x27;WizardImage&#x27;</span>);</span><br><span class="line">    LoadEmbededScaledBitmap(WizardForm.WizardBitmapImage2, <span class="string">&#x27;WizardImage&#x27;</span>);</span><br><span class="line">    LoadEmbededScaledBitmap(WizardForm.WizardSmallBitmapImage, <span class="string">&#x27;WizardSmallImage&#x27;</span>);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>那么有没有在不用重复定义，仅用一张图片然后根据当前的DPI来进行人为的缩放，也能达到良好的显示效果呢，当然有，方法如下：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">  CustomPage: TWizardPage;</span><br><span class="line">  BtnImage: TBitmapImage;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  CustomPage := CreateCustomPage(wpLicense, <span class="string">&#x27;Heading&#x27;</span>, <span class="string">&#x27;Sub heading.&#x27;</span>);</span><br><span class="line">  ExtractTemporaryFile(<span class="string">&#x27;image.bmp&#x27;</span>);</span><br><span class="line">  BtnImage := TBitmapImage.Create(WizardForm); <span class="comment">//在当前页面即wpLicense页面创建一个Image按钮。</span></span><br><span class="line">  <span class="keyword">with</span> BtnImage <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      Parent := CustomPage.Surface;</span><br><span class="line">      Bitmap.LoadFromFile(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;&#x27;</span>)+<span class="string">&#x27;\image.bmp&#x27;</span>);</span><br><span class="line">      AutoSize := True;</span><br><span class="line">      AutoSize := False;  <span class="comment">// 缩放之前 关系BtnImage的自由大小属性</span></span><br><span class="line">      Height := ScaleX(Height); <span class="comment">// 然后根据当前BtnImage的大小进行缩放</span></span><br><span class="line">      Width := ScaleY(Width);</span><br><span class="line">      Stretch := True;</span><br><span class="line">      Left := ScaleX(<span class="number">90</span>);</span><br><span class="line">      Top := WizardForm.SelectTasksPage.Top + WizardForm.SelectTasksPage.Height -</span><br><span class="line">             Height - ScaleY(<span class="number">8</span>);</span><br><span class="line">      Cursor := crHand;</span><br><span class="line">      OnClick := @ImageOnClick;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><h3 id="3-进阶，Win8之后新系统得到当前的显示器的DPI"><a href="#3-进阶，Win8之后新系统得到当前的显示器的DPI" class="headerlink" title="3. 进阶，Win8之后新系统得到当前的显示器的DPI"></a>3. 进阶，Win8之后新系统得到当前的显示器的DPI</h3><p>由于Windows 8.1之后的系统中，用户可以调整每个监视器的DPI缩放比例，并且Font.PixelsPerInch始终为主监视器返回DPI值，因此<strong>第2节</strong>中的方法就不在适用新的系统了。如果在多显示多DPI的复杂环境中，<strong>第2节</strong>中的方法表现的也不尽如人意。某些时候，可以监听WM_DPICHANGED事件，然后手动并使窗口适应变化的DPI（但此更改可以只是将窗口移动到具有不同DPI设置的监视器）。而 要获取某个窗口的DPI，就需要考虑别的解决方案了。我在网上找到了相关的介绍，但是我当前的项目中不需要这些，也就没对代码进行测试。感兴趣的朋友可以自己尝试一下，代码如下：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="keyword">const</span></span><br><span class="line">  S_OK = <span class="number">$00000000</span>;</span><br><span class="line">  LOGPIXELSY = <span class="number">90</span>;</span><br><span class="line">  MONITOR_DEFAULTTONULL = <span class="number">$00000000</span>;</span><br><span class="line">  MONITOR_DEFAULTTOPRIMARY = <span class="number">$00000001</span>;</span><br><span class="line">  MONITOR_DEFAULTTONEAREST = <span class="number">$00000002</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span></span><br><span class="line">  HDC = THandle;</span><br><span class="line">  HMONITOR = THandle;</span><br><span class="line">  MONITOR_DPI_TYPE = (</span><br><span class="line">    MDT_EFFECTIVE_DPI,</span><br><span class="line">    MDT_ANGULAR_DPI,</span><br><span class="line">    MDT_RAW_DPI</span><br><span class="line">  );</span><br><span class="line"><span class="keyword">const</span></span><br><span class="line">  MDT_DEFAULT = MDT_EFFECTIVE_DPI;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetDC</span><span class="params">(hWnd: HWND)</span>:</span> HDC;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">&#x27;GetDC@user32.dll stdcall&#x27;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReleaseDC</span><span class="params">(hWnd: HWND; hDC: HDC)</span>:</span> Integer;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">&#x27;ReleaseDC@user32.dll stdcall&#x27;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetDeviceCaps</span><span class="params">(hdc: HDC; <span class="keyword">index</span>: Integer)</span>:</span> Integer;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">&#x27;GetDeviceCaps@gdi32.dll stdcall&#x27;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MonitorFromWindow</span><span class="params">(hwnd: HWND; dwFlags: DWORD)</span>:</span> HMONITOR;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">&#x27;MonitorFromWindow@user32.dll stdcall&#x27;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetDpiForMonitor</span><span class="params">(hmonitor: HMONITOR; dpiType: MONITOR_DPI_TYPE;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">out</span> dpiX: UINT; <span class="keyword">out</span> dpiY: UINT)</span>:</span> HRESULT;</span><br><span class="line">  <span class="keyword">external</span> <span class="string">&#x27;GetDpiForMonitor@shcore.dll stdcall delayload&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsWindows81OrLater</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := GetWindowsVersion &gt;= <span class="number">$06030000</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetPrimaryMonitorDPI</span>:</span> Integer;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  DC: HDC;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// no need for try..finally block here; just get the desktop DC handle,</span></span><br><span class="line">  <span class="comment">// get the DPI and release the obtained handle</span></span><br><span class="line">  DC := GetDC(<span class="number">0</span>);</span><br><span class="line">  Result := GetDeviceCaps(DC, LOGPIXELSY);</span><br><span class="line">  ReleaseDC(<span class="number">0</span>, DC);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetWindowMonitorDPI</span><span class="params">(Handle: HWND)</span>:</span> Integer;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  HorzDPI: UINT;</span><br><span class="line">  VertDPI: UINT;</span><br><span class="line">  Monitor: HMONITOR;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// if we&#x27;re not on at least Windows 8.1, then return the primary monitor</span></span><br><span class="line">  <span class="comment">// DPI since earlier systems did not allow per monitor DPI settings</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> IsWindows81OrLater <span class="keyword">then</span></span><br><span class="line">    Result := GetPrimaryMonitorDPI</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  <span class="comment">// otherwise determine which monitor the given window intersects and try</span></span><br><span class="line">  <span class="comment">// to get DPI settings of the found monitor (if any; check MSDN docs for</span></span><br><span class="line">  <span class="comment">// the explanation and other options how to find the nearest monitor)</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// try to get the monitor which the window intersects</span></span><br><span class="line">    Monitor := MonitorFromWindow(Handle, MONITOR_DEFAULTTONULL);</span><br><span class="line">    <span class="comment">// if there&#x27;s any, then...</span></span><br><span class="line">    <span class="keyword">if</span> Monitor &lt;&gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      <span class="comment">// try to get DPI for that monitor; if it succeeds, return the value,</span></span><br><span class="line">      <span class="comment">// raise an exception otherwise (for details check the MSDN docs)</span></span><br><span class="line">      <span class="keyword">if</span> GetDpiForMonitor(Monitor, MDT_DEFAULT, HorzDPI, VertDPI) = S_OK <span class="keyword">then</span></span><br><span class="line">        Result := VertDPI</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        RaiseException(<span class="string">&#x27;GetDpiForMonitor function call failed!&#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      RaiseException(<span class="string">&#x27;The given window does not intersect any monitor!&#x27;</span>);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>这是Windows SDK中介绍的方法，整个设计相对来说比较复杂。简单来说，将上述代码加入你的项目中，当你需要显示器的DPI的时候就调用<code>GetWindowMonitorDPI</code>函数，然后根据DPI结合<strong>第2节</strong>中的方法来缩放或者选择你要显示的图片。</p><h3 id="4-回到项目，更换向导页面标题部分的背景"><a href="#4-回到项目，更换向导页面标题部分的背景" class="headerlink" title="4. 回到项目，更换向导页面标题部分的背景"></a>4. 回到项目，更换向导页面标题部分的背景</h3><p>上述的内容，也是我再寻找解决新需求的过程中，搜集和整理的部分内容，记录下来也是为了以后需要的时候知道应该向那个方向努力。我告诉开发主管的是，我个人不建议将我们安装应用程序的向导页面设置为可缩放，因为这样需要做出的改变特别多，而且当前的大小也能满足使用需求。但美化工作不能少，第一步的任务核心就是页面简介背景部分，代码如下：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[Files]</span><br><span class="line">Source: &quot;Logo-header.bmp&quot;; Flags: dontcopy</span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span><span class="params">()</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  BitmapImage: TBitmapImage;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  ExtractTemporaryFile(<span class="string">&#x27;Logo-header.bmp&#x27;</span>);</span><br><span class="line">  BitmapImage := TBitmapImage.Create(WizardForm);</span><br><span class="line">  BitmapImage.Parent := WizardForm.MainPanel;</span><br><span class="line">  BitmapImage.Width := WizardForm.MainPanel.Width;</span><br><span class="line">  BitmapImage.Height := WizardForm.MainPanel.Height;</span><br><span class="line">  BitmapImage.Stretch := True;</span><br><span class="line">  BitmapImage.AutoSize := False;</span><br><span class="line">  BitmapImage.Bitmap.LoadFromFile(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\Logo-header.bmp&#x27;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 禁用 原始页面的小图标</span></span><br><span class="line">  WizardForm.WizardSmallBitmapImage.Visible := False;</span><br><span class="line">  <span class="comment">// 启用 页面简介标题</span></span><br><span class="line">  WizardForm.PageDescriptionLabel.Visible := True;</span><br><span class="line">  <span class="comment">// 启用 页面名称标题</span></span><br><span class="line">  WizardForm.PageNameLabel.Visible := True;</span><br><span class="line">  <span class="comment">// 限定页面简介标题宽度</span></span><br><span class="line">  WizardForm.PageDescriptionLabel.Width :=</span><br><span class="line">    WizardForm.PageDescriptionLabel.Width - ScaleX(<span class="number">120</span>);</span><br><span class="line">  <span class="comment">// 限定页面名称标题宽度</span></span><br><span class="line">  WizardForm.PageNameLabel.Width :=</span><br><span class="line">    WizardForm.PageNameLabel.Width - ScaleX(<span class="number">120</span>)</span><br><span class="line"> <span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>上述代码的核心思想就是，准备一张图片，该图片并不会被拷贝在目标文件夹中，在页面初始的时候，设定页面标题简述部分的背景，由于原始页面小logo被禁用，就需要缩进标题名称和简介文本的宽度，防止其覆盖图片的部分内容。</p><p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-welcome-part.png" alt="image-20200220170839898"></p><p>任务第二部分内容，就是更改欢迎页面的背景图片，即上图中红色部分框选的地方。首先在**[Setup]<strong>中定义属性为<a href="http://www.jrsoftware.org/ishelp/index.php?topic=setup_disablewelcomepage"><code>DisableWelcomePage=no</code></a>，意指启用欢迎页面。 然后在</strong>[Setup]<strong>部分定义<code>WizardBitmapImage</code>属性即可。结束页面（下图）与开始页面相似，只需在</strong>[Setup]**部分定义<code>WizardBitmapImage2</code> 属性即可。</p><p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-finish-part.png" alt="image-20200220170935862"></p><p>需要说明的是，如果属性<code>WizardBitmapImage2</code>为被定义，而属性<code>WizardBitmapImage</code>被定义，则结束页面会选择<code>WizardBitmapImage</code>中定义的图片作为上图中红色部分圈选的背景图片。</p><h3 id="5-扩展，欢迎页面和结束页面整页照片"><a href="#5-扩展，欢迎页面和结束页面整页照片" class="headerlink" title="5. 扩展，欢迎页面和结束页面整页照片"></a>5. 扩展，欢迎页面和结束页面整页照片</h3><p>我们在<strong>第4节</strong>部分，了解了如何在使用Inno Setup的属性设定，更改欢迎和结束页面的左侧背景图片，那么有没有一种可能，即省去这两个页面的文字（通常需要考虑翻译的问题），直接使用一张图片作为整个页面的背景呢？有，本节我们就探索一下。中心思想为四部：</p><ul><li>在各自的父页面上拉伸“ WizardBitmapImage”（欢迎）和“ WizardBitmapImage2”（完成），因为这两个页面都有图片部分，就不需要再初始化TBitmapImage了。</li><li>隐藏其它内容，例如 标题和段落.</li><li>确保安装程序永远不需要重新启动计算机，否则会在结束图片上会显示上重新启动提示。</li><li>请确保在**[Run]**部分中没有任何<code>postinstall</code>条目。否则结束页面上也会显示提示信息。</li></ul><p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-finish-part-full.png" alt="image-20200220171021313"></p><p>实现这部分的代码如下：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[Setup]</span><br><span class="line">DisableWelcomePage=no</span><br><span class="line">WizardImageFile=Demo.bmp  <span class="comment">// 如果WizardImageFile2 没定义则结束页面也使用该图片</span></span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span><span class="params">()</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// 欢迎页面</span></span><br><span class="line">  <span class="comment">// 隐藏 部分内容</span></span><br><span class="line">  WizardForm.WelcomeLabel1.Visible := False;</span><br><span class="line">  WizardForm.WelcomeLabel2.Visible := False;</span><br><span class="line">  <span class="comment">// 拉伸页面宽度</span></span><br><span class="line">  WizardForm.WizardBitmapImage.Width := WizardForm.WizardBitmapImage.Parent.Width;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 结束页面</span></span><br><span class="line">  <span class="comment">// 隐藏 部分内容</span></span><br><span class="line">  WizardForm.FinishedLabel.Visible := False;</span><br><span class="line">  WizardForm.FinishedHeadingLabel.Visible := False;</span><br><span class="line">  <span class="comment">// 拉伸页面宽度</span></span><br><span class="line">  WizardForm.WizardBitmapImage2.Width := WizardForm.WizardBitmapImage2.Parent.Width;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><h3 id="6-扩展2，在向导页脚左侧显示版本号"><a href="#6-扩展2，在向导页脚左侧显示版本号" class="headerlink" title="6. 扩展2，在向导页脚左侧显示版本号"></a>6. 扩展2，在向导页脚左侧显示版本号</h3><p>需要的显示结果如下图所示：</p><p><img src="/2019/08/10/inno-05-beautify-wizard-laben/inno-bottom-left-part.png" alt="image-20200221093833941"></p><p>代码如下：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span><span class="params">()</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  VersionLabel: TNewStaticText;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// 定义一个静态文本实例</span></span><br><span class="line">  VersionLabel := TNewStaticText.Create(WizardForm);</span><br><span class="line">  <span class="comment">// 从Setup部分的设定中获取版本号</span></span><br><span class="line">  VersionLabel.Caption := Format(<span class="string">&#x27;Version: %s&#x27;</span>, [<span class="string">&#x27;&#123;#SetupSetting(&quot;AppVersion&quot;)&#125;&#x27;</span>]);</span><br><span class="line">  <span class="comment">// 所有页面有效</span></span><br><span class="line">  VersionLabel.Parent := WizardForm;</span><br><span class="line">  <span class="comment">// 左侧位置</span></span><br><span class="line">  VersionLabel.Left := ScaleX(<span class="number">16</span>);</span><br><span class="line">  <span class="comment">// 保证 文本与按钮的 在水平方向 中心对齐</span></span><br><span class="line">  VersionLabel.Top :=</span><br><span class="line">    WizardForm.BackButton.Top +</span><br><span class="line">    (WizardForm.BackButton.Height <span class="keyword">div</span> <span class="number">2</span>) -</span><br><span class="line">    (VersionLabel.Height <span class="keyword">div</span> <span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>对齐的方式，以按钮的左上位置为基点，加上按钮高度与文本高度之差即可。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;开发部领导新的要求，希望在产品安装包的向导页面做些美化。比如，显示公司的logo在向导页面的标题部分。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Inno Setup 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/Inno-Setup-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="Inno Setup" scheme="https://zicowarn.github.io/tags/Inno-Setup/"/>
    
  </entry>
  
  <entry>
    <title>Inno Setup Windows 注册表关键字HKEY\_CLASSES\_ROOT相关内容</title>
    <link href="https://zicowarn.github.io/2019/07/10/inno-04-registry-hcr/"/>
    <id>https://zicowarn.github.io/2019/07/10/inno-04-registry-hcr/</id>
    <published>2019-07-10T00:11:08.000Z</published>
    <updated>2020-08-25T03:13:03.272Z</updated>
    
    <content type="html"><![CDATA[<p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><h2 id="Windows-注册表"><a href="#Windows-注册表" class="headerlink" title="Windows 注册表"></a>Windows 注册表</h2><p>HKEY_CLASSES_ROOT在此关键字之下，可以看见有一个CLSID关键字。在CLSID关键字之下列有系统中安装的所有组件的CLSID。注册表CLSID是一个具有如下格式的串：00000010-0000-0010-8000-00AA00D2EA4</p><a id="more"></a><p>HKEY_CLASSES_ROOT的开头，列出了将是各种应用程序所注册的文件扩展名。在扩展名之后，可以看到许多其它的名字。此类名字大多数被称作是ProgID，表示是程序员定义的标识符。某些名称表示的不是ProgID而实一些特殊的关键字。</p><p>如：</p><ul><li>CLSID</li><li>AppID，此关键字下的子关键字的作用是将某个APPID（应用程序的ID）映射成某个远程服务器名称。分式COM（DCOM）将用到此关键字。</li><li>组件类别，注册表的这一分支可以将CATID（组件类别ID）映射成某个特定的组件类别。</li><li>Interface，此关键字将用于将IID映射成某个接口相关的信息。这些信息主要用于在跨进程边界使用接口的情况。</li><li>Licenses，保存的是授权使用COM组件的一些认可信息。</li><li>TypeLib，类型库关键字保存的是关于接口成员函数所用的参数的信息。另外还有一些信息。此关键字可以将一个LIBID映射成存储类型库的文件名称。</li></ul><h3 id="ProgID"><a href="#ProgID" class="headerlink" title="ProgID"></a>ProgID</h3><p>所谓ProgID指的是程序员给某个CLSID指定的一个程序员易记的名称。ProgID命名规则为：..，如下图：</p><p>如WPDSp.WPDServiceProvider是版本无关ProgID，根据其值可在CLSID下找到相应键，进而找到相应信息，如组件最新版本信息。</p><p>WPDSp.WPDServiceProvider.1是版本相关ProgID，根据其CLSID值可以找到该版本组件的信息。</p><h3 id="ProgID注册表格式"><a href="#ProgID注册表格式" class="headerlink" title="ProgID注册表格式"></a>ProgID注册表格式</h3><p>ProgID及与版本无关的ProgID被列在组件CLSID下面。</p><p>ProgID的主要作用是获取相应的CLSID。在每一个CLSID项中查找查个ProgID将非常低效的。因此在其下面也将直接列出ProgID。由于ProgID不是针对最终用户而定义的，因此ProgID关键字的缺省值为用户易记的名称。在之下有一个名为CLSID的关键字，其缺省值为组件的CLSID。如下图所示：</p><p>与版本好无关的ProgID也直接被列在HKEY_CLASSES_ROOT下面。它们还有另外一个关键字CurVer，其缺省值为组件当前版本的ProgID，如下图：</p><h3 id="ProgID和CLSID的转换"><a href="#ProgID和CLSID的转换" class="headerlink" title="ProgID和CLSID的转换"></a>ProgID和CLSID的转换</h3><ul><li>CLSIDFromProgID</li><li>ProgIDFromCLSID</li></ul><h3 id="组件的自注册"><a href="#组件的自注册" class="headerlink" title="组件的自注册"></a>组件的自注册</h3><p>为把组件注册到注册表，在DLL中一定要输出如下两个函数：</p><p>STDAPI DllRegisterServer(); //注册</p><p>STDAPI DllUnregisterServer(); //反注册</p><p>我们使用Regsvr32.exe注册某个组件或者反注册某个组件时，其实就是调用这两个函数的过程。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Windows-注册表&quot;&gt;&lt;a href=&quot;#Windows-注册表&quot; class=&quot;headerlink&quot; title=&quot;Windows 注册表&quot;&gt;&lt;/a&gt;Windows 注册表&lt;/h2&gt;&lt;p&gt;HKEY_CLASSES_ROOT在此关键字之下，可以看见有一个CLSID关键字。在CLSID关键字之下列有系统中安装的所有组件的CLSID。注册表CLSID是一个具有如下格式的串：00000010-0000-0010-8000-00AA00D2EA4&lt;/p&gt;
    
    </summary>
    
    
      <category term="Inno Setup 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/Inno-Setup-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="Inno Setup" scheme="https://zicowarn.github.io/tags/Inno-Setup/"/>
    
      <category term="注册表" scheme="https://zicowarn.github.io/tags/%E6%B3%A8%E5%86%8C%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>Inno Setup 检查网络连接的Pascal代码</title>
    <link href="https://zicowarn.github.io/2019/07/05/inno-03-check-network-state/"/>
    <id>https://zicowarn.github.io/2019/07/05/inno-03-check-network-state/</id>
    <published>2019-07-05T00:11:08.000Z</published>
    <updated>2020-08-25T03:13:10.229Z</updated>
    
    <content type="html"><![CDATA[<p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><h2 id="InnoSetup-检查网络连接"><a href="#InnoSetup-检查网络连接" class="headerlink" title="InnoSetup 检查网络连接"></a>InnoSetup 检查网络连接</h2><h3 id="1-循环检查网络连接直至连接成共，代码如下："><a href="#1-循环检查网络连接直至连接成共，代码如下：" class="headerlink" title="1. 循环检查网络连接直至连接成共，代码如下："></a>1. 循环检查网络连接直至连接成共，代码如下：</h3><a id="more"></a><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">function IsNetWorkActivatedRepeated: boolean;</span><br><span class="line">var</span><br><span class="line">  WinHttpReq: Variant;</span><br><span class="line">  Connected: Boolean;</span><br><span class="line">begin</span><br><span class="line">  Connected := False;</span><br><span class="line">  repeat</span><br><span class="line">    Log(&#x27;Checking connection to the server&#x27;);</span><br><span class="line">    try</span><br><span class="line">      WinHttpReq := CreateOleObject(&#x27;WinHttp.WinHttpRequest.5.1&#x27;);</span><br><span class="line">      &#123; Use your real server host name &#125;</span><br><span class="line">      WinHttpReq.Open(&#x27;GET&#x27;, &#x27;https://www.camtek.de/&#x27;, False);</span><br><span class="line">      WinHttpReq.Send(&#x27;&#x27;);</span><br><span class="line">      Log(&#x27;Connected to the server; status: &#x27; + IntToStr(WinHttpReq.Status) + &#x27; &#x27; +</span><br><span class="line">          WinHttpReq.StatusText);</span><br><span class="line">      Connected := True;</span><br><span class="line">    except</span><br><span class="line">      Log(&#x27;Error connecting to the server: &#x27; + GetExceptionMessage);</span><br><span class="line">      if WizardSilent then</span><br><span class="line">      begin</span><br><span class="line">        Log(&#x27;Connection to the server is not available, aborting silent installation&#x27;);</span><br><span class="line">        Result := False;</span><br><span class="line">        Exit;</span><br><span class="line">      end</span><br><span class="line">        else</span><br><span class="line">      if MsgBox(&#x27;Cannot reach server. Please check your Internet connection.&#x27;,</span><br><span class="line">                mbError, MB_RETRYCANCEL) = IDRETRY then</span><br><span class="line">      begin</span><br><span class="line">        Log(&#x27;Retrying&#x27;);</span><br><span class="line">      end</span><br><span class="line">        else</span><br><span class="line">      begin</span><br><span class="line">        Log(&#x27;Aborting&#x27;);</span><br><span class="line">        Result := False;</span><br><span class="line">        Exit;</span><br><span class="line">      end;</span><br><span class="line">    end;</span><br><span class="line">  until Connected;</span><br><span class="line"></span><br><span class="line">  Result := True;</span><br><span class="line">end;</span><br></pre></td></tr></table></figure><h3 id="2-有限次数检测网络，代码如下："><a href="#2-有限次数检测网络，代码如下：" class="headerlink" title="2. 有限次数检测网络，代码如下："></a>2. 有限次数检测网络，代码如下：</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">function IsNetWorkActivatedTried: boolean;</span><br><span class="line">var</span><br><span class="line">  WinHttpReq: Variant;</span><br><span class="line">  Connected: Boolean;</span><br><span class="line">  iTriedTime: Integer;</span><br><span class="line">begin</span><br><span class="line">  Connected := False;</span><br><span class="line">  iTriedTime := 0;</span><br><span class="line">  repeat</span><br><span class="line">    iTriedTime := iTriedTime + 1;</span><br><span class="line">    Log(&#x27;Checking connection to the server, try &#x27; +  + IntToStr(iTriedTime) + &#x27; time.&#x27;);</span><br><span class="line">    try</span><br><span class="line"></span><br><span class="line">      WinHttpReq := CreateOleObject(&#x27;WinHttp.WinHttpRequest.5.1&#x27;);</span><br><span class="line">      WinHttpReq.SetTimeouts(&#x27;3000&#x27;, &#x27;3000&#x27;, &#x27;3000&#x27;, &#x27;3000&#x27;);</span><br><span class="line">      // Use your real server host name </span><br><span class="line">      WinHttpReq.Open(&#x27;GET&#x27;, &#x27;https://www.goolge.de/&#x27;, False);</span><br><span class="line">      WinHttpReq.Send(&#x27;&#x27;);</span><br><span class="line">      Log(&#x27;Connected to the server; status: &#x27; + IntToStr(WinHttpReq.Status) + &#x27; &#x27; +</span><br><span class="line">          WinHttpReq.StatusText);</span><br><span class="line">      Connected := True;</span><br><span class="line">    except</span><br><span class="line">      Log(&#x27;Error connecting to the server, msg: &#x27; + GetExceptionMessage + &#x27;try again! &#x27;);</span><br><span class="line">    end;</span><br><span class="line">  until (iTriedTime = 3) or (Connected = True) ;</span><br><span class="line">  Result := Connected;</span><br><span class="line">end;</span><br></pre></td></tr></table></figure><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;InnoSetup-检查网络连接&quot;&gt;&lt;a href=&quot;#InnoSetup-检查网络连接&quot; class=&quot;headerlink&quot; title=&quot;InnoSetup 检查网络连接&quot;&gt;&lt;/a&gt;InnoSetup 检查网络连接&lt;/h2&gt;&lt;h3 id=&quot;1-循环检查网络连接直至连接成共，代码如下：&quot;&gt;&lt;a href=&quot;#1-循环检查网络连接直至连接成共，代码如下：&quot; class=&quot;headerlink&quot; title=&quot;1. 循环检查网络连接直至连接成共，代码如下：&quot;&gt;&lt;/a&gt;1. 循环检查网络连接直至连接成共，代码如下：&lt;/h3&gt;
    
    </summary>
    
    
      <category term="Inno Setup 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/Inno-Setup-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="Inno Setup" scheme="https://zicowarn.github.io/tags/Inno-Setup/"/>
    
      <category term="网络连接" scheme="https://zicowarn.github.io/tags/%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5/"/>
    
      <category term="Pascal" scheme="https://zicowarn.github.io/tags/Pascal/"/>
    
  </entry>
  
  <entry>
    <title>Inno Setup 在x86和x64环境下安装-NET安装包</title>
    <link href="https://zicowarn.github.io/2019/06/30/inno-02-installdotnet/"/>
    <id>https://zicowarn.github.io/2019/06/30/inno-02-installdotnet/</id>
    <published>2019-06-30T00:11:08.000Z</published>
    <updated>2020-08-25T03:13:23.301Z</updated>
    
    <content type="html"><![CDATA[<p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><h3 id="任务难点"><a href="#任务难点" class="headerlink" title="任务难点"></a>任务难点</h3><p>准备一个安装程序，以验证系统的体系结构并安装.NET。</p><h3 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h3><p>此安装脚本示例的目的是启动一个安装程序，该安装程序检查系统上当前安装的.NET版本，并仅在需要时安装一个。安装程序将在软件包中包括Microsoft提供的Web安装程序。 安装程序还将根据运行所在的体系结构安装一些库。</p><a id="more"></a><h3 id="2-背景"><a href="#2-背景" class="headerlink" title="2. 背景"></a>2. 背景</h3><p>出于我们的目的，我们需要可从Microsoft下载站点下载的InnoSetup编译器和.NET Framework Web安装程序文件。Microsoft维护一组注册表项，这些注册表项指示已安装的.NET Framework版本和Service Pack。C＃MVP Scott Dorman在此<a href="http://stackoverflow.com/questions/199080/how-to-detect-what-net-framework-versions-and-service-packs-are-installed">Stack Overflow线程中</a>发布了一个列表，其中包含版本1.0到4.0（在撰写本文时）。除1.0以外，大多数.NET Framework版本所需的注册表项都非常相似。无论如何，我们将忽略该版本已被1.1淘汰的版本。</p><p>4.5版和更高版本有些棘手，因为它们可以作为4.0版的就地更新安装并重用完全相同的注册表项。MSDN官方页面“ <a href="https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed">如何：确定安装的.NET Framework版本”</a>建议检查<code>DWORD</code>value 的存在<code>Release</code>，所以我在下面做这件事。替代方法是检查.NET 4.0 的<code>REG_SZ</code>值<code>Version</code>4.0.30319，.NET 4.5的4.5.50709和.NET 4.6的4.6.00079。（可悲的是，在安装它们时，我不认为要记录4.5.1和4.5.2的版本字符串。）</p><p>4.5.1版引入了另一个复杂性：根据Windows版本，可能有<em>两个</em><code>Release</code>值！该脚本通过将所有4.5版或更高版本的查询视为_最低_要求来处理此问题，即，如果该<code>Release</code>值等于或大于任何系统上指定版本的最小值，则这些查询将成功。.NET 4.5或更高版本也可以满足.NET 4.0的查询，因为后者是作为就地更新安装的。对较早版本的查询需要完全匹配，即，即使应用程序兼容，.NET 4.0或更高版本也_无法_满足它们。</p><h3 id="3-代码部分"><a href="#3-代码部分" class="headerlink" title="3. 代码部分"></a>3. 代码部分</h3><p>在[Code]部分，我们定义如下函数来检测以安装的.NET版本。该部分代码取自Jordan Russell的网站。 在下面的Inno Setup脚本代码块中，函数<code>IsDotNetDetected</code>检查是否安装了指定的.NET Framework版本和至少指定的Service Pack级别。所有列出的版本字符串均适用于最终发行版本；测试版和发行候选版通常具有不同的版本号。函数<code>InitializeSetup</code>演示了如何使用<code>IsDotNetDetected</code>不带Service Pack的.NET Framework 4.6进行检查。 原始代码如下：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsDotNetDetected</span><span class="params">(version: <span class="keyword">string</span>; service: cardinal)</span>:</span> boolean;</span><br><span class="line"><span class="comment">// Indicates whether the specified version and service pack of the .NET Framework is installed.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// version -- Specify one of these strings for the required .NET Framework version:</span></span><br><span class="line"><span class="comment">//    &#x27;v1.1&#x27;          .NET Framework 1.1</span></span><br><span class="line"><span class="comment">//    &#x27;v2.0&#x27;          .NET Framework 2.0</span></span><br><span class="line"><span class="comment">//    &#x27;v3.0&#x27;          .NET Framework 3.0</span></span><br><span class="line"><span class="comment">//    &#x27;v3.5&#x27;          .NET Framework 3.5</span></span><br><span class="line"><span class="comment">//    &#x27;v4\Client&#x27;     .NET Framework 4.0 Client Profile</span></span><br><span class="line"><span class="comment">//    &#x27;v4\Full&#x27;       .NET Framework 4.0 Full Installation</span></span><br><span class="line"><span class="comment">//    &#x27;v4.5&#x27;          .NET Framework 4.5</span></span><br><span class="line"><span class="comment">//    &#x27;v4.5.1&#x27;        .NET Framework 4.5.1</span></span><br><span class="line"><span class="comment">//    &#x27;v4.5.2&#x27;        .NET Framework 4.5.2</span></span><br><span class="line"><span class="comment">//    &#x27;v4.6&#x27;          .NET Framework 4.6</span></span><br><span class="line"><span class="comment">//    &#x27;v4.6.1&#x27;        .NET Framework 4.6.1</span></span><br><span class="line"><span class="comment">//    &#x27;v4.6.2&#x27;        .NET Framework 4.6.2</span></span><br><span class="line"><span class="comment">//    &#x27;v4.7&#x27;          .NET Framework 4.7</span></span><br><span class="line"><span class="comment">//    &#x27;v4.7.1&#x27;        .NET Framework 4.7.1</span></span><br><span class="line"><span class="comment">//    &#x27;v4.7.2&#x27;        .NET Framework 4.7.2</span></span><br><span class="line"><span class="comment">//    &#x27;v4.8&#x27;          .NET Framework 4.8</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// service -- Specify any non-negative integer for the required service pack level:</span></span><br><span class="line"><span class="comment">//    0               No service packs required</span></span><br><span class="line"><span class="comment">//    1, 2, etc.      Service pack 1, 2, etc. required</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    key, versionKey: <span class="keyword">string</span>;</span><br><span class="line">    install, release, serviceCount, versionRelease: cardinal;</span><br><span class="line">    success: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    versionKey := version;</span><br><span class="line">    versionRelease := <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 1.1 and 2.0 embed release number in version key</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">&#x27;v1.1&#x27;</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        versionKey := <span class="string">&#x27;v1.1.4322&#x27;</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> version = <span class="string">&#x27;v2.0&#x27;</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        versionKey := <span class="string">&#x27;v2.0.50727&#x27;</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 and newer install as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> Pos(<span class="string">&#x27;v4.&#x27;</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        versionKey := <span class="string">&#x27;v4\Full&#x27;</span>;</span><br><span class="line">        <span class="keyword">case</span> version <span class="keyword">of</span></span><br><span class="line">          <span class="string">&#x27;v4.5&#x27;</span>:   versionRelease := <span class="number">378389</span>;</span><br><span class="line">          <span class="string">&#x27;v4.5.1&#x27;</span>: versionRelease := <span class="number">378675</span>; <span class="comment">// 378758 on Windows 8 and older</span></span><br><span class="line">          <span class="string">&#x27;v4.5.2&#x27;</span>: versionRelease := <span class="number">379893</span>;</span><br><span class="line">          <span class="string">&#x27;v4.6&#x27;</span>:   versionRelease := <span class="number">393295</span>; <span class="comment">// 393297 on Windows 8.1 and older</span></span><br><span class="line">          <span class="string">&#x27;v4.6.1&#x27;</span>: versionRelease := <span class="number">394254</span>; <span class="comment">// 394271 before Win10 November Update</span></span><br><span class="line">          <span class="string">&#x27;v4.6.2&#x27;</span>: versionRelease := <span class="number">394802</span>; <span class="comment">// 394806 before Win10 Anniversary Update</span></span><br><span class="line">          <span class="string">&#x27;v4.7&#x27;</span>:   versionRelease := <span class="number">460798</span>; <span class="comment">// 460805 before Win10 Creators Update</span></span><br><span class="line">          <span class="string">&#x27;v4.7.1&#x27;</span>: versionRelease := <span class="number">461308</span>; <span class="comment">// 461310 before Win10 Fall Creators Update</span></span><br><span class="line">          <span class="string">&#x27;v4.7.2&#x27;</span>: versionRelease := <span class="number">461808</span>; <span class="comment">// 461814 before Win10 April 2018 Update</span></span><br><span class="line">          <span class="string">&#x27;v4.8&#x27;</span>:   versionRelease := <span class="number">528040</span>; <span class="comment">// 528049 before Win10 May 2019 Update</span></span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">&#x27;SOFTWARE\Microsoft\NET Framework Setup\NDP\&#x27;</span> + versionKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 3.0 uses value InstallSuccess in subkey Setup</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">&#x27;v3.0&#x27;</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key + <span class="string">&#x27;\Setup&#x27;</span>, <span class="string">&#x27;InstallSuccess&#x27;</span>, install);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key, <span class="string">&#x27;Install&#x27;</span>, install);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.0 and newer use value Servicing instead of SP</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">&#x27;v4&#x27;</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">&#x27;Servicing&#x27;</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">&#x27;SP&#x27;</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 and newer use additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> versionRelease &gt; <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">&#x27;Release&#x27;</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= versionRelease);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    result := success <span class="keyword">and</span> (install = <span class="number">1</span>) <span class="keyword">and</span> (serviceCount &gt;= service);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InitializeSetup</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> IsDotNetDetected(<span class="string">&#x27;v4.6&#x27;</span>, <span class="number">0</span>) <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        MsgBox(<span class="string">&#x27;MyApp requires Microsoft .NET Framework 4.6.&#x27;</span><span class="string">#13#13</span></span><br><span class="line">            <span class="string">&#x27;Please use Windows Update to install this version,&#x27;</span><span class="string">#13</span></span><br><span class="line">            <span class="string">&#x27;and then re-run the MyApp setup program.&#x27;</span>, mbInformation, MB_OK);</span><br><span class="line">        result := false;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        result := true;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>针对此代码，我们修改为如下形式：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsDotNetDetected</span><span class="params">(version: <span class="keyword">string</span>; service: cardinal)</span>:</span> boolean;</span><br><span class="line"><span class="comment">// Indicates whether the specified version and service pack of the .NET Framework is installed.</span></span><br><span class="line"><span class="comment">// see the link: https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed?redirectedfrom=MSDN#net_b</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// version -- Specify one of these strings for the required .NET Framework version:</span></span><br><span class="line"><span class="comment">//    &#x27;v1.1.4322&#x27;     .NET Framework 1.1</span></span><br><span class="line"><span class="comment">//    &#x27;v2.0.50727&#x27;    .NET Framework 2.0</span></span><br><span class="line"><span class="comment">//    &#x27;v3.0&#x27;          .NET Framework 3.0</span></span><br><span class="line"><span class="comment">//    &#x27;v3.5&#x27;          .NET Framework 3.5</span></span><br><span class="line"><span class="comment">//    &#x27;v4\Client&#x27;     .NET Framework 4.0 Client Profile</span></span><br><span class="line"><span class="comment">//    &#x27;v4\Full&#x27;       .NET Framework 4.0 Full Installation</span></span><br><span class="line"><span class="comment">//    &#x27;v4.5&#x27;          .NET Framework 4.5 378389</span></span><br><span class="line"><span class="comment">//    &#x27;v4.6&#x27;          .NET Framework 4.6 393295</span></span><br><span class="line"><span class="comment">//    &#x27;v4.6.1&#x27;        .NET Framework 4.6.1 394254</span></span><br><span class="line"><span class="comment">//    &#x27;v4.6.2&#x27;        .NET Framework 4.6.2 394802</span></span><br><span class="line"><span class="comment">//    &#x27;v4.7&#x27;          .NET Framework 4.7 393295</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// service -- Specify any non-negative integer for the required service pack level:</span></span><br><span class="line"><span class="comment">//    0               No service packs required</span></span><br><span class="line"><span class="comment">//    1, 2, etc.      Service pack 1, 2, etc. required</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    key: <span class="keyword">string</span>;</span><br><span class="line">    install, release, serviceCount: cardinal;</span><br><span class="line">    check45, success: boolean;</span><br><span class="line"><span class="keyword">var</span> reqNetVer : <span class="keyword">string</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// .NET 4.5 installs as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">&#x27;v4.5&#x27;</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">&#x27;v4\Full&#x27;</span>;</span><br><span class="line">        check45 := true;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        check45 := false;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">&#x27;SOFTWARE\Microsoft\NET Framework Setup\NDP\&#x27;</span> + version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 3.0 uses value InstallSuccess in subkey Setup</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">&#x27;v3.0&#x27;</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key + <span class="string">&#x27;\Setup&#x27;</span>, <span class="string">&#x27;InstallSuccess&#x27;</span>, install);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key, <span class="string">&#x27;Install&#x27;</span>, install);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.0/4.5 uses value Servicing instead of SP</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">&#x27;v4&#x27;</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">&#x27;Servicing&#x27;</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">&#x27;SP&#x27;</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 uses additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> check45 <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">&#x27;Release&#x27;</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= <span class="number">378389</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    result := success <span class="keyword">and</span> (install = <span class="number">1</span>) <span class="keyword">and</span> (serviceCount &gt;= service);</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>这是一个全局函数，用于验证是否正确安装了作为参数传递的.NET Framework版本。 现在，我们应该编写一个由安装程序在运行时调用的简单函数，以验证是否已安装所需的.NET版本。我们将以4.0为例。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function IsRequiredDotNetDetected(): Boolean;  </span><br><span class="line">begin</span><br><span class="line">    result := IsDotNetDetected(&#x27;v4\Full&#x27;, 0);</span><br><span class="line">end;</span><br></pre></td></tr></table></figure><p>如果需要，我们还可以在设置过程中发布一条消息：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InitializeSetup</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> IsDotNetDetected(<span class="string">&#x27;v4\Full&#x27;</span>, <span class="number">0</span>) <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        MsgBox(<span class="string">&#x27;&#123;#MyAppName&#125; requires Microsoft .NET Framework 4.0 Client Profile.&#x27;</span><span class="string">#13#13</span></span><br><span class="line">          <span class="string">&#x27;The installer will attempt to install it&#x27;</span>, mbInformation, MB_OK);        </span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    result := true;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>代码部分已经完成，现在我们可以关注**[Files]**部分。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Files]</span><br><span class="line">Source: &quot;&#123;#MyDistFolder&#125;\dotNetFx40_Full_setup.exe&quot;; DestDir: &#123;tmp&#125;; Flags: deleteafterinstall; Check: not IsRequiredDotNetDetected</span><br></pre></td></tr></table></figure><p>安装程序将复制.NET安装程序文件（这大约是850 KB的智能文件），<strong>只有</strong>在没有已经存在于系统中，到<strong>系统临时</strong>目录。安装完成后，该文件将被删除。现在已经复制了网络安装程序，如果需要，我们需要运行它。 在**[run]**部分中，输入以下内容：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Run]</span><br><span class="line">Filename: &#123;tmp&#125;\dotNetFx40_Full_setup.exe; Parameters: &quot;/q:a /c:&quot;&quot;install /l </span><br><span class="line">  /q&quot;&quot;&quot;; Check: not IsRequiredDotNetDetected; StatusMsg: Microsoft Framework 4.0 is beïng installed. Please wait...</span><br></pre></td></tr></table></figure><h3 id="4-x86-x64选项"><a href="#4-x86-x64选项" class="headerlink" title="4. x86 / x64选项"></a>4. x86 / x64选项</h3><p>此示例显示安装程序如何根据系统体系结构运行。它将安装系统所需的本机库，以进行更智能的安装。在 **[setuo]**部分中，定义以下指令：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArchitecturesInstallIn64BitMode=x64</span><br></pre></td></tr></table></figure><p>这两行将根据系统安装一个lib文件夹：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Source: &quot;&#123;#MyDistFolder&#125;\lib\x64\*&quot;; DestDir: &quot;&#123;app&#125;\lib\x64&quot;; Check: Is64BitInstallMode; Flags: ignoreversion recursesubdirs createallsubdirs</span><br><span class="line">Source: &quot;&#123;#MyDistFolder&#125;\lib\x86\*&quot;; DestDir: &quot;&#123;app&#125;\lib\x86&quot;; Check: not Is64BitInstallMode; Flags: ignoreversion recursesubdirs createallsubdirs</span><br></pre></td></tr></table></figure><h3 id="5-有关安装-NET过程代码的其它解决方案"><a href="#5-有关安装-NET过程代码的其它解决方案" class="headerlink" title="5. 有关安装.NET过程代码的其它解决方案"></a>5. 有关安装.NET过程代码的其它解决方案</h3><p>如果不行实现InnoSetup中的AfterInstall的标识，希望.NET的安装在文件**[Files]**执行的某一步骤时被执行，就需要主意.NET的执行顺序。请参看如下两部分代码。</p><p>使用安装的返回值</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[Code]</span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InstallFramework</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\dotNetFx40_Full_x86_x64.exe&#x27;</span>), <span class="string">&#x27;/q /norestart&#x27;</span>, <span class="string">&#x27;&#x27;</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">&#123; you can interact with the user that the installation failed &#125;</span></span><br><span class="line">    MsgBox(<span class="string">&#x27;.NET installation failed with code: &#x27;</span> + IntToStr(ResultCode) + <span class="string">&#x27;.&#x27;</span>,</span><br><span class="line">      mbError, MB_OK);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>使用进度条显示安装进度，但是由于要获得.NET安装程序的安装进度并不容易，因此我将在安装执行过程中向用户简单显示无休止的选取框进度栏。 即，该进度条仅在此具用于显示，不能准确表示安装的进度。</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InstallFramework</span>;</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  StatusText: <span class="keyword">string</span>;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  StatusText := WizardForm.StatusLabel.Caption;</span><br><span class="line">  WizardForm.StatusLabel.Caption := <span class="string">&#x27;Installing .NET framework...&#x27;</span>;</span><br><span class="line">  WizardForm.ProgressGauge.Style := npbstMarquee;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\dotNetFx45_Full_asetup.exe&#x27;</span>), <span class="string">&#x27;/q /norestart&#x27;</span>, <span class="string">&#x27;&#x27;</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    <span class="comment">// you can interact with the user that the installation failed</span></span><br><span class="line">    MsgBox(<span class="string">&#x27;.NET installation failed with code: &#x27;</span> + IntToStr(ResultCode) + <span class="string">&#x27;.&#x27;</span>,</span><br><span class="line">      mbError, MB_OK);</span><br><span class="line">    CancelWithoutPrompt := true;</span><br><span class="line">    WizardForm.Close;       </span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.StatusLabel.Caption := StatusText;</span><br><span class="line">    WizardForm.ProgressGauge.Style := npbstNormal;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><h3 id="6-提示"><a href="#6-提示" class="headerlink" title="6. 提示"></a>6. 提示</h3><p>Inno 是具有一个内置变量{dotnet40}的，ExpandConstant(‘{dotnet40}’)。其它有关的变量为：</p><p><strong>{dotnet11}</strong></p><p>32-bit .NET Framework version 1.1 root directory.</p><p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 1.1 present.</p><p>32位.NET Framework 1.1版根目录。</p><p>会将系统扩展到当前的.NET Framework版本1.1会发生例外。</p><p><strong>{dotnet20}</strong></p><p>.NET Framework version 2.0-3.5 root directory. <code>&#123;dotnet20&#125;</code> is equivalent to <code>&#123;dotnet2032&#125;</code> unless the install is running in [64-bit install mode], in which case it is equivalent to <code>&#123;dotnet2064&#125;</code>.</p><p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 2.0-3.5 present.</p><p>.NET Framework 2.0-3.5版根目录。除非安装以64位安装模式运行，否则{dotnet20}等效于{dotnet2032}，在这种情况下，等效于{dotnet2064}。</p><p>会将系统扩展到当前的.NET Framework版本2.0-3.5将会发生例外。</p><p><strong>{dotnet2032}</strong></p><p>32-bit .NET Framework version 2.0-3.5 root directory.</p><p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 2.0-3.5 present.</p><p>32位.NET Framework 2.0-3.5版根目录。</p><p>会将系统扩展到当前的.NET Framework版本2.0-3.5将会发生例外。</p><p><strong>{dotnet2064}</strong></p><p>64-bit Windows only: 64-bit .NET Framework version 2.0-3.5 root directory.</p><p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 2.0-3.5 present.</p><p>仅适用于64位Windows：64位.NET Framework 2.0-3.5版根目录。</p><p>会将系统扩展到当前的.NET Framework版本2.0-3.5将会发生例外。</p><p><strong>{dotnet40}</strong></p><p>.NET Framework version 4.0 and later root directory. <code>&#123;dotnet40&#125;</code> is equivalent to <code>&#123;dotnet4032&#125;</code> unless the install is running in [64-bit install mode], in which case it is equivalent to <code>&#123;dotnet4064&#125;</code>.</p><p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 4.0 or later present.</p><p>.NET Framework 4.0版和更高版本的根目录。除非安装以64位安装模式运行，否则{dotnet40}等效于{dotnet4032}，在这种情况下，等效于{dotnet4064}。</p><p>将系统扩展到.NET Framework 4.0或更高版本时，将发生例外。</p><p><strong>{dotnet4032}</strong></p><p>32-bit .NET Framework version 4.0 and later root directory.</p><p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 4.0 or later present.</p><p>32位.NET Framework 4.0版和更高版本的根目录。</p><p>将系统扩展到.NET Framework 4.0或更高版本时，将发生例外。</p><p><strong>{dotnet4064}</strong></p><p>64-bit Windows only: 64-bit .NET Framework version 4.0 and later root directory.</p><p>An exception will be raised if an attempt is made to expand this constant on a system with no .NET Framework version 4.0 or later present.</p><p>仅适用于64位Windows：64位.NET Framework 4.0版和更高版本的根目录。</p><p>将系统扩展到.NET Framework 4.0或更高版本时，将发生例外。</p><h3 id="7-使用RegAsm-exe-注册-NET-DLL-文件"><a href="#7-使用RegAsm-exe-注册-NET-DLL-文件" class="headerlink" title="7. 使用RegAsm.exe 注册 .NET DLL 文件"></a>7. 使用RegAsm.exe 注册 .NET DLL 文件</h3><p>其中**[run]**的代码如下， 主意其WorkingDir参数，其表示运行注册程序的时候，运行的目录：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Filename: &quot;&#123;dotnet20&#125;\RegAsm.exe&quot;; Parameters: /codebase YourDLL.dll; WorkingDir: &#123;app&#125;; StatusMsg: &quot;Registering Controls...&quot;; Flags: runminimized</span><br></pre></td></tr></table></figure><h3 id="8-其它完整解决方案"><a href="#8-其它完整解决方案" class="headerlink" title="8. 其它完整解决方案"></a>8. 其它完整解决方案</h3><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Other parts of installer file go here</span></span><br><span class="line">[CustomMessages]</span><br><span class="line">IDP_DownloadFailed=Download <span class="keyword">of</span> .NET Framework <span class="number">4.7</span>.<span class="number">2</span> failed. .NET Framework <span class="number">4.7</span> <span class="keyword">is</span> required <span class="keyword">to</span> run VidCoder.</span><br><span class="line">IDP_RetryCancel=Click <span class="string">&#x27;Retry&#x27;</span> <span class="keyword">to</span> <span class="keyword">try</span> downloading the files again, <span class="keyword">or</span> click <span class="string">&#x27;Cancel&#x27;</span> <span class="keyword">to</span> terminate setup.</span><br><span class="line">InstallingDotNetFramework=Installing .NET Framework <span class="number">4.7</span>.<span class="number">2</span>. This might take a few minutes...</span><br><span class="line">DotNetFrameworkFailedToLaunch=Failed to launch .NET Framework Installer with error &quot;%1&quot;. Please fix the error then run this installer again.</span><br><span class="line">DotNetFrameworkFailed1602=.NET Framework installation was cancelled. This installation can <span class="keyword">continue</span>, but be aware that this application may <span class="keyword">not</span> run unless the .NET Framework installation <span class="keyword">is</span> completed successfully.</span><br><span class="line">DotNetFrameworkFailed1603=A fatal error occurred <span class="keyword">while</span> installing the .NET Framework. Please fix the error, <span class="keyword">then</span> run the installer again.</span><br><span class="line">DotNetFrameworkFailed5100=Your computer does <span class="keyword">not</span> meet the requirements <span class="keyword">of</span> the .NET Framework. Please consult the documentation.</span><br><span class="line">DotNetFrameworkFailedOther=The .NET Framework installer exited with an unexpected status code &quot;%1&quot;. Please review any other messages shown by the installer to determine whether the installation completed successfully, and abort this installation and fix the problem if it did not.</span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  requiresRestart: boolean;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NetFrameworkIsMissing</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  bSuccess: Boolean;</span><br><span class="line">  regVersion: Cardinal;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := True;</span><br><span class="line"></span><br><span class="line">  bSuccess := RegQueryDWordValue(HKLM, <span class="string">&#x27;Software\Microsoft\NET Framework Setup\NDP\v4\Full&#x27;</span>, <span class="string">&#x27;Release&#x27;</span>, regVersion);</span><br><span class="line">  <span class="keyword">if</span> (True = bSuccess) <span class="keyword">and</span> (regVersion &gt;= <span class="number">461308</span>) <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">    Result := False;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">procedure</span> <span class="title">InitializeWizard</span>;</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> NetFrameworkIsMissing() <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    idpAddFile(<span class="string">&#x27;http://go.microsoft.com/fwlink/?LinkId=863262&#x27;</span>, ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\NetFrameworkInstaller.exe&#x27;</span>));</span><br><span class="line">    idpDownloadAfter(wpReady);</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFramework</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  StatusText: <span class="keyword">string</span>;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  StatusText := WizardForm.StatusLabel.Caption;</span><br><span class="line">  WizardForm.StatusLabel.Caption := CustomMessage(<span class="string">&#x27;InstallingDotNetFramework&#x27;</span>);</span><br><span class="line">  WizardForm.ProgressGauge.Style := npbstMarquee;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\NetFrameworkInstaller.exe&#x27;</span>), <span class="string">&#x27;/passive /norestart /showrmui /showfinalerror&#x27;</span>, <span class="string">&#x27;&#x27;</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      Result := FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailedToLaunch&#x27;</span>), [SysErrorMessage(resultCode)]);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      <span class="comment">// See https://msdn.microsoft.com/en-us/library/ee942965(v=vs.110).aspx#return_codes</span></span><br><span class="line">      <span class="keyword">case</span> resultCode <span class="keyword">of</span></span><br><span class="line">        <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// Successful</span></span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">          MsgBox(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed1602&#x27;</span>), mbInformation, MB_OK);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">          Result := CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed1603&#x27;</span>);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">          requiresRestart := True;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">          requiresRestart := True;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">          Result := CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed5100&#x27;</span>);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">          MsgBox(FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailedOther&#x27;</span>), [IntToStr(resultCode)]), mbError, MB_OK);</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">      <span class="keyword">end</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.StatusLabel.Caption := StatusText;</span><br><span class="line">    WizardForm.ProgressGauge.Style := npbstNormal;</span><br><span class="line"></span><br><span class="line">    DeleteFile(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\NetFrameworkInstaller.exe&#x27;</span>));</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PrepareToInstall</span><span class="params">(<span class="keyword">var</span> NeedsRestart: Boolean)</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// &#x27;NeedsRestart&#x27; only has an effect if we return a non-empty string, thus aborting the installation.</span></span><br><span class="line">  <span class="comment">// If the installers indicate that they want a restart, this should be done at the end of installation.</span></span><br><span class="line">  <span class="comment">// Therefore we set the global &#x27;restartRequired&#x27; if a restart is needed, and return this from NeedRestart()</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> NetFrameworkIsMissing() <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    Result := InstallFramework();</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NeedRestart</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := requiresRestart;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>根据此版本修改后适用于自己项目的.NET框架安装代码如下：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFrameworkWebRuntime</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WasVisible: Boolean;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  ExtractTemporaryFile(<span class="string">&#x27;&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>);</span><br><span class="line">  WasVisible := WizardForm.PreparingLabel.Visible;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      WizardForm.PreparingLabel.Visible := True;</span><br><span class="line">      WizardForm.PreparingLabel.Caption := FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkWebInstallerCaption&#x27;</span>), [TO_COMPARE_DOT_NET]);</span><br><span class="line">      ExtractTemporaryFile(<span class="string">&#x27;&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>);</span><br><span class="line">      <span class="comment">//if not Exec(ExpandConstant(&#x27;&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;), &#x27;/q /norestart&#x27;, &#x27;&#x27;, SW_SHOW, ewWaitUntilTerminated, ResultCode) then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>), <span class="string">&#x27;/passive /norestart /showrmui /showfinalerror&#x27;</span>, <span class="string">&#x27;&#x27;</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-</span></span><br><span class="line">          <span class="comment">// you can interact with the user that the installation failed, for example: error code 2: the system cannot find the file specified.</span></span><br><span class="line">          Result := FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailedToLaunch&#x27;</span>), [SysErrorMessage(ResultCode)])     </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">case</span> ResultCode <span class="keyword">of</span></span><br><span class="line">            <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">// Successful</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">              MsgBox(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed1602&#x27;</span>), mbInformation, MB_OK);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed1603&#x27;</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed5100&#x27;</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">//MsgBox(FmtMessage(CustomMessage(&#x27;DotNetFrameworkFailedOther&#x27;), [IntToStr(resultCode)]), mbError, MB_OK);</span></span><br><span class="line">              Result := FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailedOther&#x27;</span>), IntToStr(ResultCode));     </span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">          <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.PreparingLabel.Visible := WasVisible;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  DeleteFile(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>));</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>上述代码中</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExtractTemporaryFile(<span class="string">&#x27;&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>); </span><br></pre></td></tr></table></figure><p>强制解压安装文件。该动作早于[Files]的运行。在安装结束之后删除该文件，使用代码如：</p><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DeleteFile(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>));</span><br></pre></td></tr></table></figure><p>有关.NET安装包运行时的错误代码可以参考连接：</p><p>// See <a href="https://msdn.microsoft.com/en-us/library/ee942965%28v=vs.110%29.aspx#return_codes">https://msdn.microsoft.com/en-us/library/ee942965(v=vs.110).aspx#return_codes</a></p><p>有关Exec函数，其错误代码为Windows系统错误代码，运行时的错误文本，可以参考连接：</p><p>// See [<a href="https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-]">https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-]</a>(</p><h3 id="9-Inno-Setup-对注册表的操作"><a href="#9-Inno-Setup-对注册表的操作" class="headerlink" title="9. Inno Setup 对注册表的操作"></a>9. Inno Setup 对注册表的操作</h3><p>由于安装.NET的框架的目的就是要使用一下依赖.NET框架的动态库文件。而这部分DLL文件能够顺利使用就需要对该DLL文件进行注册。</p><h4 id="9-1-Regasm-程序集注册工具"><a href="#9-1-Regasm-程序集注册工具" class="headerlink" title="9.1 Regasm  程序集注册工具"></a>9.1 Regasm  程序集注册工具</h4><p><strong>Regasm 简介 ：</strong></p><p>EXE files such as RegAsm.exe are categorized as Executable Application (Windows Executable) files. As a Windows Executable file, it was created for use in Windows 10 by [Microsoft].</p><p>像RegAsm.exe这样的EXE文件都被分类为可执行应用程序（Windows Executable）文件。 作为Windows可执行文件，它由Microsoft创建供Windows 10使用。</p><p>The first version of RegAsm.exe for Windows Vista was introduced on 11/08/2006 in Windows Vista. The most recent version [file version 10] was introduced on 07/29/2015 for Windows 10. RegAsm.exe is bundled with the software package in Windows 10, Windows 8.1, and Windows 8.</p><p>Windows Vista的RegAsm.exe的第一版于2006年11月8日在Windows Vista中引入。 Windows 10的最新版本（文件版本10）已于07/29/2015引入。RegAsm.exe与Windows 10，Windows 8.1和Windows 8中的软件包捆绑在一起。</p><p>Please see below for more detailed information, <a href="https://www.exefiles.com/en/extensions/exe/all-files/">EXE</a> file troubleshooting instructions, and free downloads of different versions of RegAsm.exe.</p><p>请参阅下面的详细信息，EXE文件故障排除说明以及RegAsm.exe不同版本的免费下载。</p><p><strong>作用：</strong> 读取程序集中的元数据，并将所需的项添加到注册表中。注册表允许 COM 客户程序以透明方式创建 .NET Framework 类。类一经注册，任何 COM 客户程序都可以使用它，就好像该类是一个 COM 类。类仅在安装程序集时注册一次。程序集中的类实例直到被实际注册时，才能从 COM 中创建。</p><p><strong>使用方法：</strong></p><p>regasm assemblyFile [options]</p><p><strong>重要参数：</strong></p><p>/codebase 在注册表中创建一个 Codebase 项。Codebase 项指定未安装到全局程序集缓存中的程序集的文件路径。如果随后要安装正在注册到全局程序集缓存中的程序集，则不应指定此选项。用 /codebase 选项指定的 assemblyFile 参数必须是具有强名称的程序集。</p><h4 id="9-2-Regsvr32-程序集注册工具"><a href="#9-2-Regsvr32-程序集注册工具" class="headerlink" title="9.2 Regsvr32  程序集注册工具"></a>9.2 Regsvr32  程序集注册工具</h4><p><strong>作用：</strong> Regsvr32命令用于注册COM组件，是 Windows 系统提供的用来向系统注册控件或者卸载控件的命令，以命令行方式运行。WinXP及以上系统的regsvr32.exe在windows\system32文件夹下；2000系统的regsvr32.exe在winnt\system32文件夹下。</p><h4 id="9-3-两个DLL注册工具的差异"><a href="#9-3-两个DLL注册工具的差异" class="headerlink" title="9.3 两个DLL注册工具的差异"></a>9.3 两个DLL注册工具的差异</h4><p>使用regasm.exe来注册.NET 组件，regsvr32并不适用于.NET组件。 （或者您也可以将regasm.exe理解为.NET的regsvr32）。regsvr32不适用于.NET的组件的注册，感觉意思是对于非托管的代码使用regsvr32来注册，对于托管的代码使用regasm来注册。</p><p><code>regsvr32</code> will load the library and try to call the <code>DllRegisterServer()</code> from that library. It doesn’t care what <code>DllRegisterServer()</code> actually does - it just calls that function and checks the returned value. You use it to register COM servers in unmanaged DLLs. It can’t generate a .tlb file.</p><p>regsvr32将加载该库并尝试从该库中调用DllRegisterServer（）。 不管DllRegisterServer（）实际做什么，它只是调用该函数并检查返回的值。 您可以使用它在非托管DLL中注册COM服务器。 无法生成.tlb文件。</p><p><code>regasm</code> will register a COM-exposed .NET assembly as a COM server. You use it for .NET assemblies. It can generate a .tlb file given the assembly only - it inspects the type infromation stored in the assembly and includes the COM-exposed entities into the type library.</p><p>regasm将把暴露于COM的.NET程序集注册为COM服务器。 您将其用于.NET程序集。 仅在给定程序集的情况下，它可以生成.tlb文件-它检查存储在程序集中的类型信息，并将COM公开的实体包括到类型库中。</p><h4 id="9-4-NET中“托管代码”和“非托管代码”的区别"><a href="#9-4-NET中“托管代码”和“非托管代码”的区别" class="headerlink" title="9.4  .NET中“托管代码”和“非托管代码”的区别"></a>9.4  .NET中“托管代码”和“非托管代码”的区别</h4><p><strong>托管代码</strong> <strong>(managed code)</strong></p><p>托管代码是Visual Basic .NET和C#编译器创建的代码。它运行在CLR(公共语言运行时)，除其他外，它提供像垃圾收集，运行时类型检查和引用检查的服务。所以，认为它是，“我的代码是由CLR管理。</p><p>Visual Basic和C#只能生成托管代码，所以，如果你正在用这些语言编写一个应用程序，你正在写一个由CLR管理的应用程序。如果您在Visual C .NET中编写应用程序，您可以根据需要生成托管代码，但它是可选的。</p><p><strong>非托管代码</strong> <strong>(unmanaged code)</strong></p><p>非托管代码直接编译为机器代码。因此，通过该定义，所有由传统C/C++编译器编译的代码是“非托管代码”。此外，由于它编译为机器代码而不是中间语言，所以它是不可移植的。</p><p>没有可用的内存管理或任何其他CLR提供。</p><p>由于您不能使用Visual Basic或C#创建非托管代码，在Visual Studio中，所有非托管代码都用C/C++编写。</p><p><strong>混合两者</strong></p><p>由于Visual C可以编译为托管代码或非托管代码，因此可以在同一个应用程序中混合这两个代码。这模糊了两者之间的界限，并使定义复杂化，但值得一提的是，你知道，如果你使用的第三方库有一些严重的非托管代码，你仍然可能有内存泄漏。</p><p><strong>区别：</strong></p><p>1、托管代码是一种中间语言，运行在CLR上；</p><p> 非托管代码被编译为机器码，运行在机器上。</p><p>2、托管代码独立于平台和语言，能更好的实现不同语言平台之间的兼容；</p><p> 非托管代码依赖于平台和语言。</p><p>3、托管代码可享受CLR提供的服务（如安全检测、垃圾回收等），不需要自己完成这些操作；</p><p> 非托管代码需要自己提供安全检测、垃圾回收等操作。</p><p>托管代码就意味着托管数据？答案是否定的。</p><p>对于Visual Basic和C#来说，生活是简单的，因为你没有其它选择。当你在那些语言里面声明一个类，那么这个类的实例会在托管堆中被创建，垃圾收集器(GC)会帮我们管理这些对象的回收。但是在Visual C++中，你有另一个选择。即使你正创建一个托管程序，你可以决定哪些类是托管类型，哪些类是非托管类型的。</p><p>这就是非托管类型：</p><p>class Foo { private: int x; public: Foo(): x(0){} Foo(int xx): x(xx) {} };</p><p>这就是托管类型</p><p>__gc class Bar { private: int x; public: Bar(): x(0){} Bar(int xx): x(xx) {} };</p><p>他们唯一的区别就是类Bar的定义中有__gc关键字。这个关键字会给代码带来巨大的区别。</p><h4 id="9-5-使用Inno-Setup的-Registry-段注册-NET相关DLL文件"><a href="#9-5-使用Inno-Setup的-Registry-段注册-NET相关DLL文件" class="headerlink" title="9.5 使用Inno Setup的 [Registry] 段注册.NET相关DLL文件"></a>9.5 使用Inno Setup的 [Registry] 段注册.NET相关DLL文件</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[Registry]</span><br><span class="line">; ProgID part, TechTemp</span><br><span class="line">Root: HKCR; Subkey: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM&quot;; Flags: uninsdeletekeyifempty</span><br><span class="line">Root: HKCR; Subkey: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID&quot;; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID&quot;; ValueType: string; ValueName: &quot;&quot;; ValueData: &quot;&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;&quot;; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part, TechTemp </span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;&quot;; Flags: uninsdeletekeyifempty</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;&quot;; ValueType: string; ValueName: &quot;&quot;; ValueData: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM&quot;; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part\InprocServer32, TechTemp</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;&quot;; ValueData: &quot;mscoree.dll&quot;; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;ThreadingModel&quot;; ValueData: &quot;Both&quot;; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;Class&quot;; ValueData: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM&quot;; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;Assembly&quot;; ValueData: &quot;xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;RuntimeVersion&quot;; ValueData: &quot;v4.0.30319&quot;; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;CodeBase&quot;; ValueData: &quot;file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll&quot;; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part\InprocServer32\<span class="number">1.0</span>.<span class="number">0.0</span>, TechTemp</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0&quot;; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0&quot;; ValueType: string; ValueName: &quot;Class&quot;; ValueData: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM&quot;; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0&quot;; ValueType: string; ValueName: &quot;Assembly&quot;; ValueData: &quot;xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0&quot;; ValueType: string; ValueName: &quot;RuntimeVersion&quot;; ValueData: &quot;v4.0.30319&quot;; Flags: uninsdeletevalue</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0&quot;; ValueType: string; ValueName: &quot;CodeBase&quot;; ValueData: &quot;file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll&quot;; Flags: uninsdeletevalue</span><br><span class="line">; CLSID Part\Implemented Categories, TechTemp</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories&quot;; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories\&#123;&#123;&#123;#DotNetDllCLSIDImplementedCategories&#125;&#125;&quot;; Flags: uninsdeletekey</span><br><span class="line">; CLSID Part\ProgId, TechTemp</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId&quot;; Flags: uninsdeletekey</span><br><span class="line">Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId&quot;; ValueType: string; ValueName: &quot;&quot;; ValueData: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM&quot;; Flags: uninsdeletevalue</span><br></pre></td></tr></table></figure><h3 id="10-项目完整代码，最小测试版"><a href="#10-项目完整代码，最小测试版" class="headerlink" title="10. 项目完整代码，最小测试版"></a>10. 项目完整代码，最小测试版</h3><figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br></pre></td><td class="code"><pre><span class="line">; -- Example1.iss --</span><br><span class="line">; Demonstrates copying <span class="number">3</span> files <span class="keyword">and</span> creating an icon.</span><br><span class="line"></span><br><span class="line">; SEE THE DOCUMENTATION <span class="keyword">FOR</span> DETAILS <span class="keyword">ON</span> CREATING .ISS SCRIPT FILES!</span><br><span class="line"></span><br><span class="line">#define ********AppPath</span><br><span class="line">#expr ********AppPath = &quot;\********\trunk\hcnt\wire\&quot;</span><br><span class="line"></span><br><span class="line">#define DotNetRegistToolPath</span><br><span class="line">#expr DotNetRegistToolPath = &quot;&quot;</span><br><span class="line"></span><br><span class="line">#define DotNetFrameWorkInstallerPath</span><br><span class="line">#expr DotNetFrameWorkInstallerPath = &quot;..\NET\NET_Framework_Runtime\462\&quot;</span><br><span class="line"></span><br><span class="line">#define DotNet4OCTechTemplDllPath</span><br><span class="line">#expr DotNet4OCTechTemplDllPath = &quot;..\helper\xxxxxxxxxxxxxxxxxxx&quot;</span><br><span class="line"></span><br><span class="line">#define DotNetFrameWorkOfflineInstaller</span><br><span class="line">#expr DotNetFrameWorkOfflineInstaller = &quot;ndp48-x86-x64-allos-enu.exe&quot;</span><br><span class="line"></span><br><span class="line">#define DotNetFrameWorkWebInstaller</span><br><span class="line">#expr DotNetFrameWorkWebInstaller = &quot;ndp48-web.exe&quot;</span><br><span class="line"></span><br><span class="line">;#define DotNetDllCLSID</span><br><span class="line">;#expr DotNetDllCLSID = &quot;62519924-26A8-3770-9F82-0A0BC26EE7D4&quot;</span><br><span class="line"></span><br><span class="line">;#define DotNetDllCLSIDImplementedCategories</span><br><span class="line">;#expr DotNetDllCLSIDImplementedCategories = &quot;62C8FE65-4EBB-45E7-B440-6E39B2CDBF29&quot;</span><br><span class="line"></span><br><span class="line">;#define AppPathBackSlash</span><br><span class="line">;#expr AppPathBackSlash = &quot;********/trunk/hcnt/wire&quot;</span><br><span class="line"></span><br><span class="line">;#define CommonappdataPathBackSlash</span><br><span class="line">;#expr CommonappdataPathBackSlash = &quot;C:/ProgramData&quot;</span><br><span class="line"></span><br><span class="line">[Setup]</span><br><span class="line">;SignTool=MyCustom sign /a /tr http:<span class="comment">//sha256timestamp.ws.symantec.com/sha256/timestamp /d $q******** for SolidWorks 2020 Beta3$q $f</span></span><br><span class="line">PrivilegesRequired=admin </span><br><span class="line">AppName=My <span class="keyword">Program</span></span><br><span class="line">AppVersion=<span class="number">1.5</span></span><br><span class="line">WizardStyle=modern</span><br><span class="line">DefaultDirName=<span class="comment">&#123;autopf&#125;</span>\My <span class="keyword">Program</span></span><br><span class="line">DefaultGroupName=My <span class="keyword">Program</span></span><br><span class="line">UninstallDisplayIcon=<span class="comment">&#123;app&#125;</span>\MyProg.exe</span><br><span class="line">Compression=lzma2</span><br><span class="line">SolidCompression=yes</span><br><span class="line">OutputDir=userdocs:Inno Setup Examples Output</span><br><span class="line">ArchitecturesInstallIn64BitMode = x64</span><br><span class="line">ArchitecturesAllowed = x64</span><br><span class="line">SetupLogging=yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Languages]</span><br><span class="line"><span class="keyword">Name</span>: ENGLISH; MessagesFile: compiler:<span class="keyword">Default</span>.isl</span><br><span class="line"><span class="keyword">Name</span>: DEUTSCH; MessagesFile: compiler:Languages\German.isl; </span><br><span class="line"></span><br><span class="line">[Files]</span><br><span class="line">; .NET Part</span><br><span class="line">; .NET Framework Runtime, offline installer english all os runtime </span><br><span class="line">Source: &quot;&#123;#DotNetFrameWorkInstallerPath&#125;&#123;#DotNetFrameWorkOfflineInstaller&#125;&quot;; DestDir: &quot;&#123;tmp&#125;&quot;; Flags: dontcopy noencryption;</span><br><span class="line">; .NET Framework Runtime, web installer <span class="keyword">for</span> other languages</span><br><span class="line">Source: &quot;&#123;#DotNetFrameWorkInstallerPath&#125;&#123;#DotNetFrameWorkWebInstaller&#125;&quot;; DestDir: &quot;&#123;tmp&#125;&quot;; Flags: dontcopy noencryption;</span><br><span class="line">; xxxxxxxxxxxxxxxxxxx.dll + Hilfsdlls</span><br><span class="line">Source: &quot;&#123;#DotNet4OCTechTemplDllPath&#125;\*.*&quot;; DestDir: &quot;&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\&quot;; Flags: ignoreversion recursesubdirs; Permissions: everyone-full;</span><br><span class="line"></span><br><span class="line">Source: &quot;MyProg.exe&quot;; DestDir: &quot;&#123;app&#125;&quot;</span><br><span class="line">Source: &quot;MyProg.chm&quot;; DestDir: &quot;&#123;app&#125;&quot;</span><br><span class="line">Source: &quot;Readme.txt&quot;; DestDir: &quot;&#123;app&#125;&quot;; Flags: isreadme</span><br><span class="line"></span><br><span class="line">[Run]</span><br><span class="line">; Regist the .NET DLL <span class="keyword">file</span> by using the tool regasm.exe, return <span class="number">0</span>: ERROR_SUCCESS; <span class="number">1</span>:ERROR_INVALID_FUNCTION; <span class="number">2</span>:ERROR_FILE_NOT_FOUND; <span class="number">3</span>: ERROR_PATH_NOT_FOUND  </span><br><span class="line">Filename:  &#123;code:GetCurrentRegAsmPath|&#123;#DotNetRegistToolPath&#125;&#125;\regasm.exe; Parameters: &quot; &quot;&quot;&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\xxxxxxxxxxxxxxxxxxx.dll&quot;&quot; /codebase /verbose&quot;; WorkingDir: &quot;&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\&quot;; StatusMsg: Registering DLLs; Flags: 64bit runhidden waituntilterminated;</span><br><span class="line"></span><br><span class="line">[UninstallRun]</span><br><span class="line">; Regist the .NET DLL <span class="keyword">file</span> by using the tool regasm.exe, return <span class="number">0</span>: ERROR_SUCCESS; <span class="number">1</span>:ERROR_INVALID_FUNCTION; <span class="number">2</span>:ERROR_FILE_NOT_FOUND; <span class="number">3</span>: ERROR_PATH_NOT_FOUND  </span><br><span class="line">Filename:  &#123;code:GetCurrentRegAsmPath|&#123;#DotNetRegistToolPath&#125;&#125;\regasm.exe; Parameters: &quot;/unregister &quot;&quot;&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\xxxxxxxxxxxxxxxxxxx.dll&quot;&quot; /codebase /verbose&quot;; WorkingDir: &quot;&#123;commonappdata&#125;\&#123;#********AppPath&#125;\bin\NET\&quot;; StatusMsg: Unregistering DLLs; Flags: 64bit runhidden waituntilterminated;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[CustomMessages]</span><br><span class="line">; .NET Framwork installation processing </span><br><span class="line">ENGLISH.DotNetFrameworkOfflineInstallerCaption = Installing Microsoft .NET framework <span class="number">%1</span> offline installer <span class="keyword">for</span> Windows...</span><br><span class="line">ENGLISH.DotNetFrameworkWebInstallerCaption = Installing Microsoft .NET framework <span class="number">%1</span> Web installer <span class="keyword">for</span> Windows...</span><br><span class="line">ENGLISH.DotNetFrameworkFailedToLaunch = .NET installation failed <span class="keyword">with</span> code: <span class="number">%1</span>. Please fix the error <span class="keyword">then</span> run this installer again.</span><br><span class="line">ENGLISH.DotNetFrameworkFailed1602 = .NET Framework installation was cancelled. This installation can <span class="keyword">continue</span>, but be aware that this application may <span class="keyword">not</span> run unless the .NET Framework installation <span class="keyword">is</span> completed successfully.</span><br><span class="line">ENGLISH.DotNetFrameworkFailed1603 = A fatal error occurred <span class="keyword">while</span> installing the .NET Framework. Please fix the error, <span class="keyword">then</span> run the installer again.</span><br><span class="line">ENGLISH.DotNetFrameworkFailed5100 = Your computer does <span class="keyword">not</span> meet the requirements <span class="keyword">of</span> the .NET Framework. Please consult the documentation.</span><br><span class="line">ENGLISH.DotNetFrameworkFailedOther = The .NET Framework installer exited with an unexpected status code &quot;%1&quot;. Please review any other messages shown by the installer to determine whether the installation completed successfully, and abort this installation and fix the problem if it did not.</span><br><span class="line"></span><br><span class="line">; .NET Framwork installation processing </span><br><span class="line">DEUTSCH.DotNetFrameworkOfflineInstallerCaption = Installation von Microsoft .NET Framework <span class="number">%1</span> offline Installationsprogramm für Windows ...</span><br><span class="line">DEUTSCH.DotNetFrameworkWebInstallerCaption = Installation von Microsoft .NET Framework <span class="number">%1</span> Web Installationsprogramm für Windows ...</span><br><span class="line">DEUTSCH.DotNetFrameworkFailedToLaunch = .NET Installation fehlgeschlagen mit Code: <span class="number">%1</span>. Bitte beheben Sie den Fehler und führen Sie das Installationsprogramm erneut aus.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailed1602 = .NET Framework-Installation wurde abgebrochen. Diese Installation kann fortgesetzt werden. Beachten Sie jedoch, dass diese Anwendung möglicherweise erst ausgeführt wird, wenn die .NET Framework-Installation erfolgreich abgeschlossen wurde.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailed1603 = Bei der Installation von .NET Framework ist ein schwerwiegender Fehler aufgetreten. Bitte beheben Sie den Fehler und führen Sie das Installationsprogramm erneut aus.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailed5100 = Ihr Computer entspricht nicht den Anforderungen von .NET Framework. Bitte konsultieren Sie die Dokumentation.</span><br><span class="line">DEUTSCH.DotNetFrameworkFailedOther = Das .NET Framework-Installationsprogramm wurde mit dem unerwarteten Statuscode &quot;%1&quot; beendet. Überprüfen Sie alle anderen vom Installationsprogramm angezeigten Meldungen, um festzustellen, ob die Installation erfolgreich abgeschlossen wurde, und brechen Sie diese Installation ab, und beheben Sie das Problem, wenn dies nicht der Fall ist.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;; Please <span class="keyword">do</span> <span class="keyword">not</span> delete the following, you can use it <span class="keyword">to</span> check the resgition <span class="keyword">of</span> the .NET DLL xxxxxxxxxxxxxxxxxxx.dll </span><br><span class="line">;; ProgID part, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM&quot;; Flags: uninsdeletekeyifempty</span><br><span class="line">;Root: HKCR; Subkey: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID&quot;; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM\CLSID&quot;; ValueType: string; ValueName: &quot;&quot;; ValueData: &quot;&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;&quot;; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part, TechTemp </span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;&quot;; Flags: uninsdeletekeyifempty</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;&quot;; ValueType: string; ValueName: &quot;&quot;; ValueData: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM&quot;; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part\InprocServer32, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;&quot;; ValueData: &quot;mscoree.dll&quot;; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;ThreadingModel&quot;; ValueData: &quot;Both&quot;; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;Class&quot;; ValueData: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM&quot;; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;Assembly&quot;; ValueData: &quot;xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;RuntimeVersion&quot;; ValueData: &quot;v4.0.30319&quot;; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32&quot;; ValueType: string; ValueName: &quot;CodeBase&quot;; ValueData: &quot;file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll&quot;; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part\InprocServer32\<span class="number">1.0</span>.<span class="number">0.0</span>, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0&quot;; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0&quot;; ValueType: string; ValueName: &quot;Class&quot;; ValueData: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM&quot;; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0&quot;; ValueType: string; ValueName: &quot;Assembly&quot;; ValueData: &quot;xxxxxxxxxxxxxxxxxxx, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null&quot;; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0&quot;; ValueType: string; ValueName: &quot;RuntimeVersion&quot;; ValueData: &quot;v4.0.30319&quot;; Flags: uninsdeletevalue</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\InprocServer32\1.0.0.0&quot;; ValueType: string; ValueName: &quot;CodeBase&quot;; ValueData: &quot;file:///&#123;#CommonappdataPathBackSlash&#125;/&#123;#AppPathBackSlash&#125;/bin/NET/xxxxxxxxxxxxxxxxxxx.dll&quot;; Flags: uninsdeletevalue</span><br><span class="line">;; CLSID Part\Implemented Categories, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories&quot;; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\Implemented Categories\&#123;&#123;&#123;#DotNetDllCLSIDImplementedCategories&#125;&#125;&quot;; Flags: uninsdeletekey</span><br><span class="line">;; CLSID Part\ProgId, TechTemp</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId&quot;; Flags: uninsdeletekey</span><br><span class="line">;Root: HKCR; Subkey: &quot;CLSID\&#123;&#123;&#123;#DotNetDllCLSID&#125;&#125;\ProgId&quot;; ValueType: string; ValueName: &quot;&quot;; ValueData: &quot;XXXXXXXXXXXX.MMMMMMMMMMMMMMM&quot;; Flags: uninsdeletevalue</span><br><span class="line"></span><br><span class="line">[Icons]</span><br><span class="line">Name: &quot;&#123;group&#125;\My Program&quot;; Filename: &quot;&#123;app&#125;\MyProg.exe&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Code]</span><br><span class="line"><span class="keyword">const</span> TO_COMPARE_DOT_NET = <span class="string">&#x27;v4.6.2&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bCancelWithoutPrompt: boolean;</span><br><span class="line">    bConnectWithNetwork: boolean;</span><br><span class="line">    bRequiresRestart: boolean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetCurrentRegAsmPath</span><span class="params">(S: <span class="keyword">String</span>)</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span> version: <span class="keyword">String</span>;</span><br><span class="line">    key: <span class="keyword">String</span>;</span><br><span class="line">    installPath: <span class="keyword">String</span>;</span><br><span class="line">    success: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    Result := S;</span><br><span class="line">    <span class="comment">// .NET 4.6.2 installs also as update to .NET 4.0 Full, you can also be on the safe side, check the windows 10 anniversary update</span></span><br><span class="line">    <span class="comment">// if the build was newer than (build 10.0.14393) with the code GetWindowsVersion &gt;= $A003839</span></span><br><span class="line">    <span class="keyword">if</span> TO_COMPARE_DOT_NET = <span class="string">&#x27;v4.6.2&#x27;</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">&#x27;v4\Full&#x27;</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">    <span class="comment">// .NET 4.5 installs as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">if</span> TO_COMPARE_DOT_NET = <span class="string">&#x27;v4.5&#x27;</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">&#x27;v4\Full&#x27;</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">&#x27;SOFTWARE\Microsoft\NET Framework Setup\NDP\&#x27;</span> + version;</span><br><span class="line">    success := RegQueryStringValue(HKLM, key, <span class="string">&#x27;InstallPath&#x27;</span>, installPath);</span><br><span class="line">    <span class="keyword">if</span> (success = True) <span class="keyword">and</span> (S = <span class="string">&#x27;&#x27;</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      Result := installPath;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFrameworkWebRuntime</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WasVisible: Boolean;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  ExtractTemporaryFile(<span class="string">&#x27;&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>);</span><br><span class="line">  WasVisible := WizardForm.PreparingLabel.Visible;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      WizardForm.PreparingLabel.Visible := True;</span><br><span class="line">      WizardForm.PreparingLabel.Caption := FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkWebInstallerCaption&#x27;</span>), [TO_COMPARE_DOT_NET]);</span><br><span class="line">      ExtractTemporaryFile(<span class="string">&#x27;&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>);</span><br><span class="line">      <span class="comment">//if not Exec(ExpandConstant(&#x27;&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;), &#x27;/q /norestart&#x27;, &#x27;&#x27;, SW_SHOW, ewWaitUntilTerminated, ResultCode) then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>), <span class="string">&#x27;/passive /norestart /showrmui /showfinalerror&#x27;</span>, <span class="string">&#x27;&#x27;</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-</span></span><br><span class="line">          <span class="comment">// you can interact with the user that the installation failed, for example: error code 2: the system cannot find the file specified.</span></span><br><span class="line">          Result := FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailedToLaunch&#x27;</span>), [SysErrorMessage(ResultCode)])     </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">case</span> ResultCode <span class="keyword">of</span></span><br><span class="line">            <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">// Successful</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">              MsgBox(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed1602&#x27;</span>), mbInformation, MB_OK);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed1603&#x27;</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed5100&#x27;</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">//MsgBox(FmtMessage(CustomMessage(&#x27;DotNetFrameworkFailedOther&#x27;), [IntToStr(resultCode)]), mbError, MB_OK);</span></span><br><span class="line">              Result := FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailedOther&#x27;</span>), IntToStr(ResultCode));     </span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">          <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.PreparingLabel.Visible := WasVisible;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  DeleteFile(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\&#123;#DotNetFrameWorkWebInstaller&#125;&#x27;</span>));</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallFrameworkOfflineRuntime</span><span class="params">()</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WasVisible: Boolean;</span><br><span class="line">  ResultCode: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  WasVisible := WizardForm.PreparingLabel.Visible;</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">      WizardForm.PreparingLabel.Visible := True;</span><br><span class="line">      WizardForm.PreparingLabel.Caption := FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkOfflineInstallerCaption&#x27;</span>), [TO_COMPARE_DOT_NET]);</span><br><span class="line">      ExtractTemporaryFile(<span class="string">&#x27;&#123;#DotNetFrameWorkOfflineInstaller&#125;&#x27;</span>);</span><br><span class="line">      <span class="comment">//if not Exec(ExpandConstant(&#x27;&#123;tmp&#125;\&#123;#DotNetFrameWorkOfflineInstaller&#125;&#x27;), &#x27;/q /norestart&#x27;, &#x27;&#x27;, SW_SHOW, ewWaitUntilTerminated, ResultCode) then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> Exec(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\&#123;#DotNetFrameWorkOfflineInstaller&#125;&#x27;</span>), <span class="string">&#x27;/passive /norestart /showrmui /showfinalerror&#x27;</span>, <span class="string">&#x27;&#x27;</span>, SW_SHOW, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="comment">// https://docs.microsoft.com/de-de/windows/win32/debug/system-error-codes--0-499-</span></span><br><span class="line">          <span class="comment">// you can interact with the user that the installation failed, for example: error code 2: the system cannot find the file specified.</span></span><br><span class="line">          Result := FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailedToLaunch&#x27;</span>), [SysErrorMessage(ResultCode)])     </span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          <span class="keyword">case</span> ResultCode <span class="keyword">of</span></span><br><span class="line">            <span class="number">0</span>: <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">// Successful</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1602</span> : <span class="keyword">begin</span></span><br><span class="line">              MsgBox(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed1602&#x27;</span>), mbInformation, MB_OK);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1603</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed1603&#x27;</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">1641</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">3010</span>: <span class="keyword">begin</span></span><br><span class="line">              bRequiresRestart := True;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="number">5100</span>: <span class="keyword">begin</span></span><br><span class="line">              Result := CustomMessage(<span class="string">&#x27;DotNetFrameworkFailed5100&#x27;</span>);</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">              <span class="comment">//MsgBox(FmtMessage(CustomMessage(&#x27;DotNetFrameworkFailedOther&#x27;), [IntToStr(resultCode)]), mbError, MB_OK);</span></span><br><span class="line">              Result := FmtMessage(CustomMessage(<span class="string">&#x27;DotNetFrameworkFailedOther&#x27;</span>), IntToStr(ResultCode));</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">          <span class="keyword">end</span>;</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">finally</span></span><br><span class="line">    WizardForm.PreparingLabel.Visible := WasVisible;</span><br><span class="line">  <span class="keyword">end</span>;</span><br><span class="line">  DeleteFile(ExpandConstant(<span class="string">&#x27;&#123;tmp&#125;\&#123;#DotNetFrameWorkOfflineInstaller&#125;&#x27;</span>));</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsNetWorkActivatedTried</span>:</span> boolean;</span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">  WinHttpReq: Variant;</span><br><span class="line">  Connected: Boolean;</span><br><span class="line">  iTriedTime: Integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Connected := False;</span><br><span class="line">  iTriedTime := <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">repeat</span></span><br><span class="line">    iTriedTime := iTriedTime + <span class="number">1</span>;</span><br><span class="line">    Log(<span class="string">&#x27;Checking connection to the server, try &#x27;</span> +  + IntToStr(iTriedTime) + <span class="string">&#x27; time.&#x27;</span>);</span><br><span class="line">    <span class="keyword">try</span> </span><br><span class="line">      WinHttpReq := CreateOleObject(<span class="string">&#x27;WinHttp.WinHttpRequest.5.1&#x27;</span>);</span><br><span class="line">      WinHttpReq.SetTimeouts(<span class="string">&#x27;3000&#x27;</span>, <span class="string">&#x27;3000&#x27;</span>, <span class="string">&#x27;3000&#x27;</span>, <span class="string">&#x27;3000&#x27;</span>);</span><br><span class="line">      <span class="comment">// Use your real server host name </span></span><br><span class="line">      WinHttpReq.Open(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;https://www.camtek.de/&#x27;</span>, False);</span><br><span class="line">      WinHttpReq.Send(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">      Log(<span class="string">&#x27;Connected to the server; status: &#x27;</span> + IntToStr(WinHttpReq.Status) + <span class="string">&#x27; &#x27;</span> +</span><br><span class="line">          WinHttpReq.StatusText);</span><br><span class="line">      Connected := True;</span><br><span class="line">    <span class="keyword">except</span></span><br><span class="line">      Log(<span class="string">&#x27;Error connecting to the server, msg: &#x27;</span> + GetExceptionMessage + <span class="string">&#x27;try again! &#x27;</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line">  <span class="keyword">until</span> (iTriedTime = <span class="number">3</span>) <span class="keyword">or</span> (Connected = True) ;</span><br><span class="line">  Result := Connected;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsDotNetDetected</span><span class="params">(version: <span class="keyword">string</span>; service: cardinal)</span>:</span> boolean;</span><br><span class="line"><span class="comment">// Indicates whether the specified version and service pack of the .NET Framework is installed.</span></span><br><span class="line"><span class="comment">// see the link: https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed?redirectedfrom=MSDN#net_b</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// version -- Specify one of these strings for the required .NET Framework version:</span></span><br><span class="line"><span class="comment">//    &#x27;v1.1.4322&#x27;     .NET Framework 1.1</span></span><br><span class="line"><span class="comment">//    &#x27;v2.0.50727&#x27;    .NET Framework 2.0</span></span><br><span class="line"><span class="comment">//    &#x27;v3.0&#x27;          .NET Framework 3.0</span></span><br><span class="line"><span class="comment">//    &#x27;v3.5&#x27;          .NET Framework 3.5</span></span><br><span class="line"><span class="comment">//    &#x27;v4\Client&#x27;     .NET Framework 4.0 Client Profile</span></span><br><span class="line"><span class="comment">//    &#x27;v4\Full&#x27;       .NET Framework 4.0 Full Installation</span></span><br><span class="line"><span class="comment">//    &#x27;v4.5&#x27;          .NET Framework 4.5 378389</span></span><br><span class="line"><span class="comment">//    &#x27;v4.6&#x27;          .NET Framework 4.6 393295</span></span><br><span class="line"><span class="comment">//    &#x27;v4.6.1&#x27;        .NET Framework 4.6.1 394254</span></span><br><span class="line"><span class="comment">//    &#x27;v4.6.2&#x27;        .NET Framework 4.6.2 394802</span></span><br><span class="line"><span class="comment">//    &#x27;v4.7&#x27;          .NET Framework 4.7 393295</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// service -- Specify any non-negative integer for the required service pack level:</span></span><br><span class="line"><span class="comment">//    0               No service packs required</span></span><br><span class="line"><span class="comment">//    1, 2, etc.      Service pack 1, 2, etc. required</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    key: <span class="keyword">string</span>;</span><br><span class="line">    install, release, serviceCount: cardinal;</span><br><span class="line">    check45, check462, success: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.6.2 installs also as update to .NET 4.0 Full, you can also be on the safe side, check the windows 10 anniversary update</span></span><br><span class="line">    <span class="comment">// if the build was newer than (build 10.0.14393) with the code GetWindowsVersion &gt;= $A003839</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">&#x27;v4.6.2&#x27;</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">&#x27;v4\Full&#x27;</span>;</span><br><span class="line">        check462 := true;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        check462 := false;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 installs as update to .NET 4.0 Full</span></span><br><span class="line">    <span class="keyword">if</span> version = <span class="string">&#x27;v4.5&#x27;</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        version := <span class="string">&#x27;v4\Full&#x27;</span>;</span><br><span class="line">        check45 := true;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span></span><br><span class="line">        check45 := false;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// installation key group for all .NET versions</span></span><br><span class="line">    key := <span class="string">&#x27;SOFTWARE\Microsoft\NET Framework Setup\NDP\&#x27;</span> + version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 3.0 uses value InstallSuccess in subkey Setup</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">&#x27;v3.0&#x27;</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key + <span class="string">&#x27;\Setup&#x27;</span>, <span class="string">&#x27;InstallSuccess&#x27;</span>, install);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := RegQueryDWordValue(HKLM, key, <span class="string">&#x27;Install&#x27;</span>, install);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.0/4.5 uses value Servicing instead of SP</span></span><br><span class="line">    <span class="keyword">if</span> Pos(<span class="string">&#x27;v4&#x27;</span>, version) = <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">&#x27;Servicing&#x27;</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">&#x27;SP&#x27;</span>, serviceCount);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.5 uses additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> check45 <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">&#x27;Release&#x27;</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= <span class="number">378389</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// .NET 4.6.2 uses additional value Release</span></span><br><span class="line">    <span class="keyword">if</span> check462 <span class="keyword">then</span> <span class="keyword">begin</span></span><br><span class="line">        success := success <span class="keyword">and</span> RegQueryDWordValue(HKLM, key, <span class="string">&#x27;Release&#x27;</span>, release);</span><br><span class="line">        success := success <span class="keyword">and</span> (release &gt;= <span class="number">394802</span>);</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">    Result := success <span class="keyword">and</span> (install = <span class="number">1</span>) <span class="keyword">and</span> (serviceCount &gt;= service);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">IsRequiredDotNetDetected</span>:</span> Boolean;  </span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    Result := IsDotNetDetected(TO_COMPARE_DOT_NET, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallDotNetOfflineRuntime</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bConnectWithNetwork <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        Result := True;</span><br><span class="line">      <span class="keyword">end</span> </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> ActiveLanguage = <span class="string">&#x27;ENGLISH&#x27;</span> <span class="keyword">then</span></span><br><span class="line">          <span class="keyword">begin</span></span><br><span class="line">             Result := True;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">          <span class="keyword">begin</span></span><br><span class="line">            Result := False;</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InstallDotNetWebRuntime</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> bConnectWithNetwork) <span class="keyword">and</span> ( <span class="keyword">not</span> ActiveLanguage = <span class="string">&#x27;ENGLISH&#x27;</span>) <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        Result := True;</span><br><span class="line">      <span class="keyword">end</span> </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">      <span class="keyword">begin</span></span><br><span class="line">        Result := False;</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">InitializeSetup</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    bConnectWithNetwork := IsNetWorkActivatedTried;</span><br><span class="line">    Result := True;</span><br><span class="line"><span class="keyword">end</span>; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PrepareToInstall</span><span class="params">(<span class="keyword">var</span> NeedsRestart: Boolean)</span>:</span> <span class="keyword">String</span>;</span><br><span class="line"><span class="keyword">var</span> bInstallWeb: boolean;</span><br><span class="line">    bInstallStd: boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="comment">// &#x27;NeedsRestart&#x27; only has an effect if we return a non-empty string, thus aborting the installation.</span></span><br><span class="line">  <span class="comment">// If the installers indicate that they want a restart, this should be done at the end of installation.</span></span><br><span class="line">  <span class="comment">// Therefore we set the global &#x27;restartRequired&#x27; if a restart is needed, and return this from NeedRestart()</span></span><br><span class="line">  bCancelWithoutPrompt := false;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> IsRequiredDotNetDetected <span class="keyword">then</span> </span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      bInstallWeb := InstallDotNetWebRuntime;</span><br><span class="line">      bInstallStd := InstallDotNetOfflineRuntime;</span><br><span class="line">      <span class="keyword">if</span> ( bInstallWeb = True) <span class="keyword">then</span> </span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          Result := InstallFrameworkWebRuntime</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( bInstallStd = True) <span class="keyword">then</span> </span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          Result := InstallFrameworkOfflineRuntime</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">          Result := InstallFrameworkWebRuntime</span><br><span class="line">        <span class="keyword">end</span>;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">end</span>;          </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NeedRestart</span><span class="params">()</span>:</span> Boolean;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  Result := bRequiresRestart;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure><p>欢迎订阅我的个人微信公众号，一起讨论学习。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;任务难点&quot;&gt;&lt;a href=&quot;#任务难点&quot; class=&quot;headerlink&quot; title=&quot;任务难点&quot;&gt;&lt;/a&gt;任务难点&lt;/h3&gt;&lt;p&gt;准备一个安装程序，以验证系统的体系结构并安装.NET。&lt;/p&gt;
&lt;h3 id=&quot;1-介绍&quot;&gt;&lt;a href=&quot;#1-介绍&quot; class=&quot;headerlink&quot; title=&quot;1. 介绍&quot;&gt;&lt;/a&gt;1. 介绍&lt;/h3&gt;&lt;p&gt;此安装脚本示例的目的是启动一个安装程序，该安装程序检查系统上当前安装的.NET版本，并仅在需要时安装一个。安装程序将在软件包中包括Microsoft提供的Web安装程序。 安装程序还将根据运行所在的体系结构安装一些库。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Inno Setup 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/Inno-Setup-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="Inno Setup" scheme="https://zicowarn.github.io/tags/Inno-Setup/"/>
    
      <category term=".NET" scheme="https://zicowarn.github.io/tags/NET/"/>
    
  </entry>
  
  <entry>
    <title>Inno Setup 如何以管理员的身份运行</title>
    <link href="https://zicowarn.github.io/2019/06/25/inno-01-run-as-admin/"/>
    <id>https://zicowarn.github.io/2019/06/25/inno-01-run-as-admin/</id>
    <published>2019-06-25T00:11:08.000Z</published>
    <updated>2020-08-25T03:13:33.868Z</updated>
    
    <content type="html"><![CDATA[<p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><h2 id="Inno-Setup-如何以管理员的身份相关"><a href="#Inno-Setup-如何以管理员的身份相关" class="headerlink" title="Inno Setup 如何以管理员的身份相关"></a>Inno Setup 如何以管理员的身份相关</h2><h3 id="1-如何以管理员身份运行一个Batch脚本文件"><a href="#1-如何以管理员身份运行一个Batch脚本文件" class="headerlink" title="1. 如何以管理员身份运行一个Batch脚本文件"></a>1. 如何以管理员身份运行一个Batch脚本文件</h3><p>If you are using <code>[Run]</code> section then make sure you use <code>runascurrentuser</code> flag (If this flag is specified, the spawned process will inherit Setup/Uninstall’s user credentials (typically, full administrative privileges))</p><a id="more"></a><p>Else there are three ways how to run applications programatically (recommended way):</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function Exec(const Filename, Params, WorkingDir: String; const ShowCmd: Integer; const Wait: TExecWait; var ResultCode: Integer): Boolean;</span><br><span class="line"></span><br><span class="line">function ShellExec(const Verb, Filename, Params, WorkingDir: String; const ShowCmd: Integer; const Wait: TExecWait; var ErrorCode: Integer): Boolean;</span><br><span class="line"></span><br><span class="line">function ShellExecAsOriginalUser(const Verb, Filename, Params, WorkingDir: String; const ShowCmd: Integer; const Wait: TExecWait; var ErrorCode: Integer): Boolean;</span><br></pre></td></tr></table></figure><p>You should use <code>Exec()</code> or <code>ShellExec()</code> because they open the specified file or performs another action specified by Verb, using the same credentials as Setup/Uninstall.</p><p>But none of mentioned ways will work if your installer is not running in elevated mode. So make sure the UAC window will appear before installer starts:</p><p>In section <code>[Setup]</code> use directive <code>PrivilegesRequired</code></p><p>Valid values:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">none`, `poweruser`, `admin`, or `lowest</span><br></pre></td></tr></table></figure><p>Use admin to ensure appropriate credentials.</p><h3 id="2-各个合法值在不同版本中的表现"><a href="#2-各个合法值在不同版本中的表现" class="headerlink" title="2. 各个合法值在不同版本中的表现"></a>2. 各个合法值在不同版本中的表现</h3><h4 id="合法值为："><a href="#合法值为：" class="headerlink" title="合法值为："></a>合法值为：</h4><ul><li>none, poweruser, admin, or lowest</li></ul><h4 id="默认值为：Default-value"><a href="#默认值为：Default-value" class="headerlink" title="默认值为：Default value:"></a>默认值为：Default value:</h4><ul><li>admin</li></ul><h4 id="描述Description"><a href="#描述Description" class="headerlink" title="描述Description:"></a>描述Description:</h4><p>The effect of this directive depends on which version of Windows the user is running:</p><p>此参数的效果取决于用户运行的Windows版本：</p><p><strong>On Windows Vista and later:</strong></p><p>This directive affects whether elevated rights are requested (via a User Account Control dialog) when the installation is started.</p><p>该指令影响安装开始时是否要求提升权限（通过“用户帐户控制”对话框）。</p><p>When set to admin (the default) or poweruser, Setup will always run with administrative privileges. If Setup was started by an unprivileged user, Windows will ask for the password to an account that has administrative privileges, and Setup will then run under that account.</p><p>当设置为admin（默认）或超级用户时，安装程序将始终以管理特权运行。 如果安装程序是由非特权用户启动的，则Windows将要求输入具有管理特权的帐户的密码，然后安装程序将在该帐户下运行。</p><p>When set to none, Setup will only run with administrative privileges if it was started by a member of the Administrators group. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p><p>如果设置为none，则安装程序仅由Administrators组的成员启动时才具有管理特权。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p><p>When set to lowest, Setup will not request to be run administrative privileges even if it was started by a member of the Administrators group. Additionally, the uninstall info root key will always be HKEY_CURRENT_USER, and the “common” forms of the Shell Folder constants are mapped to the “user” forms, even if administrative privileges are available. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p><p>设置为最低时，即使安装程序是由Administrators组的成员启动的，它也不会请求运行管理权限。 此外，卸载信息的根密钥将始终为HKEY_CURRENT_USER，并且即使具有管理特权，Shell文件夹常量的“公共”形式也将映射到“用户”形式。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p><p><strong>On Windows NT/2000/XP/2003</strong></p><p>This directive specifies the minimum user privileges required to run the installation.</p><p>该指令指定运行安装所需的最低用户特权。</p><p>When set to admin (the default), Setup will only run if the user is a member of the Administrators group. Otherwise, it will display the following message and exit: “You must be logged in as an administrator when installing this program.”</p><p>当设置为admin（默认值）时，仅当用户是Administrators组的成员时，安装程序才会运行。 否则，它将显示以下消息并退出：“安装此程序时，您必须以管理员身份登录。”</p><p>When set to poweruser, Setup will only run if the user is a member of the Administrators or Power Users groups. Otherwise, it will display the following message and exit: “You must be logged in as an administrator or as a member of the Power Users group when installing this program.”</p><p>设置为poweruser时，仅当用户是Administrators或Power Users组的成员时，安装程序才会运行。 否则，它将显示以下消息并退出：“安装此程序时，您必须以管理员或Power Users组成员的身份登录。”</p><p>When set to none Setup will not check the user’s group membership. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p><p>设置为none时，安装程序将不检查用户的组成员身份。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p><p>When set to lowest Setup will not check the user’s group membership. Additionally, the uninstall info root key will always be HKEY_CURRENT_USER, and the “common” forms of the Shell Folder constants are mapped to the “user” forms, even if administrative privileges are available. Do not use this setting unless you are sure your installation will run successfully on unprivileged accounts.</p><p>设置为最低时，安装程序将不检查用户的组成员身份。 此外，卸载信息的根密钥将始终为HKEY_CURRENT_USER，并且即使具有管理特权，Shell文件夹常量的“公共”形式也将映射到“用户”形式。 除非您确定安装将在非特权帐户上成功运行，否则不要使用此设置。</p><p><strong>On Windows 95/98/Me</strong></p><p>This directive has no effect on these versions of Windows.</p><p>该指令对这些版本的Windows无效。</p><h3 id="以管理员身份安装和非管理员身份安装的区别"><a href="#以管理员身份安装和非管理员身份安装的区别" class="headerlink" title="以管理员身份安装和非管理员身份安装的区别"></a>以管理员身份安装和非管理员身份安装的区别</h3><p>An installation can run in one of two modes: administrative or non administrative. Which mode is selected is specified by the <a href="http://www.jrsoftware.org/ishelp/topic_setup_privilegesrequired.htm">PrivilegesRequired</a> and <a href="http://www.jrsoftware.org/ishelp/topic_setup_privilegesrequiredoverridesallowed.htm">PrivilegesRequiredOverridesAllowed</a> [Setup] section directives.</p><p>In administrative install mode:</p><ul><li>The <code>&#123;group&#125;</code> folder is created in the <em>All Users</em> profile.</li><li>The “auto” form of the directory and Shell Folder constants is mapped to the “common” form.</li><li>The <a href="http://www.jrsoftware.org/ishelp/topic_registrysection.htm">HKA</a> and uninstall info root keys will be HKEY_LOCAL_MACHINE.</li></ul><p>In non administrative install mode:</p><ul><li>The <code>&#123;group&#125;</code> folder is created in the current user’s profile.</li><li>The “auto” form of the directory and Shell Folder constants is mapped to the “user” form.</li><li>The <a href="http://www.jrsoftware.org/ishelp/topic_registrysection.htm">HKA</a> and uninstall info root keys will be HKEY_CURRENT_USER.</li></ul><p><strong>Notes:</strong></p><p>Regardless of the version of Windows, if the installation is running in administrative install mode then you should be careful about making any per-user area changes: such changes may not achieve what you are intending. The compiler will warn you about this, which can be disabled using <a href="http://www.jrsoftware.org/ishelp/topic_setup_useduserareaswarning.htm">UsedUserAreasWarning</a>.</p><p>无论Windows的版本如何，如果安装均以管理安装模式运行，则应谨慎进行每个用户区域的更改：此类更改可能无法实现您的预期。 编译器将对此警告，可以使用<a href="http://www.jrsoftware.org/ishelp/topic_setup_useduserareaswarning.htm">UsedUserAreasWarning</a>禁用。</p><p>If the installation is running in non administrative install mode, but administrative privileges are available anyway then Setup or the [Code] section might still make use of these privileges. For this reason the uninstaller will always be marked as requiring administrative privileges in this case, just as if the installation was running in administrative install mode.</p><p>如果安装程序在非管理安装模式下运行，但是仍然具有管理特权，则安装程序或[Code]部分可能仍会使用这些特权。 因此，在这种情况下，卸载程序将始终被标记为需要管理特权，就像安装在管理安装模式下运行一样。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;Inno-Setup-如何以管理员的身份相关&quot;&gt;&lt;a href=&quot;#Inno-Setup-如何以管理员的身份相关&quot; class=&quot;headerlink&quot; title=&quot;Inno Setup 如何以管理员的身份相关&quot;&gt;&lt;/a&gt;Inno Setup 如何以管理员的身份相关&lt;/h2&gt;&lt;h3 id=&quot;1-如何以管理员身份运行一个Batch脚本文件&quot;&gt;&lt;a href=&quot;#1-如何以管理员身份运行一个Batch脚本文件&quot; class=&quot;headerlink&quot; title=&quot;1. 如何以管理员身份运行一个Batch脚本文件&quot;&gt;&lt;/a&gt;1. 如何以管理员身份运行一个Batch脚本文件&lt;/h3&gt;&lt;p&gt;If you are using &lt;code&gt;[Run]&lt;/code&gt; section then make sure you use &lt;code&gt;runascurrentuser&lt;/code&gt; flag (If this flag is specified, the spawned process will inherit Setup/Uninstall’s user credentials (typically, full administrative privileges))&lt;/p&gt;
    
    </summary>
    
    
      <category term="Inno Setup 相关 - 实战经验" scheme="https://zicowarn.github.io/categories/Inno-Setup-%E7%9B%B8%E5%85%B3-%E5%AE%9E%E6%88%98%E7%BB%8F%E9%AA%8C/"/>
    
    
      <category term="Inno Setup" scheme="https://zicowarn.github.io/tags/Inno-Setup/"/>
    
  </entry>
  
  <entry>
    <title>Python 杂记之 根据版本号自动调用泛函数</title>
    <link href="https://zicowarn.github.io/2019/04/25/0807-ma-auto-generic-function/"/>
    <id>https://zicowarn.github.io/2019/04/25/0807-ma-auto-generic-function/</id>
    <published>2019-04-25T00:11:08.000Z</published>
    <updated>2020-11-19T20:16:09.993Z</updated>
    
    <content type="html"><![CDATA[<p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><p>在未来使用中，窗口的表现形式可能根据版本的不同而不同，但又需要同时要保证代码的向下兼容，也就说可以不断地添加了新的窗口，那老用户的老版本也应该能够继续使用。所以要根据版本信息进行代码（至少是窗体生成部分的代码）的调度。</p><a id="more"></a><ol><li><p>调度方式1， 传统设计理念中，也就是预定义一部分类方法，在根据实际需求，用字典索引的方式查找类方法或者函数。如下，</p><ul><li><p>可以如下方式进行调度:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p1</span>(<span class="params">args</span>):</span></span><br><span class="line">    whatever</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p2</span>(<span class="params">more args</span>):</span></span><br><span class="line">    whatever</span><br><span class="line"></span><br><span class="line">myDict = &#123;</span><br><span class="line">    <span class="string">&quot;P1&quot;</span>: p1,</span><br><span class="line">    <span class="string">&quot;P2&quot;</span>: p2,</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&quot;Pn&quot;</span>: pn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myMain</span>(<span class="params">name</span>):</span></span><br><span class="line">    myDict[name]()</span><br></pre></td></tr></table></figure></li><li><p>或者以下列方式进行调度：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">myMain</span>(<span class="params">key</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ExecP1</span>():</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ExecP2</span>():</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ExecP3</span>():</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ExecPn</span>():</span></span><br><span class="line">        <span class="keyword">pass</span> </span><br><span class="line">    <span class="built_in">locals</span>()[<span class="string">&#x27;Exec&#x27;</span> + key]()</span><br></pre></td></tr></table></figure><p>两种的调度思路是一致的。</p></li></ul></li><li><p>调度方式2， Python标准库种有一个functools模块，该模块可以为可调用对象定义高阶函数和操作。即，依据现有函数定义新的函数。我们实现的方式运用了partial函数和singledispatch函数，parital由于定义偏函数，也就是为了固定函数或者方法的一个参数，在该实现方式种用于向Event的Handler传递第二个参数。singledispatch是用于函数调度，即将函数装饰为泛函数。其根据参数的数据类型实现函数的自主调度。因为我们要实现类方法根据不同的版本进行自主调度，就意味着需要将版本作为一种新的数据类型。</p><ul><li>基本代码如下：</li></ul></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx </span><br><span class="line"><span class="keyword">import</span> wx.adv </span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> modules </span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> singledispatch, update_wrapper, partial</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">methdispatch</span>(<span class="params">func</span>):</span></span><br><span class="line">  dispatcher = singledispatch(func) </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">_args, **kw</span>):</span> </span><br><span class="line">    <span class="keyword">return</span> dispatcher.dispatch(args[<span class="number">1</span>].**<span class="class"><span class="keyword">class</span>**)(<span class="params">_args, **kw</span>) </span></span><br><span class="line">  wrapper.register = dispatcher.register </span><br><span class="line">  update_wrapper(wrapper, func) </span><br><span class="line">  <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">thisModule = modules[__name__]</span><br><span class="line"> <span class="comment"># assign the new types inodule level m</span></span><br><span class="line"> <span class="built_in">setattr</span>(thisModule, <span class="string">&#x27;v1_20&#x27;</span>, <span class="built_in">type</span>(<span class="string">&#x27;v1_20&#x27;</span>, (<span class="built_in">object</span>,), &#123;&#125;))</span><br><span class="line"> <span class="built_in">setattr</span>(thisModule, <span class="string">&#x27;v1_30&#x27;</span>, <span class="built_in">type</span>(<span class="string">&#x27;v1_30&#x27;</span>, (<span class="built_in">object</span>,), &#123;&#125;))</span><br><span class="line"> <span class="built_in">setattr</span>(thisModule, <span class="string">&#x27;v1_40&#x27;</span>, <span class="built_in">type</span>(<span class="string">&#x27;v1_40&#x27;</span>, (<span class="built_in">object</span>,), &#123;&#125;))</span><br><span class="line"> <span class="built_in">setattr</span>(thisModule, <span class="string">&#x27;v1_50&#x27;</span>, <span class="built_in">type</span>(<span class="string">&#x27;v1_50&#x27;</span>, (<span class="built_in">object</span>,), &#123;&#125;))</span><br><span class="line"> <span class="built_in">setattr</span>(thisModule, <span class="string">&#x27;v1_60&#x27;</span>, <span class="built_in">type</span>(<span class="string">&#x27;v1_60&#x27;</span>, (<span class="built_in">object</span>,), &#123;&#125;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassDialog</span>(<span class="params">wx.Dialog</span>):</span></span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent, title=<span class="string">&quot;Test Demo&quot;</span>, size=wx.DefaultSize, pos=wx.DefaultPosition, style=wx.DEFAULT_DIALOG_STYLE, strVersion=<span class="string">&quot;v1_20&quot;</span>, name=<span class="string">&quot;TestDemo&quot;</span></span>):</span></span><br><span class="line">         <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">         strVersion, format v1_20</span></span><br><span class="line"><span class="string">         &quot;&quot;&quot;</span></span><br><span class="line">         wx.Dialog.__init__(self, parent, wx.ID_ANY, title,</span><br><span class="line">                                size=size,</span><br><span class="line">                                pos=pos,</span><br><span class="line">                                style=style,</span><br><span class="line">                                name=name)</span><br><span class="line">         <span class="keyword">try</span>:</span><br><span class="line">             self.objVersion = <span class="built_in">eval</span>(strVersion)()</span><br><span class="line">         <span class="keyword">except</span>:</span><br><span class="line">             self.objVersion = <span class="literal">None</span></span><br><span class="line">         self.CreateWidgets(self.objVersion)</span><br><span class="line"></span><br><span class="line"><span class="meta">     @methdispatch</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">CreateWidgets</span>(<span class="params">self, objVersion</span>):</span>  <span class="comment"># @UnusedVariable</span></span><br><span class="line">         self.panel = wx.Panel(self)</span><br><span class="line">         vBoxSizer = wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">         self.quote = wx.StaticText(self.panel, label=<span class="string">&quot;Your quote: Default &quot;</span>, pos=(<span class="number">20</span>, <span class="number">30</span>))</span><br><span class="line">         vBoxSizer.Add(self.quote, <span class="number">5</span>)</span><br><span class="line">         self.btn = wx.Button(self.panel, wx.ID_ANY, size=wx.DefaultSize, label=<span class="string">&quot;Test&quot;</span>)</span><br><span class="line">         vBoxSizer.Add(self.btn, <span class="number">1</span>)</span><br><span class="line">         self.panel.SetSizer(vBoxSizer)</span><br><span class="line">         self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br><span class="line"></span><br><span class="line"><span class="meta">     @CreateWidgets.register(<span class="params">v1_20</span>)  </span><span class="comment"># @UndefinedVariable</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">self, objVersion</span>):</span>  <span class="comment"># @UnusedVariable</span></span><br><span class="line">         self.panel = wx.Panel(self)</span><br><span class="line">         vBoxSizer = wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">         self.quote = wx.StaticText(self.panel, label=<span class="string">&quot;Your quote: 1.20 &quot;</span>, pos=(<span class="number">20</span>, <span class="number">30</span>))</span><br><span class="line">         vBoxSizer.Add(self.quote, <span class="number">5</span>)</span><br><span class="line">         self.btn = wx.Button(self.panel, wx.ID_ANY, size=wx.DefaultSize, label=<span class="string">&quot;Test&quot;</span>)</span><br><span class="line">         vBoxSizer.Add(self.btn, <span class="number">1</span>)</span><br><span class="line">         self.panel.SetSizer(vBoxSizer)</span><br><span class="line">         self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br><span class="line"></span><br><span class="line"><span class="meta">     @CreateWidgets.register(<span class="params">v1_30</span>)  </span><span class="comment"># @UndefinedVariable</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">self, objVersion</span>):</span>  <span class="comment"># @UnusedVariable @DuplicatedSignature</span></span><br><span class="line">         self.panel = wx.Panel(self)</span><br><span class="line">         vBoxSizer = wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">         self.quote = wx.StaticText(self.panel, label=<span class="string">&quot;Your quote: 1.30 &quot;</span>, pos=(<span class="number">20</span>, <span class="number">30</span>))</span><br><span class="line">         vBoxSizer.Add(self.quote, <span class="number">5</span>)</span><br><span class="line">         self.btn = wx.Button(self.panel, wx.ID_ANY, size=wx.DefaultSize, label=<span class="string">&quot;Test&quot;</span>)</span><br><span class="line">         vBoxSizer.Add(self.btn, <span class="number">1</span>)</span><br><span class="line">         self.panel.SetSizer(vBoxSizer)</span><br><span class="line">         self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br><span class="line"></span><br><span class="line"><span class="meta">     @methdispatch </span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">OnButtonClicked</span>(<span class="params">self, objVersion, event</span>):</span>  <span class="comment"># @UnusedVariable</span></span><br><span class="line">         print(<span class="string">&quot;aaaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">     @OnButtonClicked.register(<span class="params">v1_20</span>)  </span><span class="comment"># @UndefinedVariable</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">self, objVersion, event</span>):</span>  <span class="comment"># @UndefinedVariable @DuplicatedSignature @UnusedVariable</span></span><br><span class="line">         print(event.EventObject.Name)</span><br><span class="line">         print(<span class="string">&quot;bbbbb&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">SubClassDialog</span>(<span class="params">ClassDialog</span>):</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent, title=<span class="string">&quot;Test Demo&quot;</span>, size=wx.DefaultSize, pos=wx.DefaultPosition, style=wx.DEFAULT_DIALOG_STYLE, strVersion=<span class="string">&quot;v1_20&quot;</span>, name=<span class="string">&quot;TestDemo&quot;</span></span>):</span></span><br><span class="line">         <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">         strVersion, format v1_20</span></span><br><span class="line"><span class="string">         &quot;&quot;&quot;</span></span><br><span class="line">         ClassDialog.__init__(self, parent, title=title, size=size, pos=pos, style=style, strVersion=strVersion, name=name)  <span class="comment"># @UndefinedVariable</span></span><br><span class="line"></span><br><span class="line"><span class="meta">     @ClassDialog.CreateWidgets.register(<span class="params">v1_40</span>)  </span><span class="comment"># @UndefinedVariable</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">self, objVersion</span>):</span>  <span class="comment"># @DuplicatedSignature @UnusedVariable</span></span><br><span class="line">         print(<span class="string">&quot;1.40&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">     @ClassDialog.CreateWidgets.register(<span class="params">v1_50</span>)  </span><span class="comment"># @UndefinedVariable</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">self, objVersion</span>):</span>  <span class="comment"># @DuplicatedSignature @UnusedVariable</span></span><br><span class="line">         print(<span class="string">&quot;1.50&quot;</span>)</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">MyFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">     <span class="string">&quot;&quot;&quot; We simply derive a new class of Frame. &quot;&quot;&quot;</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent, title</span>):</span>  <span class="comment"># @DuplicatedSignature</span></span><br><span class="line">         wx.Frame.__init__(self, parent, title=title, size=(<span class="number">200</span>,<span class="number">100</span>))</span><br><span class="line">         dlg=SubClassDialog(self, strVersion=<span class="string">&quot;v1_x0&quot;</span>)</span><br><span class="line">         res = dlg.ShowModal()</span><br><span class="line">         <span class="comment">#self.Show(True)</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">     app = wx.App(<span class="literal">False</span>)</span><br><span class="line">     frame = MyFrame(<span class="literal">None</span>, <span class="string">&#x27;Small editor&#x27;</span>)  <span class="comment"># @UnusedVariable</span></span><br><span class="line">     app.MainLoop()</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">     main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> 在日常实践种singledispatch都是用来调度函数的，如果直接用在类方法上，会出现输入参数异常的问题。在这里我们就需要重新定义singledispatch进而得到一个methdispatch的函数。因为类方法的第一个参数为self即实例，所以我们要在函数种dispatch()第二个个参数。检查其数据类型然后调度注册的函数。</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">methdispatch</span>(<span class="params">func</span>):</span></span><br><span class="line">    dispatcher = singledispatch(func)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kw</span>):</span></span><br><span class="line">        <span class="keyword">return</span> dispatcher.dispatch(args[<span class="number">1</span>].__class__)(*args, **kw)</span><br><span class="line">    wrapper.register = dispatcher.register</span><br><span class="line">    update_wrapper(wrapper, func)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure><p> 为了实现类方法依照版本类型自主调度，上文中说到，我们要将版本注册成新的数据类型，或者类。在未来任何需要新的版本，都要将该版本好吧注册成新的类，代码如下：</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">thisModule = modules[__name__]</span><br><span class="line"><span class="comment"># assign the new types inodule level m</span></span><br><span class="line"><span class="built_in">setattr</span>(thisModule, <span class="string">&#x27;v1_20&#x27;</span>, <span class="built_in">type</span>(<span class="string">&#x27;v1_20&#x27;</span>, (<span class="built_in">object</span>,), &#123;&#125;))</span><br><span class="line"><span class="built_in">setattr</span>(thisModule, <span class="string">&#x27;v1_30&#x27;</span>, <span class="built_in">type</span>(<span class="string">&#x27;v1_30&#x27;</span>, (<span class="built_in">object</span>,), &#123;&#125;))</span><br><span class="line"><span class="built_in">setattr</span>(thisModule, <span class="string">&#x27;v1_40&#x27;</span>, <span class="built_in">type</span>(<span class="string">&#x27;v1_40&#x27;</span>, (<span class="built_in">object</span>,), &#123;&#125;))</span><br><span class="line"><span class="built_in">setattr</span>(thisModule, <span class="string">&#x27;v1_50&#x27;</span>, <span class="built_in">type</span>(<span class="string">&#x27;v1_50&#x27;</span>, (<span class="built_in">object</span>,), &#123;&#125;))</span><br><span class="line"><span class="built_in">setattr</span>(thisModule, <span class="string">&#x27;v1_60&#x27;</span>, <span class="built_in">type</span>(<span class="string">&#x27;v1_60&#x27;</span>, (<span class="built_in">object</span>,), &#123;&#125;))</span><br></pre></td></tr></table></figure><p> 普通的类方法可以用如下的代码实现调度，如果采用上述的方式进行版本数据类型的声明，一些IDE并不能够自动找到新注册的数据类型，就会出现该类型未找到的错，如果使用Eclipse就需要添加特别注释@UndefinedVariable：</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CreateWidgets.register(<span class="params">v1_30</span>)  </span><span class="comment"># @UndefinedVariable</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">self, objVersion</span>):</span>  <span class="comment"># @UnusedVariable @DuplicatedSignature</span></span><br><span class="line">    self.panel = wx.Panel(self)</span><br><span class="line">    vBoxSizer = wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">    self.quote = wx.StaticText(self.panel, label=<span class="string">&quot;Your quote: 1.30 &quot;</span>, pos=(<span class="number">20</span>, <span class="number">30</span>))</span><br><span class="line">    vBoxSizer.Add(self.quote, <span class="number">5</span>)</span><br><span class="line">    self.btn = wx.Button(self.panel, wx.ID_ANY, size=wx.DefaultSize, label=<span class="string">&quot;Test&quot;</span>)</span><br><span class="line">    vBoxSizer.Add(self.btn, <span class="number">1</span>)</span><br><span class="line">    self.panel.SetSizer(vBoxSizer)</span><br><span class="line">    self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br></pre></td></tr></table></figure><p> 针对一些特别的类方法如，事件处理函数，就要用到partial函数，代码如下。需要注意的是在这里partial固定的是类方法OnButtonClicked的第一个参数，第二个参数是Event。 理解了这些，我们就可以根据版本的不同调度同一事件的不同时间的处理方法了。</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br></pre></td></tr></table></figure><p> 注册同一事件处理函数的泛函数方法如下，泛函数的名称可以自由定义，但是_在这里确实是一个很好的选择，如果某一版本的泛函数没被注册，就会使用函数的本体:</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@methdispatch </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">OnButtonClicked</span>(<span class="params">self, objVersion, event</span>):</span>  <span class="comment"># @UnusedVariable</span></span><br><span class="line">    print(<span class="string">&quot;aaaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@OnButtonClicked.register(<span class="params">v1_20</span>)  </span><span class="comment"># @UndefinedVariable</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">self, objVersion, event</span>):</span>  <span class="comment"># @DuplicatedSignature @UnusedVariable</span></span><br><span class="line">    print(event.EventObject.Name)</span><br><span class="line">    print(<span class="string">&quot;bbbbb&quot;</span>)</span><br></pre></td></tr></table></figure><p> 上述的内容都是在一个Python种的使用情况，下面我们介绍一下如何跨模块实现上述内容，在跨模块使用该调度方式的时候，需要注意要从基本模块加载版本的数据类型，在注册泛函数的时候写法也于在同一模块种的不同，本例种：@ClassDialog.CreateWidgets.register(v1_60)，从类名，类方法名再进而注册版本类型。</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="keyword">from</span> test <span class="keyword">import</span> ClassDialog, v1_60 <span class="comment"># @UnusedImport @UnresolvedImport</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubClassDialogInExtraModule</span>(<span class="params">ClassDialog</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent, title=<span class="string">&quot;Test Demo&quot;</span>, size=wx.DefaultSize, pos=wx.DefaultPosition, style=wx.DEFAULT_DIALOG_STYLE, strVersion=<span class="string">&quot;v1_20&quot;</span>, name=<span class="string">&quot;TestDemo&quot;</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        strVersion, format v1_20</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        ClassDialog.__init__(self, parent, title=title, size=size, pos=pos, style=style, strVersion=strVersion, name=name)  <span class="comment"># @UndefinedVariable</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @ClassDialog.CreateWidgets.register(<span class="params">v1_60</span>)  </span><span class="comment"># @UndefinedVariable</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_</span>(<span class="params">self, objVersion</span>):</span>  <span class="comment"># @UnusedVariable @DuplicatedSignature</span></span><br><span class="line">        self.panel = wx.Panel(self)</span><br><span class="line">        vBoxSizer = wx.BoxSizer(wx.VERTICAL)</span><br><span class="line">        self.quote = wx.StaticText(self.panel, label=<span class="string">&quot;Your quote: 1.60 &quot;</span>, pos=(<span class="number">20</span>, <span class="number">30</span>))</span><br><span class="line">        vBoxSizer.Add(self.quote, <span class="number">5</span>)</span><br><span class="line">        self.btn = wx.Button(self.panel, wx.ID_ANY, size=wx.DefaultSize, label=<span class="string">&quot;Test&quot;</span>)</span><br><span class="line">        vBoxSizer.Add(self.btn, <span class="number">1</span>)</span><br><span class="line">        self.panel.SetSizer(vBoxSizer)</span><br><span class="line">        self.btn.Bind(wx.EVT_BUTTON, partial(self.OnButtonClicked, self.objVersion))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFrame</span>(<span class="params">wx.Frame</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; We simply derive a new class of Frame. &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent, title</span>):</span>  <span class="comment"># @DuplicatedSignature</span></span><br><span class="line">        wx.Frame.__init__(self, parent, title=title, size=(<span class="number">200</span>,<span class="number">100</span>))</span><br><span class="line">        dlg=SubClassDialogInExtraModule(self, strVersion=<span class="string">&quot;v1_60&quot;</span>)</span><br><span class="line">        res = dlg.ShowModal()  <span class="comment"># @UnusedVariable</span></span><br><span class="line">        <span class="comment">#self.Show(True)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    app = wx.App(<span class="literal">False</span>)</span><br><span class="line">    frame = MyFrame(<span class="literal">None</span>, <span class="string">&#x27;Small editor&#x27;</span>)  <span class="comment"># @UnusedVariable</span></span><br><span class="line">    app.MainLoop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p> 上述就是使用functools种的两个函数实现依据不同版本调度不同的泛函数的全部内容</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;在未来使用中，窗口的表现形式可能根据版本的不同而不同，但又需要同时要保证代码的向下兼容，也就说可以不断地添加了新的窗口，那老用户的老版本也应该能够继续使用。所以要根据版本信息进行代码（至少是窗体生成部分的代码）的调度。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python 相关 - 8. Python 杂记" scheme="https://zicowarn.github.io/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/"/>
    
    
      <category term="Python" scheme="https://zicowarn.github.io/tags/Python/"/>
    
      <category term="杂记" scheme="https://zicowarn.github.io/tags/%E6%9D%82%E8%AE%B0/"/>
    
      <category term="自动调用" scheme="https://zicowarn.github.io/tags/%E8%87%AA%E5%8A%A8%E8%B0%83%E7%94%A8/"/>
    
      <category term="泛函数" scheme="https://zicowarn.github.io/tags/%E6%B3%9B%E5%87%BD%E6%95%B0/"/>
    
  </entry>
  
  <entry>
    <title>Python 杂记之 不同版本间剪切板代码兼容性问题</title>
    <link href="https://zicowarn.github.io/2018/12/20/0805-ma-compability-issue/"/>
    <id>https://zicowarn.github.io/2018/12/20/0805-ma-compability-issue/</id>
    <published>2018-12-20T00:11:08.000Z</published>
    <updated>2020-08-19T05:26:38.606Z</updated>
    
    <content type="html"><![CDATA[<p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><h2 id="剪切板的基本操作"><a href="#剪切板的基本操作" class="headerlink" title="剪切板的基本操作"></a>剪切板的基本操作</h2><p>在Python的实际应用中有时候会遇到对剪切板进行操作的问题。剪切板的基本操作需求如下：</p><ul><li>获取剪切板中的内容。</li><li>向剪切板中注入内容。</li><li>清除剪切板的内容。</li></ul><a id="more"></a><p>使用Python对剪切板进行操作，可以使用tkinter和ctypes这两个标准库。或者使用Qt或者wxpython这些第三方模块（库）来实现。</p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/LNbO7CDlxmad3eibCibvYHAE43LAlxR0KtSSXwcJAlficsqnvlLNnicHfJPN2C4VYBICeeVI71H81mkWvViaMdQ4KDw/640?wx_fmt=png" alt="img"></p><h2 id="使用ctypes标准库操作剪切板"><a href="#使用ctypes标准库操作剪切板" class="headerlink" title="使用ctypes标准库操作剪切板"></a>使用ctypes标准库操作剪切板</h2><p>使用tkinter标准库或者第三方的Qt或者wxpython，这些实现方式常常是用在在<strong>图形界面化</strong>的项目中的，比如结合按钮事件等。使用ctypes就可以直接在<strong>非图形化界面</strong>项目中实现对剪切板的操作。或者使用pyperclip第三方模块也可实现跨平台的普通项目中对剪切板的操作，基本实现代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line">CF_TEXT = <span class="number">1</span></span><br><span class="line">kernel32 = ctypes.windll.kernel32</span><br><span class="line">user32 = ctypes.windll.user32</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>():</span></span><br><span class="line">    rts = <span class="string">&quot;&quot;</span></span><br><span class="line">    user32.OpenClipboard(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> user32.IsClipboardFormatAvailable(CF_TEXT):</span><br><span class="line">        data = user32.GetClipboardData(CF_TEXT)</span><br><span class="line">        data_locked = kernel32.GlobalLock(data)</span><br><span class="line">        text = ctypes.c_char_p(data_locked)</span><br><span class="line">        print(text.value)</span><br><span class="line">        rts = text.value</span><br><span class="line">        kernel32.GlobalUnlock(data_locked)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;no text in clipboard&#x27;</span>)</span><br><span class="line">    user32.CloseClipboard()</span><br><span class="line">    <span class="keyword">return</span> rts</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set</span>(<span class="params">text</span>):</span></span><br><span class="line">    GMEM_DDESHARE = <span class="number">0x2000</span></span><br><span class="line">    user32.OpenClipboard(<span class="number">0</span>)</span><br><span class="line">    user32.EmptyClipboard()</span><br><span class="line">    hCd = ctypes.windll.kernel32.GlobalAlloc(GMEM_DDESHARE, <span class="built_in">len</span>(<span class="built_in">bytes</span>(text))+<span class="number">1</span>)</span><br><span class="line">    pchData = ctypes.windll.kernel32.GlobalLock(hCd)</span><br><span class="line">    ctypes.cdll.msvcrt.strcpy(ctypes.c_char_p(pchData), <span class="built_in">bytes</span>(text))</span><br><span class="line">    kernel32.GlobalUnlock(hCd)</span><br><span class="line">    user32.SetClipboardData(CF_TEXT, hCd)</span><br><span class="line">    user32.CloseClipboard()</span><br></pre></td></tr></table></figure><p>上述代码中，比较难以理解的应该是GlobalLock和GlobalUnlock，如果有C++的开发背景应该很容易理解这两个函数。简单解释：</p><blockquote><p>GlobalLock()函数 说明：锁定内存中指定的内存块，并返回一个地址值，令其指向内存块的起始处。除非用 GlobalUnlock 函数将内存块解锁，否则地址会一直保持有效。Windows 为每个内存对象都维持着一个锁定计数。对这个函数的每次调用都应有一个对应的 GlobalUnlock 调用 返回值 Long，如成功，返回内存块的地址；如出错，或者这是一个已被丢弃的“可丢弃”内存块，则返回零。通常我们在编程的时候，给应用程序分配的内存都是可以移动的或者是可以丢弃的，这样能使有限的内存资源充分利用，所以，在某一个时候我们分配 的那块内存的地址是不确定的，因为他是可以移动的，所以得先锁定那块内存块，这儿应用程序需要调用API函数GlobalLock函数来锁定句柄。如下：lpMem=GlobalLock(hMem)（数据类型应该是指针类型）; 这样应用程序才能存取这块内存。</p></blockquote><h2 id="剪切板操作的兼容性问题"><a href="#剪切板操作的兼容性问题" class="headerlink" title="剪切板操作的兼容性问题"></a>剪切板操作的兼容性问题</h2><p>上述代码我在公司的项目中也有使用。但是自从公司决定将软件中内嵌的Python2.7升级到Python3.7之后，类似上述的代码就不能在继续运行了。经过调试之后，发现了问题所在，请看下面代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_clipboard_text</span>():</span></span><br><span class="line">    user32.OpenClipboard(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> user32.IsClipboardFormatAvailable(CF_TEXT):</span><br><span class="line">        data = user32.GetClipboardData(CF_TEXT)</span><br><span class="line">        data_locked = kernel32.GlobalLock(data)</span><br><span class="line">        text = ctypes.c_char_p(data_locked)</span><br><span class="line">        value = text.value <span class="comment"># 问题所在位置。</span></span><br><span class="line">        kernel32.GlobalUnlock(data_locked)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    user32.CloseClipboard()</span><br></pre></td></tr></table></figure><p>在上述代码中，在调试代码时，代码可以运行至带有注释的这一行的前一行。当试图尝试使用便利text时，程序就会出错，从而引发崩溃。可以肯定的是text变量并不为None，在一开始一直以为是锁定内存带来的问题。但是最后发现整个代码都有问题的。</p><p>在不断尝试之后，项目背景是，剪切板的中不会存在特殊字符或者宽字符。本着最少代码修改量就能解决问题的原则，以及“简单胜过复杂”的设计哲学。我们用下列代码解决了这部分代码对Python3的兼容。</p><p><strong>“Simple is better than complicated”</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kernel32.GlobalLock.argtypes = [ctypes.c_void_p]</span><br><span class="line">kernel32.GlobalLock.restype = ctypes.c_void_p</span><br><span class="line">kernel32.GlobalUnlock.argtypes = [ctypes.c_void_p]</span><br><span class="line">user32.GetClipboardData.restype = ctypes.c_void_p</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_clipboard_text</span>():</span></span><br><span class="line">    user32.OpenClipboard(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> user32.IsClipboardFormatAvailable(CF_TEXT):</span><br><span class="line">            data = user32.GetClipboardData(CF_TEXT)</span><br><span class="line">            data_locked = kernel32.GlobalLock(data)</span><br><span class="line">            text = ctypes.c_char_p(data_locked)</span><br><span class="line">            value = text.value</span><br><span class="line">            kernel32.GlobalUnlock(data_locked)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        user32.CloseClipboard()</span><br></pre></td></tr></table></figure><p>在使用函数的时候，只要提前申明了函数参数的数据类型，和函数返回值的数据类型。就解决了兼容性问题。虽然解决了问题，但是总觉得有种知其然不知所以然的感觉。为什么Python2中不需要声明，而Python3中却需要。经过不断地查找，找到了下面的解决方案。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> ctypes.wintypes <span class="keyword">as</span> w</span><br><span class="line"></span><br><span class="line">CF_UNICODETEXT = <span class="number">13</span></span><br><span class="line"></span><br><span class="line">u32 = ctypes.WinDLL(<span class="string">&#x27;user32&#x27;</span>)</span><br><span class="line">k32 = ctypes.WinDLL(<span class="string">&#x27;kernel32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">OpenClipboard = u32.OpenClipboard</span><br><span class="line">OpenClipboard.argtypes = w.HWND,</span><br><span class="line">OpenClipboard.restype = w.BOOL</span><br><span class="line">GetClipboardData = u32.GetClipboardData</span><br><span class="line">GetClipboardData.argtypes = w.UINT,</span><br><span class="line">GetClipboardData.restype = w.HANDLE</span><br><span class="line">GlobalLock = k32.GlobalLock</span><br><span class="line">GlobalLock.argtypes = w.HGLOBAL,</span><br><span class="line">GlobalLock.restype = w.LPVOID</span><br><span class="line">GlobalUnlock = k32.GlobalUnlock</span><br><span class="line">GlobalUnlock.argtypes = w.HGLOBAL,</span><br><span class="line">GlobalUnlock.restype = w.BOOL</span><br><span class="line">CloseClipboard = u32.CloseClipboard</span><br><span class="line">CloseClipboard.argtypes = <span class="literal">None</span></span><br><span class="line">CloseClipboard.restype = w.BOOL</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_clipboard_text</span>():</span></span><br><span class="line">    text = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> OpenClipboard(<span class="literal">None</span>):</span><br><span class="line">        h_clip_mem = GetClipboardData(CF_UNICODETEXT)</span><br><span class="line">        text = ctypes.wstring_at(GlobalLock(h_clip_mem))</span><br><span class="line">        GlobalUnlock(h_clip_mem)</span><br><span class="line">        CloseClipboard()</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">print(get_clipboard_text())</span><br></pre></td></tr></table></figure><p>乍一看，很复杂，其实其实现过程和第一个解决方案相似，而且上述的代码够同时在Python2.x和Python3.x中完美运行，也同时支持ascii与unicode字符，算是一个完美的解决方案。</p><p>这个解决方案的提供者Mark Tolonen也解释道，由于Python3是64位的，如果我们在Python3.x的环境下使用原来在Python2.x中的代码。默认情况下，我们传递是句柄就是c_int(32bit)的，存储长度不够。超出会存在负值，导致代码不兼容的主要问题就在这儿。</p><p>kernel内核和windows的句柄都是32位的。如果在64位环境中使用这些句柄就会存在负值，为了避免这种情况发生，就应该将这些句柄扩展至64位。而且一些句柄实际上是内存的地址，例如HMODULE和HGLOBAL，以及GlobalLock的返回结果也应该得到扩展。总的来讲，在处理句柄和指针的时候总是声明参数argtypes和返回值restype，就可以避免硬编码实现细节和假设。</p><p>学无止境，总有高手，在这些高手的解释中也学习到了很多，了解一些问题出现的根本原因，和这些高手在面对这些问题时所思考的内容。然后学以致用，来提高自己。</p><p>参考目录：</p><p><strong>Stackflow：</strong><a href="https://stackoverflow.com/questions/46132401/read-text-from-clipboard-in-windows-using-ctypes">https://stackoverflow.com/questions/46132401/read-text-from-clipboard-in-windows-using-ctypes</a></p><p><strong>CSDN：</strong><a href="https://blog.csdn.net/longxin5/article/details/83394388">https://blog.csdn.net/longxin5/article/details/83394388</a></p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;剪切板的基本操作&quot;&gt;&lt;a href=&quot;#剪切板的基本操作&quot; class=&quot;headerlink&quot; title=&quot;剪切板的基本操作&quot;&gt;&lt;/a&gt;剪切板的基本操作&lt;/h2&gt;&lt;p&gt;在Python的实际应用中有时候会遇到对剪切板进行操作的问题。剪切板的基本操作需求如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;获取剪切板中的内容。&lt;/li&gt;
&lt;li&gt;向剪切板中注入内容。&lt;/li&gt;
&lt;li&gt;清除剪切板的内容。&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Python 相关 - 8. Python 杂记" scheme="https://zicowarn.github.io/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/"/>
    
    
      <category term="Python" scheme="https://zicowarn.github.io/tags/Python/"/>
    
      <category term="杂记" scheme="https://zicowarn.github.io/tags/%E6%9D%82%E8%AE%B0/"/>
    
      <category term="剪切板" scheme="https://zicowarn.github.io/tags/%E5%89%AA%E5%88%87%E6%9D%BF/"/>
    
      <category term="代码兼容" scheme="https://zicowarn.github.io/tags/%E4%BB%A3%E7%A0%81%E5%85%BC%E5%AE%B9/"/>
    
  </entry>
  
  <entry>
    <title>Python 杂记之 实现列表的自加和左移等操作</title>
    <link href="https://zicowarn.github.io/2018/12/15/0804-ma-list-leftadd-selfadd-op/"/>
    <id>https://zicowarn.github.io/2018/12/15/0804-ma-list-leftadd-selfadd-op/</id>
    <published>2018-12-15T00:11:08.000Z</published>
    <updated>2020-08-19T05:26:34.925Z</updated>
    
    <content type="html"><![CDATA[<p>作者: Jim Wang 公众号: <a class="main-button-link" href="#wechat" rel="noopener">巴博萨船长</a></p><h2 id="列表与操作方法"><a href="#列表与操作方法" class="headerlink" title="列表与操作方法"></a>列表与操作方法</h2><p>列表<strong>list</strong>是Python语言中的标准数据类型，进一步讲list是一种可变的序列类型，不可变的有tuple和range（注：Python 3.x中xrange已经不存在了）。<strong>可变序列类型</strong>，<strong>可变</strong>就是长度可以改变，所含元素数值可以改变，元素数据类型可以改变；<strong>序列</strong>意指成员有序排列，可以通过索引访问元素。既然是序列类型，就一定可以迭代（for 循环），所以列表是<strong>可迭代</strong>的对象，请注意<strong>可迭代</strong>和<strong>迭代器</strong>的差异。</p><a id="more"></a><p>列表的常用操作包括，索引，切片，改变与排序。而这几种操作要属<strong>改变</strong>最多样。改变包括，一、<strong>长度改变</strong>，成员的<strong>添加</strong>（常用方法append，insert和extend）与<strong>删除</strong>（常用方法pop与remove）。二、<strong>数值改变</strong>，通过索引访问与重新赋值来实现。</p><h2 id="列表操作的延伸思考"><a href="#列表操作的延伸思考" class="headerlink" title="列表操作的延伸思考"></a>列表操作的延伸思考</h2><p>由于上一篇文章是与运算符相关，所以在准备文字的时候就思索，作为标准数据类型的列表，能和它组合使用的运算符都有什么呢？今天我就和大家一起总结，共同学习一下。</p><p>一般情况下，Python中列表只能与➕操作符组合使用，前提是➕号左右都是序列类型。可能别的教程里面规定➕左右都应该是一样的列表类型。我们今天扩展一下，定义：➕号左右都是序列类型。</p><ul><li>当加号➕右侧为列表，或者range()时，代码表现符合正常预期，请参看下面例子：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m3 = [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 + m3</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 + <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ss = <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(ss)</span><br><span class="line">&lt;<span class="built_in">type</span> <span class="string">&#x27;list&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 + (<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: can only concatenate <span class="built_in">list</span> (<span class="keyword">not</span> <span class="string">&quot;tuple&quot;</span>) to <span class="built_in">list</span></span><br></pre></td></tr></table></figure><p>List作为唯一的可变序列类型，而且与加号左侧数据类型一直，它的加法运算正常且容易理解。range， str与tuple是不可变的数据类型，理论上与列表相加时肯定会出错的，但是在Python 2.x 中却没有问题，结果如上。其原因为: Python 2.x 中range返回的是一个列表。而在Python 3.x 中这样写就会引发异常，参考如下代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 + <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: can only concatenate <span class="built_in">list</span> (<span class="keyword">not</span> <span class="string">&quot;range&quot;</span>) to <span class="built_in">list</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ss = <span class="built_in">range</span>(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(ss)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">range</span>&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p>因为Python 3.x 中返回的是一个真正的range类实例，是一个不可变的序列类型。</p><ul><li>当加号➕右侧为其它序列类型，即不可变序列类型，如 tuple 或 str 时，请参看下面例子：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 += <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;o&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = m2 + <span class="string">&quot;hello&quot;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: can only concatenate <span class="built_in">list</span> (<span class="keyword">not</span> <span class="string">&quot;str&quot;</span>) to <span class="built_in">list</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 += (<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m2 = m2 + (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: can only concatenate <span class="built_in">list</span> (<span class="keyword">not</span> <span class="string">&quot;tuple&quot;</span>) to <span class="built_in">list</span></span><br></pre></td></tr></table></figure><p>理论上肯定不行的，毕竟左右两侧的数据类型不同。但是总会有些意外，有些惊喜。虽然在<strong>运算符</strong>的章节中，我们了解到自加操作符与加法和赋值的组合等效，即 a += 1 等效于 a = a + 1。但是参照上方的例子，我们发现应该在解析运行的时候。两种数据操作方式还是有些不一样的，比如在参与的数据有列表是，<strong>自加</strong>时，因为列表（等号左侧）为可变对象，原则上仅需要本地对象（这里指m2）进行修改，不需要产生新的对象。那么在修改的时候解释器会讲右侧的对象尝试数据类型转换，上述的例子中讲字符穿转换为字符列表，将tuple转换为列表，进而对本地m2对象进行修改，所以我们就实现了所有<strong>序列类型</strong>的加法操作，注意非序列的数据类型不行，是不是有点神奇。</p><h2 id="进一步延伸思考"><a href="#进一步延伸思考" class="headerlink" title="进一步延伸思考"></a>进一步延伸思考</h2><p>上一节，我们通过总结可知：1. 列表的加法操作，并不是全效的加法，因为对数据只能对序列操作，那么如果仅需要添加一个成员的时候，加法操作就不再适用。2. 列表没有减法操作。那么有解决方法吗？了解到Python<strong>万物皆对象</strong>（必定不单身）。那么如果继承列表基本类，创建自有字类，通过重写方法就是实现Python的全效加法于减法。有想法之后就实现一下，代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#-*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyList</span>(<span class="params"><span class="built_in">list</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__add__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="comment">#Function is called by + command</span></span><br><span class="line">        self.addObj(obj)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__sub__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="comment">#Function is called by - command</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">list</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">tuple</span>):</span><br><span class="line">        <span class="comment">#if isinstance(obj, list) or isinstance(obj, tuple) or isinstance(obj, range): # Python 3.x</span></span><br><span class="line">            <span class="keyword">for</span> o <span class="keyword">in</span> obj: </span><br><span class="line">                <span class="keyword">return</span> self.__class__([item <span class="keyword">for</span> item <span class="keyword">in</span> self <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> obj])</span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> self.__class__([item <span class="keyword">for</span> item <span class="keyword">in</span> self <span class="keyword">if</span> item != obj])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lshift__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="comment">#Function is called by &lt;&lt; command</span></span><br><span class="line">        self += obj</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iadd__</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="comment">#Function is called by += command</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">list</span>) <span class="keyword">or</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">tuple</span>):</span><br><span class="line">        <span class="comment">#if isinstance(obj, list) or isinstance(obj, tuple) or isinstance(obj, range): # Python 3.x</span></span><br><span class="line">            <span class="keyword">for</span> o <span class="keyword">in</span> obj: </span><br><span class="line">                self.addObj(o)</span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            self.addObj(obj)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addObj</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        self.append(obj)</span><br></pre></td></tr></table></figure><p>在使用需要注意，由于Python默认的列表类为list，传统的列表赋值方式只能产生list的实例对象，那么如果初始化玩MyList类的实例后，再为实例变量使用传统方式赋值时，那么就会产生新的对象，而且新类的<strong>属性</strong>与<strong>方法</strong>将丢失。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> test <span class="keyword">import</span> MyList</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml = MyList([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(ml)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">test</span>.<span class="title">MyList</span>&#x27;&gt;</span></span><br><span class="line">&gt;&gt;&gt; ml = MyList()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(ml)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">test</span>.<span class="title">MyList</span>&#x27;&gt;</span></span><br><span class="line">&gt;&gt;&gt; ml = [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(ml)</span><br><span class="line">&lt;<span class="built_in">type</span> <span class="string">&#x27;list&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><p>实际使用结果如下，因为在加法运算时，我们返回类实例本身，所以列表的值在做加法是会发生变化。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml = MyList([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml + [<span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, [<span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml = MyList([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml + [<span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, [<span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>]]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml = MyList([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml += [<span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml = MyList([<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml + <span class="string">&quot;e&quot;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;e&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml + <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml - <span class="number">1</span></span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;e&#x27;</span>]  <span class="comment"># 新的列表对象</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml - [<span class="string">&#x27;c&#x27;</span>, <span class="number">1</span>]</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;e&#x27;</span>] <span class="comment"># 新的列表对象</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml &lt;&lt; <span class="string">&quot;e&quot;</span></span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;e&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ml &lt;&lt; [<span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;f&#x27;</span>]</span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;f&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tt = ml - [<span class="string">&#x27;c&#x27;</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(tt)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">test</span>.<span class="title">MyList</span>&#x27;&gt;</span></span><br></pre></td></tr></table></figure><p>而在做减法运算时，我们创建并返回一个新的类实例，所以减数，即原始列表值不发生改变，请参见上述代码中带注释的内容。有心的同学可能也发现了，我们重写__iadd__()， 实现了我们预期的自加，重写__add__()， 实现了我们预期的加法，重写__sub__()， 实现了我们预期的列表减法运算和重写__lshift__()， 实现了我们预期的列表的左移运算，怎么样是不是也有一点成就感。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在之前的文章中我们介绍了如何动态重写类方法，那么我们的上述的方法能不能也动态地写入基类list中，使其所有实例都有新的方法呢？感兴趣的童鞋可以自己可以试一下。我把结果写出来, 就不再举例分析。<strong>是不行的</strong>，由于基类是由别的语言实现的属于built-in类型，虽然也是动态的类，但是却因为别的语言限制了访问，所以其__iadd__()方法，在实例中是<strong>仅可读的</strong>。所以就没办法实现list基类，这些方法的动态绑定和重写。</p><hr><div style="color:#757288;font-size:1.3rem;padding:2px 6px;border:1px solid #fad2d2;background:#ffecea;border-radius:3px;line-height:22px;">          版权声明：<br>文章首发于 <a href="http://zhichaowang.online"> Jim Wang's blog </a>，          转载文章请务必以超链接形式标明文章出处，作者信息及本版权声明。        </div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;作者: Jim Wang 公众号: &lt;a class=&quot;main-button-link&quot; href=&quot;#wechat&quot; rel=&quot;noopener&quot;&gt;巴博萨船长&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;列表与操作方法&quot;&gt;&lt;a href=&quot;#列表与操作方法&quot; class=&quot;headerlink&quot; title=&quot;列表与操作方法&quot;&gt;&lt;/a&gt;列表与操作方法&lt;/h2&gt;&lt;p&gt;列表&lt;strong&gt;list&lt;/strong&gt;是Python语言中的标准数据类型，进一步讲list是一种可变的序列类型，不可变的有tuple和range（注：Python 3.x中xrange已经不存在了）。&lt;strong&gt;可变序列类型&lt;/strong&gt;，&lt;strong&gt;可变&lt;/strong&gt;就是长度可以改变，所含元素数值可以改变，元素数据类型可以改变；&lt;strong&gt;序列&lt;/strong&gt;意指成员有序排列，可以通过索引访问元素。既然是序列类型，就一定可以迭代（for 循环），所以列表是&lt;strong&gt;可迭代&lt;/strong&gt;的对象，请注意&lt;strong&gt;可迭代&lt;/strong&gt;和&lt;strong&gt;迭代器&lt;/strong&gt;的差异。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python 相关 - 8. Python 杂记" scheme="https://zicowarn.github.io/categories/Python-%E7%9B%B8%E5%85%B3-8-Python-%E6%9D%82%E8%AE%B0/"/>
    
    
      <category term="Python" scheme="https://zicowarn.github.io/tags/Python/"/>
    
      <category term="杂记" scheme="https://zicowarn.github.io/tags/%E6%9D%82%E8%AE%B0/"/>
    
      <category term="自加" scheme="https://zicowarn.github.io/tags/%E8%87%AA%E5%8A%A0/"/>
    
  </entry>
  
</feed>
